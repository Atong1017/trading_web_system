{% extends "base.html" %}

{% block title %}å›æ¸¬åˆ†æ - å°ç£è‚¡ç¥¨äº¤æ˜“ç³»çµ±{% endblock %}

{% block feature_nav %}
<div class="feature-nav">
    <h4><i class="fas fa-compass"></i> åŠŸèƒ½å€å°èˆª</h4>
    <!-- å›æ¸¬åŠŸèƒ½å€ -->
    <div class="feature-section">
        <h5><i class="fas fa-chart-bar"></i> å›æ¸¬åŠŸèƒ½</h5>
        <div class="feature-links" id="feature-links-nav">
            <a href="/backtest#settings" class="feature-link">ç½®é ‚ğŸ </a>
            <a href="/backtest#results" class="feature-link">å›æ¸¬çµæœğŸ§ª</a>
            <a href="/backtest#trades-section" class="feature-link">äº¤æ˜“è¨˜éŒ„ğŸ’°</a>
            <a href="/backtest#charts-section" class="feature-link">åœ–è¡¨åˆ†æğŸ“ˆ</a>
            <a href="/backtest#performance" class="feature-link">ç¸¾æ•ˆçµ±è¨ˆğŸ¯</a>
            <a href="/backtest#export" class="feature-link">åŒ¯å‡ºå ±å‘ŠğŸ’¾</a>
        </div>
    </div>    
</div>
<script>
// è®“ feature-nav çš„æ‰€æœ‰é€£çµè‡ªå‹•å¸¶ä¸Š strategy åƒæ•¸
(function() {
    const urlParams = new URLSearchParams(window.location.search);
    const strategy = urlParams.get('strategy');
    if (strategy) {
        document.querySelectorAll('#feature-links-nav a').forEach(function(link) {
            const url = new URL(link.href, window.location.origin);
            url.searchParams.set('strategy', strategy);
            // ä¿ç•™ hash
            if (link.hash) url.hash = link.hash;
            link.href = url.pathname + url.search + url.hash;
        });
    }
})();
</script>
{% endblock %}

{% block extra_css %}
<style>
/* ç­–ç•¥å¡ç‰‡æ¨£å¼ */
.strategy-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.strategy-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    border-color: #007bff;
}

.strategy-card.selected {
    border-color: #007bff;
    background-color: #f8f9fa;
    box-shadow: 0 4px 8px rgba(0,123,255,0.2);
}

/* æª”æ¡ˆä¸Šå‚³æ¨£å¼ */
.file-upload {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.file-upload:hover {
    border-color: #007bff;
    background-color: #f8f9fa;
}

/* è¼‰å…¥ä¸­æ¨£å¼ */
.loading {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.loading > div {
    background-color: white;
    padding: 2rem;
    border-radius: 8px;
    text-align: center;
}

/* åƒæ•¸å€å¡Šç¶²æ ¼æ’ç‰ˆ - æ›´ç°¡æ½”ä¸¦æ’ */
.backtest-params-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
    align-items: start;
}

.param-item {
    margin-bottom: 0;
}

/* ç­–ç•¥åƒæ•¸æ©«å‘ä¸¦æ’ */
.strategy-params-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 12px 20px;
    align-items: start;
}

.strategy-params-grid .param-item {
    margin-bottom: 0.5rem;
}

.strategy-params-grid label.form-label {
    font-size: 0.9rem;
    font-weight: 500;
    margin-bottom: 0.3rem;
}

.strategy-params-grid .form-control,
.strategy-params-grid .form-select {
    font-size: 0.85rem;
    padding: 0.4rem 0.6rem;
}

.strategy-params-grid .form-text {
    font-size: 0.8rem;
    color: #888;
    margin-top: 0.2rem;
}

/* èª¿æ•´æ•´é«”å­—å‹å¤§å° */
.form-label {
    font-size: 0.9rem;
    font-weight: 500;
}

.form-control,
.form-select {
    font-size: 0.85rem;
}

.form-text {
    font-size: 0.8rem;
}

.card-header h5 {
    font-size: 1.1rem;
}

.table {
    font-size: 0.85rem;
}

.table th {
    font-size: 0.8rem;
    font-weight: 600;
}

.btn {
    font-size: 0.85rem;
}

.btn-sm {
    font-size: 0.8rem;
}

/* æ·±è‰²ä¸»é¡Œä¸‹è¡¨æ ¼é¡è‰²ä¿®æ­£ */
.dark-theme .table-striped > tbody > tr:nth-of-type(odd) > td {
    color: #e9ecef !important;
}

.dark-theme .table-striped > tbody > tr:nth-of-type(even) > td {
    color: #e9ecef !important;
}

.dark-theme .table-hover > tbody > tr:hover > td {
    color: #ffffff !important;
}

/* è‡ªå®šç¾©å‹¾é¸é–‹é—œæ¨£å¼ - æ©«ç§»ç¶ è‰² */
.custom-toggle-switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 30px;
    background-color: #ccc;
    border-radius: 15px;
    transition: background-color 0.3s ease;
    cursor: pointer;
}

.custom-toggle-switch.active {
    background-color: #28a745;
}

.custom-toggle-switch .toggle-slider {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 26px;
    height: 26px;
    background-color: white;
    border-radius: 50%;
    transition: transform 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.custom-toggle-switch.active .toggle-slider {
    transform: translateX(30px);
}

.custom-toggle-switch input[type="checkbox"] {
    display: none;
}

@media (max-width: 600px) {
    .strategy-params-grid {
        grid-template-columns: 1fr;
    }
    
    .backtest-params-grid {
        grid-template-columns: 1fr;
    }
}

/* æ·±è‰²ä¸»é¡Œä¸‹æ¼²è·Œé¡è‰²å¼·åŒ– - å¢åŠ æ›´å¼·çš„æ¬Šé‡ */
body.dark-theme .text-success {
    color: #4be37a !important;
}
body.dark-theme .text-danger {
    color: #ff6b6b !important;
}

/* å±•é–‹åˆ—æ¨£å¼ */
.trades-table-details-row {
    background: rgba(0,0,0,0.04);
}
.dark-theme .trades-table-details-row {
    background: #23272b;
    color: #e9ecef;
}
.trades-table-details-content {
    font-size: 0.85rem;
    padding: 1rem 2rem;
    word-break: break-all;
}
.trades-table-details-content pre {
    background: #f8f9fa;
    color: #333;
    border-radius: 4px;
    padding: 0.5rem;
}
.dark-theme .trades-table-details-content pre {
    background: #181a1b;
    color: #e9ecef;
}

/* å±•é–‹ç‹€æ…‹çš„è¦–è¦ºæç¤º */
.trade-row.expanded {
    background-color: rgba(0,123,255,0.1) !important;
}
.dark-theme .trade-row.expanded {
    background-color: rgba(0,123,255,0.2) !important;
}

/* åœ–è¡¨å®¹å™¨æ¨£å¼ï¼ˆç§»é™¤ .chart-container ç›¸é—œè¨­å®šï¼Œçµ±ä¸€ç”± style.css æ§åˆ¶ï¼‰ */
/* .chart-container {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    background-color: #f8f9fa;
    width: 100%;
    box-sizing: border-box;
} */

.dark-theme .chart-container {
    background-color: #2d2d2d;
    border-color: #404040;
}

/* ç¢ºä¿åœ–è¡¨å…§å®¹å¡«æ»¿å®¹å™¨ */
.chart-container > div {
    width: 100%;
}

.chart-container .plotly-graph-div {
    width: 100% !important;
    min-height: 400px !important;
    height: auto !important;
}

/* ä¸Šä¸‹æ’åˆ—æ¨¡å¼çš„åœ–è¡¨å®¹å™¨ */
#vertical-charts-container .chart-container {
    margin-bottom: 1rem;
}

/* åœ–è¡¨æ¨™ç±¤é æ¨£å¼ */
.nav-tabs .nav-link {
    font-size: 0.85rem;
    padding: 0.5rem 0.75rem;
}

.nav-tabs .nav-link.active {
    font-weight: 600;
}

/* åœ–è¡¨è¼‰å…¥ä¸­æ¨£å¼ */
.chart-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #6c757d;
}

.chart-loading .spinner-border {
    width: 2rem;
    height: 2rem;
    margin-bottom: 1rem;
}

/* åœ–è¡¨éŒ¯èª¤æ¨£å¼ */
.chart-error {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #dc3545;
}

.chart-error .fas {
    font-size: 2rem;
    margin-bottom: 1rem;
}

option.strategy-divider {
    color: #aaa !important;
    font-style: italic;
    background: #222 !important;
    font-weight: bold;
    border-top: 1px solid #444;
    pointer-events: none;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- å›æ¸¬è¨­å®šåœ¨ä¸Š -->
    <div class="row mb-4" id="settings">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cog me-2"></i>
                        å›æ¸¬è¨­å®š
                    </h5>
                </div>
                <div class="card-body">
                    <form id="backtest-form" novalidate>
                        <div class="backtest-params-grid">
                            <!-- äº¤æ˜“ç­–ç•¥ -->
                            <div class="param-item">
                                <label for="strategy_name" class="form-label">äº¤æ˜“ç­–ç•¥</label>
                                <select class="form-select" id="strategy_name" name="strategy_name" required>
                                    <option value="">è«‹é¸æ“‡ç­–ç•¥</option>
                                    <span id="custom-strategies-group"></span>
                                </select>
                                <div class="form-text" id="strategy-description"></div>
                            </div>
                            <!-- è‚¡ç¥¨ä¾†æº -->
                            <div class="param-item">
                                <label class="form-label">è‚¡ç¥¨ä»£ç¢¼ä¾†æº</label>
                                <select class="form-select" id="stock_source" name="stock_source">
                                    <option value="excel">Excelæª”æ¡ˆ</option>
                                    <option value="manual">æ‰‹å‹•è¼¸å…¥</option>
                                </select>
                                <div class="form-text" id="stock_source_help"></div>
                            </div>
                            <!-- Excelæª”æ¡ˆä¸Šå‚³ -->
                            <div class="param-item" id="excel-upload-section">
                                <label class="form-label">Excelæª”æ¡ˆ</label>
                                <div class="d-flex gap-2">
                                    <input class="form-control" type="file" id="excel_file" name="excel_file" accept=".xlsx,.xls,.csv">
                                    <button type="button" class="btn btn-outline-info" id="format-help-btn" style="max-width: 40px;" title="æŸ¥çœ‹æª”æ¡ˆæ ¼å¼èªªæ˜">
                                        <i class="fas fa-question"></i>
                                    </button>
                                </div>
                                <div class="form-text" id="excel_help"></div>
                            </div>
                            <!-- æ‰‹å‹•è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ -->
                            <div class="param-item" id="manual-stock-section" style="display: none;">
                                <label class="form-label">è‚¡ç¥¨ä»£ç¢¼</label>
                                <textarea class="form-control" id="manual_stock_ids" name="manual_stock_ids" rows="3" placeholder="è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼Œæ¯è¡Œä¸€å€‹ï¼Œä¾‹å¦‚ï¼š&#10;2330&#10;2317&#10;2454"></textarea>
                                <div class="form-text">è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼Œæ¯è¡Œä¸€å€‹</div>
                            </div>
                            <!-- è‚¡åƒ¹è³‡æ–™ä¾†æº -->
                            <div class="param-item">
                                <label class="form-label">è‚¡åƒ¹è³‡æ–™ä¾†æº</label>
                                <select class="form-select" id="price_source" name="price_source">
                                    <option value="api" selected>API (å³æ™‚å–å¾—è‚¡åƒ¹è³‡æ–™)</option>
                                    <option value="cache">å¿«å– (ä½¿ç”¨å·²å¿«å–çš„è‚¡åƒ¹è³‡æ–™)</option>
                                    <option value="excel">Excel (å¾æª”æ¡ˆä¸­å–å¾—è‚¡åƒ¹è³‡æ–™)</option>
                                </select>
                                <div class="form-text" id="price_source_help"></div>
                            </div>
                            <!-- å¿«å–è³‡æ–™ä¾†æºè¨­å®š -->
                            <div class="param-item" id="cache-source-section" style="display: none;">
                                <label class="form-label">å¿«å–æª”æ¡ˆé¸æ“‡</label>
                                <select class="form-select" id="cache_file_select" name="cache_file_select">
                                    <option value="">è«‹é¸æ“‡å¿«å–æª”æ¡ˆ...</option>
                                </select>
                                <div class="form-text">é¸æ“‡å·²å¿«å–çš„è‚¡åƒ¹è³‡æ–™æª”æ¡ˆ</div>
                            </div>
                            <!-- è‚¡åƒ¹è³‡æ–™ Excel ä¸Šå‚³ -->
                            <div class="param-item" id="price-excel-section" style="display: none;">
                                <label class="form-label">è‚¡åƒ¹è³‡æ–™ Excel æª”æ¡ˆ</label>
                                <input type="file" class="form-control" id="price_excel_file" name="price_excel_file" accept=".xlsx,.xls">
                                <div class="form-text">ä¸Šå‚³åŒ…å«å®Œæ•´Kç·šè³‡æ–™çš„Excelæª”æ¡ˆï¼ˆéœ€åŒ…å«ï¼šstock_id, date, open, high, low, close æ¬„ä½ï¼‰</div>
                            </div>
                            <!-- åˆå§‹è³‡é‡‘ -->
                            <div class="param-item">
                                <label class="form-label">åˆå§‹è³‡é‡‘</label>
                                <input type="number" class="form-control" id="initial_capital" name="initial_capital" value="1000000" min="10000" step="10000" required>
                                <div class="form-text">å›æ¸¬èµ·å§‹è³‡é‡‘</div>
                            </div>
                        </div>
                        <!-- ç­–ç•¥é…ç½®ç¨ç«‹ä¸€è¡Œ -->
                        <div class="mt-4">
                            <label class="form-label">ç­–ç•¥é…ç½®</label>
                            <div id="strategy-config"></div>
                        </div>
                        <!-- åŸ·è¡ŒæŒ‰éˆ• -->
                        <div class="d-grid mt-3">
                            <button type="submit" class="btn btn-primary" id="run-backtest-btn">
                                <i class="fas fa-play me-2"></i>
                                åŸ·è¡Œå›æ¸¬
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- å›æ¸¬çµæœåœ¨ä¸­ -->
    <div class="row mb-4" id="results">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        å›æ¸¬çµæœ
                    </h5>
                </div>
                <div class="card-body" id="performance">
                    <div id="backtest-results">
                        <div class="text-center text-muted">
                            <i class="fas fa-chart-bar fa-3x mb-3"></i>
                            <p>è«‹è¨­å®šå›æ¸¬åƒæ•¸ä¸¦åŸ·è¡Œå›æ¸¬</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- äº¤æ˜“è¨˜éŒ„/åœ–è¡¨åœ¨ä¸‹ -->
    <div class="row" id="trades-section" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        äº¤æ˜“è¨˜éŒ„
                        <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="toggle-trades-table" onclick="toggleTradesTable()">
                            <i class="fas fa-chevron-up" id="trades-toggle-icon"></i>
                        </button>
                    </h5>
                    <div>
                        <button type="button" class="btn btn-outline-success btn-sm" id="download-detailed-btn">
                            <i class="fas fa-download me-1"></i>
                            ä¸‹è¼‰è©³ç´°è¨˜éŒ„
                        </button>
                    </div>
                </div>
                <div class="card-body" id="trades-table-body">
                    <div class="table-responsive">
                        <!-- æ¸¬è©¦æŒ‰éˆ• -->
                        <!-- <div class="mb-3">
                            <button type="button" class="btn btn-sm btn-outline-info" onclick="testExpandFunction()">
                                <i class="fas fa-test"></i> æ¸¬è©¦å±•é–‹åŠŸèƒ½
                            </button>
                        </div> -->
                        
                        <table class="table table-hover" id="trades-table">
                            <thead>
                                <tr>
                                    <th>é€²å ´æ—¥æœŸ</th>
                                    <th>å‡ºå ´æ—¥æœŸ</th>
                                    <th>è‚¡ç¥¨ä»£ç¢¼</th>
                                    <th>è‚¡ç¥¨åç¨±</th>
                                    <th>é€²å ´åƒ¹æ ¼</th>
                                    <th>å‡ºå ´åƒ¹æ ¼</th>
                                    <th>è‚¡æ•¸</th>
                                    <th>å ±é…¬</th>
                                    <th>å ±é…¬ç‡</th>
                                    <th>æŒæœ‰å¤©æ•¸</th>
                                    <th>å‡ºå ´ç‹€æ…‹</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- äº¤æ˜“è¨˜éŒ„å°‡ç”±JavaScriptå‹•æ…‹è¼‰å…¥ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- åœ–è¡¨åˆ†æå€åŸŸ -->
    <div class="row" id="charts-section" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-area me-2"></i>
                        åœ–è¡¨åˆ†æ
                        <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="toggle-charts" onclick="toggleChartsSection()">
                            <i class="fas fa-chevron-up" id="charts-toggle-icon"></i>
                        </button>
                    </h5>
                    <div>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="refreshAllCharts()">
                            <i class="fas fa-sync me-1"></i>
                            é‡æ–°æ•´ç†åœ–è¡¨
                        </button>
                    </div>
                </div>
                <div class="card-body" id="charts-body">
                    <!-- åœ–è¡¨æ¨™ç±¤é  -->
                    <ul class="nav nav-tabs" id="chartsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="drawdown-tab" data-bs-toggle="tab" data-bs-target="#drawdown-chart" type="button" role="tab">
                                <i class="fas fa-chart-line me-1"></i>å›è½åœ–
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="heatmap-tab" data-bs-toggle="tab" data-bs-target="#heatmap-chart" type="button" role="tab">
                                <i class="fas fa-th me-1"></i>æœˆæç›Šç†±åŠ›åœ–
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="return-heatmap-tab" data-bs-toggle="tab" data-bs-target="#return-heatmap-chart" type="button" role="tab">
                                <i class="fas fa-percentage me-1"></i>æœˆæ”¶ç›Šç‡ç†±åŠ›åœ–
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="yearly-tab" data-bs-toggle="tab" data-bs-target="#yearly-chart" type="button" role="tab">
                                <i class="fas fa-calendar-alt me-1"></i>å¹´åº¦æç›Š
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="trading-days-tab" data-bs-toggle="tab" data-bs-target="#trading-days-chart" type="button" role="tab">
                                <i class="fas fa-calendar-day me-1"></i>æœˆäº¤æ˜“å¤©æ•¸
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="trading-stocks-tab" data-bs-toggle="tab" data-bs-target="#trading-stocks-chart" type="button" role="tab">
                                <i class="fas fa-chart-bar me-1"></i>æœˆäº¤æ˜“è‚¡ç¥¨æ•¸
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="win-rate-tab" data-bs-toggle="tab" data-bs-target="#win-rate-chart" type="button" role="tab">
                                <i class="fas fa-trophy me-1"></i>æœˆå‹ç‡
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="weekday-tab" data-bs-toggle="tab" data-bs-target="#weekday-chart" type="button" role="tab">
                                <i class="fas fa-calendar-week me-1"></i>æ˜ŸæœŸåˆ†æ
                            </button>
                        </li>
                    </ul>
                    
                    <!-- åœ–è¡¨å…§å®¹ -->
                    <div class="tab-content mt-3" id="chartsTabContent" style="display: none;">
                        <!-- å›è½åœ– -->
                        <div class="tab-pane fade show active" id="drawdown-chart" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6>å›è½åœ–åˆ†æ</h6>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-info me-2" id="btn-vertical">ä¸Šä¸‹æ’åˆ—</button>
                                    <button type="button" class="btn btn-sm btn-outline-info" id="btn-horizontal">å·¦å³æ’åˆ—</button>
                                    <button type="button" class="btn btn-sm btn-outline-info ms-2" onclick="toggleDrawdownView()">
                                        <i class="fas fa-exchange-alt me-1"></i>åˆ‡æ›è¦–åœ–
                                    </button>
                                </div>
                            </div>
                            <div id="drawdown-chart-container" class="chart-container">
                                <div class="text-center text-muted">
                                    <i class="fas fa-chart-line fa-2x mb-2"></i>
                                    <p>é»æ“Šã€Œé‡æ–°æ•´ç†åœ–è¡¨ã€è¼‰å…¥å›è½åœ–</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æœˆæç›Šç†±åŠ›åœ– -->
                        <div class="tab-pane fade" id="heatmap-chart" role="tabpanel">
                            <h6 class="mb-3">æœˆç´¯ç©å¹³å‡æç›Š (è¬å…ƒ)</h6>
                            <div id="heatmap-chart-container" class="chart-container">
                                <div class="text-center text-muted">
                                    <i class="fas fa-th fa-2x mb-2"></i>
                                    <p>é»æ“Šã€Œé‡æ–°æ•´ç†åœ–è¡¨ã€è¼‰å…¥ç†±åŠ›åœ–</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æœˆæ”¶ç›Šç‡ç†±åŠ›åœ– -->
                        <div class="tab-pane fade" id="return-heatmap-chart" role="tabpanel">
                            <h6 class="mb-3">æœˆå¹³å‡æ”¶ç›Šç‡ (bp)</h6>
                            <div id="return-heatmap-chart-container" class="chart-container">
                                <div class="text-center text-muted">
                                    <i class="fas fa-percentage fa-2x mb-2"></i>
                                    <p>é»æ“Šã€Œé‡æ–°æ•´ç†åœ–è¡¨ã€è¼‰å…¥æ”¶ç›Šç‡åœ–</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å¹´åº¦æç›Š -->
                        <div class="tab-pane fade" id="yearly-chart" role="tabpanel">
                            <h6 class="mb-3">å¹´åº¦ç¸½æç›Š (è¬å…ƒ)</h6>
                            <div id="yearly-chart-container" class="chart-container">
                                <div class="text-center text-muted">
                                    <i class="fas fa-calendar-alt fa-2x mb-2"></i>
                                    <p>é»æ“Šã€Œé‡æ–°æ•´ç†åœ–è¡¨ã€è¼‰å…¥å¹´åº¦åœ–</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æœˆäº¤æ˜“å¤©æ•¸ -->
                        <div class="tab-pane fade" id="trading-days-chart" role="tabpanel">
                            <h6 class="mb-3">æœˆäº¤æ˜“ç­†æ•¸(å¤©)</h6>
                            <div id="trading-days-chart-container" class="chart-container">
                                <div class="text-center text-muted">
                                    <i class="fas fa-calendar-day fa-2x mb-2"></i>
                                    <p>é»æ“Šã€Œé‡æ–°æ•´ç†åœ–è¡¨ã€è¼‰å…¥äº¤æ˜“å¤©æ•¸åœ–</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æœˆäº¤æ˜“è‚¡ç¥¨æ•¸ -->
                        <div class="tab-pane fade" id="trading-stocks-chart" role="tabpanel">
                            <h6 class="mb-3">æœˆäº¤æ˜“ç­†æ•¸(éš»)</h6>
                            <div id="trading-stocks-chart-container" class="chart-container">
                                <div class="text-center text-muted">
                                    <i class="fas fa-chart-bar fa-2x mb-2"></i>
                                    <p>é»æ“Šã€Œé‡æ–°æ•´ç†åœ–è¡¨ã€è¼‰å…¥äº¤æ˜“è‚¡ç¥¨æ•¸åœ–</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æœˆå‹ç‡ -->
                        <div class="tab-pane fade" id="win-rate-chart" role="tabpanel">
                            <h6 class="mb-3">æœˆåº¦å‹ç‡ (%)</h6>
                            <div id="win-rate-chart-container" class="chart-container">
                                <div class="text-center text-muted">
                                    <i class="fas fa-trophy fa-2x mb-2"></i>
                                    <p>é»æ“Šã€Œé‡æ–°æ•´ç†åœ–è¡¨ã€è¼‰å…¥å‹ç‡åœ–</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ˜ŸæœŸåˆ†æ -->
                        <div class="tab-pane fade" id="weekday-chart" role="tabpanel">
                            <h6 class="mb-3">æŒ‰æ˜ŸæœŸåˆ†æäº¤æ˜“ (å·¥ä½œæ—¥)</h6>
                            <div id="weekday-chart-container" class="chart-container">
                                <div class="text-center text-muted">
                                    <i class="fas fa-calendar-week fa-2x mb-2"></i>
                                    <p>é»æ“Šã€Œé‡æ–°æ•´ç†åœ–è¡¨ã€è¼‰å…¥æ˜ŸæœŸåˆ†æåœ–</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ä¸Šä¸‹æ’åˆ—æ¨¡å¼çš„æ‰€æœ‰åœ–è¡¨å®¹å™¨ -->
                    <div id="vertical-charts-container">
                        <div class="chart-container" id="all-vertical-charts">
                            <div class="d-flex justify-content-end align-items-center mb-3" id="vertical-charts-toolbar">
                                <button type="button" class="btn btn-sm btn-outline-info me-2" id="btn-vertical-vertical">ä¸Šä¸‹æ’åˆ—</button>
                                <button type="button" class="btn btn-sm btn-outline-info" id="btn-horizontal-vertical">å·¦å³æ’åˆ—</button>
                                <button type="button" class="btn btn-sm btn-outline-info ms-2" onclick="toggleDrawdownView()">
                                    <i class="fas fa-exchange-alt me-1"></i>åˆ‡æ›è¦–åœ–
                                </button>
                            </div>
                            <div id="vertical-drawdown-chart" class="vertical-chart-block"></div>
                            <div id="vertical-heatmap-chart" class="vertical-chart-block"></div>
                            <div id="vertical-return-heatmap-chart" class="vertical-chart-block"></div>
                            <div id="vertical-yearly-chart" class="vertical-chart-block"></div>
                            <div id="vertical-trading-days-chart" class="vertical-chart-block"></div>
                            <div id="vertical-trading-stocks-chart" class="vertical-chart-block"></div>
                            <div id="vertical-win-rate-chart" class="vertical-chart-block"></div>
                            <div id="vertical-weekday-chart" class="vertical-chart-block"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- æŒæœ‰éƒ¨ä½è¡¨æ ¼ -->
    <div class="row" id="holding-positions-section" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-hand-holding-usd me-2"></i>
                        æŒæœ‰æœªå‡ºå ´éƒ¨ä½
                    </h5>
                    <!-- æš«æ™‚éš±è—æŒæœ‰éƒ¨ä½åŒ¯å‡ºæŒ‰éˆ• -->
                    <!-- <div>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="export-holdings-btn">
                            <i class="fas fa-download me-1"></i>
                            åŒ¯å‡ºæŒæœ‰éƒ¨ä½
                        </button>
                    </div> -->
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="holding-positions-table">
                            <thead>
                                <tr>
                                    <th>é€²å ´æ—¥æœŸ</th>
                                    <th>å‡ºå ´æ—¥æœŸ</th>
                                    <th>è‚¡ç¥¨ä»£ç¢¼</th>
                                    <th>è‚¡ç¥¨åç¨±</th>
                                    <th>æ–¹å‘</th>
                                    <th>é€²å ´åƒ¹</th>
                                    <th>ç•¶å‰åƒ¹</th>
                                    <th>ç•¶æ—¥æœªå‡ºå ´åƒ¹</th>
                                    <th>è‚¡æ•¸</th>
                                    <th>æœªå¯¦ç¾æç›Š</th>
                                    <th>æœªå¯¦ç¾æç›Šç‡</th>
                                    <th>ç•¶æ—¥æœªå‡ºå ´æç›Š</th>
                                    <th>ç•¶æ—¥æœªå‡ºå ´æç›Šç‡</th>
                                    <th>æŒæœ‰å¤©æ•¸</th>
                                    <th>å‡ºå ´ç‹€æ…‹</th>
                                    <th>åœåˆ©åƒ¹</th>
                                    <th>åœæåƒ¹</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- æŒæœ‰éƒ¨ä½å°‡ç”±JavaScriptå‹•æ…‹è¼‰å…¥ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    let currentStrategy = '';
    let currentStrategyParameters = {};
    
    // å…¨åŸŸè®Šæ•¸å„²å­˜æ¬„ä½å®šç¾©
    let tradeRecordFields = [];
    let holdingPositionFields = [];
    
    // åˆå§‹åŒ–æ™‚è¼‰å…¥è‡ªå®šç¾©ç­–ç•¥
    loadCustomStrategies();
    
    // è¼‰å…¥è³‡æ–™çµæ§‹å®šç¾©
    loadDataStructure();
    
    // ç­–ç•¥é¸æ“‡è®Šæ›´äº‹ä»¶
    $('#strategy_name').change(function() {
        const selectedStrategy = $(this).val();
        if (selectedStrategy) {
            loadStrategyConfiguration(selectedStrategy);
        } else {
            resetStrategyConfiguration();
        }
    });
    
    // ç›£è½ç­–ç•¥æ›´æ–°äº‹ä»¶
    window.addEventListener('strategyUpdated', function(event) {
        console.log('æ”¶åˆ°ç­–ç•¥æ›´æ–°äº‹ä»¶:', event.detail);
        // é‡æ–°è¼‰å…¥è‡ªå®šç¾©ç­–ç•¥
        loadCustomStrategies();
    });
    
    // è‚¡ç¥¨ä¾†æºè®Šæ›´äº‹ä»¶
    $('#stock_source').change(function() {
        updateParameterDisplay();
    });
    
    // è‚¡åƒ¹è³‡æ–™ä¾†æºè®Šæ›´äº‹ä»¶
    $('#price_source').change(function() {
        updateExcelHelp();
        updatePriceSourceDisplay();
    });
    
    // æ ¼å¼èªªæ˜æŒ‰éˆ•é»æ“Šäº‹ä»¶
    $('#format-help-btn').click(function() {
        showFormatHelp();
    });
    
    // ä¸‹è¼‰è©³ç´°è¨˜éŒ„æŒ‰éˆ•é»æ“Šäº‹ä»¶
    $('#download-detailed-btn').click(function() {
        downloadDetailedRecords();
    });
    
    // åŒ¯å‡ºæŒæœ‰éƒ¨ä½æŒ‰éˆ•é»æ“Šäº‹ä»¶
    $('#export-holdings-btn').click(function() {
        exportHoldingPositionsToCSV();
    });
    
    // æª¢æŸ¥URLåƒæ•¸æ˜¯å¦æœ‰é è¨­ç­–ç•¥
    const urlParams = new URLSearchParams(window.location.search);
    const defaultStrategy = urlParams.get('strategy');
    if (defaultStrategy) {
        $('#strategy_name').val(defaultStrategy).trigger('change');
    }
    
    // è¼‰å…¥è‡ªå®šç¾©ç­–ç•¥
    function loadCustomStrategies() {
        console.log('é–‹å§‹è¼‰å…¥è‡ªå®šç¾©ç­–ç•¥...');
        $.get('/api/strategies/custom')
            .done(function(response) {
                console.log('è‡ªå®šç¾©ç­–ç•¥APIå›æ‡‰:', response);
                if (response.status === 'success' && response.strategies) {
                    const group = $('#strategy_name');
                    group.find('option:not(:first)').remove();
                    
                    if (response.strategies.length === 0) {
                        group.append('<option disabled>æš«ç„¡è‡ªå®šç¾©ç­–ç•¥</option>');
                    } else {
                        // åˆ†é›¢å·²ç¢ºèªå’Œæœªç¢ºèªçš„ç­–ç•¥
                        const confirmedStrategies = [];
                        const unconfirmedStrategies = [];
                        
                        response.strategies.forEach(strategy => {
                            if (strategy.is_confirmed) {
                                confirmedStrategies.push(strategy);
                            } else {
                                unconfirmedStrategies.push(strategy);
                            }
                        });
                        
                        // å…ˆæ·»åŠ å·²ç¢ºèªçš„ç­–ç•¥ï¼ˆé¡¯ç¤ºåœ¨ä¸Šæ–¹ï¼‰
                        if (confirmedStrategies.length > 0) {
                            // æ·»åŠ å·²ç¢ºèªç­–ç•¥çš„åˆ†éš”æ¨™é¡Œ
                            group.append('<option disabled class="strategy-divider">--- å·²ç¢ºèªç­–ç•¥ ---</option>');
                            
                            confirmedStrategies.forEach(strategy => {
                                const option = $(`<option value="custom_${strategy.id}">âœ… ${strategy.name}</option>`);
                                option.attr('data-strategy-id', strategy.id);
                                option.attr('data-strategy-name', strategy.name);
                                option.attr('data-strategy-description', strategy.description);
                                option.attr('data-is-confirmed', 'true');
                                group.append(option);
                            });
                        }
                        
                        // å†æ·»åŠ æœªç¢ºèªçš„ç­–ç•¥
                        if (unconfirmedStrategies.length > 0) {
                            // æ·»åŠ æœªç¢ºèªç­–ç•¥çš„åˆ†éš”æ¨™é¡Œ
                            group.append('<option disabled class="strategy-divider">--- ç·¨è¼¯ä¸­ç­–ç•¥ ---</option>');
                            
                            unconfirmedStrategies.forEach(strategy => {
                                const option = $(`<option value="custom_${strategy.id}">ğŸ“ ${strategy.name}</option>`);
                                option.attr('data-strategy-id', strategy.id);
                                option.attr('data-strategy-name', strategy.name);
                                option.attr('data-strategy-description', strategy.description);
                                option.attr('data-is-confirmed', 'false');
                                group.append(option);
                            });
                        }
                        
                        console.log(`è¼‰å…¥ ${confirmedStrategies.length} å€‹å·²ç¢ºèªç­–ç•¥ï¼Œ${unconfirmedStrategies.length} å€‹ç·¨è¼¯ä¸­ç­–ç•¥`);
                    }
                    // === æ–°å¢ï¼šæ¸²æŸ“å®Œ option å¾Œå†æ ¹æ“š URL åƒæ•¸è‡ªå‹•é¸æ“‡ ===
                    const urlParams = new URLSearchParams(window.location.search);
                    const defaultStrategy = urlParams.get('strategy');
                    if (defaultStrategy) {
                        group.val(defaultStrategy).trigger('change');
                    }
                } else {
                    console.error('è‡ªå®šç¾©ç­–ç•¥APIå›æ‡‰æ ¼å¼éŒ¯èª¤:', response);
                }
            })
            .fail(function(xhr) {
                console.error('è¼‰å…¥è‡ªå®šç¾©ç­–ç•¥å¤±æ•—:', xhr.responseText);
                const group = $('#strategy_name');
                group.empty();
                group.append('<option disabled>è¼‰å…¥å¤±æ•—</option>');
            });
    }
    
    // è¼‰å…¥å¿«å–æª”æ¡ˆåˆ—è¡¨
    function loadCacheFiles() {
        console.log('é–‹å§‹è¼‰å…¥å¿«å–æª”æ¡ˆ...');
        $.get('/api/cache/files')
            .done(function(response) {
                console.log('å¿«å–æª”æ¡ˆAPIå›æ‡‰:', response);
                if (response.status === 'success' && response.data.files.length > 0) {
                    const select = $('#cache_file_select');
                    select.empty();
                    select.append('<option value="">è«‹é¸æ“‡å¿«å–æª”æ¡ˆ...</option>');
                    
                    response.data.files.forEach(cacheFile => {
                        const option = $(`<option value="${cacheFile.filename}">${cacheFile.friendly_display_name} (${cacheFile.size_mb}MB)</option>`);
                        select.append(option);
                    });
                    console.log(`è¼‰å…¥ ${response.data.files.length} å€‹å¿«å–æª”æ¡ˆ`);
                } else {
                    const select = $('#cache_file_select');
                    select.empty();
                    select.append('<option value="">è«‹é¸æ“‡å¿«å–æª”æ¡ˆ...</option>');
                    select.append('<option value="" disabled>--- ç„¡å¿«å–æª”æ¡ˆ ---</option>');
                    console.log('æ²’æœ‰å¿«å–æª”æ¡ˆ');
                }
            })
            .fail(function(xhr) {
                console.error('è¼‰å…¥å¿«å–æª”æ¡ˆå¤±æ•—:', xhr.responseText);
                const select = $('#cache_file_select');
                select.empty();
                select.append('<option value="">è«‹é¸æ“‡å¿«å–æª”æ¡ˆ...</option>');
                select.append('<option value="" disabled>è¼‰å…¥å¤±æ•—</option>');
            });
    }
    
    // æ›´æ–°è‚¡åƒ¹è³‡æ–™ä¾†æºé¡¯ç¤º
    function updatePriceSourceDisplay() {
        const priceSource = $('#price_source').val();
        
        // éš±è—æ‰€æœ‰ç›¸é—œå€å¡Š
        $('#cache-source-section').hide();
        $('#price-excel-section').hide();
        
        if (priceSource === 'cache') {
            $('#cache-source-section').show();
            // è¼‰å…¥å¿«å–æª”æ¡ˆåˆ—è¡¨
            loadCacheFiles();
        } else if (priceSource === 'excel') {
            $('#price-excel-section').show();
        }
    }
    
    // å¾å¾Œç«¯è¼‰å…¥ç­–ç•¥é…ç½®
    function loadStrategyConfiguration(strategyType) {
        console.log('è¼‰å…¥ç­–ç•¥é…ç½®:', strategyType);
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºè‡ªå®šç¾©ç­–ç•¥
        if (strategyType.startsWith('custom_')) {
            const strategyId = strategyType.replace('custom_', '');
            const option = $(`#strategy_name option[value="${strategyType}"]`);
            const strategyName = option.attr('data-strategy-name');
            const strategyDescription = option.attr('data-strategy-description');
            
            console.log('è‡ªå®šç¾©ç­–ç•¥ID:', strategyId);
            console.log('è‡ªå®šç¾©ç­–ç•¥åç¨±:', strategyName);
            
            // æ›´æ–°ç­–ç•¥æè¿°
            $('#strategy-description').text(strategyDescription || 'è‡ªå®šç¾©ç­–ç•¥');
            
            // é¡¯ç¤ºåƒæ•¸ä¾†æºè¨­å®š
            $('#parameter-sources').show();
            
            // è¼‰å…¥è‡ªå®šç¾©ç­–ç•¥çš„åƒæ•¸é…ç½®
            loadCustomStrategyParameters(strategyId);
            
            return;
        }
        
        // å¦‚æœä¸æ˜¯è‡ªå®šç¾©ç­–ç•¥ï¼Œé¡¯ç¤ºéŒ¯èª¤
        showError('ä¸æ”¯æ´çš„ç­–ç•¥é¡å‹: ' + strategyType);
        resetStrategyConfiguration();
    }
    
    // è¼‰å…¥è‡ªå®šç¾©ç­–ç•¥åƒæ•¸
    function loadCustomStrategyParameters(strategyId) {
        console.log('è¼‰å…¥è‡ªå®šç¾©ç­–ç•¥åƒæ•¸:', strategyId);
        $.get(`/api/strategies/custom/${strategyId}`)
            .done(function(response) {
                console.log('è‡ªå®šç¾©ç­–ç•¥è©³æƒ…APIå›æ‡‰:', response);
                if (response.status === 'success') {
                    const strategy = response.strategy;
                    
                    // è¨­å®šç•¶å‰ç­–ç•¥
                    currentStrategy = `custom_${strategyId}`;
                    
                    // é¡¯ç¤ºåƒæ•¸ä¾†æºè¨­å®š
                    $('#parameter-sources').show();
                    
                    // æ›´æ–°åƒæ•¸ä¾†æºé¡¯ç¤ºï¼ˆè‡ªå®šç¾©ç­–ç•¥ä½¿ç”¨é è¨­è¨­å®šï¼‰
                    updateParameterSources({
                        stock_source: {
                            description: 'è«‹é¸æ“‡è‚¡ç¥¨ä»£ç¢¼ä¾†æº'
                        },
                        price_source: {
                            description: 'è«‹é¸æ“‡è‚¡åƒ¹è³‡æ–™ä¾†æº'
                        },
                        date_range: {
                            required: true
                        }
                    });
                    
                    // æ¸²æŸ“è‡ªå®šç¾©ç­–ç•¥åƒæ•¸ï¼ˆå¦‚æœæœ‰å®šç¾©çš„è©±ï¼‰
                    if (strategy.parameters && Object.keys(strategy.parameters).length > 0) {
                        renderStrategyParameters(strategy.parameters);
                    } else {
                        $('#strategy-config').html('<div class="text-center text-muted"><small>æ­¤è‡ªå®šç¾©ç­–ç•¥ç„¡éœ€é¡å¤–åƒæ•¸</small></div>');
                    }
                } else {
                    showError('è¼‰å…¥è‡ªå®šç¾©ç­–ç•¥é…ç½®å¤±æ•—: ' + (response.message || 'æœªçŸ¥éŒ¯èª¤'));
                }
            })
            .fail(function(xhr) {
                console.error('è¼‰å…¥è‡ªå®šç¾©ç­–ç•¥é…ç½®å¤±æ•—:', xhr.responseText);
                showError('è¼‰å…¥è‡ªå®šç¾©ç­–ç•¥é…ç½®å¤±æ•—: ' + xhr.responseText);
            });
    }
    
    // é‡ç½®ç­–ç•¥é…ç½®
    function resetStrategyConfiguration() {
        currentStrategy = '';
        currentStrategyParameters = {};
        $('#strategy-description').text('');
        $('#parameter-sources').hide();
        $('#bookbuilding-section').hide();
        $('#strategy-config').html('<div class="text-center text-muted"><small>è«‹å…ˆé¸æ“‡ç­–ç•¥</small></div>');
    }
    
    // æ›´æ–°åƒæ•¸ä¾†æºé¡¯ç¤º
    function updateParameterSources(parameterSources) {
        // æ›´æ–°è‚¡ç¥¨ä¾†æºèªªæ˜
        if (parameterSources.stock_source) {
            $('#stock_source_help').text(parameterSources.stock_source.description);
        }
        
        // æ›´æ–°è‚¡åƒ¹è³‡æ–™ä¾†æºèªªæ˜
        if (parameterSources.price_source) {
            $('#price_source_help').text(parameterSources.price_source.description);
        }
        
        // æ›´æ–°æ—¥æœŸç¯„åœé¡¯ç¤º
        if (parameterSources.date_range && parameterSources.date_range.required) {
            $('#date-range-section').show();
        } else {
            $('#date-range-section').hide();
        }
    }
    
    // æ¸²æŸ“ç­–ç•¥åƒæ•¸
    function renderStrategyParameters(parameters) {
        console.log('é–‹å§‹æ¸²æŸ“ç­–ç•¥åƒæ•¸:', parameters);
        const container = $('#strategy-config');
        container.empty();
        const grid = $('<div class="strategy-params-grid"></div>');
        Object.keys(parameters).forEach(key => {
            const param = parameters[key];
            const formGroup = $('<div class="param-item"></div>');
            
            const label = $(`<label for="param-${key}" class="form-label">${param.label}</label>`);
            let input;
            
            if (param.type === 'number') {
                input = $(`<input type="number" class="form-control" id="param-${key}" name="param-${key}" 
                              value="${param.default || ''}" 
                              min="${param.min || ''}" 
                              max="${param.max || ''}" 
                              step="${param.step || '1'}">`);
                console.log(`æ•¸å­—è¼¸å…¥ ${key}: é è¨­å€¼=${param.default}`);
            } else if (param.type === 'select') {
                input = $(`<select class="form-select" id="param-${key}" name="param-${key}"></select>`);
                // æ·»åŠ é è¨­çš„ã€Œè«‹é¸æ“‡ã€é¸é …
                input.append('<option value="">è«‹é¸æ“‡...</option>');
                
                // æª¢æŸ¥æ˜¯å¦æœ‰é¸é …è¨­å®š
                if (param.options && param.options.length > 0) {
                    param.options.forEach(option => {
                        const optionElement = $(`<option value="${option.value}">${option.label}</option>`);
                        if (option.value === param.default) {
                            optionElement.attr('selected', true);
                            console.log(`é¸é … ${key}: é è¨­é¸ä¸­=${option.value}`);
                        }
                        input.append(optionElement);
                    });
                } else {
                    // å¦‚æœæ²’æœ‰é¸é …ï¼Œæä¾›é è¨­é¸é …
                    const defaultOptions = [
                        { value: "option1", label: "é¸é …1" },
                        { value: "option2", label: "é¸é …2" }
                    ];
                    defaultOptions.forEach(option => {
                        const optionElement = $(`<option value="${option.value}">${option.label}</option>`);
                        // å¦‚æœæ²’æœ‰é è¨­å€¼ï¼Œé¸ä¸­ç¬¬ä¸€å€‹é¸é …
                        if (option.value === (param.default || defaultOptions[0].value)) {
                            optionElement.attr('selected', true);
                        }
                        input.append(optionElement);
                    });
                }
                console.log(`å»ºç«‹ä¸‹æ‹‰å¼é¸å–® ${key}: é¡å‹=${param.type}, é è¨­å€¼=${param.default}`);
            } else if (param.type === 'boolean') {
                // ä½¿ç”¨è‡ªå®šç¾©æ©«ç§»é–‹é—œæ¨£å¼
                const toggleId = `param-${key}`;
                input = $(`<div class="d-flex align-items-center">
                              <div class="custom-toggle-switch ${param.default ? 'active' : ''}" onclick="toggleCustomSwitch('${toggleId}')">
                                  <input type="checkbox" id="${toggleId}" name="param-${key}" ${param.default ? 'checked' : ''}>
                                  <div class="toggle-slider"></div>
                              </div>
                              <label class="ms-2 mb-0">${param.label}</label>
                           </div>`);
                console.log(`å¸ƒæ—è¼¸å…¥ ${key}: é è¨­å€¼=${param.default}`);
            } else if (param.type === 'date') {
                input = $(`<input type="date" class="form-control" id="param-${key}" name="param-${key}" value="${param.default || ''}">`);
                console.log(`æ—¥æœŸè¼¸å…¥ ${key}: é è¨­å€¼=${param.default}`);
            } else {
                input = $(`<input type="text" class="form-control" id="param-${key}" name="param-${key}" value="${param.default || ''}">`);
                console.log(`æ–‡å­—è¼¸å…¥ ${key}: é è¨­å€¼=${param.default}`);
            }
            
            formGroup.append(label).append(input);
            
            if (param.description) {
                const helpText = $(`<div class="form-text">${param.description}</div>`);
                formGroup.append(helpText);
            }
            
            grid.append(formGroup);
        });
        container.append(grid);
    }
    
    // æ›´æ–°åƒæ•¸é¡¯ç¤º
    function updateParameterDisplay() {
        const stockSource = $('#stock_source').val();
        
        if (stockSource === 'excel') {
            $('#excel-upload-section').show();
            $('#manual-stock-section').hide();
        } else if (stockSource === 'manual') {
            $('#excel-upload-section').hide();
            $('#manual-stock-section').show();
        }
    }
    
    // æ›´æ–°Excelå¹«åŠ©æ–‡å­—
    function updateExcelHelp() {
        const dataSource = $('#price_source').val();
        const strategyName = $('#strategy_name').val();
        
        if (!strategyName) {
            $('#excel_help').text('è«‹å…ˆé¸æ“‡ç­–ç•¥');
            return;
        }
        
        if (dataSource === 'api') {
            $('#excel_help').text('APIæ¨¡å¼ï¼šè«‹ä¸Šå‚³åŒ…å«è­‰åˆ¸ä»£ç¢¼å’Œæ—¥æœŸçš„Excelæª”æ¡ˆï¼Œè‚¡åƒ¹è³‡æ–™å°‡å¾APIå–å¾—');
        } else if (dataSource === 'cache') {
            $('#excel_help').text('å¿«å–æ¨¡å¼ï¼šè«‹ä¸Šå‚³åŒ…å«è­‰åˆ¸ä»£ç¢¼å’Œæ—¥æœŸçš„Excelæª”æ¡ˆï¼Œè‚¡åƒ¹è³‡æ–™å°‡å¾APIå–å¾—');
        } else {
            $('#excel_help').text('Excelæ¨¡å¼ï¼šè«‹ä¸Šå‚³åŒ…å«è­‰åˆ¸ä»£ç¢¼å’Œæ—¥æœŸçš„Excelæª”æ¡ˆï¼Œè‚¡åƒ¹è³‡æ–™å°‡å¾APIå–å¾—');
        }
    }
    
    // é¡¯ç¤ºæ ¼å¼èªªæ˜
    function showFormatHelp() {
        const dataSource = $('#price_source').val();
        const strategyName = $('#strategy_name').val();
        
        if (!strategyName) {
            alert('è«‹å…ˆé¸æ“‡ç­–ç•¥');
            return;
        }
        
        let helpText = '';
        let requiredColumns = [];
        let exampleData = [];
        
        // if (dataSource === 'api') {
        helpText = '<h6>APIæ¨¡å¼æª”æ¡ˆæ ¼å¼ï¼š</h6>';
        requiredColumns = ['stock_id', 'date'];
        exampleData = [
            ['2330', '2024-01-01'],
            ['2330', '2024-01-02']
        ];
        // } else {
        //     helpText = '<h6>Excelæ¨¡å¼æª”æ¡ˆæ ¼å¼ï¼š.xlsx, .csv</h6>';
        //     requiredColumns = ['stock_id', 'date', 'open', 'high', 'low', 'close'];
        //     exampleData = [
        //         ['2330', '2024-01-01', '100', '105', '98', '103'],
        //         ['2330', '2024-01-02', '103', '108', '102', '106']
        //     ];
        // }
        
        helpText += `
            <p>Excelæª”æ¡ˆéœ€åŒ…å«ä»¥ä¸‹æ¬„ä½ï¼š</p>
            <ul>
                ${requiredColumns.map(col => `<li><strong>${col}</strong>ï¼š${getColumnDescription(col)}ï¼ˆå¿…å¡«ï¼‰</li>`).join('')}
            </ul>
            <p>ç¯„ä¾‹ï¼š</p>
            <table class="table table-sm">
                <thead><tr>${requiredColumns.map(col => `<th>${col}</th>`).join('')}</tr></thead>
                <tbody>
                    ${exampleData.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('')}
                </tbody>
            </table>
        `;
        
        // ä½¿ç”¨Bootstrap modalé¡¯ç¤ºèªªæ˜
        const modalHtml = `
            <div class="modal fade" id="formatHelpModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">æª”æ¡ˆæ ¼å¼èªªæ˜</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            ${helpText}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // ç§»é™¤èˆŠçš„modalä¸¦æ·»åŠ æ–°çš„
        $('#formatHelpModal').remove();
        $('body').append(modalHtml);
        
        // é¡¯ç¤ºmodal
        new bootstrap.Modal(document.getElementById('formatHelpModal')).show();
    }
    
    // å–å¾—æ¬„ä½æè¿°
    function getColumnDescription(column) {
        const descriptions = {
            'stock_id': 'è‚¡ç¥¨ä»£ç¢¼',
            'date': 'æ—¥æœŸï¼ˆæ ¼å¼ï¼šYYYY-MM-DDï¼‰',
            'open': 'é–‹ç›¤åƒ¹',
            'high': 'æœ€é«˜åƒ¹',
            'low': 'æœ€ä½åƒ¹',
            'close': 'æ”¶ç›¤åƒ¹'
        };
        return descriptions[column] || column;
    }
    
    // åŸ·è¡Œå›æ¸¬
    $('#backtest-form').submit(function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const strategyName = formData.get('strategy_name');
        const stockSource = formData.get('stock_source');
        const priceSource = formData.get('price_source');
        
        // é©—è­‰å¿…å¡«æ¬„ä½
        if (!strategyName) {
            alert('è«‹é¸æ“‡ç­–ç•¥');
            return;
        }
        
        // é©—è­‰è‚¡ç¥¨ä¾†æº
        if (stockSource === 'excel') {
            const excelFile = $('#excel_file')[0].files[0];
            if (!excelFile) {
                alert('è«‹é¸æ“‡Excelæª”æ¡ˆ');
                return;
            }
        } else if (stockSource === 'manual') {
            const manualStockIds = formData.get('manual_stock_ids');
            if (!manualStockIds || !manualStockIds.trim()) {
                alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼');
                return;
            }
        }
        
        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        $('#run-backtest-btn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>åŸ·è¡Œä¸­...');
        $('#backtest-results').html('<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">åŸ·è¡Œå›æ¸¬ä¸­...</p></div>');
        
        // æº–å‚™ä¸Šå‚³è³‡æ–™
        const uploadFormData = new FormData();
        
        // åŸºæœ¬åƒæ•¸
        uploadFormData.append('strategy_id', strategyName);
        uploadFormData.append('stock_source', stockSource);
        uploadFormData.append('price_source', priceSource);
        uploadFormData.append('initial_capital', formData.get('initial_capital'));
        
        // æ”¶é›†ç­–ç•¥åƒæ•¸ï¼ˆæ‰€æœ‰ä»¥ param- é–‹é ­çš„æ¬„ä½ï¼‰
        $('#strategy-config input, #strategy-config select').each(function() {
            const name = $(this).attr('name');
            if (name && name.startsWith('param-')) {
                let value;
                if ($(this).attr('type') === 'checkbox') {
                    value = $(this).is(':checked') ? '1' : '0';
                } else {
                    value = $(this).val();
                }
                console.log(`DEBUG: æ”¶é›†åƒæ•¸ ${name} = ${value}`);
                uploadFormData.append(name, value);
            }
        });
        
        // ç‰¹åˆ¥è™•ç†è‡ªå®šç¾©é–‹é—œçš„å¸ƒæ—å€¼åƒæ•¸
        $('#strategy-config .custom-toggle-switch input[type="checkbox"]').each(function() {
            const name = $(this).attr('name');
            if (name) {
                const value = $(this).is(':checked') ? '1' : '0';
                console.log(`DEBUG: æ”¶é›†è‡ªå®šç¾©é–‹é—œåƒæ•¸ ${name} = ${value}`);
                uploadFormData.append(name, value);
            }
        });
        
        // è‚¡ç¥¨ä¾†æºç›¸é—œåƒæ•¸
        if (stockSource === 'excel') {
            const excelFile = $('#excel_file')[0].files[0];
            uploadFormData.append('excel_file', excelFile);
        } else if (stockSource === 'manual') {
            uploadFormData.append('manual_stock_ids', formData.get('manual_stock_ids'));
        }
        
        // è‚¡åƒ¹è³‡æ–™ä¾†æºç›¸é—œåƒæ•¸
        if (priceSource === 'cache') {
            const cacheFile = $('#cache_file_select').val();
            if (cacheFile) {
                uploadFormData.append('cache_file', cacheFile);
            }
        } else if (priceSource === 'excel') {
            const priceExcelFile = $('#price_excel_file')[0].files[0];
            if (priceExcelFile) {
                uploadFormData.append('price_excel_file', priceExcelFile);
            }
        }
        
        // æ—¥æœŸç¯„åœåƒæ•¸
        const startDate = formData.get('start_date');
        const endDate = formData.get('end_date');
        if (startDate) uploadFormData.append('start_date', startDate);
        if (endDate) uploadFormData.append('end_date', endDate);
        
        // è©¢åœˆå…¬å‘Šç­–ç•¥ç‰¹æ®Šåƒæ•¸
        if (strategyName === 'bookbuilding') {
            const startYear = formData.get('start_year');
            const endYear = formData.get('end_year');
            if (startYear) uploadFormData.append('start_year', startYear);
            if (endYear) uploadFormData.append('end_year', endYear);
        }
        
        // ç™¼é€è«‹æ±‚
        $.ajax({
            url: '/api/backtest/execute',
            method: 'POST',
            data: uploadFormData,
            processData: false,
            contentType: false,
            success: function(data) {
                displayBacktestResults(data);
            },
            error: function(xhr, status, error) {
                console.error('å›æ¸¬åŸ·è¡Œå¤±æ•—:', error);
                $('#backtest-results').html(`
                    <div class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <p>å›æ¸¬åŸ·è¡Œå¤±æ•—: ${xhr.responseJSON?.detail || error}</p>
                    </div>
                `);
            },
            complete: function() {
                $('#run-backtest-btn').prop('disabled', false).html('<i class="fas fa-play me-2"></i>åŸ·è¡Œå›æ¸¬');
            }
        });
    });
    
    // é¡¯ç¤ºå›æ¸¬çµæœ
    function displayBacktestResults(data) {
        console.log('æ”¶åˆ°å›æ¸¬çµæœ:', data);
        
        // æª¢æŸ¥è³‡æ–™æ ¼å¼
        if (!data || (data.status && data.status !== 'success')) {
            $('#backtest-results').html(`
                <div class="text-center text-danger">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <p>å›æ¸¬åŸ·è¡Œå¤±æ•—: ${data?.detail || data?.message || 'æœªçŸ¥éŒ¯èª¤'}</p>
                </div>
            `);
            return;
        }
        
        // è™•ç†ä¸åŒçš„è³‡æ–™æ ¼å¼
        let summary, trades, holding_positions;
        
        if (data.summary && data.trades) {
            // èˆŠæ ¼å¼ï¼šç›´æ¥åŒ…å« summary å’Œ trades
            summary = data.summary;
            trades = data.trades;
            holding_positions = data.holding_positions || [];
        } else if (data.results) {
            // æ–°æ ¼å¼ï¼šåŒ…å«åœ¨ results ä¸­
            const results = data.results;
            if (results.backtest_results) {
                // è‡ªå®šç¾©ç­–ç•¥æ ¼å¼
                const backtestResults = results.backtest_results;
                summary = {
                    total_trades: backtestResults.total_trades || 0,
                    winning_trades: backtestResults.winning_trades || 0,
                    win_rate: backtestResults.win_rate || 0,
                    total_profit: backtestResults.total_profit_loss || 0,
                    total_profit_rate: backtestResults.total_profit_loss_rate || 0
                };
                trades = backtestResults.trade_records || [];
                holding_positions = backtestResults.holding_positions || [];
            } else {
                // ä¸€èˆ¬å›æ¸¬æ ¼å¼
                summary = results;
                trades = results.trade_records || [];
                holding_positions = results.holding_positions || [];
            }
        } else {
            // ç›´æ¥æ ¼å¼
            summary = data;
            trades = data.trade_records || [];
            holding_positions = data.holding_positions || [];
        }
        
        console.log('è™•ç†å¾Œçš„è³‡æ–™:', { summary, trades, holding_positions });
        
        // é¡¯ç¤ºæ‘˜è¦
        const summaryHtml = `
            <div class="row mb-4">
                <div class="col-md-3 text-center">
                    <h4 class="text-primary">${summary.total_trades || 0}</h4>
                    <small class="text-muted">ç¸½äº¤æ˜“æ¬¡æ•¸</small>
                </div>
                <div class="col-md-3 text-center">
                    <h4 class="text-success">${summary.winning_trades || 0}</h4>
                    <small class="text-muted">ç²åˆ©äº¤æ˜“</small>
                </div>
                <div class="col-md-3 text-center">
                    <h4 class="text-info">${(summary.win_rate * 100 || 0).toFixed(2)}%</h4>
                    <small class="text-muted">å‹ç‡</small>
                </div>
                <div class="col-md-3 text-center">
                    <h4 class="${(summary.total_profit || 0) >= 0 ? 'text-success' : 'text-danger'}">${(summary.total_profit || 0).toLocaleString()}</h4>
                    <small class="text-muted">ç¸½æç›Š</small>
                </div>
            </div>
        `;
        
        $('#backtest-results').html(summaryHtml);
        
        // é¡¯ç¤ºäº¤æ˜“è¨˜éŒ„
        if (trades && trades.length > 0) {
            console.log('é¡¯ç¤ºäº¤æ˜“è¨˜éŒ„ï¼Œæ•¸é‡:', trades.length);
            displayTradesTable(trades);
            $('#trades-section').show();
            $('#charts-section').show(); // é¡¯ç¤ºåœ–è¡¨å€åŸŸ
            
            // å„²å­˜å›æ¸¬åƒæ•¸å’Œå®Œæ•´çš„åŸå§‹è³‡æ–™ä¾›ä¸‹è¼‰è©³ç´°è¨˜éŒ„ä½¿ç”¨
            window.lastBacktestParams = {
                strategy_name: $('#strategy_name').val(),
                price_source: $('#price_source').val(),
                config: getStrategyConfig(),
                trade_records: trades,  // å„²å­˜å®Œæ•´çš„åŸå§‹äº¤æ˜“è¨˜éŒ„
                holding_positions: holding_positions  // å„²å­˜å®Œæ•´çš„åŸå§‹æŒæœ‰éƒ¨ä½
            };
            // è‡ªå‹•è¼‰å…¥åœ–è¡¨ï¼Œé è¨­vertical
            currentDrawdownLayout = 'vertical';
            $('#btn-vertical').addClass('btn-primary').removeClass('btn-outline-info');
            $('#btn-horizontal').addClass('btn-outline-info').removeClass('btn-primary');
            refreshAllCharts();
        } else {
            console.log('æ²’æœ‰äº¤æ˜“è¨˜éŒ„');
            $('#trades-section').hide();
            $('#charts-section').hide(); // éš±è—åœ–è¡¨å€åŸŸ
        }
        
        // é¡¯ç¤ºæŒæœ‰éƒ¨ä½è³‡æ–™
        if (holding_positions && holding_positions.length > 0) {
            console.log('é¡¯ç¤ºæŒæœ‰éƒ¨ä½ï¼Œæ•¸é‡:', holding_positions.length);
            displayHoldingPositionsTable(holding_positions);
            $('#holding-positions-section').show();
        } else {
            $('#holding-positions-section').hide();
        }
    }
    
    // é¡¯ç¤ºäº¤æ˜“è¨˜éŒ„è¡¨æ ¼
    function displayTradesTable(trades) {
        console.log('é¡¯ç¤ºäº¤æ˜“è¨˜éŒ„è¡¨æ ¼ï¼Œäº¤æ˜“æ•¸é‡:', trades.length);
        
        // å°‡tradesè³‡æ–™ä¿å­˜åˆ°å…¨åŸŸè®Šæ•¸ï¼Œä¾›å±•é–‹åŠŸèƒ½ä½¿ç”¨
        window.currentTradesData = trades;
        
        trades.sort((a, b) => {
            if (a.stock_id !== b.stock_id) {
                return a.stock_id.localeCompare(b.stock_id);
            }
            return new Date(a.entry_date) - new Date(b.entry_date);
        });
        
        const tbody = $('#trades-table tbody');
        tbody.empty();
        
        trades.forEach(function(trade, index) {
            const profit = trade.profit_loss || trade.net_profit_loss || trade.profit || 0;
            const profitRate = trade.profit_loss_rate || trade.profit_rate || 0;
            const profitClass = profit >= 0 ? 'text-success' : 'text-danger';
            const profitRateClass = profitRate >= 0 ? 'text-success' : 'text-danger';
            const profitIcon = profit >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
            const exitStatus = trade.exit_reason || trade.exit_status || 'æœªçŸ¥';
            const statusClass = getStatusClass(exitStatus);
            const stockName = trade.stock_name || 'æœªçŸ¥';
            
            // æ–°å¢å±•é–‹/æ”¶åˆåŠŸèƒ½
            const row = `
                <tr data-trade-index="${index}" class="trade-row" style="cursor:pointer;" onclick="toggleTradeDetails(${index})">
                    <td>${trade.entry_date}</td>
                    <td>${trade.exit_date}</td>
                    <td>${trade.stock_id}</td>
                    <td>${stockName}</td>
                    <td>${parseFloat(trade.entry_price).toFixed(2)}</td>
                    <td>${parseFloat(trade.exit_price).toFixed(2)}</td>
                    <td>${trade.shares.toLocaleString()}</td>
                    <td class="${profitClass}"><i class="fas ${profitIcon} me-1"></i>${Math.round(profit).toLocaleString()}</td>
                    <td class="${profitRateClass}">${parseFloat(profitRate).toFixed(2)}%</td>
                    <td>${trade.holding_days || 0}å¤©</td>
                    <td><span class="badge ${statusClass}">${exitStatus}</span></td>
                </tr>
            `;
            tbody.append(row);
        });
    }
    
    // å…¨åŸŸå‡½æ•¸ï¼šåˆ‡æ›äº¤æ˜“è©³ç´°è³‡è¨Š
    window.toggleTradeDetails = function(index) {
        console.log('=== é–‹å§‹åˆ‡æ›äº¤æ˜“è©³ç´°è³‡è¨Š ===');
        console.log('ç´¢å¼•:', index);
        console.log('ç•¶å‰äº¤æ˜“è³‡æ–™:', window.currentTradesData);
        
        const tbody = $('#trades-table tbody');
        console.log('è¡¨æ ¼tbody:', tbody.length);
        
        const $row = tbody.find(`tr[data-trade-index="${index}"]`);
        console.log('æ‰¾åˆ°çš„è¡Œ:', $row.length);
        console.log('è¡Œçš„HTML:', $row.html());
        
        if ($row.length === 0) {
            console.error('æ‰¾ä¸åˆ°å°æ‡‰çš„äº¤æ˜“åˆ—');
            return;
        }
        
        // è‹¥å·²å±•é–‹å‰‡æ”¶åˆ
        if ($row.hasClass('expanded')) {
            console.log('æ”¶åˆå±•é–‹åˆ—');
            $row.removeClass('expanded');
            $row.next('.trades-table-details-row').remove();
            return;
        }
        
        // å…ˆæ”¶åˆå…¶ä»–å±•é–‹åˆ—
        tbody.find('tr.trade-row.expanded').removeClass('expanded');
        tbody.find('.trades-table-details-row').remove();
        
        // å±•é–‹ç•¶å‰åˆ—
        console.log('å±•é–‹äº¤æ˜“è¨˜éŒ„');
        $row.addClass('expanded');
        
        // é¡¯ç¤ºè©³ç´°å…§å®¹
        const trade = window.currentTradesData[index];
        if (!trade) {
            console.error('æ‰¾ä¸åˆ°äº¤æ˜“è³‡æ–™');
            return;
        }
        
        console.log('äº¤æ˜“è³‡æ–™:', trade);
        const detailHtml = `<tr class="trades-table-details-row"><td colspan="11"><div class="trades-table-details-content"><b>è©³ç´°å…§å®¹ï¼š</b><pre>${JSON.stringify(trade, null, 2)}</pre></div></td></tr>`;
        $row.after(detailHtml);
        console.log('=== åˆ‡æ›å®Œæˆ ===');
    };
    
    // æ¸¬è©¦å±•é–‹åŠŸèƒ½
    window.testExpandFunction = function() {
        // console.log('=== æ¸¬è©¦å±•é–‹åŠŸèƒ½ ===');
        // console.log('window.currentTradesData:', window.currentTradesData);
        // console.log('è¡¨æ ¼è¡Œæ•¸:', $('#trades-table tbody tr').length);
        
        if (window.currentTradesData && window.currentTradesData.length > 0) {
            console.log('å˜—è©¦å±•é–‹ç¬¬ä¸€ç­†äº¤æ˜“');
            window.toggleTradeDetails(0);
        } else {
            console.log('æ²’æœ‰äº¤æ˜“è³‡æ–™å¯æ¸¬è©¦');
            alert('è«‹å…ˆåŸ·è¡Œå›æ¸¬ç”¢ç”Ÿäº¤æ˜“è³‡æ–™');
        }
    };
    
    // åˆ‡æ›æ•´å€‹äº¤æ˜“è¨˜éŒ„è¡¨æ ¼çš„å±•é–‹/ç¸®èµ·
    window.toggleTradesTable = function() {
        const $body = $('#trades-table-body');
        const $icon = $('#trades-toggle-icon');
        
        if ($body.is(':visible')) {
            // ç¸®èµ·è¡¨æ ¼
            $body.slideUp(300);
            $icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
        } else {
            // å±•é–‹è¡¨æ ¼
            $body.slideDown(300);
            $icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
        }
    };
    
    // é¡¯ç¤ºæŒæœ‰éƒ¨ä½è¡¨æ ¼
    function displayHoldingPositionsTable(holdingPositions) {
        console.log('é¡¯ç¤ºæŒæœ‰éƒ¨ä½è¡¨æ ¼ï¼Œéƒ¨ä½æ•¸é‡:', holdingPositions.length);
        
        // å‰ç«¯æ’åºï¼šå…ˆæŒ‰è‚¡ç¥¨ä»£ç¢¼æ’åºï¼Œå†æŒ‰é€²å ´æ—¥æœŸæ’åº
        holdingPositions.sort((a, b) => {
            if (a.stock_id !== b.stock_id) {
                return a.stock_id.localeCompare(b.stock_id);
            }
            return new Date(a.entry_date) - new Date(b.entry_date);
        });
        
        const tbody = $('#holding-positions-table tbody');
        tbody.empty();
        
        holdingPositions.forEach(function(position, index) {
            const profitClass = position.unrealized_profit_loss >= 0 ? 'text-success' : 'text-danger';
            const profitIcon = position.unrealized_profit_loss >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
            const currentProfitClass = position.current_profit_loss >= 0 ? 'text-success' : 'text-danger';
            const currentProfitIcon = position.current_profit_loss >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
            const direction = position.trade_direction === 1 ? 'åšå¤š' : 'åšç©º';
            const stockName = position.stock_name || 'æœªçŸ¥';
            
            // åªé¡¯ç¤ºä¸»è¦æ¬„ä½ï¼Œä½†ä¿ç•™å®Œæ•´è³‡æ–™ä¾›ä¸‹è¼‰ä½¿ç”¨
            const row = `
                <tr data-position-index="${index}">
                    <td>${position.entry_date}</td>
                    <td>${position.current_date || position.entry_date}</td>
                    <td>${position.stock_id}</td>
                    <td>${stockName}</td>
                    <td><span class="badge ${position.trade_direction === 1 ? 'bg-success' : 'bg-danger'}">${direction}</span></td>
                    <td>${parseFloat(position.entry_price).toFixed(2)}</td>
                    <td>${parseFloat(position.current_price || position.entry_price).toFixed(2)}</td>
                    <td>${parseFloat(position.current_exit_price || position.current_price || position.entry_price).toFixed(2)}</td>
                    <td>${position.shares.toLocaleString()}</td>
                    <td class="${profitClass}">
                        <i class="fas ${profitIcon} me-1"></i>
                        ${Math.round(position.unrealized_profit_loss || 0).toLocaleString()}
                    </td>
                    <td class="${profitClass}">${parseFloat(position.unrealized_profit_loss_rate || 0).toFixed(2)}%</td>
                    <td class="${currentProfitClass}">
                        <i class="fas ${currentProfitIcon} me-1"></i>
                        ${Math.round(position.current_profit_loss || 0).toLocaleString()}
                    </td>
                    <td class="${currentProfitClass}">${parseFloat(position.current_profit_loss_rate || 0).toFixed(2)}%</td>
                    <td>${position.holding_days || 0}å¤©</td>
                    <td>${position.exit_price_type || 'close'}</td>
                    <td>${position.take_profit_price ? parseFloat(position.take_profit_price).toFixed(2) : '-'}</td>
                    <td>${position.stop_loss_price ? parseFloat(position.stop_loss_price).toFixed(2) : '-'}</td>
                </tr>
            `;
            tbody.append(row);
        });
    }
    
    // åŒ¯å‡ºæŒæœ‰éƒ¨ä½åˆ°CSV
    function exportHoldingPositionsToCSV() {
        const tbody = $('#holding-positions-table tbody');
        const rows = tbody.find('tr');
        
        if (rows.length === 0) {
            alert('æ²’æœ‰æŒæœ‰éƒ¨ä½è³‡æ–™å¯åŒ¯å‡º');
            return;
        }
        
        let csvContent = 'é€²å ´æ—¥æœŸ,æœªå‡ºå ´æ—¥æœŸ,è‚¡ç¥¨ä»£ç¢¼,è‚¡ç¥¨åç¨±,æ–¹å‘,é€²å ´åƒ¹,ç•¶å‰åƒ¹,ç•¶æ—¥æœªå‡ºå ´åƒ¹,è‚¡æ•¸,æœªå¯¦ç¾æç›Š,æœªå¯¦ç¾æç›Šç‡,ç•¶æ—¥æœªå‡ºå ´æç›Š,ç•¶æ—¥æœªå‡ºå ´æç›Šç‡,æŒæœ‰å¤©æ•¸,å‡ºå ´åƒ¹é¡å‹,åœåˆ©åƒ¹,åœæåƒ¹\\n';
        
        rows.each(function() {
            const cells = $(this).find('td');
            const rowData = [];
            
            cells.each(function(index) {
                let text = $(this).text().trim();
                // ç§»é™¤åœ–æ¨™å’Œç‰¹æ®Šå­—ç¬¦
                text = text.replace(/[â†‘â†“]/g, '').trim();
                // å¦‚æœåŒ…å«é€—è™Ÿï¼Œç”¨å¼•è™ŸåŒ…åœ
                if (text.includes(',')) {
                    text = `"${text}"`;
                }
                rowData.push(text);
            });
            
            csvContent += rowData.join(',') + '\\n';
        });
        
        // ä¸‹è¼‰CSVæª”æ¡ˆ
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'holding_positions.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    // å–å¾—ç­–ç•¥é…ç½®
    function getStrategyConfig() {
        const config = {};
        $('#strategy-config input, #strategy-config select').each(function() {
            const name = $(this).attr('name');
            const value = $(this).attr('type') === 'checkbox' ? $(this).is(':checked') : $(this).val();
            if (name) {
                config[name] = value;
            }
        });
        
        // ç‰¹åˆ¥è™•ç†è‡ªå®šç¾©é–‹é—œçš„å¸ƒæ—å€¼åƒæ•¸
        $('#strategy-config .custom-toggle-switch input[type="checkbox"]').each(function() {
            const name = $(this).attr('name');
            if (name) {
                config[name] = $(this).is(':checked');
            }
        });
        
        return config;
    }
    
    // å–å¾—è‚¡ç¥¨ä¾†æºè¨­å®š
    function getStockSourceConfig() {
        const stockSource = document.querySelector('input[name="stockSource"]:checked').value;
        
        if (stockSource === 'excel') {
            return {
                type: 'excel',
                config: {
                    required_columns: ['stock_id', 'startdate', 'enddate']
                }
            };
        } else if (stockSource === 'stock_list') {
            const stockListId = document.getElementById('stockListSelect').value;
            return {
                type: 'stock_list',
                config: {
                    stock_list_id: stockListId
                }
            };
        }
        
        return null;
    }
    
    // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
    function showError(message) {
        console.error('éŒ¯èª¤:', message);
        alert('éŒ¯èª¤: ' + message);
    }
    
    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
    function showSuccess(message) {
        console.log('æˆåŠŸ:', message);
        alert('æˆåŠŸ: ' + message);
    }
    
    // å–å¾—ç‹€æ…‹CSSé¡åˆ¥
    function getStatusClass(status) {
        const statusMap = {
            'åœåˆ©': 'bg-success',
            'åœæ': 'bg-danger',
            'å¼·åˆ¶å‡ºå ´': 'bg-warning',
            'æ‰‹å‹•å‡ºå ´': 'bg-info',
            'åˆ°æœŸå‡ºå ´': 'bg-secondary',
            'æœªçŸ¥': 'bg-secondary'
        };
        return statusMap[status] || 'bg-secondary';
    }
    
    // ä¸‹è¼‰è©³ç´°è¨˜éŒ„
    function downloadDetailedRecords() {
        if (!window.lastBacktestParams) {
            alert('è«‹å…ˆåŸ·è¡Œå›æ¸¬');
            return;
        }
        
        const params = window.lastBacktestParams;
        console.log('ä¸‹è¼‰è©³ç´°è¨˜éŒ„ï¼Œåƒæ•¸:', params);
        
        // å…ˆå–å¾—å®Œæ•´çš„äº¤æ˜“è¨˜éŒ„è³‡æ–™
        const requestData = {
            trade_records: params.trade_records || [],
            holding_positions: params.holding_positions || []
        };
        
        console.log('è«‹æ±‚å®Œæ•´äº¤æ˜“è¨˜éŒ„è³‡æ–™:', requestData);
        console.log('åŸå§‹äº¤æ˜“è¨˜éŒ„æ•¸é‡:', requestData.trade_records.length);
        console.log('åŸå§‹æŒæœ‰éƒ¨ä½æ•¸é‡:', requestData.holding_positions.length);
        if (requestData.trade_records.length > 0) {
            console.log('ç¬¬ä¸€å€‹äº¤æ˜“è¨˜éŒ„çš„æ¬„ä½:', Object.keys(requestData.trade_records[0]));
            console.log('ç¬¬ä¸€å€‹äº¤æ˜“è¨˜éŒ„çš„æ¬„ä½æ•¸é‡:', Object.keys(requestData.trade_records[0]).length);
            console.log('ç¬¬ä¸€å€‹äº¤æ˜“è¨˜éŒ„å…§å®¹:', requestData.trade_records[0]);
        }
        if (requestData.holding_positions.length > 0) {
            console.log('ç¬¬ä¸€å€‹æŒæœ‰éƒ¨ä½çš„æ¬„ä½:', Object.keys(requestData.holding_positions[0]));
            console.log('ç¬¬ä¸€å€‹æŒæœ‰éƒ¨ä½çš„æ¬„ä½æ•¸é‡:', Object.keys(requestData.holding_positions[0]).length);
            console.log('ç¬¬ä¸€å€‹æŒæœ‰éƒ¨ä½å…§å®¹:', requestData.holding_positions[0]);
        }
        
        // å…ˆå‘¼å« API å–å¾—å®Œæ•´çš„äº¤æ˜“è¨˜éŒ„è³‡æ–™
        $.ajax({
            url: '/api/backtest/complete-trade-data',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(requestData),
            success: function(response) {
                if (response.success) {
                    console.log('å–å¾—å®Œæ•´äº¤æ˜“è¨˜éŒ„è³‡æ–™æˆåŠŸ:', response);
                    
                    // æº–å‚™ä¸‹è¼‰è³‡æ–™ - ä½¿ç”¨å®Œæ•´çš„äº¤æ˜“è¨˜éŒ„è³‡æ–™
                    const downloadData = {
                        strategy_name: params.strategy_name,
                        price_source: params.price_source,
                        config: params.config,
                        complete_trade_records: response.complete_trade_records,
                        complete_holding_positions: response.complete_holding_positions
                    };
                    
                    console.log('æº–å‚™ä¸‹è¼‰çš„å®Œæ•´è³‡æ–™:', downloadData);
                    
                    // ç™¼é€ä¸‹è¼‰è«‹æ±‚
                    $.ajax({
                        url: '/api/backtest/export-detailed',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(downloadData),
                        xhrFields: {
                            responseType: 'blob'
                        },
                        success: function(blob, status, xhr) {
                            // å»ºç«‹ä¸‹è¼‰é€£çµ
                            const url = window.URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            
                            // å¾å›æ‡‰æ¨™é ­å–å¾—æª”æ¡ˆå
                            const contentDisposition = xhr.getResponseHeader('Content-Disposition');
                            let filename = 'detailed_backtest_records.xlsx';
                            if (contentDisposition) {
                                const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                                if (filenameMatch && filenameMatch[1]) {
                                    filename = filenameMatch[1].replace(/['"]/g, '');
                                }
                            }
                            
                            link.download = filename;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            window.URL.revokeObjectURL(url);
                            
                            // showSuccess('è©³ç´°è¨˜éŒ„ä¸‹è¼‰æˆåŠŸ');
                        },
                        error: function(xhr, status, error) {
                            console.error('ä¸‹è¼‰è©³ç´°è¨˜éŒ„å¤±æ•—:', error);
                            showError('ä¸‹è¼‰è©³ç´°è¨˜éŒ„å¤±æ•—: ' + (xhr.responseJSON?.detail || error));
                        }
                    });
                } else {
                    console.error('å–å¾—å®Œæ•´äº¤æ˜“è¨˜éŒ„è³‡æ–™å¤±æ•—:', response);
                    showError('å–å¾—å®Œæ•´äº¤æ˜“è¨˜éŒ„è³‡æ–™å¤±æ•—');
                }
            },
            error: function(xhr, status, error) {
                console.error('å–å¾—å®Œæ•´äº¤æ˜“è¨˜éŒ„è³‡æ–™å¤±æ•—:', error);
                showError('å–å¾—å®Œæ•´äº¤æ˜“è¨˜éŒ„è³‡æ–™å¤±æ•—: ' + (xhr.responseJSON?.detail || error));
            }
        });
    }
    
    // è¼‰å…¥è³‡æ–™çµæ§‹å®šç¾©
    async function loadDataStructure() {
        try {
            const response = await fetch('/api/backtest/data-structure');
            const data = await response.json();
            
            if (data.success) {
                tradeRecordFields = data.trade_record_fields;
                holdingPositionFields = data.holding_position_fields;
                console.log('è¼‰å…¥æ¬„ä½å®šç¾©æˆåŠŸ:', { tradeRecordFields, holdingPositionFields });
            } else {
                console.error('è¼‰å…¥æ¬„ä½å®šç¾©å¤±æ•—:', data);
            }
        } catch (error) {
            console.error('è¼‰å…¥æ¬„ä½å®šç¾©æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        }
    }
    
    // ==================== åœ–è¡¨ç›¸é—œå‡½æ•¸ ====================
    
    // å…¨åŸŸè®Šæ•¸
    let currentDrawdownView = 'separate'; // 'separate' æˆ– 'merge'
    let currentDrawdownLayout = 'vertical';
    let currentChartMode = 'vertical'; // 'horizontal'ï¼ˆåˆ†é ï¼‰æˆ–'vertical'ï¼ˆå…¨éƒ¨é¡¯ç¤ºï¼‰

    // åˆ‡æ›åœ–è¡¨å€åŸŸçš„å±•é–‹/ç¸®èµ·
    window.toggleChartsSection = function() {
        const $body = $('#charts-body');
        const $icon = $('#charts-toggle-icon');
        
        if ($body.is(':visible')) {
            // ç¸®èµ·åœ–è¡¨
            $body.slideUp(300);
            $icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
        } else {
            // å±•é–‹åœ–è¡¨
            $body.slideDown(300);
            $icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
        }
    };

    // åˆ‡æ›å›è½åœ–è¦–åœ–
    window.toggleDrawdownView = function() {
        currentDrawdownView = currentDrawdownView === 'separate' ? 'merge' : 'separate';
        if(currentChartMode === 'vertical') {
            loadAllVerticalCharts();
        } else {
            loadDrawdownChart();
        }
    };

    // åˆ‡æ›æ’åˆ—æ¨¡å¼
    $('#btn-vertical, #btn-vertical-vertical').click(function() {
        currentChartMode = 'vertical';
        $('#chartsTabContent').hide();
        $('#vertical-charts-container').show();
        $('.nav-tabs').hide(); // æ–°å¢ï¼šéš±è—æ¨™ç±¤åˆ—
        $('#btn-vertical, #btn-vertical-vertical').addClass('btn-primary').removeClass('btn-outline-info');
        $('#btn-horizontal, #btn-horizontal-vertical').addClass('btn-outline-info').removeClass('btn-primary');
        loadAllVerticalCharts();
    });
    $('#btn-horizontal, #btn-horizontal-vertical').click(function() {
        currentChartMode = 'horizontal';
        $('#vertical-charts-container').hide();
        $('#chartsTabContent').show();
        $('.nav-tabs').show(); // æ–°å¢ï¼šé¡¯ç¤ºæ¨™ç±¤åˆ—
        $('#btn-horizontal, #btn-horizontal-vertical').addClass('btn-primary').removeClass('btn-outline-info');
        $('#btn-vertical, #btn-vertical-vertical').addClass('btn-outline-info').removeClass('btn-primary');
        window.refreshAllCharts();
    });

    // é é¢è¼‰å…¥æ™‚è¨­å®šé è¨­ç‹€æ…‹
    $(document).ready(function() {
        // è¨­å®šé è¨­ç‚ºå‚ç›´æ¨¡å¼
        $('#btn-vertical-vertical').addClass('btn-primary').removeClass('btn-outline-info');
        $('#btn-horizontal-vertical').addClass('btn-outline-info').removeClass('btn-primary');
        $('.nav-tabs').hide(); // æ–°å¢ï¼šé è¨­éš±è—æ¨™ç±¤åˆ—ï¼ˆä¸Šä¸‹æ’ç‰ˆï¼‰
    });

    // è¼‰å…¥æ‰€æœ‰åœ–è¡¨ï¼ˆverticalæ¨¡å¼ï¼‰
    function loadAllVerticalCharts() {
        if (!window.lastBacktestParams || !window.lastBacktestParams.trade_records) {
            showChartError('vertical-drawdown-chart', 'æ²’æœ‰äº¤æ˜“è³‡æ–™');
            showChartError('vertical-heatmap-chart', 'æ²’æœ‰äº¤æ˜“è³‡æ–™');
            showChartError('vertical-return-heatmap-chart', 'æ²’æœ‰äº¤æ˜“è³‡æ–™');
            showChartError('vertical-yearly-chart', 'æ²’æœ‰äº¤æ˜“è³‡æ–™');
            showChartError('vertical-trading-days-chart', 'æ²’æœ‰äº¤æ˜“è³‡æ–™');
            showChartError('vertical-trading-stocks-chart', 'æ²’æœ‰äº¤æ˜“è³‡æ–™');
            showChartError('vertical-win-rate-chart', 'æ²’æœ‰äº¤æ˜“è³‡æ–™');
            showChartError('vertical-weekday-chart', 'æ²’æœ‰äº¤æ˜“è³‡æ–™');
            return;
        }
        showChartLoading('vertical-drawdown-chart');
        showChartLoading('vertical-heatmap-chart');
        showChartLoading('vertical-return-heatmap-chart');
        showChartLoading('vertical-yearly-chart');
        showChartLoading('vertical-trading-days-chart');
        showChartLoading('vertical-trading-stocks-chart');
        showChartLoading('vertical-win-rate-chart');
        showChartLoading('vertical-weekday-chart');
        // å›è½åœ–
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: currentDrawdownView === 'separate' ? 'drawdown' : 'drawdown_merge',
                trade_records: window.lastBacktestParams.trade_records,
                layout_mode: 'vertical'
            }),
            success: function(response) {
                if (response.success) {
                    $('#vertical-drawdown-chart').html(response.chart_html);
                } else {
                    showChartError('vertical-drawdown-chart', response.message || 'è¼‰å…¥å›è½åœ–å¤±æ•—');
                }
            },
            error: function(xhr, status, error) {
                showChartError('vertical-drawdown-chart', 'è¼‰å…¥å›è½åœ–å¤±æ•—: ' + (xhr.responseJSON?.detail || error));
            }
        });
        // æœˆæç›Šç†±åŠ›åœ–
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'heatmap',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#vertical-heatmap-chart').html(response.chart_html);
                } else {
                    showChartError('vertical-heatmap-chart', response.message || 'è¼‰å…¥ç†±åŠ›åœ–å¤±æ•—');
                }
            },
            error: function(xhr, status, error) {
                showChartError('vertical-heatmap-chart', 'è¼‰å…¥ç†±åŠ›åœ–å¤±æ•—: ' + (xhr.responseJSON?.detail || error));
            }
        });
        // æœˆæ”¶ç›Šç‡ç†±åŠ›åœ–
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'monthly_return_heatmap',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#vertical-return-heatmap-chart').html(response.chart_html);
                } else {
                    showChartError('vertical-return-heatmap-chart', response.message || 'è¼‰å…¥æ”¶ç›Šç‡åœ–å¤±æ•—');
                }
            },
            error: function(xhr, status, error) {
                showChartError('vertical-return-heatmap-chart', 'è¼‰å…¥æ”¶ç›Šç‡åœ–å¤±æ•—: ' + (xhr.responseJSON?.detail || error));
            }
        });
        // å¹´åº¦æç›Š
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'yearly_return_heatmap',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#vertical-yearly-chart').html(response.chart_html);
                } else {
                    showChartError('vertical-yearly-chart', response.message || 'è¼‰å…¥å¹´åº¦åœ–å¤±æ•—');
                }
            },
            error: function(xhr, status, error) {
                showChartError('vertical-yearly-chart', 'è¼‰å…¥å¹´åº¦åœ–å¤±æ•—: ' + (xhr.responseJSON?.detail || error));
            }
        });
        // æœˆäº¤æ˜“å¤©æ•¸
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'trading_days_heatmap',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#vertical-trading-days-chart').html(response.chart_html);
                } else {
                    showChartError('vertical-trading-days-chart', response.message || 'è¼‰å…¥äº¤æ˜“å¤©æ•¸åœ–å¤±æ•—');
                }
            },
            error: function(xhr, status, error) {
                showChartError('vertical-trading-days-chart', 'è¼‰å…¥äº¤æ˜“å¤©æ•¸åœ–å¤±æ•—: ' + (xhr.responseJSON?.detail || error));
            }
        });
        // æœˆäº¤æ˜“è‚¡ç¥¨æ•¸
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'trading_stocks_heatmap',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#vertical-trading-stocks-chart').html(response.chart_html);
                } else {
                    showChartError('vertical-trading-stocks-chart', response.message || 'è¼‰å…¥äº¤æ˜“è‚¡ç¥¨æ•¸åœ–å¤±æ•—');
                }
            },
            error: function(xhr, status, error) {
                showChartError('vertical-trading-stocks-chart', 'è¼‰å…¥äº¤æ˜“è‚¡ç¥¨æ•¸åœ–å¤±æ•—: ' + (xhr.responseJSON?.detail || error));
            }
        });
        // æœˆå‹ç‡
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'win_rate_heatmap',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#vertical-win-rate-chart').html(response.chart_html);
                } else {
                    showChartError('vertical-win-rate-chart', response.message || 'è¼‰å…¥å‹ç‡åœ–å¤±æ•—');
                }
            },
            error: function(xhr, status, error) {
                showChartError('vertical-win-rate-chart', 'è¼‰å…¥å‹ç‡åœ–å¤±æ•—: ' + (xhr.responseJSON?.detail || error));
            }
        });
        // æ˜ŸæœŸåˆ†æ
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'weekday_analysis_charts',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#vertical-weekday-chart').html(response.chart_html);
                } else {
                    showChartError('vertical-weekday-chart', response.message || 'è¼‰å…¥æ˜ŸæœŸåˆ†æåœ–å¤±æ•—');
                }
            },
            error: function(xhr, status, error) {
                showChartError('vertical-weekday-chart', 'è¼‰å…¥æ˜ŸæœŸåˆ†æåœ–å¤±æ•—: ' + (xhr.responseJSON?.detail || error));
            }
        });
    }

    // é‡æ–°æ•´ç†æ‰€æœ‰åœ–è¡¨
    window.refreshAllCharts = function() {
        if (!window.lastBacktestParams || !window.lastBacktestParams.trade_records) {
            alert('è«‹å…ˆåŸ·è¡Œå›æ¸¬ç”¢ç”Ÿäº¤æ˜“è³‡æ–™');
            return;
        }
        if(currentChartMode === 'vertical') {
            loadAllVerticalCharts();
            return;
        }
        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        showChartLoading('drawdown-chart-container');
        showChartLoading('heatmap-chart-container');
        showChartLoading('return-heatmap-chart-container');
        showChartLoading('yearly-chart-container');
        showChartLoading('trading-days-chart-container');
        showChartLoading('trading-stocks-chart-container');
        showChartLoading('win-rate-chart-container');
        showChartLoading('weekday-chart-container');
        // è¼‰å…¥æ‰€æœ‰åœ–è¡¨
        loadDrawdownChart();
        loadHeatmapChart();
        loadReturnHeatmapChart();
        loadYearlyChart();
        loadTradingDaysChart();
        loadTradingStocksChart();
        loadWinRateChart();
        loadWeekdayChart();
    };

    // é¡¯ç¤ºåœ–è¡¨è¼‰å…¥ä¸­ç‹€æ…‹
    function showChartLoading(containerId) {
        const container = $(`#${containerId}`);
        container.html(`
            <div class="chart-loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                </div>
                <p>è¼‰å…¥åœ–è¡¨ä¸­...</p>
            </div>
        `);
    }
    
    // é¡¯ç¤ºåœ–è¡¨éŒ¯èª¤ç‹€æ…‹
    function showChartError(containerId, message) {
        const container = $(`#${containerId}`);
        container.html(`
            <div class="chart-error">
                <i class="fas fa-exclamation-triangle"></i>
                <p>${message}</p>
            </div>
        `);
    }
    
    // è¼‰å…¥å›è½åœ–
    function loadDrawdownChart() {
        if (!window.lastBacktestParams || !window.lastBacktestParams.trade_records) {
            showChartError('drawdown-chart-container', 'æ²’æœ‰äº¤æ˜“è³‡æ–™');
            return;
        }
        
        const chartType = currentDrawdownView === 'separate' ? 'drawdown' : 'drawdown_merge';
        
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: chartType,
                trade_records: window.lastBacktestParams.trade_records,
                layout_mode: currentDrawdownLayout
            }),
            success: function(response) {
                if (response.success) {
                    $('#drawdown-chart-container').html(response.chart_html);
                } else {
                    showChartError('drawdown-chart-container', response.message || 'è¼‰å…¥å›è½åœ–å¤±æ•—');
                }
            },
            error: function(xhr, status, error) {
                console.error('è¼‰å…¥å›è½åœ–å¤±æ•—:', error);
                showChartError('drawdown-chart-container', 'è¼‰å…¥å›è½åœ–å¤±æ•—: ' + (xhr.responseJSON?.detail || error));
            }
        });
    }
    
    // è¼‰å…¥æœˆæç›Šç†±åŠ›åœ–
    function loadHeatmapChart() {
        if (!window.lastBacktestParams || !window.lastBacktestParams.trade_records) {
            showChartError('heatmap-chart-container', 'æ²’æœ‰äº¤æ˜“è³‡æ–™');
            return;
        }
        
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'heatmap',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#heatmap-chart-container').html(response.chart_html);
                } else {
                    showChartError('heatmap-chart-container', response.message || 'è¼‰å…¥ç†±åŠ›åœ–å¤±æ•—');
                }
            },
            error: function(xhr, status, error) {
                console.error('è¼‰å…¥ç†±åŠ›åœ–å¤±æ•—:', error);
                showChartError('heatmap-chart-container', 'è¼‰å…¥ç†±åŠ›åœ–å¤±æ•—: ' + (xhr.responseJSON?.detail || error));
            }
        });
    }
    
    // è¼‰å…¥æœˆæ”¶ç›Šç‡ç†±åŠ›åœ–
    function loadReturnHeatmapChart() {
        if (!window.lastBacktestParams || !window.lastBacktestParams.trade_records) {
            showChartError('return-heatmap-chart-container', 'æ²’æœ‰äº¤æ˜“è³‡æ–™');
            return;
        }
        
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'monthly_return_heatmap',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#return-heatmap-chart-container').html(response.chart_html);
                } else {
                    showChartError('return-heatmap-chart-container', response.message || 'è¼‰å…¥æ”¶ç›Šç‡åœ–å¤±æ•—');
                }
            },
            error: function(xhr, status, error) {
                console.error('è¼‰å…¥æ”¶ç›Šç‡åœ–å¤±æ•—:', error);
                showChartError('return-heatmap-chart-container', 'è¼‰å…¥æ”¶ç›Šç‡åœ–å¤±æ•—: ' + (xhr.responseJSON?.detail || error));
            }
        });
    }
    
    // è¼‰å…¥å¹´åº¦æç›Šåœ–
    function loadYearlyChart() {
        if (!window.lastBacktestParams || !window.lastBacktestParams.trade_records) {
            showChartError('yearly-chart-container', 'æ²’æœ‰äº¤æ˜“è³‡æ–™');
            return;
        }
        
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'yearly_return_heatmap',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#yearly-chart-container').html(response.chart_html);
                } else {
                    showChartError('yearly-chart-container', response.message || 'è¼‰å…¥å¹´åº¦åœ–å¤±æ•—');
                }
            },
            error: function(xhr, status, error) {
                console.error('è¼‰å…¥å¹´åº¦åœ–å¤±æ•—:', error);
                showChartError('yearly-chart-container', 'è¼‰å…¥å¹´åº¦åœ–å¤±æ•—: ' + (xhr.responseJSON?.detail || error));
            }
        });
    }
    
    // è¼‰å…¥æœˆäº¤æ˜“å¤©æ•¸åœ–
    function loadTradingDaysChart() {
        if (!window.lastBacktestParams || !window.lastBacktestParams.trade_records) {
            showChartError('trading-days-chart-container', 'æ²’æœ‰äº¤æ˜“è³‡æ–™');
            return;
        }
        
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'trading_days_heatmap',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#trading-days-chart-container').html(response.chart_html);
                } else {
                    showChartError('trading-days-chart-container', response.message || 'è¼‰å…¥äº¤æ˜“å¤©æ•¸åœ–å¤±æ•—');
                }
            },
            error: function(xhr, status, error) {
                console.error('è¼‰å…¥äº¤æ˜“å¤©æ•¸åœ–å¤±æ•—:', error);
                showChartError('trading-days-chart-container', 'è¼‰å…¥äº¤æ˜“å¤©æ•¸åœ–å¤±æ•—: ' + (xhr.responseJSON?.detail || error));
            }
        });
    }
    
    // è¼‰å…¥æœˆäº¤æ˜“è‚¡ç¥¨æ•¸åœ–
    function loadTradingStocksChart() {
        if (!window.lastBacktestParams || !window.lastBacktestParams.trade_records) {
            showChartError('trading-stocks-chart-container', 'æ²’æœ‰äº¤æ˜“è³‡æ–™');
            return;
        }
        
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'trading_stocks_heatmap',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#trading-stocks-chart-container').html(response.chart_html);
                } else {
                    showChartError('trading-stocks-chart-container', response.message || 'è¼‰å…¥äº¤æ˜“è‚¡ç¥¨æ•¸åœ–å¤±æ•—');
                }
            },
            error: function(xhr, status, error) {
                console.error('è¼‰å…¥äº¤æ˜“è‚¡ç¥¨æ•¸åœ–å¤±æ•—:', error);
                showChartError('trading-stocks-chart-container', 'è¼‰å…¥äº¤æ˜“è‚¡ç¥¨æ•¸åœ–å¤±æ•—: ' + (xhr.responseJSON?.detail || error));
            }
        });
    }
    
    // è¼‰å…¥æœˆå‹ç‡åœ–
    function loadWinRateChart() {
        if (!window.lastBacktestParams || !window.lastBacktestParams.trade_records) {
            showChartError('win-rate-chart-container', 'æ²’æœ‰äº¤æ˜“è³‡æ–™');
            return;
        }
        
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'win_rate_heatmap',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#win-rate-chart-container').html(response.chart_html);
                } else {
                    showChartError('win-rate-chart-container', response.message || 'è¼‰å…¥å‹ç‡åœ–å¤±æ•—');
                }
            },
            error: function(xhr, status, error) {
                console.error('è¼‰å…¥å‹ç‡åœ–å¤±æ•—:', error);
                showChartError('win-rate-chart-container', 'è¼‰å…¥å‹ç‡åœ–å¤±æ•—: ' + (xhr.responseJSON?.detail || error));
            }
        });
    }
    
    // è¼‰å…¥æ˜ŸæœŸåˆ†æåœ–
    function loadWeekdayChart() {
        if (!window.lastBacktestParams || !window.lastBacktestParams.trade_records) {
            showChartError('weekday-chart-container', 'æ²’æœ‰äº¤æ˜“è³‡æ–™');
            return;
        }
        
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'weekday_analysis_charts',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#weekday-chart-container').html(response.chart_html);
                } else {
                    showChartError('weekday-chart-container', response.message || 'è¼‰å…¥æ˜ŸæœŸåˆ†æåœ–å¤±æ•—');
                }
            },
            error: function(xhr, status, error) {
                console.error('è¼‰å…¥æ˜ŸæœŸåˆ†æåœ–å¤±æ•—:', error);
                showChartError('weekday-chart-container', 'è¼‰å…¥æ˜ŸæœŸåˆ†æåœ–å¤±æ•—: ' + (xhr.responseJSON?.detail || error));
            }
        });
    }
});
</script>
{% endblock %} 