{% extends "base.html" %}

{% block title %}回測分析 - 台灣股票交易系統{% endblock %}

{% block feature_nav %}
<div class="feature-nav">
    <h4><i class="fas fa-compass"></i> 功能區導航</h4>
    <!-- 回測功能區 -->
    <div class="feature-section">
        <h5><i class="fas fa-chart-bar"></i> 回測功能</h5>
        <div class="feature-links" id="feature-links-nav">
            <a href="/backtest#settings" class="feature-link">置頂🏠</a>
            <a href="/backtest#results" class="feature-link">回測結果🧪</a>
            <a href="/backtest#trades-section" class="feature-link">交易記錄💰</a>
            <a href="/backtest#charts-section" class="feature-link">圖表分析📈</a>
            <a href="/backtest#performance" class="feature-link">績效統計🎯</a>
            <a href="/backtest#export" class="feature-link">匯出報告💾</a>
        </div>
    </div>    
</div>
<script>
// 讓 feature-nav 的所有連結自動帶上 strategy 參數
(function() {
    const urlParams = new URLSearchParams(window.location.search);
    const strategy = urlParams.get('strategy');
    if (strategy) {
        document.querySelectorAll('#feature-links-nav a').forEach(function(link) {
            const url = new URL(link.href, window.location.origin);
            url.searchParams.set('strategy', strategy);
            // 保留 hash
            if (link.hash) url.hash = link.hash;
            link.href = url.pathname + url.search + url.hash;
        });
    }
})();
</script>
{% endblock %}

{% block extra_css %}
<style>
/* 策略卡片樣式 */
.strategy-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.strategy-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    border-color: #007bff;
}

.strategy-card.selected {
    border-color: #007bff;
    background-color: #f8f9fa;
    box-shadow: 0 4px 8px rgba(0,123,255,0.2);
}

/* 檔案上傳樣式 */
.file-upload {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.file-upload:hover {
    border-color: #007bff;
    background-color: #f8f9fa;
}

/* 載入中樣式 */
.loading {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.loading > div {
    background-color: white;
    padding: 2rem;
    border-radius: 8px;
    text-align: center;
}

/* 參數區塊網格排版 - 更簡潔並排 */
.backtest-params-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
    align-items: start;
}

.param-item {
    margin-bottom: 0;
}

/* 策略參數橫向並排 */
.strategy-params-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 12px 20px;
    align-items: start;
}

.strategy-params-grid .param-item {
    margin-bottom: 0.5rem;
}

.strategy-params-grid label.form-label {
    font-size: 0.9rem;
    font-weight: 500;
    margin-bottom: 0.3rem;
}

.strategy-params-grid .form-control,
.strategy-params-grid .form-select {
    font-size: 0.85rem;
    padding: 0.4rem 0.6rem;
}

.strategy-params-grid .form-text {
    font-size: 0.8rem;
    color: #888;
    margin-top: 0.2rem;
}

/* 調整整體字型大小 */
.form-label {
    font-size: 0.9rem;
    font-weight: 500;
}

.form-control,
.form-select {
    font-size: 0.85rem;
}

.form-text {
    font-size: 0.8rem;
}

.card-header h5 {
    font-size: 1.1rem;
}

.table {
    font-size: 0.85rem;
}

.table th {
    font-size: 0.8rem;
    font-weight: 600;
}

.btn {
    font-size: 0.85rem;
}

.btn-sm {
    font-size: 0.8rem;
}

/* 深色主題下表格顏色修正 */
.dark-theme .table-striped > tbody > tr:nth-of-type(odd) > td {
    color: #e9ecef !important;
}

.dark-theme .table-striped > tbody > tr:nth-of-type(even) > td {
    color: #e9ecef !important;
}

.dark-theme .table-hover > tbody > tr:hover > td {
    color: #ffffff !important;
}

/* 自定義勾選開關樣式 - 橫移綠色 */
.custom-toggle-switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 30px;
    background-color: #ccc;
    border-radius: 15px;
    transition: background-color 0.3s ease;
    cursor: pointer;
}

.custom-toggle-switch.active {
    background-color: #28a745;
}

.custom-toggle-switch .toggle-slider {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 26px;
    height: 26px;
    background-color: white;
    border-radius: 50%;
    transition: transform 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.custom-toggle-switch.active .toggle-slider {
    transform: translateX(30px);
}

.custom-toggle-switch input[type="checkbox"] {
    display: none;
}

@media (max-width: 600px) {
    .strategy-params-grid {
        grid-template-columns: 1fr;
    }
    
    .backtest-params-grid {
        grid-template-columns: 1fr;
    }
}

/* 深色主題下漲跌顏色強化 - 增加更強的權重 */
body.dark-theme .text-success {
    color: #4be37a !important;
}
body.dark-theme .text-danger {
    color: #ff6b6b !important;
}

/* 展開列樣式 */
.trades-table-details-row {
    background: rgba(0,0,0,0.04);
}
.dark-theme .trades-table-details-row {
    background: #23272b;
    color: #e9ecef;
}
.trades-table-details-content {
    font-size: 0.85rem;
    padding: 1rem 2rem;
    word-break: break-all;
}
.trades-table-details-content pre {
    background: #f8f9fa;
    color: #333;
    border-radius: 4px;
    padding: 0.5rem;
}
.dark-theme .trades-table-details-content pre {
    background: #181a1b;
    color: #e9ecef;
}

/* 展開狀態的視覺提示 */
.trade-row.expanded {
    background-color: rgba(0,123,255,0.1) !important;
}
.dark-theme .trade-row.expanded {
    background-color: rgba(0,123,255,0.2) !important;
}

/* 圖表容器樣式（移除 .chart-container 相關設定，統一由 style.css 控制） */
/* .chart-container {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    background-color: #f8f9fa;
    width: 100%;
    box-sizing: border-box;
} */

.dark-theme .chart-container {
    background-color: #2d2d2d;
    border-color: #404040;
}

/* 確保圖表內容填滿容器 */
.chart-container > div {
    width: 100%;
}

.chart-container .plotly-graph-div {
    width: 100% !important;
    min-height: 400px !important;
    height: auto !important;
}

/* 上下排列模式的圖表容器 */
#vertical-charts-container .chart-container {
    margin-bottom: 1rem;
}

/* 圖表標籤頁樣式 */
.nav-tabs .nav-link {
    font-size: 0.85rem;
    padding: 0.5rem 0.75rem;
}

.nav-tabs .nav-link.active {
    font-weight: 600;
}

/* 圖表載入中樣式 */
.chart-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #6c757d;
}

.chart-loading .spinner-border {
    width: 2rem;
    height: 2rem;
    margin-bottom: 1rem;
}

/* 圖表錯誤樣式 */
.chart-error {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #dc3545;
}

.chart-error .fas {
    font-size: 2rem;
    margin-bottom: 1rem;
}

option.strategy-divider {
    color: #aaa !important;
    font-style: italic;
    background: #222 !important;
    font-weight: bold;
    border-top: 1px solid #444;
    pointer-events: none;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 回測設定在上 -->
    <div class="row mb-4" id="settings">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cog me-2"></i>
                        回測設定
                    </h5>
                </div>
                <div class="card-body">
                    <form id="backtest-form" novalidate>
                        <div class="backtest-params-grid">
                            <!-- 交易策略 -->
                            <div class="param-item">
                                <label for="strategy_name" class="form-label">交易策略</label>
                                <select class="form-select" id="strategy_name" name="strategy_name" required>
                                    <option value="">請選擇策略</option>
                                    <span id="custom-strategies-group"></span>
                                </select>
                                <div class="form-text" id="strategy-description"></div>
                            </div>
                            <!-- 股票來源 -->
                            <div class="param-item">
                                <label class="form-label">股票代碼來源</label>
                                <select class="form-select" id="stock_source" name="stock_source">
                                    <option value="excel">Excel檔案</option>
                                    <option value="manual">手動輸入</option>
                                </select>
                                <div class="form-text" id="stock_source_help"></div>
                            </div>
                            <!-- Excel檔案上傳 -->
                            <div class="param-item" id="excel-upload-section">
                                <label class="form-label">Excel檔案</label>
                                <div class="d-flex gap-2">
                                    <input class="form-control" type="file" id="excel_file" name="excel_file" accept=".xlsx,.xls,.csv">
                                    <button type="button" class="btn btn-outline-info" id="format-help-btn" style="max-width: 40px;" title="查看檔案格式說明">
                                        <i class="fas fa-question"></i>
                                    </button>
                                </div>
                                <div class="form-text" id="excel_help"></div>
                            </div>
                            <!-- 手動輸入股票代碼 -->
                            <div class="param-item" id="manual-stock-section" style="display: none;">
                                <label class="form-label">股票代碼</label>
                                <textarea class="form-control" id="manual_stock_ids" name="manual_stock_ids" rows="3" placeholder="請輸入股票代碼，每行一個，例如：&#10;2330&#10;2317&#10;2454"></textarea>
                                <div class="form-text">請輸入股票代碼，每行一個</div>
                            </div>
                            <!-- 股價資料來源 -->
                            <div class="param-item">
                                <label class="form-label">股價資料來源</label>
                                <select class="form-select" id="price_source" name="price_source">
                                    <option value="api" selected>API (即時取得股價資料)</option>
                                    <option value="cache">快取 (使用已快取的股價資料)</option>
                                    <option value="excel">Excel (從檔案中取得股價資料)</option>
                                </select>
                                <div class="form-text" id="price_source_help"></div>
                            </div>
                            <!-- 快取資料來源設定 -->
                            <div class="param-item" id="cache-source-section" style="display: none;">
                                <label class="form-label">快取檔案選擇</label>
                                <select class="form-select" id="cache_file_select" name="cache_file_select">
                                    <option value="">請選擇快取檔案...</option>
                                </select>
                                <div class="form-text">選擇已快取的股價資料檔案</div>
                            </div>
                            <!-- 股價資料 Excel 上傳 -->
                            <div class="param-item" id="price-excel-section" style="display: none;">
                                <label class="form-label">股價資料 Excel 檔案</label>
                                <input type="file" class="form-control" id="price_excel_file" name="price_excel_file" accept=".xlsx,.xls">
                                <div class="form-text">上傳包含完整K線資料的Excel檔案（需包含：stock_id, date, open, high, low, close 欄位）</div>
                            </div>
                            <!-- 初始資金 -->
                            <div class="param-item">
                                <label class="form-label">初始資金</label>
                                <input type="number" class="form-control" id="initial_capital" name="initial_capital" value="1000000" min="10000" step="10000" required>
                                <div class="form-text">回測起始資金</div>
                            </div>
                        </div>
                        <!-- 策略配置獨立一行 -->
                        <div class="mt-4">
                            <label class="form-label">策略配置</label>
                            <div id="strategy-config"></div>
                        </div>
                        <!-- 執行按鈕 -->
                        <div class="d-grid mt-3">
                            <button type="submit" class="btn btn-primary" id="run-backtest-btn">
                                <i class="fas fa-play me-2"></i>
                                執行回測
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- 回測結果在中 -->
    <div class="row mb-4" id="results">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        回測結果
                    </h5>
                </div>
                <div class="card-body" id="performance">
                    <div id="backtest-results">
                        <div class="text-center text-muted">
                            <i class="fas fa-chart-bar fa-3x mb-3"></i>
                            <p>請設定回測參數並執行回測</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 交易記錄/圖表在下 -->
    <div class="row" id="trades-section" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        交易記錄
                        <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="toggle-trades-table" onclick="toggleTradesTable()">
                            <i class="fas fa-chevron-up" id="trades-toggle-icon"></i>
                        </button>
                    </h5>
                    <div>
                        <button type="button" class="btn btn-outline-success btn-sm" id="download-detailed-btn">
                            <i class="fas fa-download me-1"></i>
                            下載詳細記錄
                        </button>
                    </div>
                </div>
                <div class="card-body" id="trades-table-body">
                    <div class="table-responsive">
                        <!-- 測試按鈕 -->
                        <!-- <div class="mb-3">
                            <button type="button" class="btn btn-sm btn-outline-info" onclick="testExpandFunction()">
                                <i class="fas fa-test"></i> 測試展開功能
                            </button>
                        </div> -->
                        
                        <table class="table table-hover" id="trades-table">
                            <thead>
                                <tr>
                                    <th>進場日期</th>
                                    <th>出場日期</th>
                                    <th>股票代碼</th>
                                    <th>股票名稱</th>
                                    <th>進場價格</th>
                                    <th>出場價格</th>
                                    <th>股數</th>
                                    <th>報酬</th>
                                    <th>報酬率</th>
                                    <th>持有天數</th>
                                    <th>出場狀態</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 交易記錄將由JavaScript動態載入 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 圖表分析區域 -->
    <div class="row" id="charts-section" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-area me-2"></i>
                        圖表分析
                        <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="toggle-charts" onclick="toggleChartsSection()">
                            <i class="fas fa-chevron-up" id="charts-toggle-icon"></i>
                        </button>
                    </h5>
                    <div>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="refreshAllCharts()">
                            <i class="fas fa-sync me-1"></i>
                            重新整理圖表
                        </button>
                    </div>
                </div>
                <div class="card-body" id="charts-body">
                    <!-- 圖表標籤頁 -->
                    <ul class="nav nav-tabs" id="chartsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="drawdown-tab" data-bs-toggle="tab" data-bs-target="#drawdown-chart" type="button" role="tab">
                                <i class="fas fa-chart-line me-1"></i>回落圖
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="heatmap-tab" data-bs-toggle="tab" data-bs-target="#heatmap-chart" type="button" role="tab">
                                <i class="fas fa-th me-1"></i>月損益熱力圖
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="return-heatmap-tab" data-bs-toggle="tab" data-bs-target="#return-heatmap-chart" type="button" role="tab">
                                <i class="fas fa-percentage me-1"></i>月收益率熱力圖
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="yearly-tab" data-bs-toggle="tab" data-bs-target="#yearly-chart" type="button" role="tab">
                                <i class="fas fa-calendar-alt me-1"></i>年度損益
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="trading-days-tab" data-bs-toggle="tab" data-bs-target="#trading-days-chart" type="button" role="tab">
                                <i class="fas fa-calendar-day me-1"></i>月交易天數
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="trading-stocks-tab" data-bs-toggle="tab" data-bs-target="#trading-stocks-chart" type="button" role="tab">
                                <i class="fas fa-chart-bar me-1"></i>月交易股票數
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="win-rate-tab" data-bs-toggle="tab" data-bs-target="#win-rate-chart" type="button" role="tab">
                                <i class="fas fa-trophy me-1"></i>月勝率
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="weekday-tab" data-bs-toggle="tab" data-bs-target="#weekday-chart" type="button" role="tab">
                                <i class="fas fa-calendar-week me-1"></i>星期分析
                            </button>
                        </li>
                    </ul>
                    
                    <!-- 圖表內容 -->
                    <div class="tab-content mt-3" id="chartsTabContent" style="display: none;">
                        <!-- 回落圖 -->
                        <div class="tab-pane fade show active" id="drawdown-chart" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6>回落圖分析</h6>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-info me-2" id="btn-vertical">上下排列</button>
                                    <button type="button" class="btn btn-sm btn-outline-info" id="btn-horizontal">左右排列</button>
                                    <button type="button" class="btn btn-sm btn-outline-info ms-2" onclick="toggleDrawdownView()">
                                        <i class="fas fa-exchange-alt me-1"></i>切換視圖
                                    </button>
                                </div>
                            </div>
                            <div id="drawdown-chart-container" class="chart-container">
                                <div class="text-center text-muted">
                                    <i class="fas fa-chart-line fa-2x mb-2"></i>
                                    <p>點擊「重新整理圖表」載入回落圖</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 月損益熱力圖 -->
                        <div class="tab-pane fade" id="heatmap-chart" role="tabpanel">
                            <h6 class="mb-3">月累積平均損益 (萬元)</h6>
                            <div id="heatmap-chart-container" class="chart-container">
                                <div class="text-center text-muted">
                                    <i class="fas fa-th fa-2x mb-2"></i>
                                    <p>點擊「重新整理圖表」載入熱力圖</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 月收益率熱力圖 -->
                        <div class="tab-pane fade" id="return-heatmap-chart" role="tabpanel">
                            <h6 class="mb-3">月平均收益率 (bp)</h6>
                            <div id="return-heatmap-chart-container" class="chart-container">
                                <div class="text-center text-muted">
                                    <i class="fas fa-percentage fa-2x mb-2"></i>
                                    <p>點擊「重新整理圖表」載入收益率圖</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 年度損益 -->
                        <div class="tab-pane fade" id="yearly-chart" role="tabpanel">
                            <h6 class="mb-3">年度總損益 (萬元)</h6>
                            <div id="yearly-chart-container" class="chart-container">
                                <div class="text-center text-muted">
                                    <i class="fas fa-calendar-alt fa-2x mb-2"></i>
                                    <p>點擊「重新整理圖表」載入年度圖</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 月交易天數 -->
                        <div class="tab-pane fade" id="trading-days-chart" role="tabpanel">
                            <h6 class="mb-3">月交易筆數(天)</h6>
                            <div id="trading-days-chart-container" class="chart-container">
                                <div class="text-center text-muted">
                                    <i class="fas fa-calendar-day fa-2x mb-2"></i>
                                    <p>點擊「重新整理圖表」載入交易天數圖</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 月交易股票數 -->
                        <div class="tab-pane fade" id="trading-stocks-chart" role="tabpanel">
                            <h6 class="mb-3">月交易筆數(隻)</h6>
                            <div id="trading-stocks-chart-container" class="chart-container">
                                <div class="text-center text-muted">
                                    <i class="fas fa-chart-bar fa-2x mb-2"></i>
                                    <p>點擊「重新整理圖表」載入交易股票數圖</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 月勝率 -->
                        <div class="tab-pane fade" id="win-rate-chart" role="tabpanel">
                            <h6 class="mb-3">月度勝率 (%)</h6>
                            <div id="win-rate-chart-container" class="chart-container">
                                <div class="text-center text-muted">
                                    <i class="fas fa-trophy fa-2x mb-2"></i>
                                    <p>點擊「重新整理圖表」載入勝率圖</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 星期分析 -->
                        <div class="tab-pane fade" id="weekday-chart" role="tabpanel">
                            <h6 class="mb-3">按星期分析交易 (工作日)</h6>
                            <div id="weekday-chart-container" class="chart-container">
                                <div class="text-center text-muted">
                                    <i class="fas fa-calendar-week fa-2x mb-2"></i>
                                    <p>點擊「重新整理圖表」載入星期分析圖</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 上下排列模式的所有圖表容器 -->
                    <div id="vertical-charts-container">
                        <div class="chart-container" id="all-vertical-charts">
                            <div class="d-flex justify-content-end align-items-center mb-3" id="vertical-charts-toolbar">
                                <button type="button" class="btn btn-sm btn-outline-info me-2" id="btn-vertical-vertical">上下排列</button>
                                <button type="button" class="btn btn-sm btn-outline-info" id="btn-horizontal-vertical">左右排列</button>
                                <button type="button" class="btn btn-sm btn-outline-info ms-2" onclick="toggleDrawdownView()">
                                    <i class="fas fa-exchange-alt me-1"></i>切換視圖
                                </button>
                            </div>
                            <div id="vertical-drawdown-chart" class="vertical-chart-block"></div>
                            <div id="vertical-heatmap-chart" class="vertical-chart-block"></div>
                            <div id="vertical-return-heatmap-chart" class="vertical-chart-block"></div>
                            <div id="vertical-yearly-chart" class="vertical-chart-block"></div>
                            <div id="vertical-trading-days-chart" class="vertical-chart-block"></div>
                            <div id="vertical-trading-stocks-chart" class="vertical-chart-block"></div>
                            <div id="vertical-win-rate-chart" class="vertical-chart-block"></div>
                            <div id="vertical-weekday-chart" class="vertical-chart-block"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 持有部位表格 -->
    <div class="row" id="holding-positions-section" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-hand-holding-usd me-2"></i>
                        持有未出場部位
                    </h5>
                    <!-- 暫時隱藏持有部位匯出按鈕 -->
                    <!-- <div>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="export-holdings-btn">
                            <i class="fas fa-download me-1"></i>
                            匯出持有部位
                        </button>
                    </div> -->
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="holding-positions-table">
                            <thead>
                                <tr>
                                    <th>進場日期</th>
                                    <th>出場日期</th>
                                    <th>股票代碼</th>
                                    <th>股票名稱</th>
                                    <th>方向</th>
                                    <th>進場價</th>
                                    <th>當前價</th>
                                    <th>當日未出場價</th>
                                    <th>股數</th>
                                    <th>未實現損益</th>
                                    <th>未實現損益率</th>
                                    <th>當日未出場損益</th>
                                    <th>當日未出場損益率</th>
                                    <th>持有天數</th>
                                    <th>出場狀態</th>
                                    <th>停利價</th>
                                    <th>停損價</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 持有部位將由JavaScript動態載入 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    let currentStrategy = '';
    let currentStrategyParameters = {};
    
    // 全域變數儲存欄位定義
    let tradeRecordFields = [];
    let holdingPositionFields = [];
    
    // 初始化時載入自定義策略
    loadCustomStrategies();
    
    // 載入資料結構定義
    loadDataStructure();
    
    // 策略選擇變更事件
    $('#strategy_name').change(function() {
        const selectedStrategy = $(this).val();
        if (selectedStrategy) {
            loadStrategyConfiguration(selectedStrategy);
        } else {
            resetStrategyConfiguration();
        }
    });
    
    // 監聽策略更新事件
    window.addEventListener('strategyUpdated', function(event) {
        console.log('收到策略更新事件:', event.detail);
        // 重新載入自定義策略
        loadCustomStrategies();
    });
    
    // 股票來源變更事件
    $('#stock_source').change(function() {
        updateParameterDisplay();
    });
    
    // 股價資料來源變更事件
    $('#price_source').change(function() {
        updateExcelHelp();
        updatePriceSourceDisplay();
    });
    
    // 格式說明按鈕點擊事件
    $('#format-help-btn').click(function() {
        showFormatHelp();
    });
    
    // 下載詳細記錄按鈕點擊事件
    $('#download-detailed-btn').click(function() {
        downloadDetailedRecords();
    });
    
    // 匯出持有部位按鈕點擊事件
    $('#export-holdings-btn').click(function() {
        exportHoldingPositionsToCSV();
    });
    
    // 檢查URL參數是否有預設策略
    const urlParams = new URLSearchParams(window.location.search);
    const defaultStrategy = urlParams.get('strategy');
    if (defaultStrategy) {
        $('#strategy_name').val(defaultStrategy).trigger('change');
    }
    
    // 載入自定義策略
    function loadCustomStrategies() {
        console.log('開始載入自定義策略...');
        $.get('/api/strategies/custom')
            .done(function(response) {
                console.log('自定義策略API回應:', response);
                if (response.status === 'success' && response.strategies) {
                    const group = $('#strategy_name');
                    group.find('option:not(:first)').remove();
                    
                    if (response.strategies.length === 0) {
                        group.append('<option disabled>暫無自定義策略</option>');
                    } else {
                        // 分離已確認和未確認的策略
                        const confirmedStrategies = [];
                        const unconfirmedStrategies = [];
                        
                        response.strategies.forEach(strategy => {
                            if (strategy.is_confirmed) {
                                confirmedStrategies.push(strategy);
                            } else {
                                unconfirmedStrategies.push(strategy);
                            }
                        });
                        
                        // 先添加已確認的策略（顯示在上方）
                        if (confirmedStrategies.length > 0) {
                            // 添加已確認策略的分隔標題
                            group.append('<option disabled class="strategy-divider">--- 已確認策略 ---</option>');
                            
                            confirmedStrategies.forEach(strategy => {
                                const option = $(`<option value="custom_${strategy.id}">✅ ${strategy.name}</option>`);
                                option.attr('data-strategy-id', strategy.id);
                                option.attr('data-strategy-name', strategy.name);
                                option.attr('data-strategy-description', strategy.description);
                                option.attr('data-is-confirmed', 'true');
                                group.append(option);
                            });
                        }
                        
                        // 再添加未確認的策略
                        if (unconfirmedStrategies.length > 0) {
                            // 添加未確認策略的分隔標題
                            group.append('<option disabled class="strategy-divider">--- 編輯中策略 ---</option>');
                            
                            unconfirmedStrategies.forEach(strategy => {
                                const option = $(`<option value="custom_${strategy.id}">📝 ${strategy.name}</option>`);
                                option.attr('data-strategy-id', strategy.id);
                                option.attr('data-strategy-name', strategy.name);
                                option.attr('data-strategy-description', strategy.description);
                                option.attr('data-is-confirmed', 'false');
                                group.append(option);
                            });
                        }
                        
                        console.log(`載入 ${confirmedStrategies.length} 個已確認策略，${unconfirmedStrategies.length} 個編輯中策略`);
                    }
                    // === 新增：渲染完 option 後再根據 URL 參數自動選擇 ===
                    const urlParams = new URLSearchParams(window.location.search);
                    const defaultStrategy = urlParams.get('strategy');
                    if (defaultStrategy) {
                        group.val(defaultStrategy).trigger('change');
                    }
                } else {
                    console.error('自定義策略API回應格式錯誤:', response);
                }
            })
            .fail(function(xhr) {
                console.error('載入自定義策略失敗:', xhr.responseText);
                const group = $('#strategy_name');
                group.empty();
                group.append('<option disabled>載入失敗</option>');
            });
    }
    
    // 載入快取檔案列表
    function loadCacheFiles() {
        console.log('開始載入快取檔案...');
        $.get('/api/cache/files')
            .done(function(response) {
                console.log('快取檔案API回應:', response);
                if (response.status === 'success' && response.data.files.length > 0) {
                    const select = $('#cache_file_select');
                    select.empty();
                    select.append('<option value="">請選擇快取檔案...</option>');
                    
                    response.data.files.forEach(cacheFile => {
                        const option = $(`<option value="${cacheFile.filename}">${cacheFile.friendly_display_name} (${cacheFile.size_mb}MB)</option>`);
                        select.append(option);
                    });
                    console.log(`載入 ${response.data.files.length} 個快取檔案`);
                } else {
                    const select = $('#cache_file_select');
                    select.empty();
                    select.append('<option value="">請選擇快取檔案...</option>');
                    select.append('<option value="" disabled>--- 無快取檔案 ---</option>');
                    console.log('沒有快取檔案');
                }
            })
            .fail(function(xhr) {
                console.error('載入快取檔案失敗:', xhr.responseText);
                const select = $('#cache_file_select');
                select.empty();
                select.append('<option value="">請選擇快取檔案...</option>');
                select.append('<option value="" disabled>載入失敗</option>');
            });
    }
    
    // 更新股價資料來源顯示
    function updatePriceSourceDisplay() {
        const priceSource = $('#price_source').val();
        
        // 隱藏所有相關區塊
        $('#cache-source-section').hide();
        $('#price-excel-section').hide();
        
        if (priceSource === 'cache') {
            $('#cache-source-section').show();
            // 載入快取檔案列表
            loadCacheFiles();
        } else if (priceSource === 'excel') {
            $('#price-excel-section').show();
        }
    }
    
    // 從後端載入策略配置
    function loadStrategyConfiguration(strategyType) {
        console.log('載入策略配置:', strategyType);
        
        // 檢查是否為自定義策略
        if (strategyType.startsWith('custom_')) {
            const strategyId = strategyType.replace('custom_', '');
            const option = $(`#strategy_name option[value="${strategyType}"]`);
            const strategyName = option.attr('data-strategy-name');
            const strategyDescription = option.attr('data-strategy-description');
            
            console.log('自定義策略ID:', strategyId);
            console.log('自定義策略名稱:', strategyName);
            
            // 更新策略描述
            $('#strategy-description').text(strategyDescription || '自定義策略');
            
            // 顯示參數來源設定
            $('#parameter-sources').show();
            
            // 載入自定義策略的參數配置
            loadCustomStrategyParameters(strategyId);
            
            return;
        }
        
        // 如果不是自定義策略，顯示錯誤
        showError('不支援的策略類型: ' + strategyType);
        resetStrategyConfiguration();
    }
    
    // 載入自定義策略參數
    function loadCustomStrategyParameters(strategyId) {
        console.log('載入自定義策略參數:', strategyId);
        $.get(`/api/strategies/custom/${strategyId}`)
            .done(function(response) {
                console.log('自定義策略詳情API回應:', response);
                if (response.status === 'success') {
                    const strategy = response.strategy;
                    
                    // 設定當前策略
                    currentStrategy = `custom_${strategyId}`;
                    
                    // 顯示參數來源設定
                    $('#parameter-sources').show();
                    
                    // 更新參數來源顯示（自定義策略使用預設設定）
                    updateParameterSources({
                        stock_source: {
                            description: '請選擇股票代碼來源'
                        },
                        price_source: {
                            description: '請選擇股價資料來源'
                        },
                        date_range: {
                            required: true
                        }
                    });
                    
                    // 渲染自定義策略參數（如果有定義的話）
                    if (strategy.parameters && Object.keys(strategy.parameters).length > 0) {
                        renderStrategyParameters(strategy.parameters);
                    } else {
                        $('#strategy-config').html('<div class="text-center text-muted"><small>此自定義策略無需額外參數</small></div>');
                    }
                } else {
                    showError('載入自定義策略配置失敗: ' + (response.message || '未知錯誤'));
                }
            })
            .fail(function(xhr) {
                console.error('載入自定義策略配置失敗:', xhr.responseText);
                showError('載入自定義策略配置失敗: ' + xhr.responseText);
            });
    }
    
    // 重置策略配置
    function resetStrategyConfiguration() {
        currentStrategy = '';
        currentStrategyParameters = {};
        $('#strategy-description').text('');
        $('#parameter-sources').hide();
        $('#bookbuilding-section').hide();
        $('#strategy-config').html('<div class="text-center text-muted"><small>請先選擇策略</small></div>');
    }
    
    // 更新參數來源顯示
    function updateParameterSources(parameterSources) {
        // 更新股票來源說明
        if (parameterSources.stock_source) {
            $('#stock_source_help').text(parameterSources.stock_source.description);
        }
        
        // 更新股價資料來源說明
        if (parameterSources.price_source) {
            $('#price_source_help').text(parameterSources.price_source.description);
        }
        
        // 更新日期範圍顯示
        if (parameterSources.date_range && parameterSources.date_range.required) {
            $('#date-range-section').show();
        } else {
            $('#date-range-section').hide();
        }
    }
    
    // 渲染策略參數
    function renderStrategyParameters(parameters) {
        console.log('開始渲染策略參數:', parameters);
        const container = $('#strategy-config');
        container.empty();
        const grid = $('<div class="strategy-params-grid"></div>');
        Object.keys(parameters).forEach(key => {
            const param = parameters[key];
            const formGroup = $('<div class="param-item"></div>');
            
            const label = $(`<label for="param-${key}" class="form-label">${param.label}</label>`);
            let input;
            
            if (param.type === 'number') {
                input = $(`<input type="number" class="form-control" id="param-${key}" name="param-${key}" 
                              value="${param.default || ''}" 
                              min="${param.min || ''}" 
                              max="${param.max || ''}" 
                              step="${param.step || '1'}">`);
                console.log(`數字輸入 ${key}: 預設值=${param.default}`);
            } else if (param.type === 'select') {
                input = $(`<select class="form-select" id="param-${key}" name="param-${key}"></select>`);
                // 添加預設的「請選擇」選項
                input.append('<option value="">請選擇...</option>');
                
                // 檢查是否有選項設定
                if (param.options && param.options.length > 0) {
                    param.options.forEach(option => {
                        const optionElement = $(`<option value="${option.value}">${option.label}</option>`);
                        if (option.value === param.default) {
                            optionElement.attr('selected', true);
                            console.log(`選項 ${key}: 預設選中=${option.value}`);
                        }
                        input.append(optionElement);
                    });
                } else {
                    // 如果沒有選項，提供預設選項
                    const defaultOptions = [
                        { value: "option1", label: "選項1" },
                        { value: "option2", label: "選項2" }
                    ];
                    defaultOptions.forEach(option => {
                        const optionElement = $(`<option value="${option.value}">${option.label}</option>`);
                        // 如果沒有預設值，選中第一個選項
                        if (option.value === (param.default || defaultOptions[0].value)) {
                            optionElement.attr('selected', true);
                        }
                        input.append(optionElement);
                    });
                }
                console.log(`建立下拉式選單 ${key}: 類型=${param.type}, 預設值=${param.default}`);
            } else if (param.type === 'boolean') {
                // 使用自定義橫移開關樣式
                const toggleId = `param-${key}`;
                input = $(`<div class="d-flex align-items-center">
                              <div class="custom-toggle-switch ${param.default ? 'active' : ''}" onclick="toggleCustomSwitch('${toggleId}')">
                                  <input type="checkbox" id="${toggleId}" name="param-${key}" ${param.default ? 'checked' : ''}>
                                  <div class="toggle-slider"></div>
                              </div>
                              <label class="ms-2 mb-0">${param.label}</label>
                           </div>`);
                console.log(`布林輸入 ${key}: 預設值=${param.default}`);
            } else if (param.type === 'date') {
                input = $(`<input type="date" class="form-control" id="param-${key}" name="param-${key}" value="${param.default || ''}">`);
                console.log(`日期輸入 ${key}: 預設值=${param.default}`);
            } else {
                input = $(`<input type="text" class="form-control" id="param-${key}" name="param-${key}" value="${param.default || ''}">`);
                console.log(`文字輸入 ${key}: 預設值=${param.default}`);
            }
            
            formGroup.append(label).append(input);
            
            if (param.description) {
                const helpText = $(`<div class="form-text">${param.description}</div>`);
                formGroup.append(helpText);
            }
            
            grid.append(formGroup);
        });
        container.append(grid);
    }
    
    // 更新參數顯示
    function updateParameterDisplay() {
        const stockSource = $('#stock_source').val();
        
        if (stockSource === 'excel') {
            $('#excel-upload-section').show();
            $('#manual-stock-section').hide();
        } else if (stockSource === 'manual') {
            $('#excel-upload-section').hide();
            $('#manual-stock-section').show();
        }
    }
    
    // 更新Excel幫助文字
    function updateExcelHelp() {
        const dataSource = $('#price_source').val();
        const strategyName = $('#strategy_name').val();
        
        if (!strategyName) {
            $('#excel_help').text('請先選擇策略');
            return;
        }
        
        if (dataSource === 'api') {
            $('#excel_help').text('API模式：請上傳包含證券代碼和日期的Excel檔案，股價資料將從API取得');
        } else if (dataSource === 'cache') {
            $('#excel_help').text('快取模式：請上傳包含證券代碼和日期的Excel檔案，股價資料將從API取得');
        } else {
            $('#excel_help').text('Excel模式：請上傳包含證券代碼和日期的Excel檔案，股價資料將從API取得');
        }
    }
    
    // 顯示格式說明
    function showFormatHelp() {
        const dataSource = $('#price_source').val();
        const strategyName = $('#strategy_name').val();
        
        if (!strategyName) {
            alert('請先選擇策略');
            return;
        }
        
        let helpText = '';
        let requiredColumns = [];
        let exampleData = [];
        
        // if (dataSource === 'api') {
        helpText = '<h6>API模式檔案格式：</h6>';
        requiredColumns = ['stock_id', 'date'];
        exampleData = [
            ['2330', '2024-01-01'],
            ['2330', '2024-01-02']
        ];
        // } else {
        //     helpText = '<h6>Excel模式檔案格式：.xlsx, .csv</h6>';
        //     requiredColumns = ['stock_id', 'date', 'open', 'high', 'low', 'close'];
        //     exampleData = [
        //         ['2330', '2024-01-01', '100', '105', '98', '103'],
        //         ['2330', '2024-01-02', '103', '108', '102', '106']
        //     ];
        // }
        
        helpText += `
            <p>Excel檔案需包含以下欄位：</p>
            <ul>
                ${requiredColumns.map(col => `<li><strong>${col}</strong>：${getColumnDescription(col)}（必填）</li>`).join('')}
            </ul>
            <p>範例：</p>
            <table class="table table-sm">
                <thead><tr>${requiredColumns.map(col => `<th>${col}</th>`).join('')}</tr></thead>
                <tbody>
                    ${exampleData.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('')}
                </tbody>
            </table>
        `;
        
        // 使用Bootstrap modal顯示說明
        const modalHtml = `
            <div class="modal fade" id="formatHelpModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">檔案格式說明</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            ${helpText}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // 移除舊的modal並添加新的
        $('#formatHelpModal').remove();
        $('body').append(modalHtml);
        
        // 顯示modal
        new bootstrap.Modal(document.getElementById('formatHelpModal')).show();
    }
    
    // 取得欄位描述
    function getColumnDescription(column) {
        const descriptions = {
            'stock_id': '股票代碼',
            'date': '日期（格式：YYYY-MM-DD）',
            'open': '開盤價',
            'high': '最高價',
            'low': '最低價',
            'close': '收盤價'
        };
        return descriptions[column] || column;
    }
    
    // 執行回測
    $('#backtest-form').submit(function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const strategyName = formData.get('strategy_name');
        const stockSource = formData.get('stock_source');
        const priceSource = formData.get('price_source');
        
        // 驗證必填欄位
        if (!strategyName) {
            alert('請選擇策略');
            return;
        }
        
        // 驗證股票來源
        if (stockSource === 'excel') {
            const excelFile = $('#excel_file')[0].files[0];
            if (!excelFile) {
                alert('請選擇Excel檔案');
                return;
            }
        } else if (stockSource === 'manual') {
            const manualStockIds = formData.get('manual_stock_ids');
            if (!manualStockIds || !manualStockIds.trim()) {
                alert('請輸入股票代碼');
                return;
            }
        }
        
        // 顯示載入狀態
        $('#run-backtest-btn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>執行中...');
        $('#backtest-results').html('<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">執行回測中...</p></div>');
        
        // 準備上傳資料
        const uploadFormData = new FormData();
        
        // 基本參數
        uploadFormData.append('strategy_id', strategyName);
        uploadFormData.append('stock_source', stockSource);
        uploadFormData.append('price_source', priceSource);
        uploadFormData.append('initial_capital', formData.get('initial_capital'));
        
        // 收集策略參數（所有以 param- 開頭的欄位）
        $('#strategy-config input, #strategy-config select').each(function() {
            const name = $(this).attr('name');
            if (name && name.startsWith('param-')) {
                let value;
                if ($(this).attr('type') === 'checkbox') {
                    value = $(this).is(':checked') ? '1' : '0';
                } else {
                    value = $(this).val();
                }
                console.log(`DEBUG: 收集參數 ${name} = ${value}`);
                uploadFormData.append(name, value);
            }
        });
        
        // 特別處理自定義開關的布林值參數
        $('#strategy-config .custom-toggle-switch input[type="checkbox"]').each(function() {
            const name = $(this).attr('name');
            if (name) {
                const value = $(this).is(':checked') ? '1' : '0';
                console.log(`DEBUG: 收集自定義開關參數 ${name} = ${value}`);
                uploadFormData.append(name, value);
            }
        });
        
        // 股票來源相關參數
        if (stockSource === 'excel') {
            const excelFile = $('#excel_file')[0].files[0];
            uploadFormData.append('excel_file', excelFile);
        } else if (stockSource === 'manual') {
            uploadFormData.append('manual_stock_ids', formData.get('manual_stock_ids'));
        }
        
        // 股價資料來源相關參數
        if (priceSource === 'cache') {
            const cacheFile = $('#cache_file_select').val();
            if (cacheFile) {
                uploadFormData.append('cache_file', cacheFile);
            }
        } else if (priceSource === 'excel') {
            const priceExcelFile = $('#price_excel_file')[0].files[0];
            if (priceExcelFile) {
                uploadFormData.append('price_excel_file', priceExcelFile);
            }
        }
        
        // 日期範圍參數
        const startDate = formData.get('start_date');
        const endDate = formData.get('end_date');
        if (startDate) uploadFormData.append('start_date', startDate);
        if (endDate) uploadFormData.append('end_date', endDate);
        
        // 詢圈公告策略特殊參數
        if (strategyName === 'bookbuilding') {
            const startYear = formData.get('start_year');
            const endYear = formData.get('end_year');
            if (startYear) uploadFormData.append('start_year', startYear);
            if (endYear) uploadFormData.append('end_year', endYear);
        }
        
        // 發送請求
        $.ajax({
            url: '/api/backtest/execute',
            method: 'POST',
            data: uploadFormData,
            processData: false,
            contentType: false,
            success: function(data) {
                displayBacktestResults(data);
            },
            error: function(xhr, status, error) {
                console.error('回測執行失敗:', error);
                $('#backtest-results').html(`
                    <div class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <p>回測執行失敗: ${xhr.responseJSON?.detail || error}</p>
                    </div>
                `);
            },
            complete: function() {
                $('#run-backtest-btn').prop('disabled', false).html('<i class="fas fa-play me-2"></i>執行回測');
            }
        });
    });
    
    // 顯示回測結果
    function displayBacktestResults(data) {
        console.log('收到回測結果:', data);
        
        // 檢查資料格式
        if (!data || (data.status && data.status !== 'success')) {
            $('#backtest-results').html(`
                <div class="text-center text-danger">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <p>回測執行失敗: ${data?.detail || data?.message || '未知錯誤'}</p>
                </div>
            `);
            return;
        }
        
        // 處理不同的資料格式
        let summary, trades, holding_positions;
        
        if (data.summary && data.trades) {
            // 舊格式：直接包含 summary 和 trades
            summary = data.summary;
            trades = data.trades;
            holding_positions = data.holding_positions || [];
        } else if (data.results) {
            // 新格式：包含在 results 中
            const results = data.results;
            if (results.backtest_results) {
                // 自定義策略格式
                const backtestResults = results.backtest_results;
                summary = {
                    total_trades: backtestResults.total_trades || 0,
                    winning_trades: backtestResults.winning_trades || 0,
                    win_rate: backtestResults.win_rate || 0,
                    total_profit: backtestResults.total_profit_loss || 0,
                    total_profit_rate: backtestResults.total_profit_loss_rate || 0
                };
                trades = backtestResults.trade_records || [];
                holding_positions = backtestResults.holding_positions || [];
            } else {
                // 一般回測格式
                summary = results;
                trades = results.trade_records || [];
                holding_positions = results.holding_positions || [];
            }
        } else {
            // 直接格式
            summary = data;
            trades = data.trade_records || [];
            holding_positions = data.holding_positions || [];
        }
        
        console.log('處理後的資料:', { summary, trades, holding_positions });
        
        // 顯示摘要
        const summaryHtml = `
            <div class="row mb-4">
                <div class="col-md-3 text-center">
                    <h4 class="text-primary">${summary.total_trades || 0}</h4>
                    <small class="text-muted">總交易次數</small>
                </div>
                <div class="col-md-3 text-center">
                    <h4 class="text-success">${summary.winning_trades || 0}</h4>
                    <small class="text-muted">獲利交易</small>
                </div>
                <div class="col-md-3 text-center">
                    <h4 class="text-info">${(summary.win_rate * 100 || 0).toFixed(2)}%</h4>
                    <small class="text-muted">勝率</small>
                </div>
                <div class="col-md-3 text-center">
                    <h4 class="${(summary.total_profit || 0) >= 0 ? 'text-success' : 'text-danger'}">${(summary.total_profit || 0).toLocaleString()}</h4>
                    <small class="text-muted">總損益</small>
                </div>
            </div>
        `;
        
        $('#backtest-results').html(summaryHtml);
        
        // 顯示交易記錄
        if (trades && trades.length > 0) {
            console.log('顯示交易記錄，數量:', trades.length);
            displayTradesTable(trades);
            $('#trades-section').show();
            $('#charts-section').show(); // 顯示圖表區域
            
            // 儲存回測參數和完整的原始資料供下載詳細記錄使用
            window.lastBacktestParams = {
                strategy_name: $('#strategy_name').val(),
                price_source: $('#price_source').val(),
                config: getStrategyConfig(),
                trade_records: trades,  // 儲存完整的原始交易記錄
                holding_positions: holding_positions  // 儲存完整的原始持有部位
            };
            // 自動載入圖表，預設vertical
            currentDrawdownLayout = 'vertical';
            $('#btn-vertical').addClass('btn-primary').removeClass('btn-outline-info');
            $('#btn-horizontal').addClass('btn-outline-info').removeClass('btn-primary');
            refreshAllCharts();
        } else {
            console.log('沒有交易記錄');
            $('#trades-section').hide();
            $('#charts-section').hide(); // 隱藏圖表區域
        }
        
        // 顯示持有部位資料
        if (holding_positions && holding_positions.length > 0) {
            console.log('顯示持有部位，數量:', holding_positions.length);
            displayHoldingPositionsTable(holding_positions);
            $('#holding-positions-section').show();
        } else {
            $('#holding-positions-section').hide();
        }
    }
    
    // 顯示交易記錄表格
    function displayTradesTable(trades) {
        console.log('顯示交易記錄表格，交易數量:', trades.length);
        
        // 將trades資料保存到全域變數，供展開功能使用
        window.currentTradesData = trades;
        
        trades.sort((a, b) => {
            if (a.stock_id !== b.stock_id) {
                return a.stock_id.localeCompare(b.stock_id);
            }
            return new Date(a.entry_date) - new Date(b.entry_date);
        });
        
        const tbody = $('#trades-table tbody');
        tbody.empty();
        
        trades.forEach(function(trade, index) {
            const profit = trade.profit_loss || trade.net_profit_loss || trade.profit || 0;
            const profitRate = trade.profit_loss_rate || trade.profit_rate || 0;
            const profitClass = profit >= 0 ? 'text-success' : 'text-danger';
            const profitRateClass = profitRate >= 0 ? 'text-success' : 'text-danger';
            const profitIcon = profit >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
            const exitStatus = trade.exit_reason || trade.exit_status || '未知';
            const statusClass = getStatusClass(exitStatus);
            const stockName = trade.stock_name || '未知';
            
            // 新增展開/收合功能
            const row = `
                <tr data-trade-index="${index}" class="trade-row" style="cursor:pointer;" onclick="toggleTradeDetails(${index})">
                    <td>${trade.entry_date}</td>
                    <td>${trade.exit_date}</td>
                    <td>${trade.stock_id}</td>
                    <td>${stockName}</td>
                    <td>${parseFloat(trade.entry_price).toFixed(2)}</td>
                    <td>${parseFloat(trade.exit_price).toFixed(2)}</td>
                    <td>${trade.shares.toLocaleString()}</td>
                    <td class="${profitClass}"><i class="fas ${profitIcon} me-1"></i>${Math.round(profit).toLocaleString()}</td>
                    <td class="${profitRateClass}">${parseFloat(profitRate).toFixed(2)}%</td>
                    <td>${trade.holding_days || 0}天</td>
                    <td><span class="badge ${statusClass}">${exitStatus}</span></td>
                </tr>
            `;
            tbody.append(row);
        });
    }
    
    // 全域函數：切換交易詳細資訊
    window.toggleTradeDetails = function(index) {
        console.log('=== 開始切換交易詳細資訊 ===');
        console.log('索引:', index);
        console.log('當前交易資料:', window.currentTradesData);
        
        const tbody = $('#trades-table tbody');
        console.log('表格tbody:', tbody.length);
        
        const $row = tbody.find(`tr[data-trade-index="${index}"]`);
        console.log('找到的行:', $row.length);
        console.log('行的HTML:', $row.html());
        
        if ($row.length === 0) {
            console.error('找不到對應的交易列');
            return;
        }
        
        // 若已展開則收合
        if ($row.hasClass('expanded')) {
            console.log('收合展開列');
            $row.removeClass('expanded');
            $row.next('.trades-table-details-row').remove();
            return;
        }
        
        // 先收合其他展開列
        tbody.find('tr.trade-row.expanded').removeClass('expanded');
        tbody.find('.trades-table-details-row').remove();
        
        // 展開當前列
        console.log('展開交易記錄');
        $row.addClass('expanded');
        
        // 顯示詳細內容
        const trade = window.currentTradesData[index];
        if (!trade) {
            console.error('找不到交易資料');
            return;
        }
        
        console.log('交易資料:', trade);
        const detailHtml = `<tr class="trades-table-details-row"><td colspan="11"><div class="trades-table-details-content"><b>詳細內容：</b><pre>${JSON.stringify(trade, null, 2)}</pre></div></td></tr>`;
        $row.after(detailHtml);
        console.log('=== 切換完成 ===');
    };
    
    // 測試展開功能
    window.testExpandFunction = function() {
        // console.log('=== 測試展開功能 ===');
        // console.log('window.currentTradesData:', window.currentTradesData);
        // console.log('表格行數:', $('#trades-table tbody tr').length);
        
        if (window.currentTradesData && window.currentTradesData.length > 0) {
            console.log('嘗試展開第一筆交易');
            window.toggleTradeDetails(0);
        } else {
            console.log('沒有交易資料可測試');
            alert('請先執行回測產生交易資料');
        }
    };
    
    // 切換整個交易記錄表格的展開/縮起
    window.toggleTradesTable = function() {
        const $body = $('#trades-table-body');
        const $icon = $('#trades-toggle-icon');
        
        if ($body.is(':visible')) {
            // 縮起表格
            $body.slideUp(300);
            $icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
        } else {
            // 展開表格
            $body.slideDown(300);
            $icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
        }
    };
    
    // 顯示持有部位表格
    function displayHoldingPositionsTable(holdingPositions) {
        console.log('顯示持有部位表格，部位數量:', holdingPositions.length);
        
        // 前端排序：先按股票代碼排序，再按進場日期排序
        holdingPositions.sort((a, b) => {
            if (a.stock_id !== b.stock_id) {
                return a.stock_id.localeCompare(b.stock_id);
            }
            return new Date(a.entry_date) - new Date(b.entry_date);
        });
        
        const tbody = $('#holding-positions-table tbody');
        tbody.empty();
        
        holdingPositions.forEach(function(position, index) {
            const profitClass = position.unrealized_profit_loss >= 0 ? 'text-success' : 'text-danger';
            const profitIcon = position.unrealized_profit_loss >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
            const currentProfitClass = position.current_profit_loss >= 0 ? 'text-success' : 'text-danger';
            const currentProfitIcon = position.current_profit_loss >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
            const direction = position.trade_direction === 1 ? '做多' : '做空';
            const stockName = position.stock_name || '未知';
            
            // 只顯示主要欄位，但保留完整資料供下載使用
            const row = `
                <tr data-position-index="${index}">
                    <td>${position.entry_date}</td>
                    <td>${position.current_date || position.entry_date}</td>
                    <td>${position.stock_id}</td>
                    <td>${stockName}</td>
                    <td><span class="badge ${position.trade_direction === 1 ? 'bg-success' : 'bg-danger'}">${direction}</span></td>
                    <td>${parseFloat(position.entry_price).toFixed(2)}</td>
                    <td>${parseFloat(position.current_price || position.entry_price).toFixed(2)}</td>
                    <td>${parseFloat(position.current_exit_price || position.current_price || position.entry_price).toFixed(2)}</td>
                    <td>${position.shares.toLocaleString()}</td>
                    <td class="${profitClass}">
                        <i class="fas ${profitIcon} me-1"></i>
                        ${Math.round(position.unrealized_profit_loss || 0).toLocaleString()}
                    </td>
                    <td class="${profitClass}">${parseFloat(position.unrealized_profit_loss_rate || 0).toFixed(2)}%</td>
                    <td class="${currentProfitClass}">
                        <i class="fas ${currentProfitIcon} me-1"></i>
                        ${Math.round(position.current_profit_loss || 0).toLocaleString()}
                    </td>
                    <td class="${currentProfitClass}">${parseFloat(position.current_profit_loss_rate || 0).toFixed(2)}%</td>
                    <td>${position.holding_days || 0}天</td>
                    <td>${position.exit_price_type || 'close'}</td>
                    <td>${position.take_profit_price ? parseFloat(position.take_profit_price).toFixed(2) : '-'}</td>
                    <td>${position.stop_loss_price ? parseFloat(position.stop_loss_price).toFixed(2) : '-'}</td>
                </tr>
            `;
            tbody.append(row);
        });
    }
    
    // 匯出持有部位到CSV
    function exportHoldingPositionsToCSV() {
        const tbody = $('#holding-positions-table tbody');
        const rows = tbody.find('tr');
        
        if (rows.length === 0) {
            alert('沒有持有部位資料可匯出');
            return;
        }
        
        let csvContent = '進場日期,未出場日期,股票代碼,股票名稱,方向,進場價,當前價,當日未出場價,股數,未實現損益,未實現損益率,當日未出場損益,當日未出場損益率,持有天數,出場價類型,停利價,停損價\\n';
        
        rows.each(function() {
            const cells = $(this).find('td');
            const rowData = [];
            
            cells.each(function(index) {
                let text = $(this).text().trim();
                // 移除圖標和特殊字符
                text = text.replace(/[↑↓]/g, '').trim();
                // 如果包含逗號，用引號包圍
                if (text.includes(',')) {
                    text = `"${text}"`;
                }
                rowData.push(text);
            });
            
            csvContent += rowData.join(',') + '\\n';
        });
        
        // 下載CSV檔案
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'holding_positions.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    // 取得策略配置
    function getStrategyConfig() {
        const config = {};
        $('#strategy-config input, #strategy-config select').each(function() {
            const name = $(this).attr('name');
            const value = $(this).attr('type') === 'checkbox' ? $(this).is(':checked') : $(this).val();
            if (name) {
                config[name] = value;
            }
        });
        
        // 特別處理自定義開關的布林值參數
        $('#strategy-config .custom-toggle-switch input[type="checkbox"]').each(function() {
            const name = $(this).attr('name');
            if (name) {
                config[name] = $(this).is(':checked');
            }
        });
        
        return config;
    }
    
    // 取得股票來源設定
    function getStockSourceConfig() {
        const stockSource = document.querySelector('input[name="stockSource"]:checked').value;
        
        if (stockSource === 'excel') {
            return {
                type: 'excel',
                config: {
                    required_columns: ['stock_id', 'startdate', 'enddate']
                }
            };
        } else if (stockSource === 'stock_list') {
            const stockListId = document.getElementById('stockListSelect').value;
            return {
                type: 'stock_list',
                config: {
                    stock_list_id: stockListId
                }
            };
        }
        
        return null;
    }
    
    // 顯示錯誤訊息
    function showError(message) {
        console.error('錯誤:', message);
        alert('錯誤: ' + message);
    }
    
    // 顯示成功訊息
    function showSuccess(message) {
        console.log('成功:', message);
        alert('成功: ' + message);
    }
    
    // 取得狀態CSS類別
    function getStatusClass(status) {
        const statusMap = {
            '停利': 'bg-success',
            '停損': 'bg-danger',
            '強制出場': 'bg-warning',
            '手動出場': 'bg-info',
            '到期出場': 'bg-secondary',
            '未知': 'bg-secondary'
        };
        return statusMap[status] || 'bg-secondary';
    }
    
    // 下載詳細記錄
    function downloadDetailedRecords() {
        if (!window.lastBacktestParams) {
            alert('請先執行回測');
            return;
        }
        
        const params = window.lastBacktestParams;
        console.log('下載詳細記錄，參數:', params);
        
        // 先取得完整的交易記錄資料
        const requestData = {
            trade_records: params.trade_records || [],
            holding_positions: params.holding_positions || []
        };
        
        console.log('請求完整交易記錄資料:', requestData);
        console.log('原始交易記錄數量:', requestData.trade_records.length);
        console.log('原始持有部位數量:', requestData.holding_positions.length);
        if (requestData.trade_records.length > 0) {
            console.log('第一個交易記錄的欄位:', Object.keys(requestData.trade_records[0]));
            console.log('第一個交易記錄的欄位數量:', Object.keys(requestData.trade_records[0]).length);
            console.log('第一個交易記錄內容:', requestData.trade_records[0]);
        }
        if (requestData.holding_positions.length > 0) {
            console.log('第一個持有部位的欄位:', Object.keys(requestData.holding_positions[0]));
            console.log('第一個持有部位的欄位數量:', Object.keys(requestData.holding_positions[0]).length);
            console.log('第一個持有部位內容:', requestData.holding_positions[0]);
        }
        
        // 先呼叫 API 取得完整的交易記錄資料
        $.ajax({
            url: '/api/backtest/complete-trade-data',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(requestData),
            success: function(response) {
                if (response.success) {
                    console.log('取得完整交易記錄資料成功:', response);
                    
                    // 準備下載資料 - 使用完整的交易記錄資料
                    const downloadData = {
                        strategy_name: params.strategy_name,
                        price_source: params.price_source,
                        config: params.config,
                        complete_trade_records: response.complete_trade_records,
                        complete_holding_positions: response.complete_holding_positions
                    };
                    
                    console.log('準備下載的完整資料:', downloadData);
                    
                    // 發送下載請求
                    $.ajax({
                        url: '/api/backtest/export-detailed',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(downloadData),
                        xhrFields: {
                            responseType: 'blob'
                        },
                        success: function(blob, status, xhr) {
                            // 建立下載連結
                            const url = window.URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            
                            // 從回應標頭取得檔案名
                            const contentDisposition = xhr.getResponseHeader('Content-Disposition');
                            let filename = 'detailed_backtest_records.xlsx';
                            if (contentDisposition) {
                                const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                                if (filenameMatch && filenameMatch[1]) {
                                    filename = filenameMatch[1].replace(/['"]/g, '');
                                }
                            }
                            
                            link.download = filename;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            window.URL.revokeObjectURL(url);
                            
                            // showSuccess('詳細記錄下載成功');
                        },
                        error: function(xhr, status, error) {
                            console.error('下載詳細記錄失敗:', error);
                            showError('下載詳細記錄失敗: ' + (xhr.responseJSON?.detail || error));
                        }
                    });
                } else {
                    console.error('取得完整交易記錄資料失敗:', response);
                    showError('取得完整交易記錄資料失敗');
                }
            },
            error: function(xhr, status, error) {
                console.error('取得完整交易記錄資料失敗:', error);
                showError('取得完整交易記錄資料失敗: ' + (xhr.responseJSON?.detail || error));
            }
        });
    }
    
    // 載入資料結構定義
    async function loadDataStructure() {
        try {
            const response = await fetch('/api/backtest/data-structure');
            const data = await response.json();
            
            if (data.success) {
                tradeRecordFields = data.trade_record_fields;
                holdingPositionFields = data.holding_position_fields;
                console.log('載入欄位定義成功:', { tradeRecordFields, holdingPositionFields });
            } else {
                console.error('載入欄位定義失敗:', data);
            }
        } catch (error) {
            console.error('載入欄位定義時發生錯誤:', error);
        }
    }
    
    // ==================== 圖表相關函數 ====================
    
    // 全域變數
    let currentDrawdownView = 'separate'; // 'separate' 或 'merge'
    let currentDrawdownLayout = 'vertical';
    let currentChartMode = 'vertical'; // 'horizontal'（分頁）或'vertical'（全部顯示）

    // 切換圖表區域的展開/縮起
    window.toggleChartsSection = function() {
        const $body = $('#charts-body');
        const $icon = $('#charts-toggle-icon');
        
        if ($body.is(':visible')) {
            // 縮起圖表
            $body.slideUp(300);
            $icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
        } else {
            // 展開圖表
            $body.slideDown(300);
            $icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
        }
    };

    // 切換回落圖視圖
    window.toggleDrawdownView = function() {
        currentDrawdownView = currentDrawdownView === 'separate' ? 'merge' : 'separate';
        if(currentChartMode === 'vertical') {
            loadAllVerticalCharts();
        } else {
            loadDrawdownChart();
        }
    };

    // 切換排列模式
    $('#btn-vertical, #btn-vertical-vertical').click(function() {
        currentChartMode = 'vertical';
        $('#chartsTabContent').hide();
        $('#vertical-charts-container').show();
        $('.nav-tabs').hide(); // 新增：隱藏標籤列
        $('#btn-vertical, #btn-vertical-vertical').addClass('btn-primary').removeClass('btn-outline-info');
        $('#btn-horizontal, #btn-horizontal-vertical').addClass('btn-outline-info').removeClass('btn-primary');
        loadAllVerticalCharts();
    });
    $('#btn-horizontal, #btn-horizontal-vertical').click(function() {
        currentChartMode = 'horizontal';
        $('#vertical-charts-container').hide();
        $('#chartsTabContent').show();
        $('.nav-tabs').show(); // 新增：顯示標籤列
        $('#btn-horizontal, #btn-horizontal-vertical').addClass('btn-primary').removeClass('btn-outline-info');
        $('#btn-vertical, #btn-vertical-vertical').addClass('btn-outline-info').removeClass('btn-primary');
        window.refreshAllCharts();
    });

    // 頁面載入時設定預設狀態
    $(document).ready(function() {
        // 設定預設為垂直模式
        $('#btn-vertical-vertical').addClass('btn-primary').removeClass('btn-outline-info');
        $('#btn-horizontal-vertical').addClass('btn-outline-info').removeClass('btn-primary');
        $('.nav-tabs').hide(); // 新增：預設隱藏標籤列（上下排版）
    });

    // 載入所有圖表（vertical模式）
    function loadAllVerticalCharts() {
        if (!window.lastBacktestParams || !window.lastBacktestParams.trade_records) {
            showChartError('vertical-drawdown-chart', '沒有交易資料');
            showChartError('vertical-heatmap-chart', '沒有交易資料');
            showChartError('vertical-return-heatmap-chart', '沒有交易資料');
            showChartError('vertical-yearly-chart', '沒有交易資料');
            showChartError('vertical-trading-days-chart', '沒有交易資料');
            showChartError('vertical-trading-stocks-chart', '沒有交易資料');
            showChartError('vertical-win-rate-chart', '沒有交易資料');
            showChartError('vertical-weekday-chart', '沒有交易資料');
            return;
        }
        showChartLoading('vertical-drawdown-chart');
        showChartLoading('vertical-heatmap-chart');
        showChartLoading('vertical-return-heatmap-chart');
        showChartLoading('vertical-yearly-chart');
        showChartLoading('vertical-trading-days-chart');
        showChartLoading('vertical-trading-stocks-chart');
        showChartLoading('vertical-win-rate-chart');
        showChartLoading('vertical-weekday-chart');
        // 回落圖
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: currentDrawdownView === 'separate' ? 'drawdown' : 'drawdown_merge',
                trade_records: window.lastBacktestParams.trade_records,
                layout_mode: 'vertical'
            }),
            success: function(response) {
                if (response.success) {
                    $('#vertical-drawdown-chart').html(response.chart_html);
                } else {
                    showChartError('vertical-drawdown-chart', response.message || '載入回落圖失敗');
                }
            },
            error: function(xhr, status, error) {
                showChartError('vertical-drawdown-chart', '載入回落圖失敗: ' + (xhr.responseJSON?.detail || error));
            }
        });
        // 月損益熱力圖
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'heatmap',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#vertical-heatmap-chart').html(response.chart_html);
                } else {
                    showChartError('vertical-heatmap-chart', response.message || '載入熱力圖失敗');
                }
            },
            error: function(xhr, status, error) {
                showChartError('vertical-heatmap-chart', '載入熱力圖失敗: ' + (xhr.responseJSON?.detail || error));
            }
        });
        // 月收益率熱力圖
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'monthly_return_heatmap',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#vertical-return-heatmap-chart').html(response.chart_html);
                } else {
                    showChartError('vertical-return-heatmap-chart', response.message || '載入收益率圖失敗');
                }
            },
            error: function(xhr, status, error) {
                showChartError('vertical-return-heatmap-chart', '載入收益率圖失敗: ' + (xhr.responseJSON?.detail || error));
            }
        });
        // 年度損益
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'yearly_return_heatmap',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#vertical-yearly-chart').html(response.chart_html);
                } else {
                    showChartError('vertical-yearly-chart', response.message || '載入年度圖失敗');
                }
            },
            error: function(xhr, status, error) {
                showChartError('vertical-yearly-chart', '載入年度圖失敗: ' + (xhr.responseJSON?.detail || error));
            }
        });
        // 月交易天數
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'trading_days_heatmap',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#vertical-trading-days-chart').html(response.chart_html);
                } else {
                    showChartError('vertical-trading-days-chart', response.message || '載入交易天數圖失敗');
                }
            },
            error: function(xhr, status, error) {
                showChartError('vertical-trading-days-chart', '載入交易天數圖失敗: ' + (xhr.responseJSON?.detail || error));
            }
        });
        // 月交易股票數
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'trading_stocks_heatmap',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#vertical-trading-stocks-chart').html(response.chart_html);
                } else {
                    showChartError('vertical-trading-stocks-chart', response.message || '載入交易股票數圖失敗');
                }
            },
            error: function(xhr, status, error) {
                showChartError('vertical-trading-stocks-chart', '載入交易股票數圖失敗: ' + (xhr.responseJSON?.detail || error));
            }
        });
        // 月勝率
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'win_rate_heatmap',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#vertical-win-rate-chart').html(response.chart_html);
                } else {
                    showChartError('vertical-win-rate-chart', response.message || '載入勝率圖失敗');
                }
            },
            error: function(xhr, status, error) {
                showChartError('vertical-win-rate-chart', '載入勝率圖失敗: ' + (xhr.responseJSON?.detail || error));
            }
        });
        // 星期分析
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'weekday_analysis_charts',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#vertical-weekday-chart').html(response.chart_html);
                } else {
                    showChartError('vertical-weekday-chart', response.message || '載入星期分析圖失敗');
                }
            },
            error: function(xhr, status, error) {
                showChartError('vertical-weekday-chart', '載入星期分析圖失敗: ' + (xhr.responseJSON?.detail || error));
            }
        });
    }

    // 重新整理所有圖表
    window.refreshAllCharts = function() {
        if (!window.lastBacktestParams || !window.lastBacktestParams.trade_records) {
            alert('請先執行回測產生交易資料');
            return;
        }
        if(currentChartMode === 'vertical') {
            loadAllVerticalCharts();
            return;
        }
        // 顯示載入狀態
        showChartLoading('drawdown-chart-container');
        showChartLoading('heatmap-chart-container');
        showChartLoading('return-heatmap-chart-container');
        showChartLoading('yearly-chart-container');
        showChartLoading('trading-days-chart-container');
        showChartLoading('trading-stocks-chart-container');
        showChartLoading('win-rate-chart-container');
        showChartLoading('weekday-chart-container');
        // 載入所有圖表
        loadDrawdownChart();
        loadHeatmapChart();
        loadReturnHeatmapChart();
        loadYearlyChart();
        loadTradingDaysChart();
        loadTradingStocksChart();
        loadWinRateChart();
        loadWeekdayChart();
    };

    // 顯示圖表載入中狀態
    function showChartLoading(containerId) {
        const container = $(`#${containerId}`);
        container.html(`
            <div class="chart-loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">載入中...</span>
                </div>
                <p>載入圖表中...</p>
            </div>
        `);
    }
    
    // 顯示圖表錯誤狀態
    function showChartError(containerId, message) {
        const container = $(`#${containerId}`);
        container.html(`
            <div class="chart-error">
                <i class="fas fa-exclamation-triangle"></i>
                <p>${message}</p>
            </div>
        `);
    }
    
    // 載入回落圖
    function loadDrawdownChart() {
        if (!window.lastBacktestParams || !window.lastBacktestParams.trade_records) {
            showChartError('drawdown-chart-container', '沒有交易資料');
            return;
        }
        
        const chartType = currentDrawdownView === 'separate' ? 'drawdown' : 'drawdown_merge';
        
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: chartType,
                trade_records: window.lastBacktestParams.trade_records,
                layout_mode: currentDrawdownLayout
            }),
            success: function(response) {
                if (response.success) {
                    $('#drawdown-chart-container').html(response.chart_html);
                } else {
                    showChartError('drawdown-chart-container', response.message || '載入回落圖失敗');
                }
            },
            error: function(xhr, status, error) {
                console.error('載入回落圖失敗:', error);
                showChartError('drawdown-chart-container', '載入回落圖失敗: ' + (xhr.responseJSON?.detail || error));
            }
        });
    }
    
    // 載入月損益熱力圖
    function loadHeatmapChart() {
        if (!window.lastBacktestParams || !window.lastBacktestParams.trade_records) {
            showChartError('heatmap-chart-container', '沒有交易資料');
            return;
        }
        
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'heatmap',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#heatmap-chart-container').html(response.chart_html);
                } else {
                    showChartError('heatmap-chart-container', response.message || '載入熱力圖失敗');
                }
            },
            error: function(xhr, status, error) {
                console.error('載入熱力圖失敗:', error);
                showChartError('heatmap-chart-container', '載入熱力圖失敗: ' + (xhr.responseJSON?.detail || error));
            }
        });
    }
    
    // 載入月收益率熱力圖
    function loadReturnHeatmapChart() {
        if (!window.lastBacktestParams || !window.lastBacktestParams.trade_records) {
            showChartError('return-heatmap-chart-container', '沒有交易資料');
            return;
        }
        
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'monthly_return_heatmap',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#return-heatmap-chart-container').html(response.chart_html);
                } else {
                    showChartError('return-heatmap-chart-container', response.message || '載入收益率圖失敗');
                }
            },
            error: function(xhr, status, error) {
                console.error('載入收益率圖失敗:', error);
                showChartError('return-heatmap-chart-container', '載入收益率圖失敗: ' + (xhr.responseJSON?.detail || error));
            }
        });
    }
    
    // 載入年度損益圖
    function loadYearlyChart() {
        if (!window.lastBacktestParams || !window.lastBacktestParams.trade_records) {
            showChartError('yearly-chart-container', '沒有交易資料');
            return;
        }
        
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'yearly_return_heatmap',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#yearly-chart-container').html(response.chart_html);
                } else {
                    showChartError('yearly-chart-container', response.message || '載入年度圖失敗');
                }
            },
            error: function(xhr, status, error) {
                console.error('載入年度圖失敗:', error);
                showChartError('yearly-chart-container', '載入年度圖失敗: ' + (xhr.responseJSON?.detail || error));
            }
        });
    }
    
    // 載入月交易天數圖
    function loadTradingDaysChart() {
        if (!window.lastBacktestParams || !window.lastBacktestParams.trade_records) {
            showChartError('trading-days-chart-container', '沒有交易資料');
            return;
        }
        
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'trading_days_heatmap',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#trading-days-chart-container').html(response.chart_html);
                } else {
                    showChartError('trading-days-chart-container', response.message || '載入交易天數圖失敗');
                }
            },
            error: function(xhr, status, error) {
                console.error('載入交易天數圖失敗:', error);
                showChartError('trading-days-chart-container', '載入交易天數圖失敗: ' + (xhr.responseJSON?.detail || error));
            }
        });
    }
    
    // 載入月交易股票數圖
    function loadTradingStocksChart() {
        if (!window.lastBacktestParams || !window.lastBacktestParams.trade_records) {
            showChartError('trading-stocks-chart-container', '沒有交易資料');
            return;
        }
        
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'trading_stocks_heatmap',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#trading-stocks-chart-container').html(response.chart_html);
                } else {
                    showChartError('trading-stocks-chart-container', response.message || '載入交易股票數圖失敗');
                }
            },
            error: function(xhr, status, error) {
                console.error('載入交易股票數圖失敗:', error);
                showChartError('trading-stocks-chart-container', '載入交易股票數圖失敗: ' + (xhr.responseJSON?.detail || error));
            }
        });
    }
    
    // 載入月勝率圖
    function loadWinRateChart() {
        if (!window.lastBacktestParams || !window.lastBacktestParams.trade_records) {
            showChartError('win-rate-chart-container', '沒有交易資料');
            return;
        }
        
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'win_rate_heatmap',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#win-rate-chart-container').html(response.chart_html);
                } else {
                    showChartError('win-rate-chart-container', response.message || '載入勝率圖失敗');
                }
            },
            error: function(xhr, status, error) {
                console.error('載入勝率圖失敗:', error);
                showChartError('win-rate-chart-container', '載入勝率圖失敗: ' + (xhr.responseJSON?.detail || error));
            }
        });
    }
    
    // 載入星期分析圖
    function loadWeekdayChart() {
        if (!window.lastBacktestParams || !window.lastBacktestParams.trade_records) {
            showChartError('weekday-chart-container', '沒有交易資料');
            return;
        }
        
        $.ajax({
            url: '/api/backtest/charts',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                chart_type: 'weekday_analysis_charts',
                trade_records: window.lastBacktestParams.trade_records
            }),
            success: function(response) {
                if (response.success) {
                    $('#weekday-chart-container').html(response.chart_html);
                } else {
                    showChartError('weekday-chart-container', response.message || '載入星期分析圖失敗');
                }
            },
            error: function(xhr, status, error) {
                console.error('載入星期分析圖失敗:', error);
                showChartError('weekday-chart-container', '載入星期分析圖失敗: ' + (xhr.responseJSON?.detail || error));
            }
        });
    }
});
</script>
{% endblock %} 