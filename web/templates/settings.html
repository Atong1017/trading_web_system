{% extends "base.html" %}

{% block title %}ç³»çµ±è¨­å®š{% endblock %}

{% block feature_nav %}
<div class="feature-nav">
    <h4><i class="fas fa-compass"></i> åŠŸèƒ½å€å°èˆª</h4>
    <!-- ç³»çµ±è¨­å®šåŠŸèƒ½å€ -->
    <div class="feature-section">
        <h5><i class="fas fa-cog"></i> ç³»çµ±è¨­å®šåŠŸèƒ½</h5>
        <div class="feature-links">
            <a href="/settings#api-settings" class="feature-link">APIè¨­å®šğŸ”Œ</a>
            <a href="/settings#trading-settings" class="feature-link">äº¤æ˜“è¨­å®šğŸ’°</a>
            <a href="/settings#system-settings" class="feature-link">ç³»çµ±è¨­å®šâš™ï¸</a>
            <a href="/settings#backup-settings" class="feature-link">å‚™ä»½è¨­å®šğŸ’¾</a>
        </div>
    </div>    
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-cogs"></i> ç³»çµ±è¨­å®š
            </h2>
        </div>
    </div>

    <!-- è¨­å®šå°èˆª -->
    <div class="row mb-4">
        <div class="col-12">
            <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="api-tab" data-toggle="tab" href="#api-settings" role="tab">
                        <i class="fas fa-plug"></i> APIè¨­å®š
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="trading-tab" data-toggle="tab" href="#trading-settings" role="tab">
                        <i class="fas fa-chart-line"></i> äº¤æ˜“è¨­å®š
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="system-tab" data-toggle="tab" href="#system-settings" role="tab">
                        <i class="fas fa-server"></i> ç³»çµ±è¨­å®š
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="backup-tab" data-toggle="tab" href="#backup-settings" role="tab">
                        <i class="fas fa-database"></i> å‚™ä»½è¨­å®š
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- è¨­å®šå…§å®¹ -->
    <div class="tab-content" id="settingsTabContent">
        <!-- APIè¨­å®š -->
        <div class="tab-pane fade show active" id="api-settings" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-plug"></i> è‚¡ç¥¨è³‡æ–™APIè¨­å®š</h5>
                        </div>
                        <div class="card-body">
                            <form id="stock-api-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="stock-api-provider">APIæä¾›è€…</label>
                                            <select class="form-control" id="stock-api-provider" required>
                                                <option value="twse">å°ç£è­‰åˆ¸äº¤æ˜“æ‰€</option>
                                                <option value="tpex">æ«ƒè²·ä¸­å¿ƒ</option>
                                                <option value="yahoo">Yahoo Finance</option>
                                                <option value="custom">è‡ªè¨‚API</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="stock-api-key">APIé‡‘é‘°</label>
                                            <input type="password" class="form-control" id="stock-api-key" 
                                                   placeholder="è«‹è¼¸å…¥APIé‡‘é‘°">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="stock-api-url">APIç¶²å€</label>
                                            <input type="url" class="form-control" id="stock-api-url" 
                                                   placeholder="https://api.example.com">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="stock-api-timeout">è«‹æ±‚è¶…æ™‚(ç§’)</label>
                                            <input type="number" class="form-control" id="stock-api-timeout" 
                                                   value="30" min="5" max="300">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> å„²å­˜è‚¡ç¥¨APIè¨­å®š
                                        </button>
                                        <button type="button" class="btn btn-info" id="test-stock-api">
                                            <i class="fas fa-test-tube"></i> æ¸¬è©¦é€£ç·š
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-university"></i> åˆ¸å•†APIè¨­å®š</h5>
                        </div>
                        <div class="card-body">
                            <form id="broker-api-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="broker-provider">åˆ¸å•†</label>
                                            <select class="form-control" id="broker-provider" required>
                                                <option value="">è«‹é¸æ“‡åˆ¸å•†</option>
                                                <option value="fugle">å¯Œæœè­‰åˆ¸</option>
                                                <option value="sinopac">æ°¸è±é‡‘è­‰åˆ¸</option>
                                                <option value="kgi">å‡±åŸºè­‰åˆ¸</option>
                                                <option value="yuanta">å…ƒå¤§è­‰åˆ¸</option>
                                                <option value="custom">è‡ªè¨‚åˆ¸å•†</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="broker-api-key">APIé‡‘é‘°</label>
                                            <input type="password" class="form-control" id="broker-api-key" 
                                                   placeholder="è«‹è¼¸å…¥åˆ¸å•†APIé‡‘é‘°" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="broker-secret">APIå¯†é‘°</label>
                                            <input type="password" class="form-control" id="broker-secret" 
                                                   placeholder="è«‹è¼¸å…¥APIå¯†é‘°" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="broker-account">å¸³è™Ÿ</label>
                                            <input type="text" class="form-control" id="broker-account" 
                                                   placeholder="è«‹è¼¸å…¥äº¤æ˜“å¸³è™Ÿ" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="broker-api-url">APIç¶²å€</label>
                                            <input type="url" class="form-control" id="broker-api-url" 
                                                   placeholder="https://api.broker.com">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="broker-environment">ç’°å¢ƒ</label>
                                            <select class="form-control" id="broker-environment">
                                                <option value="production">æ­£å¼ç’°å¢ƒ</option>
                                                <option value="sandbox">æ¸¬è©¦ç’°å¢ƒ</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> å„²å­˜åˆ¸å•†APIè¨­å®š
                                        </button>
                                        <button type="button" class="btn btn-info" id="test-broker-api">
                                            <i class="fas fa-test-tube"></i> æ¸¬è©¦é€£ç·š
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- äº¤æ˜“è¨­å®š -->
        <div class="tab-pane fade" id="trading-settings" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-chart-line"></i> äº¤æ˜“åƒæ•¸è¨­å®š</h5>
                        </div>
                        <div class="card-body">
                            <form id="trading-params-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="default-commission">é è¨­æ‰‹çºŒè²»ç‡(%)</label>
                                            <input type="number" class="form-control" id="default-commission" 
                                                   value="0.1425" min="0" max="1" step="0.0001">
                                            <small class="form-text text-muted">é è¨­ç‚º0.1425%</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="min-commission">æœ€ä½æ‰‹çºŒè²»</label>
                                            <input type="number" class="form-control" id="min-commission" 
                                                   value="20" min="0" step="1">
                                            <small class="form-text text-muted">é è¨­ç‚º20å…ƒ</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="securities-tax">è­‰äº¤ç¨…ç‡(%)</label>
                                            <input type="number" class="form-control" id="securities-tax" 
                                                   value="0.3" min="0" max="1" step="0.01">
                                            <small class="form-text text-muted">é è¨­ç‚º0.3%</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="default-capital">é è¨­åˆå§‹è³‡é‡‘</label>
                                            <input type="number" class="form-control" id="default-capital" 
                                                   value="1000000" min="10000" step="10000">
                                            <small class="form-text text-muted">é è¨­ç‚º100è¬å…ƒ</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="max-positions">æœ€å¤§åŒæ™‚æŒå€‰æ•¸</label>
                                            <input type="number" class="form-control" id="max-positions" 
                                                   value="5" min="1" max="20">
                                            <small class="form-text text-muted">é è¨­ç‚º5å€‹</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="risk-per-trade">æ¯ç­†äº¤æ˜“é¢¨éšªæ¯”ä¾‹(%)</label>
                                            <input type="number" class="form-control" id="risk-per-trade" 
                                                   value="2" min="0.1" max="10" step="0.1">
                                            <small class="form-text text-muted">é è¨­ç‚º2%</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> å„²å­˜äº¤æ˜“åƒæ•¸
                                        </button>
                                        <button type="button" class="btn btn-secondary" id="reset-trading-params">
                                            <i class="fas fa-undo"></i> é‡ç½®ç‚ºé è¨­å€¼
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç³»çµ±è¨­å®š -->
        <div class="tab-pane fade" id="system-settings" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-server"></i> ç³»çµ±åƒæ•¸è¨­å®š</h5>
                        </div>
                        <div class="card-body">
                            <form id="system-params-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="log-level">æ—¥èªŒç­‰ç´š</label>
                                            <select class="form-control" id="log-level">
                                                <option value="DEBUG">DEBUG</option>
                                                <option value="INFO" selected>INFO</option>
                                                <option value="WARNING">WARNING</option>
                                                <option value="ERROR">ERROR</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="max-log-files">æœ€å¤§æ—¥èªŒæª”æ¡ˆæ•¸</label>
                                            <input type="number" class="form-control" id="max-log-files" 
                                                   value="10" min="1" max="100">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="session-timeout">æœƒè©±è¶…æ™‚æ™‚é–“(åˆ†é˜)</label>
                                            <input type="number" class="form-control" id="session-timeout" 
                                                   value="30" min="5" max="480">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="max-upload-size">æœ€å¤§ä¸Šå‚³æª”æ¡ˆå¤§å°(MB)</label>
                                            <input type="number" class="form-control" id="max-upload-size" 
                                                   value="50" min="1" max="500">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="auto-cleanup-days">è‡ªå‹•æ¸…ç†å¤©æ•¸</label>
                                            <input type="number" class="form-control" id="auto-cleanup-days" 
                                                   value="30" min="1" max="365">
                                            <small class="form-text text-muted">è¶…éæŒ‡å®šå¤©æ•¸çš„æª”æ¡ˆå°‡è¢«è‡ªå‹•æ¸…ç†</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="enable-notifications">å•Ÿç”¨é€šçŸ¥</label>
                                            <div class="custom-control custom-switch">
                                                <input type="checkbox" class="custom-control-input" id="enable-notifications" checked>
                                                <label class="custom-control-label" for="enable-notifications">å•Ÿç”¨ç³»çµ±é€šçŸ¥</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> å„²å­˜ç³»çµ±åƒæ•¸
                                        </button>
                                        <button type="button" class="btn btn-warning" id="restart-system">
                                            <i class="fas fa-redo"></i> é‡æ–°å•Ÿå‹•ç³»çµ±
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å‚™ä»½è¨­å®š -->
        <div class="tab-pane fade" id="backup-settings" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-database"></i> è³‡æ–™å‚™ä»½è¨­å®š</h5>
                        </div>
                        <div class="card-body">
                            <form id="backup-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="backup-frequency">å‚™ä»½é »ç‡</label>
                                            <select class="form-control" id="backup-frequency">
                                                <option value="daily">æ¯æ—¥</option>
                                                <option value="weekly" selected>æ¯é€±</option>
                                                <option value="monthly">æ¯æœˆ</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="backup-time">å‚™ä»½æ™‚é–“</label>
                                            <input type="time" class="form-control" id="backup-time" value="02:00">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="backup-retention">ä¿ç•™å¤©æ•¸</label>
                                            <input type="number" class="form-control" id="backup-retention" 
                                                   value="30" min="1" max="365">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="backup-path">å‚™ä»½è·¯å¾‘</label>
                                            <input type="text" class="form-control" id="backup-path" 
                                                   value="./backups" placeholder="è«‹è¼¸å…¥å‚™ä»½è·¯å¾‘">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> å„²å­˜å‚™ä»½è¨­å®š
                                        </button>
                                        <button type="button" class="btn btn-success" id="create-backup">
                                            <i class="fas fa-download"></i> ç«‹å³å»ºç«‹å‚™ä»½
                                        </button>
                                        <button type="button" class="btn btn-info" id="restore-backup">
                                            <i class="fas fa-upload"></i> é‚„åŸå‚™ä»½
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-history"></i> å‚™ä»½æ­·å²</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>å‚™ä»½æ™‚é–“</th>
                                            <th>æª”æ¡ˆå¤§å°</th>
                                            <th>ç‹€æ…‹</th>
                                            <th>æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="backup-history">
                                        <!-- å‹•æ…‹è¼‰å…¥å‚™ä»½æ­·å² -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç¢ºèªå°è©±æ¡† -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ç¢ºèªæ“ä½œ</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="confirm-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="confirm-btn">ç¢ºèª</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // åˆå§‹åŒ–é é¢
    initializePage();
    
    // è¼‰å…¥è¨­å®š
    loadSettings();
    
    // è¡¨å–®æäº¤äº‹ä»¶
    $('#stock-api-form').submit(function(e) {
        e.preventDefault();
        saveStockAPISettings();
    });
    
    $('#broker-api-form').submit(function(e) {
        e.preventDefault();
        saveBrokerAPISettings();
    });
    
    $('#trading-params-form').submit(function(e) {
        e.preventDefault();
        saveTradingSettings();
    });
    
    $('#system-params-form').submit(function(e) {
        e.preventDefault();
        saveSystemSettings();
    });
    
    $('#backup-form').submit(function(e) {
        e.preventDefault();
        saveBackupSettings();
    });
    
    // æ¸¬è©¦é€£ç·š
    $('#test-stock-api').click(function() {
        testStockAPIConnection();
    });
    
    $('#test-broker-api').click(function() {
        testBrokerAPIConnection();
    });
    
    // å…¶ä»–æŒ‰éˆ•äº‹ä»¶
    $('#reset-trading-params').click(function() {
        resetTradingParams();
    });
    
    $('#restart-system').click(function() {
        showConfirmDialog('ç¢ºå®šè¦é‡æ–°å•Ÿå‹•ç³»çµ±å—ï¼Ÿé€™å°‡ä¸­æ–·æ‰€æœ‰æ­£åœ¨é€²è¡Œçš„æ“ä½œã€‚', function() {
            restartSystem();
        });
    });
    
    $('#create-backup').click(function() {
        createBackup();
    });
    
    $('#restore-backup').click(function() {
        showRestoreBackupDialog();
    });
    
    function initializePage() {
        console.log('è¨­å®šé é¢åˆå§‹åŒ–å®Œæˆ');
    }
    
    function loadSettings() {
        // è¼‰å…¥è‚¡ç¥¨APIè¨­å®š
        $.get('/api/settings/stock-api')
            .done(function(response) {
                if (response.status === 'success') {
                    const settings = response.settings;
                    $('#stock-api-provider').val(settings.provider || 'twse');
                    $('#stock-api-url').val(settings.url || '');
                    $('#stock-api-timeout').val(settings.timeout || 30);
                }
            })
            .fail(function(xhr) {
                console.error('è¼‰å…¥è‚¡ç¥¨APIè¨­å®šå¤±æ•—:', xhr.responseText);
            });
        
        // è¼‰å…¥åˆ¸å•†APIè¨­å®š
        $.get('/api/settings/broker-api')
            .done(function(response) {
                if (response.status === 'success') {
                    const settings = response.settings;
                    $('#broker-provider').val(settings.provider || '');
                    $('#broker-api-url').val(settings.url || '');
                    $('#broker-environment').val(settings.environment || 'production');
                }
            })
            .fail(function(xhr) {
                console.error('è¼‰å…¥åˆ¸å•†APIè¨­å®šå¤±æ•—:', xhr.responseText);
            });
        
        // è¼‰å…¥äº¤æ˜“åƒæ•¸è¨­å®š
        $.get('/api/settings/trading')
            .done(function(response) {
                if (response.status === 'success') {
                    const settings = response.settings;
                    $('#default-commission').val(settings.default_commission || 0.1425);
                    $('#min-commission').val(settings.min_commission || 20);
                    $('#securities-tax').val(settings.securities_tax || 0.3);
                    $('#default-capital').val(settings.default_capital || 1000000);
                    $('#max-positions').val(settings.max_positions || 5);
                    $('#risk-per-trade').val(settings.risk_per_trade || 2);
                }
            })
            .fail(function(xhr) {
                console.error('è¼‰å…¥äº¤æ˜“åƒæ•¸è¨­å®šå¤±æ•—:', xhr.responseText);
            });
        
        // è¼‰å…¥ç³»çµ±åƒæ•¸è¨­å®š
        $.get('/api/settings/system')
            .done(function(response) {
                if (response.status === 'success') {
                    const settings = response.settings;
                    $('#log-level').val(settings.log_level || 'INFO');
                    $('#max-log-files').val(settings.max_log_files || 10);
                    $('#session-timeout').val(settings.session_timeout || 30);
                    $('#max-upload-size').val(settings.max_upload_size || 50);
                    $('#auto-cleanup-days').val(settings.auto_cleanup_days || 30);
                    $('#enable-notifications').prop('checked', settings.enable_notifications !== false);
                }
            })
            .fail(function(xhr) {
                console.error('è¼‰å…¥ç³»çµ±åƒæ•¸è¨­å®šå¤±æ•—:', xhr.responseText);
            });
        
        // è¼‰å…¥å‚™ä»½è¨­å®š
        $.get('/api/settings/backup')
            .done(function(response) {
                if (response.status === 'success') {
                    const settings = response.settings;
                    $('#backup-frequency').val(settings.frequency || 'weekly');
                    $('#backup-time').val(settings.time || '02:00');
                    $('#backup-retention').val(settings.retention || 30);
                    $('#backup-path').val(settings.path || './backups');
                }
            })
            .fail(function(xhr) {
                console.error('è¼‰å…¥å‚™ä»½è¨­å®šå¤±æ•—:', xhr.responseText);
            });
        
        // è¼‰å…¥å‚™ä»½æ­·å²
        loadBackupHistory();
    }
    
    function saveStockAPISettings() {
        const settings = {
            provider: $('#stock-api-provider').val(),
            api_key: $('#stock-api-key').val(),
            url: $('#stock-api-url').val(),
            timeout: parseInt($('#stock-api-timeout').val())
        };
        
        $.post('/api/settings/stock-api', settings)
            .done(function(response) {
                if (response.status === 'success') {
                    showSuccess('è‚¡ç¥¨APIè¨­å®šå·²å„²å­˜');
                }
            })
            .fail(function(xhr) {
                showError('å„²å­˜è‚¡ç¥¨APIè¨­å®šå¤±æ•—: ' + xhr.responseText);
            });
    }
    
    function saveBrokerAPISettings() {
        const settings = {
            provider: $('#broker-provider').val(),
            api_key: $('#broker-api-key').val(),
            secret: $('#broker-secret').val(),
            account: $('#broker-account').val(),
            url: $('#broker-api-url').val(),
            environment: $('#broker-environment').val()
        };
        
        $.post('/api/settings/broker-api', settings)
            .done(function(response) {
                if (response.status === 'success') {
                    showSuccess('åˆ¸å•†APIè¨­å®šå·²å„²å­˜');
                }
            })
            .fail(function(xhr) {
                showError('å„²å­˜åˆ¸å•†APIè¨­å®šå¤±æ•—: ' + xhr.responseText);
            });
    }
    
    function saveTradingSettings() {
        const settings = {
            default_commission: parseFloat($('#default-commission').val()),
            min_commission: parseInt($('#min-commission').val()),
            securities_tax: parseFloat($('#securities-tax').val()),
            default_capital: parseInt($('#default-capital').val()),
            max_positions: parseInt($('#max-positions').val()),
            risk_per_trade: parseFloat($('#risk-per-trade').val())
        };
        
        $.post('/api/settings/trading', settings)
            .done(function(response) {
                if (response.status === 'success') {
                    showSuccess('äº¤æ˜“åƒæ•¸è¨­å®šå·²å„²å­˜');
                }
            })
            .fail(function(xhr) {
                showError('å„²å­˜äº¤æ˜“åƒæ•¸è¨­å®šå¤±æ•—: ' + xhr.responseText);
            });
    }
    
    function saveSystemSettings() {
        const settings = {
            log_level: $('#log-level').val(),
            max_log_files: parseInt($('#max-log-files').val()),
            session_timeout: parseInt($('#session-timeout').val()),
            max_upload_size: parseInt($('#max-upload-size').val()),
            auto_cleanup_days: parseInt($('#auto-cleanup-days').val()),
            enable_notifications: $('#enable-notifications').is(':checked')
        };
        
        $.post('/api/settings/system', settings)
            .done(function(response) {
                if (response.status === 'success') {
                    showSuccess('ç³»çµ±åƒæ•¸è¨­å®šå·²å„²å­˜');
                }
            })
            .fail(function(xhr) {
                showError('å„²å­˜ç³»çµ±åƒæ•¸è¨­å®šå¤±æ•—: ' + xhr.responseText);
            });
    }
    
    function saveBackupSettings() {
        const settings = {
            frequency: $('#backup-frequency').val(),
            time: $('#backup-time').val(),
            retention: parseInt($('#backup-retention').val()),
            path: $('#backup-path').val()
        };
        
        $.post('/api/settings/backup', settings)
            .done(function(response) {
                if (response.status === 'success') {
                    showSuccess('å‚™ä»½è¨­å®šå·²å„²å­˜');
                }
            })
            .fail(function(xhr) {
                showError('å„²å­˜å‚™ä»½è¨­å®šå¤±æ•—: ' + xhr.responseText);
            });
    }
    
    function testStockAPIConnection() {
        const settings = {
            provider: $('#stock-api-provider').val(),
            api_key: $('#stock-api-key').val(),
            url: $('#stock-api-url').val(),
            timeout: parseInt($('#stock-api-timeout').val())
        };
        
        $.post('/api/settings/test-stock-api', settings)
            .done(function(response) {
                if (response.status === 'success') {
                    showSuccess('è‚¡ç¥¨APIé€£ç·šæ¸¬è©¦æˆåŠŸ');
                }
            })
            .fail(function(xhr) {
                showError('è‚¡ç¥¨APIé€£ç·šæ¸¬è©¦å¤±æ•—: ' + xhr.responseText);
            });
    }
    
    function testBrokerAPIConnection() {
        const settings = {
            provider: $('#broker-provider').val(),
            api_key: $('#broker-api-key').val(),
            secret: $('#broker-secret').val(),
            account: $('#broker-account').val(),
            url: $('#broker-api-url').val(),
            environment: $('#broker-environment').val()
        };
        
        $.post('/api/settings/test-broker-api', settings)
            .done(function(response) {
                if (response.status === 'success') {
                    showSuccess('åˆ¸å•†APIé€£ç·šæ¸¬è©¦æˆåŠŸ');
                }
            })
            .fail(function(xhr) {
                showError('åˆ¸å•†APIé€£ç·šæ¸¬è©¦å¤±æ•—: ' + xhr.responseText);
            });
    }
    
    function resetTradingParams() {
        $('#default-commission').val(0.1425);
        $('#min-commission').val(20);
        $('#securities-tax').val(0.3);
        $('#default-capital').val(1000000);
        $('#max-positions').val(5);
        $('#risk-per-trade').val(2);
        
        showSuccess('äº¤æ˜“åƒæ•¸å·²é‡ç½®ç‚ºé è¨­å€¼');
    }
    
    function restartSystem() {
        $.post('/api/system/restart')
            .done(function(response) {
                if (response.status === 'success') {
                    showSuccess('ç³»çµ±é‡æ–°å•Ÿå‹•ä¸­ï¼Œè«‹ç¨å€™...');
                    setTimeout(function() {
                        window.location.reload();
                    }, 3000);
                }
            })
            .fail(function(xhr) {
                showError('é‡æ–°å•Ÿå‹•ç³»çµ±å¤±æ•—: ' + xhr.responseText);
            });
    }
    
    function createBackup() {
        $.post('/api/backup/create')
            .done(function(response) {
                if (response.status === 'success') {
                    showSuccess('å‚™ä»½å»ºç«‹æˆåŠŸ');
                    loadBackupHistory();
                }
            })
            .fail(function(xhr) {
                showError('å»ºç«‹å‚™ä»½å¤±æ•—: ' + xhr.responseText);
            });
    }
    
    function loadBackupHistory() {
        $.get('/api/backup/history')
            .done(function(response) {
                if (response.status === 'success') {
                    renderBackupHistory(response.backups);
                }
            })
            .fail(function(xhr) {
                console.error('è¼‰å…¥å‚™ä»½æ­·å²å¤±æ•—:', xhr.responseText);
            });
    }
    
    function renderBackupHistory(backups) {
        const tbody = $('#backup-history');
        tbody.empty();
        
        if (backups.length === 0) {
            tbody.append('<tr><td colspan="4" class="text-center text-muted">å°šç„¡å‚™ä»½è¨˜éŒ„</td></tr>');
            return;
        }
        
        backups.forEach(function(backup) {
            const row = $('<tr></tr>');
            row.append(`<td>${formatDateTime(backup.created_at)}</td>`);
            row.append(`<td>${formatFileSize(backup.size)}</td>`);
            row.append(`<td><span class="badge badge-${backup.status === 'success' ? 'success' : 'danger'}">${backup.status === 'success' ? 'æˆåŠŸ' : 'å¤±æ•—'}</span></td>`);
            row.append(`<td>
                <button class="btn btn-sm btn-info" onclick="downloadBackup('${backup.filename}')">
                    <i class="fas fa-download"></i> ä¸‹è¼‰
                </button>
                <button class="btn btn-sm btn-warning" onclick="restoreBackup('${backup.filename}')">
                    <i class="fas fa-upload"></i> é‚„åŸ
                </button>
            </td>`);
            tbody.append(row);
        });
    }
    
    function formatDateTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('zh-TW');
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function showConfirmDialog(message, callback) {
        $('#confirm-message').text(message);
        $('#confirm-btn').off('click').on('click', function() {
            $('#confirmModal').modal('hide');
            callback();
        });
        $('#confirmModal').modal('show');
    }
    
    function showSuccess(message) {
        showAlert('success', message);
    }
    
    function showError(message) {
        showAlert('danger', message);
    }
    
    function showAlert(type, message) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        `;
        $('.container-fluid').prepend(alertHtml);
        
        // è‡ªå‹•ç§»é™¤è­¦å‘Š
        setTimeout(function() {
            $('.alert').alert('close');
        }, 5000);
    }
});

// å…¨åŸŸå‡½æ•¸
function downloadBackup(filename) {
    window.open(`/api/backup/download/${filename}`, '_blank');
}

function restoreBackup(filename) {
    if (confirm('ç¢ºå®šè¦é‚„åŸæ­¤å‚™ä»½å—ï¼Ÿé€™å°‡è¦†è“‹ç›®å‰çš„è³‡æ–™ã€‚')) {
        $.post(`/api/backup/restore/${filename}`)
            .done(function(response) {
                if (response.status === 'success') {
                    alert('å‚™ä»½é‚„åŸæˆåŠŸï¼Œç³»çµ±å°‡é‡æ–°å•Ÿå‹•');
                    setTimeout(function() {
                        window.location.reload();
                    }, 2000);
                }
            })
            .fail(function(xhr) {
                alert('å‚™ä»½é‚„åŸå¤±æ•—: ' + xhr.responseText);
            });
    }
}
</script>
{% endblock %} 