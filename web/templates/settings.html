{% extends "base.html" %}

{% block title %}Á≥ªÁµ±Ë®≠ÂÆö{% endblock %}

{% block feature_nav %}
<div class="feature-nav">
    <h4><i class="fas fa-compass"></i> ÂäüËÉΩÂçÄÂ∞éËà™</h4>
    <!-- Á≥ªÁµ±Ë®≠ÂÆöÂäüËÉΩÂçÄ -->
    <div class="feature-section">
        <h5><i class="fas fa-cog"></i> Á≥ªÁµ±Ë®≠ÂÆöÂäüËÉΩ</h5>
        <div class="feature-links">
            <a href="/settings#api-settings" class="feature-link">APIË®≠ÂÆöüîå</a>
            <a href="/settings#trading-settings" class="feature-link">‰∫§ÊòìË®≠ÂÆöüí∞</a>
            <a href="/settings#system-settings" class="feature-link">Á≥ªÁµ±Ë®≠ÂÆö‚öôÔ∏è</a>
            <a href="/settings#backup-settings" class="feature-link">ÂÇô‰ªΩË®≠ÂÆöüíæ</a>
        </div>
    </div>    
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-cogs"></i> Á≥ªÁµ±Ë®≠ÂÆö
            </h2>
        </div>
    </div>

    <!-- Ë®≠ÂÆöÂ∞éËà™ -->
    <div class="row mb-4">
        <div class="col-12">
            <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="api-tab" data-toggle="tab" href="#api-settings" role="tab">
                        <i class="fas fa-plug"></i> APIË®≠ÂÆö
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="trading-tab" data-toggle="tab" href="#trading-settings" role="tab">
                        <i class="fas fa-chart-line"></i> ‰∫§ÊòìË®≠ÂÆö
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="system-tab" data-toggle="tab" href="#system-settings" role="tab">
                        <i class="fas fa-server"></i> Á≥ªÁµ±Ë®≠ÂÆö
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="backup-tab" data-toggle="tab" href="#backup-settings" role="tab">
                        <i class="fas fa-database"></i> ÂÇô‰ªΩË®≠ÂÆö
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Ë®≠ÂÆöÂÖßÂÆπ -->
    <div class="tab-content" id="settingsTabContent">
        <!-- APIË®≠ÂÆö -->
        <div class="tab-pane fade show active" id="api-settings" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-plug"></i> ËÇ°Á•®Ë≥áÊñôAPIË®≠ÂÆö</h5>
                        </div>
                        <div class="card-body">
                            <form id="stock-api-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="stock-api-provider">APIÊèê‰æõËÄÖ</label>
                                            <select class="form-control" id="stock-api-provider" required>
                                                <option value="twse">Âè∞ÁÅ£Ë≠âÂà∏‰∫§ÊòìÊâÄ</option>
                                                <option value="tpex">Ê´ÉË≤∑‰∏≠ÂøÉ</option>
                                                <option value="yahoo">Yahoo Finance</option>
                                                <option value="custom">Ëá™Ë®ÇAPI</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="stock-api-key">APIÈáëÈë∞</label>
                                            <input type="password" class="form-control" id="stock-api-key" 
                                                   placeholder="Ë´ãËº∏ÂÖ•APIÈáëÈë∞">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="stock-api-url">APIÁ∂≤ÂùÄ</label>
                                            <input type="url" class="form-control" id="stock-api-url" 
                                                   placeholder="https://api.example.com">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="stock-api-timeout">Ë´ãÊ±ÇË∂ÖÊôÇ(Áßí)</label>
                                            <input type="number" class="form-control" id="stock-api-timeout" 
                                                   value="30" min="5" max="300">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> ÂÑ≤Â≠òËÇ°Á•®APIË®≠ÂÆö
                                        </button>
                                        <button type="button" class="btn btn-info" id="test-stock-api">
                                            <i class="fas fa-test-tube"></i> Ê∏¨Ë©¶ÈÄ£Á∑ö
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-university"></i> Âà∏ÂïÜAPIË®≠ÂÆö</h5>
                        </div>
                        <div class="card-body">
                            <form id="broker-api-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="broker-provider">Âà∏ÂïÜ</label>
                                            <select class="form-control" id="broker-provider" required>
                                                <option value="">Ë´ãÈÅ∏ÊìáÂà∏ÂïÜ</option>
                                                <option value="fugle">ÂØåÊûúË≠âÂà∏</option>
                                                <option value="sinopac">Ê∞∏Ë±êÈáëË≠âÂà∏</option>
                                                <option value="kgi">Âá±Âü∫Ë≠âÂà∏</option>
                                                <option value="yuanta">ÂÖÉÂ§ßË≠âÂà∏</option>
                                                <option value="custom">Ëá™Ë®ÇÂà∏ÂïÜ</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="broker-api-key">APIÈáëÈë∞</label>
                                            <input type="password" class="form-control" id="broker-api-key" 
                                                   placeholder="Ë´ãËº∏ÂÖ•Âà∏ÂïÜAPIÈáëÈë∞" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="broker-secret">APIÂØÜÈë∞</label>
                                            <input type="password" class="form-control" id="broker-secret" 
                                                   placeholder="Ë´ãËº∏ÂÖ•APIÂØÜÈë∞" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="broker-account">Â∏≥Ëôü</label>
                                            <input type="text" class="form-control" id="broker-account" 
                                                   placeholder="Ë´ãËº∏ÂÖ•‰∫§ÊòìÂ∏≥Ëôü" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="broker-api-url">APIÁ∂≤ÂùÄ</label>
                                            <input type="url" class="form-control" id="broker-api-url" 
                                                   placeholder="https://api.broker.com">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="broker-environment">Áí∞Â¢É</label>
                                            <select class="form-control" id="broker-environment">
                                                <option value="production">Ê≠£ÂºèÁí∞Â¢É</option>
                                                <option value="sandbox">Ê∏¨Ë©¶Áí∞Â¢É</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> ÂÑ≤Â≠òÂà∏ÂïÜAPIË®≠ÂÆö
                                        </button>
                                        <button type="button" class="btn btn-info" id="test-broker-api">
                                            <i class="fas fa-test-tube"></i> Ê∏¨Ë©¶ÈÄ£Á∑ö
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‰∫§ÊòìË®≠ÂÆö -->
        <div class="tab-pane fade" id="trading-settings" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-chart-line"></i> ‰∫§ÊòìÂèÉÊï∏Ë®≠ÂÆö</h5>
                        </div>
                        <div class="card-body">
                            <form id="trading-params-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="default-commission">È†êË®≠ÊâãÁ∫åË≤ªÁéá(%)</label>
                                            <input type="number" class="form-control" id="default-commission" 
                                                   value="0.1425" min="0" max="1" step="0.0001">
                                            <small class="form-text text-muted">È†êË®≠ÁÇ∫0.1425%</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="min-commission">ÊúÄ‰ΩéÊâãÁ∫åË≤ª</label>
                                            <input type="number" class="form-control" id="min-commission" 
                                                   value="20" min="0" step="1">
                                            <small class="form-text text-muted">È†êË®≠ÁÇ∫20ÂÖÉ</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="securities-tax">Ë≠â‰∫§Á®ÖÁéá(%)</label>
                                            <input type="number" class="form-control" id="securities-tax" 
                                                   value="0.3" min="0" max="1" step="0.01">
                                            <small class="form-text text-muted">È†êË®≠ÁÇ∫0.3%</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="default-capital">È†êË®≠ÂàùÂßãË≥áÈáë</label>
                                            <input type="number" class="form-control" id="default-capital" 
                                                   value="1000000" min="10000" step="10000">
                                            <small class="form-text text-muted">È†êË®≠ÁÇ∫100Ëê¨ÂÖÉ</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="max-positions">ÊúÄÂ§ßÂêåÊôÇÊåÅÂÄâÊï∏</label>
                                            <input type="number" class="form-control" id="max-positions" 
                                                   value="5" min="1" max="20">
                                            <small class="form-text text-muted">È†êË®≠ÁÇ∫5ÂÄã</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="risk-per-trade">ÊØèÁ≠Ü‰∫§ÊòìÈ¢®Èö™ÊØî‰æã(%)</label>
                                            <input type="number" class="form-control" id="risk-per-trade" 
                                                   value="2" min="0.1" max="10" step="0.1">
                                            <small class="form-text text-muted">È†êË®≠ÁÇ∫2%</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> ÂÑ≤Â≠ò‰∫§ÊòìÂèÉÊï∏
                                        </button>
                                        <button type="button" class="btn btn-secondary" id="reset-trading-params">
                                            <i class="fas fa-undo"></i> ÈáçÁΩÆÁÇ∫È†êË®≠ÂÄº
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Á≥ªÁµ±Ë®≠ÂÆö -->
        <div class="tab-pane fade" id="system-settings" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-server"></i> Á≥ªÁµ±ÂèÉÊï∏Ë®≠ÂÆö</h5>
                        </div>
                        <div class="card-body">
                            <form id="system-params-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="log-level">Êó•Ë™åÁ≠âÁ¥ö</label>
                                            <select class="form-control" id="log-level">
                                                <option value="DEBUG">DEBUG</option>
                                                <option value="INFO" selected>INFO</option>
                                                <option value="WARNING">WARNING</option>
                                                <option value="ERROR">ERROR</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="max-log-files">ÊúÄÂ§ßÊó•Ë™åÊ™îÊ°àÊï∏</label>
                                            <input type="number" class="form-control" id="max-log-files" 
                                                   value="10" min="1" max="100">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="session-timeout">ÊúÉË©±Ë∂ÖÊôÇÊôÇÈñì(ÂàÜÈêò)</label>
                                            <input type="number" class="form-control" id="session-timeout" 
                                                   value="30" min="5" max="480">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="max-upload-size">ÊúÄÂ§ß‰∏äÂÇ≥Ê™îÊ°àÂ§ßÂ∞è(MB)</label>
                                            <input type="number" class="form-control" id="max-upload-size" 
                                                   value="50" min="1" max="500">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="auto-cleanup-days">Ëá™ÂãïÊ∏ÖÁêÜÂ§©Êï∏</label>
                                            <input type="number" class="form-control" id="auto-cleanup-days" 
                                                   value="30" min="1" max="365">
                                            <small class="form-text text-muted">Ë∂ÖÈÅéÊåáÂÆöÂ§©Êï∏ÁöÑÊ™îÊ°àÂ∞áË¢´Ëá™ÂãïÊ∏ÖÁêÜ</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="enable-notifications">ÂïüÁî®ÈÄöÁü•</label>
                                            <div class="custom-control custom-switch">
                                                <input type="checkbox" class="custom-control-input" id="enable-notifications" checked>
                                                <label class="custom-control-label" for="enable-notifications">ÂïüÁî®Á≥ªÁµ±ÈÄöÁü•</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> ÂÑ≤Â≠òÁ≥ªÁµ±ÂèÉÊï∏
                                        </button>
                                        <button type="button" class="btn btn-warning" id="restart-system">
                                            <i class="fas fa-redo"></i> ÈáçÊñ∞ÂïüÂãïÁ≥ªÁµ±
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÂÇô‰ªΩË®≠ÂÆö -->
        <div class="tab-pane fade" id="backup-settings" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-database"></i> Ë≥áÊñôÂÇô‰ªΩË®≠ÂÆö</h5>
                        </div>
                        <div class="card-body">
                            <form id="backup-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="backup-frequency">ÂÇô‰ªΩÈ†ªÁéá</label>
                                            <select class="form-control" id="backup-frequency">
                                                <option value="daily">ÊØèÊó•</option>
                                                <option value="weekly" selected>ÊØèÈÄ±</option>
                                                <option value="monthly">ÊØèÊúà</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="backup-time">ÂÇô‰ªΩÊôÇÈñì</label>
                                            <input type="time" class="form-control" id="backup-time" value="02:00">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="backup-retention">‰øùÁïôÂ§©Êï∏</label>
                                            <input type="number" class="form-control" id="backup-retention" 
                                                   value="30" min="1" max="365">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="backup-path">ÂÇô‰ªΩË∑ØÂæë</label>
                                            <input type="text" class="form-control" id="backup-path" 
                                                   value="./backups" placeholder="Ë´ãËº∏ÂÖ•ÂÇô‰ªΩË∑ØÂæë">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> ÂÑ≤Â≠òÂÇô‰ªΩË®≠ÂÆö
                                        </button>
                                        <button type="button" class="btn btn-success" id="create-backup">
                                            <i class="fas fa-download"></i> Á´ãÂç≥Âª∫Á´ãÂÇô‰ªΩ
                                        </button>
                                        <button type="button" class="btn btn-info" id="restore-backup">
                                            <i class="fas fa-upload"></i> ÈÇÑÂéüÂÇô‰ªΩ
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-history"></i> ÂÇô‰ªΩÊ≠∑Âè≤</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>ÂÇô‰ªΩÊôÇÈñì</th>
                                            <th>Ê™îÊ°àÂ§ßÂ∞è</th>
                                            <th>ÁãÄÊÖã</th>
                                            <th>Êìç‰Ωú</th>
                                        </tr>
                                    </thead>
                                    <tbody id="backup-history">
                                        <!-- ÂãïÊÖãËºâÂÖ•ÂÇô‰ªΩÊ≠∑Âè≤ -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Á¢∫Ë™çÂ∞çË©±Ê°Ü -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Á¢∫Ë™çÊìç‰Ωú</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="confirm-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">ÂèñÊ∂à</button>
                <button type="button" class="btn btn-primary" id="confirm-btn">Á¢∫Ë™ç</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // ÂàùÂßãÂåñÈ†ÅÈù¢
    initializePage();
    
    // ËºâÂÖ•Ë®≠ÂÆö
    loadSettings();
    
    // Ë°®ÂñÆÊèê‰∫§‰∫ã‰ª∂
    $('#stock-api-form').submit(function(e) {
        e.preventDefault();
        saveStockAPISettings();
    });
    
    $('#broker-api-form').submit(function(e) {
        e.preventDefault();
        saveBrokerAPISettings();
    });
    
    $('#trading-params-form').submit(function(e) {
        e.preventDefault();
        saveTradingSettings();
    });
    
    $('#system-params-form').submit(function(e) {
        e.preventDefault();
        saveSystemSettings();
    });
    
    $('#backup-form').submit(function(e) {
        e.preventDefault();
        saveBackupSettings();
    });
    
    // Ê∏¨Ë©¶ÈÄ£Á∑ö
    $('#test-stock-api').click(function() {
        testStockAPIConnection();
    });
    
    $('#test-broker-api').click(function() {
        testBrokerAPIConnection();
    });
    
    // ÂÖ∂‰ªñÊåâÈàï‰∫ã‰ª∂
    $('#reset-trading-params').click(function() {
        resetTradingParams();
    });
    
    $('#restart-system').click(function() {
        showConfirmDialog('Á¢∫ÂÆöË¶ÅÈáçÊñ∞ÂïüÂãïÁ≥ªÁµ±ÂóéÔºüÈÄôÂ∞á‰∏≠Êñ∑ÊâÄÊúâÊ≠£Âú®ÈÄ≤Ë°åÁöÑÊìç‰Ωú„ÄÇ', function() {
            restartSystem();
        });
    });
    
    $('#create-backup').click(function() {
        createBackup();
    });
    
    $('#restore-backup').click(function() {
        showRestoreBackupDialog();
    });
    
    function initializePage() {
        console.log('Ë®≠ÂÆöÈ†ÅÈù¢ÂàùÂßãÂåñÂÆåÊàê');
    }
    
    function loadSettings() {
        // ËºâÂÖ•ËÇ°Á•®APIË®≠ÂÆö
        $.get('/api/settings/stock-api')
            .done(function(response) {
                if (response.status === 'success') {
                    const settings = response.settings;
                    $('#stock-api-provider').val(settings.provider || 'twse');
                    $('#stock-api-url').val(settings.url || '');
                    $('#stock-api-timeout').val(settings.timeout || 30);
                }
            })
            .fail(function(xhr) {
                console.error('ËºâÂÖ•ËÇ°Á•®APIË®≠ÂÆöÂ§±Êïó:', xhr.responseText);
            });
        
        // ËºâÂÖ•Âà∏ÂïÜAPIË®≠ÂÆö
        $.get('/api/settings/broker-api')
            .done(function(response) {
                if (response.status === 'success') {
                    const settings = response.settings;
                    $('#broker-provider').val(settings.provider || '');
                    $('#broker-api-url').val(settings.url || '');
                    $('#broker-environment').val(settings.environment || 'production');
                }
            })
            .fail(function(xhr) {
                console.error('ËºâÂÖ•Âà∏ÂïÜAPIË®≠ÂÆöÂ§±Êïó:', xhr.responseText);
            });
        
        // ËºâÂÖ•‰∫§ÊòìÂèÉÊï∏Ë®≠ÂÆö
        $.get('/api/settings/trading')
            .done(function(response) {
                if (response.status === 'success') {
                    const settings = response.settings;
                    $('#default-commission').val(settings.default_commission || 0.1425);
                    $('#min-commission').val(settings.min_commission || 20);
                    $('#securities-tax').val(settings.securities_tax || 0.3);
                    $('#default-capital').val(settings.default_capital || 1000000);
                    $('#max-positions').val(settings.max_positions || 5);
                    $('#risk-per-trade').val(settings.risk_per_trade || 2);
                }
            })
            .fail(function(xhr) {
                console.error('ËºâÂÖ•‰∫§ÊòìÂèÉÊï∏Ë®≠ÂÆöÂ§±Êïó:', xhr.responseText);
            });
        
        // ËºâÂÖ•Á≥ªÁµ±ÂèÉÊï∏Ë®≠ÂÆö
        $.get('/api/settings/system')
            .done(function(response) {
                if (response.status === 'success') {
                    const settings = response.settings;
                    $('#log-level').val(settings.log_level || 'INFO');
                    $('#max-log-files').val(settings.max_log_files || 10);
                    $('#session-timeout').val(settings.session_timeout || 30);
                    $('#max-upload-size').val(settings.max_upload_size || 50);
                    $('#auto-cleanup-days').val(settings.auto_cleanup_days || 30);
                    $('#enable-notifications').prop('checked', settings.enable_notifications !== false);
                }
            })
            .fail(function(xhr) {
                console.error('ËºâÂÖ•Á≥ªÁµ±ÂèÉÊï∏Ë®≠ÂÆöÂ§±Êïó:', xhr.responseText);
            });
        
        // ËºâÂÖ•ÂÇô‰ªΩË®≠ÂÆö
        $.get('/api/settings/backup')
            .done(function(response) {
                if (response.status === 'success') {
                    const settings = response.settings;
                    $('#backup-frequency').val(settings.frequency || 'weekly');
                    $('#backup-time').val(settings.time || '02:00');
                    $('#backup-retention').val(settings.retention || 30);
                    $('#backup-path').val(settings.path || './backups');
                }
            })
            .fail(function(xhr) {
                console.error('ËºâÂÖ•ÂÇô‰ªΩË®≠ÂÆöÂ§±Êïó:', xhr.responseText);
            });
        
        // ËºâÂÖ•ÂÇô‰ªΩÊ≠∑Âè≤
        loadBackupHistory();
    }
    
    function saveStockAPISettings() {
        const settings = {
            provider: $('#stock-api-provider').val(),
            api_key: $('#stock-api-key').val(),
            url: $('#stock-api-url').val(),
            timeout: parseInt($('#stock-api-timeout').val())
        };
        
        $.post('/api/settings/stock-api', settings)
            .done(function(response) {
                if (response.status === 'success') {
                    showSuccess('ËÇ°Á•®APIË®≠ÂÆöÂ∑≤ÂÑ≤Â≠ò');
                }
            })
            .fail(function(xhr) {
                showError('ÂÑ≤Â≠òËÇ°Á•®APIË®≠ÂÆöÂ§±Êïó: ' + xhr.responseText);
            });
    }
    
    function saveBrokerAPISettings() {
        const settings = {
            provider: $('#broker-provider').val(),
            api_key: $('#broker-api-key').val(),
            secret: $('#broker-secret').val(),
            account: $('#broker-account').val(),
            url: $('#broker-api-url').val(),
            environment: $('#broker-environment').val()
        };
        
        $.post('/api/settings/broker-api', settings)
            .done(function(response) {
                if (response.status === 'success') {
                    showSuccess('Âà∏ÂïÜAPIË®≠ÂÆöÂ∑≤ÂÑ≤Â≠ò');
                }
            })
            .fail(function(xhr) {
                showError('ÂÑ≤Â≠òÂà∏ÂïÜAPIË®≠ÂÆöÂ§±Êïó: ' + xhr.responseText);
            });
    }
    
    function saveTradingSettings() {
        const settings = {
            default_commission: parseFloat($('#default-commission').val()),
            min_commission: parseInt($('#min-commission').val()),
            securities_tax: parseFloat($('#securities-tax').val()),
            default_capital: parseInt($('#default-capital').val()),
            max_positions: parseInt($('#max-positions').val()),
            risk_per_trade: parseFloat($('#risk-per-trade').val())
        };
        
        $.post('/api/settings/trading', settings)
            .done(function(response) {
                if (response.status === 'success') {
                    showSuccess('‰∫§ÊòìÂèÉÊï∏Ë®≠ÂÆöÂ∑≤ÂÑ≤Â≠ò');
                }
            })
            .fail(function(xhr) {
                showError('ÂÑ≤Â≠ò‰∫§ÊòìÂèÉÊï∏Ë®≠ÂÆöÂ§±Êïó: ' + xhr.responseText);
            });
    }
    
    function saveSystemSettings() {
        const settings = {
            log_level: $('#log-level').val(),
            max_log_files: parseInt($('#max-log-files').val()),
            session_timeout: parseInt($('#session-timeout').val()),
            max_upload_size: parseInt($('#max-upload-size').val()),
            auto_cleanup_days: parseInt($('#auto-cleanup-days').val()),
            enable_notifications: $('#enable-notifications').is(':checked')
        };
        
        $.post('/api/settings/system', settings)
            .done(function(response) {
                if (response.status === 'success') {
                    showSuccess('Á≥ªÁµ±ÂèÉÊï∏Ë®≠ÂÆöÂ∑≤ÂÑ≤Â≠ò');
                }
            })
            .fail(function(xhr) {
                showError('ÂÑ≤Â≠òÁ≥ªÁµ±ÂèÉÊï∏Ë®≠ÂÆöÂ§±Êïó: ' + xhr.responseText);
            });
    }
    
    function saveBackupSettings() {
        const settings = {
            frequency: $('#backup-frequency').val(),
            time: $('#backup-time').val(),
            retention: parseInt($('#backup-retention').val()),
            path: $('#backup-path').val()
        };
        
        $.post('/api/settings/backup', settings)
            .done(function(response) {
                if (response.status === 'success') {
                    showSuccess('ÂÇô‰ªΩË®≠ÂÆöÂ∑≤ÂÑ≤Â≠ò');
                }
            })
            .fail(function(xhr) {
                showError('ÂÑ≤Â≠òÂÇô‰ªΩË®≠ÂÆöÂ§±Êïó: ' + xhr.responseText);
            });
    }
    
    function testStockAPIConnection() {
        const settings = {
            provider: $('#stock-api-provider').val(),
            api_key: $('#stock-api-key').val(),
            url: $('#stock-api-url').val(),
            timeout: parseInt($('#stock-api-timeout').val())
        };
        
        $.post('/api/settings/test-stock-api', settings)
            .done(function(response) {
                if (response.status === 'success') {
                    showSuccess('ËÇ°Á•®APIÈÄ£Á∑öÊ∏¨Ë©¶ÊàêÂäü');
                }
            })
            .fail(function(xhr) {
                showError('ËÇ°Á•®APIÈÄ£Á∑öÊ∏¨Ë©¶Â§±Êïó: ' + xhr.responseText);
            });
    }
    
    function testBrokerAPIConnection() {
        const settings = {
            provider: $('#broker-provider').val(),
            api_key: $('#broker-api-key').val(),
            secret: $('#broker-secret').val(),
            account: $('#broker-account').val(),
            url: $('#broker-api-url').val(),
            environment: $('#broker-environment').val()
        };
        
        $.post('/api/settings/test-broker-api', settings)
            .done(function(response) {
                if (response.status === 'success') {
                    showSuccess('Âà∏ÂïÜAPIÈÄ£Á∑öÊ∏¨Ë©¶ÊàêÂäü');
                }
            })
            .fail(function(xhr) {
                showError('Âà∏ÂïÜAPIÈÄ£Á∑öÊ∏¨Ë©¶Â§±Êïó: ' + xhr.responseText);
            });
    }
    
    function resetTradingParams() {
        $('#default-commission').val(0.1425);
        $('#min-commission').val(20);
        $('#securities-tax').val(0.3);
        $('#default-capital').val(1000000);
        $('#max-positions').val(5);
        $('#risk-per-trade').val(2);
        
        showSuccess('‰∫§ÊòìÂèÉÊï∏Â∑≤ÈáçÁΩÆÁÇ∫È†êË®≠ÂÄº');
    }
    
    function restartSystem() {
        $.post('/api/system/restart')
            .done(function(response) {
                if (response.status === 'success') {
                    showSuccess('Á≥ªÁµ±ÈáçÊñ∞ÂïüÂãï‰∏≠ÔºåË´ãÁ®çÂÄô...');
                    setTimeout(function() {
                        window.location.reload();
                    }, 3000);
                }
            })
            .fail(function(xhr) {
                showError('ÈáçÊñ∞ÂïüÂãïÁ≥ªÁµ±Â§±Êïó: ' + xhr.responseText);
            });
    }
    
    function createBackup() {
        $.post('/api/backup/create')
            .done(function(response) {
                if (response.status === 'success') {
                    showSuccess('ÂÇô‰ªΩÂª∫Á´ãÊàêÂäü');
                    loadBackupHistory();
                }
            })
            .fail(function(xhr) {
                showError('Âª∫Á´ãÂÇô‰ªΩÂ§±Êïó: ' + xhr.responseText);
            });
    }
    
    function loadBackupHistory() {
        $.get('/api/backup/history')
            .done(function(response) {
                if (response.status === 'success') {
                    renderBackupHistory(response.backups);
                }
            })
            .fail(function(xhr) {
                console.error('ËºâÂÖ•ÂÇô‰ªΩÊ≠∑Âè≤Â§±Êïó:', xhr.responseText);
            });
    }
    
    function renderBackupHistory(backups) {
        const tbody = $('#backup-history');
        tbody.empty();
        
        if (backups.length === 0) {
            tbody.append('<tr><td colspan="4" class="text-center text-muted">Â∞öÁÑ°ÂÇô‰ªΩË®òÈåÑ</td></tr>');
            return;
        }
        
        backups.forEach(function(backup) {
            const row = $('<tr></tr>');
            row.append(`<td>${formatDateTime(backup.created_at)}</td>`);
            row.append(`<td>${formatFileSize(backup.size)}</td>`);
            row.append(`<td><span class="badge badge-${backup.status === 'success' ? 'success' : 'danger'}">${backup.status === 'success' ? 'ÊàêÂäü' : 'Â§±Êïó'}</span></td>`);
            row.append(`<td>
                <button class="btn btn-sm btn-info" onclick="downloadBackup('${backup.filename}')">
                    <i class="fas fa-download"></i> ‰∏ãËºâ
                </button>
                <button class="btn btn-sm btn-warning" onclick="restoreBackup('${backup.filename}')">
                    <i class="fas fa-upload"></i> ÈÇÑÂéü
                </button>
            </td>`);
            tbody.append(row);
        });
    }
    
    function formatDateTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('zh-TW');
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function showConfirmDialog(message, callback) {
        $('#confirm-message').text(message);
        $('#confirm-btn').off('click').on('click', function() {
            $('#confirmModal').modal('hide');
            callback();
        });
        $('#confirmModal').modal('show');
    }
    
    function showSuccess(message) {
        showAlert('success', message);
    }
    
    function showError(message) {
        showAlert('danger', message);
    }
    
    function showAlert(type, message) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        `;
        $('.container-fluid').prepend(alertHtml);
        
        // Ëá™ÂãïÁßªÈô§Ë≠¶Âëä
        setTimeout(function() {
            $('.alert').alert('close');
        }, 5000);
    }
});

// ÂÖ®ÂüüÂáΩÊï∏
function downloadBackup(filename) {
    window.open(`/api/backup/download/${filename}`, '_blank');
}

function restoreBackup(filename) {
    if (confirm('Á¢∫ÂÆöË¶ÅÈÇÑÂéüÊ≠§ÂÇô‰ªΩÂóéÔºüÈÄôÂ∞áË¶ÜËìãÁõÆÂâçÁöÑË≥áÊñô„ÄÇ')) {
        $.post(`/api/backup/restore/${filename}`)
            .done(function(response) {
                if (response.status === 'success') {
                    alert('ÂÇô‰ªΩÈÇÑÂéüÊàêÂäüÔºåÁ≥ªÁµ±Â∞áÈáçÊñ∞ÂïüÂãï');
                    setTimeout(function() {
                        window.location.reload();
                    }, 2000);
                }
            })
            .fail(function(xhr) {
                alert('ÂÇô‰ªΩÈÇÑÂéüÂ§±Êïó: ' + xhr.responseText);
            });
    }
}
</script>
{% endblock %} 