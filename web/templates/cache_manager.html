{% extends "base.html" %}

{% block title %}å¿«å–ç®¡ç†{% endblock %}

{% block feature_nav %}
<div class="feature-nav">
    <h4><i class="fas fa-compass"></i> åŠŸèƒ½å€å°èˆª</h4>
    <!-- å¿«å–ç®¡ç†åŠŸèƒ½å€ -->
    <div class="feature-section">
        <h5><i class="fas fa-database"></i> å¿«å–ç®¡ç†åŠŸèƒ½</h5>
        <div class="feature-links">
            <a href="/cache-manager#cache-stats" class="feature-link">å¿«å–çµ±è¨ˆğŸ”</a>
            <a href="/cache-manager#cache-items" class="feature-link">å¿«å–é …ç›®ğŸ“„</a>
            <a href="/cache-manager#stock-codes" class="feature-link">è‚¡ç¥¨ä»£ç¢¼ğŸ“Š</a>
            <a href="/cache-manager#cache-actions" class="feature-link">å¿«å–æ“ä½œğŸ“¥</a>
        </div>
    </div>    
</div>
{% endblock %}

{% block extra_css %}
<style>
/* æ·±è‰²ä¸»é¡Œä¸‹è¡¨æ ¼é¡è‰²ä¿®æ­£ */
body.dark-theme .table-striped > tbody > tr:nth-of-type(odd) > td {
    color: #e9ecef !important;
}

body.dark-theme .table-striped > tbody > tr:nth-of-type(even) > td {
    color: #e9ecef !important;
}

body.dark-theme .table-hover > tbody > tr:hover > td {
    color: #ffffff !important;
}

/* å¿«å–ç®¡ç†é é¢å­—å‹å¤§å°èª¿æ•´ */
.table {
    font-size: 0.85rem;
}

.table th {
    font-size: 0.8rem;
    font-weight: 600;
}

.btn-sm {
    font-size: 0.8rem;
}

.card-header h5, .card-header h6 {
    font-size: 1.1rem;
}

/* çµ±è¨ˆå¡ç‰‡å­—å‹èª¿æ•´ */
.card-body h4 {
    font-size: 1.5rem;
}

.card-body h6 {
    font-size: 0.9rem;
}

.card-body small {
    font-size: 0.8rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>å¿«å–ç®¡ç†</h5>
                    <div>
                        <button class="btn btn-primary btn-sm" onclick="refreshCacheInfo()">
                            <i class="fas fa-sync"></i> é‡æ–°æ•´ç†
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="clearExpiredCache()">
                            <i class="fas fa-trash"></i> æ¸…ç†éæœŸå¿«å–
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="clearAllCache()">
                            <i class="fas fa-broom"></i> æ¸…ç†æ‰€æœ‰å¿«å–
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- å¿«å–çµ±è¨ˆè³‡è¨Š -->
                    <div class="row mb-4" id="cache-stats">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <h6 class="card-title">è¨˜æ†¶é«”ä½¿ç”¨é‡</h6>
                                    <h4 id="memoryUsage">0 MB</h4>
                                    <small>æœ€å¤§: <span id="maxMemory">1024 MB</span></small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <h6 class="card-title">è¨˜æ†¶é«”é …ç›®</h6>
                                    <h4 id="memoryItems">0</h4>
                                    <small>ç¸½é …ç›®: <span id="totalItems">0</span></small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <h6 class="card-title">æª”æ¡ˆå¿«å–</h6>
                                    <h4 id="fileCacheSize">0 MB</h4>
                                    <small>æª”æ¡ˆæ•¸: <span id="fileCacheCount">0</span></small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <h6 class="card-title">è‚¡ç¥¨æ•¸é‡</h6>
                                    <h4 id="uniqueStocks">0</h4>
                                    <small>ä¸åŒè‚¡ç¥¨ä»£ç¢¼</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å¿«å–é …ç›®åˆ—è¡¨ -->
                    <div class="row" id="cache-items">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6>å¿«å–é …ç›®è©³æƒ…</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>è‚¡ç¥¨ä»£ç¢¼</th>
                                                    <th>æ—¥æœŸç¯„åœ</th>
                                                    <th>è³‡æ–™é¡å‹</th>
                                                    <th>è³‡æ–™ç­†æ•¸</th>
                                                    <th>å¤§å°</th>
                                                    <th>å»ºç«‹æ™‚é–“</th>
                                                    <th>æœ€å¾Œå­˜å–</th>
                                                    <th>éæœŸæ™‚é–“</th>
                                                    <th>ç‹€æ…‹</th>
                                                    <th>æ“ä½œ</th>
                                                </tr>
                                            </thead>
                                            <tbody id="cacheItemsTable">
                                                <!-- å¿«å–é …ç›®å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è‚¡ç¥¨ä»£ç¢¼åˆ—è¡¨ -->
                    <div class="row mt-4" id="stock-codes">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6>å¿«å–ä¸­çš„è‚¡ç¥¨ä»£ç¢¼</h6>
                                </div>
                                <div class="card-body">
                                    <div id="stockIdsList" class="d-flex flex-wrap gap-2">
                                        <!-- è‚¡ç¥¨ä»£ç¢¼å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç¢ºèªå°è©±æ¡† -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalTitle">ç¢ºèªæ“ä½œ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirmModalMessage">ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="confirmModalButton">ç¢ºèª</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let cacheInfo = {};

// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    refreshCacheInfo();
});

// é‡æ–°æ•´ç†å¿«å–è³‡è¨Š
async function refreshCacheInfo() {
    try {
        const response = await fetch('/api/cache/info');
        const data = await response.json();
        
        if (data.status === 'success') {
            cacheInfo = data.info;
            updateCacheDisplay();
        } else {
            showAlert('å–å¾—å¿«å–è³‡è¨Šå¤±æ•—', 'danger');
        }
    } catch (error) {
        console.error('å–å¾—å¿«å–è³‡è¨Šå¤±æ•—:', error);
        showAlert('å–å¾—å¿«å–è³‡è¨Šå¤±æ•—', 'danger');
    }
}

// æ›´æ–°å¿«å–é¡¯ç¤º
function updateCacheDisplay() {
    // æ›´æ–°çµ±è¨ˆè³‡è¨Š
    document.getElementById('memoryUsage').textContent = `${cacheInfo.memory_usage_mb} MB`;
    document.getElementById('maxMemory').textContent = `${cacheInfo.max_memory_mb} MB`;
    document.getElementById('memoryItems').textContent = cacheInfo.memory_items;
    document.getElementById('totalItems').textContent = cacheInfo.total_items;
    document.getElementById('fileCacheSize').textContent = `${cacheInfo.file_cache_size_mb} MB`;
    document.getElementById('fileCacheCount').textContent = cacheInfo.file_cache_count;
    document.getElementById('uniqueStocks').textContent = cacheInfo.unique_stocks;
    
    // æ›´æ–°å¿«å–é …ç›®è¡¨æ ¼
    updateCacheItemsTable();
    
    // æ›´æ–°è‚¡ç¥¨ä»£ç¢¼åˆ—è¡¨
    updateStockIdsList();
}

// æ›´æ–°å¿«å–é …ç›®è¡¨æ ¼
function updateCacheItemsTable() {
    const tbody = document.getElementById('cacheItemsTable');
    tbody.innerHTML = '';
    
    Object.entries(cacheInfo.cache_metadata || {}).forEach(([key, metadata]) => {
        const row = document.createElement('tr');
        
        // æª¢æŸ¥æ˜¯å¦éæœŸ
        const expiresAt = new Date(metadata.expires_at);
        const isExpired = new Date() > expiresAt;
        const isInMemory = cacheInfo.memory_items > 0; // ç°¡åŒ–åˆ¤æ–·
        
        // æ ¼å¼åŒ–å¤§å°
        const sizeMB = (metadata.size_bytes / (1024 * 1024)).toFixed(2);
        
        // æ ¼å¼åŒ–æ™‚é–“
        const createdAt = new Date(metadata.created_at).toLocaleString();
        const lastAccessed = new Date(metadata.last_accessed).toLocaleString();
        const expiresAtFormatted = expiresAt.toLocaleString();
        
        row.innerHTML = `
            <td>${metadata.stock_id}</td>
            <td>${metadata.start_date} ~ ${metadata.end_date}</td>
            <td>${metadata.data_type}</td>
            <td>${metadata.rows}</td>
            <td>${sizeMB} MB</td>
            <td>${createdAt}</td>
            <td>${lastAccessed}</td>
            <td>${expiresAtFormatted}</td>
            <td>
                <span class="badge ${isExpired ? 'bg-danger' : 'bg-success'}">${isExpired ? 'å·²éæœŸ' : 'æœ‰æ•ˆ'}</span>
                <span class="badge ${isInMemory ? 'bg-primary' : 'bg-secondary'}">${isInMemory ? 'è¨˜æ†¶é«”' : 'æª”æ¡ˆ'}</span>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-danger" onclick="removeCacheItem('${key}')">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

// æ›´æ–°è‚¡ç¥¨ä»£ç¢¼åˆ—è¡¨
function updateStockIdsList() {
    const container = document.getElementById('stockIdsList');
    container.innerHTML = '';
    
    (cacheInfo.stock_ids || []).forEach(stockId => {
        const badge = document.createElement('span');
        badge.className = 'badge bg-primary';
        badge.textContent = stockId;
        container.appendChild(badge);
    });
}

// æ¸…ç†éæœŸå¿«å–
async function clearExpiredCache() {
    if (!confirm('ç¢ºå®šè¦æ¸…ç†éæœŸçš„å¿«å–å—ï¼Ÿ')) {
        return;
    }
    
    try {
        const response = await fetch('/api/cache/clear', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ cache_type: 'expired' })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showAlert('éæœŸå¿«å–æ¸…ç†æˆåŠŸ', 'success');
            refreshCacheInfo();
        } else {
            showAlert(data.message || 'æ¸…ç†éæœŸå¿«å–å¤±æ•—', 'danger');
        }
    } catch (error) {
        console.error('æ¸…ç†éæœŸå¿«å–å¤±æ•—:', error);
        showAlert('æ¸…ç†éæœŸå¿«å–å¤±æ•—', 'danger');
    }
}

// æ¸…ç†æ‰€æœ‰å¿«å–
async function clearAllCache() {
    showConfirmModal(
        'æ¸…ç†æ‰€æœ‰å¿«å–',
        'ç¢ºå®šè¦æ¸…ç†æ‰€æœ‰å¿«å–å—ï¼Ÿæ­¤æ“ä½œå°‡åˆªé™¤æ‰€æœ‰å¿«å–è³‡æ–™ï¼ŒåŒ…æ‹¬è¨˜æ†¶é«”å’Œæª”æ¡ˆå¿«å–ã€‚æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚',
        async () => {
            try {
                const response = await fetch('/api/cache/clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cache_type: 'all' })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showAlert('æ‰€æœ‰å¿«å–æ¸…ç†æˆåŠŸ', 'success');
                    refreshCacheInfo();
                } else {
                    showAlert(data.message || 'æ¸…ç†æ‰€æœ‰å¿«å–å¤±æ•—', 'danger');
                }
            } catch (error) {
                console.error('æ¸…ç†æ‰€æœ‰å¿«å–å¤±æ•—:', error);
                showAlert('æ¸…ç†æ‰€æœ‰å¿«å–å¤±æ•—', 'danger');
            }
        }
    );
}

// ç§»é™¤ç‰¹å®šå¿«å–é …ç›® - ä¿®æ­£APIç«¯é»
async function removeCacheItem(cacheKey) {
    if (!confirm('ç¢ºå®šè¦ç§»é™¤é€™å€‹å¿«å–é …ç›®å—ï¼Ÿ')) {
        return;
    }
    
    try {
        // å˜—è©¦ä¸åŒçš„APIç«¯é»æ ¼å¼
        let response;
        try {
            // å…ˆå˜—è©¦åŸå§‹ç«¯é»
            response = await fetch(`/api/cache/remove/${cacheKey}`, {
                method: 'DELETE'
            });
        } catch (error) {
            // å¦‚æœå¤±æ•—ï¼Œå˜—è©¦POSTæ–¹æ³•
            response = await fetch('/api/cache/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ cache_key: cacheKey })
            });
        }
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showAlert('å¿«å–é …ç›®ç§»é™¤æˆåŠŸ', 'success');
            refreshCacheInfo();
        } else {
            showAlert(data.message || 'ç§»é™¤å¿«å–é …ç›®å¤±æ•—', 'danger');
        }
    } catch (error) {
        console.error('ç§»é™¤å¿«å–é …ç›®å¤±æ•—:', error);
        showAlert('ç§»é™¤å¿«å–é …ç›®å¤±æ•—: ' + error.message, 'danger');
    }
}

// é¡¯ç¤ºç¢ºèªå°è©±æ¡†
function showConfirmModal(title, message, onConfirm) {
    document.getElementById('confirmModalTitle').textContent = title;
    document.getElementById('confirmModalMessage').textContent = message;
    
    const confirmButton = document.getElementById('confirmModalButton');
    confirmButton.onclick = () => {
        bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
        onConfirm();
    };
    
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    modal.show();
}

// é¡¯ç¤ºæç¤ºè¨Šæ¯
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}
</script>
{% endblock %} 