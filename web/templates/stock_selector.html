{% extends "base.html" %}

{% block title %}é¸è‚¡ç·¨è¼¯å™¨{% endblock %}

{% block feature_nav %}
<div class="feature-nav">
    <h4><i class="fas fa-compass"></i> åŠŸèƒ½å€å°èˆª</h4>
    <!-- é¸è‚¡ç·¨è¼¯å™¨åŠŸèƒ½å€ -->
    <div class="feature-section">
        <h5><i class="fas fa-filter"></i> é¸è‚¡ç·¨è¼¯å™¨åŠŸèƒ½</h5>
        <div class="feature-links">
            <a href="/stock-selector#stock-lists" class="feature-link">é¸è‚¡åˆ—è¡¨ğŸ”</a>
            <a href="/stock-selector#stock-editor" class="feature-link">ç·¨è¼¯å™¨ğŸ§ </a>
            <a href="/stock-selector#conditions" class="feature-link">é¸è‚¡æ¢ä»¶ğŸ“</a>
            <a href="/stock-selector#export" class="feature-link">åŒ¯å‡ºåŠŸèƒ½ğŸ’¾</a>
        </div>
    </div>    
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- å·¦å´ï¼šé¸è‚¡åˆ—è¡¨ -->
        <div class="col-md-4" id="stock-lists">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> é¸è‚¡åˆ—è¡¨
                    </h5>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="createNewStockList()">
                            <i class="fas fa-plus"></i> æ–°å¢
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshStockLists()">
                            <i class="fas fa-sync-alt"></i> é‡æ–°æ•´ç†
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="stockLists" class="list-group">
                        <!-- é¸è‚¡åˆ—è¡¨å°‡å‹•æ…‹è¼‰å…¥ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- å³å´ï¼šé¸è‚¡ç·¨è¼¯å™¨ -->
        <div class="col-md-8" id="stock-editor">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-edit"></i> é¸è‚¡ç·¨è¼¯å™¨
                    </h5>
                    <div>
                        <button class="btn btn-sm btn-outline-success" onclick="exportToStrategy()">
                            <i class="fas fa-arrow-right"></i> åŒ¯å‡ºåˆ°ç­–ç•¥
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="exportToExcel()">
                            <i class="fas fa-download"></i> åŒ¯å‡ºExcel
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="stockEditor">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-mouse-pointer fa-3x mb-3"></i>
                            <p>è«‹å¾å·¦å´é¸æ“‡ä¸€å€‹é¸è‚¡åˆ—è¡¨æˆ–å»ºç«‹æ–°çš„é¸è‚¡åˆ—è¡¨</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ–°å¢é¸è‚¡åˆ—è¡¨å°è©±æ¡† -->
<div class="modal fade" id="newStockListModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ–°å¢é¸è‚¡åˆ—è¡¨</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="stockListName" class="form-label">é¸è‚¡åˆ—è¡¨åç¨±</label>
                    <input type="text" class="form-control" id="stockListName" placeholder="è«‹è¼¸å…¥é¸è‚¡åˆ—è¡¨åç¨±">
                </div>
                <div class="mb-3">
                    <label for="stockListDescription" class="form-label">æè¿°</label>
                    <textarea class="form-control" id="stockListDescription" rows="3" placeholder="è«‹è¼¸å…¥æè¿°"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="confirmCreateStockList()">å»ºç«‹</button>
            </div>
        </div>
    </div>
</div>

<!-- é¸è‚¡æ¢ä»¶ç·¨è¼¯å™¨å°è©±æ¡† -->
<div class="modal fade" id="stockConditionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">é¸è‚¡æ¢ä»¶ç·¨è¼¯å™¨</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>é¸è‚¡æ¢ä»¶</h6>
                        <div id="conditionBuilder">
                            <!-- æ¢ä»¶å»ºæ§‹å™¨å°‡å‹•æ…‹ç”Ÿæˆ -->
                        </div>
                        <button class="btn btn-sm btn-outline-primary mt-2" onclick="addCondition()">
                            <i class="fas fa-plus"></i> æ–°å¢æ¢ä»¶
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h6>é è¦½çµæœ</h6>
                        <div id="conditionPreview" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                            <p class="text-muted">æ¢ä»¶è¨­å®šå¾Œå°‡é¡¯ç¤ºé è¦½</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="applyConditions()">å¥—ç”¨æ¢ä»¶</button>
            </div>
        </div>
    </div>
</div>

<!-- åŒ¯å‡ºåˆ°ç­–ç•¥å°è©±æ¡† -->
<div class="modal fade" id="exportToStrategyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">åŒ¯å‡ºåˆ°ç­–ç•¥ç·¨è¼¯å™¨</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">é¸æ“‡ç›®æ¨™ç­–ç•¥</label>
                    <select class="form-control" id="targetStrategy">
                        <option value="">è«‹é¸æ“‡ç­–ç•¥...</option>
                    </select>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    åŒ¯å‡ºå¾Œå°‡è‡ªå‹•è·³è½‰åˆ°ç­–ç•¥ç·¨è¼¯å™¨é é¢
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="confirmExportToStrategy()">åŒ¯å‡º</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentStockListId = null;
let stockLists = [];
let currentStockData = [];
let conditionCounter = 0;

// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadStockLists();
});

// è¼‰å…¥é¸è‚¡åˆ—è¡¨
async function loadStockLists() {
    try {
        const response = await fetch('/api/stock-lists');
        const data = await response.json();
        
        if (data.status === 'success') {
            stockLists = data.stock_lists;
            displayStockLists();
        }
    } catch (error) {
        console.error('è¼‰å…¥é¸è‚¡åˆ—è¡¨å¤±æ•—:', error);
        showAlert('è¼‰å…¥é¸è‚¡åˆ—è¡¨å¤±æ•—', 'danger');
    }
}

// é¡¯ç¤ºé¸è‚¡åˆ—è¡¨
function displayStockLists() {
    const container = document.getElementById('stockLists');
    container.innerHTML = '';
    
    if (stockLists.length === 0) {
        container.innerHTML = '<p class="text-muted text-center py-3">å°šç„¡é¸è‚¡åˆ—è¡¨</p>';
        return;
    }
    
    stockLists.forEach(stockList => {
        const item = document.createElement('div');
        item.className = 'list-group-item list-group-item-action';
        item.onclick = () => selectStockList(stockList.id);
        
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <h6 class="mb-1">${stockList.name}</h6>
                    <p class="mb-1 text-muted small">${stockList.description || 'ç„¡æè¿°'}</p>
                    <small class="text-muted">
                        <i class="fas fa-calendar"></i> ${new Date(stockList.created_at).toLocaleDateString()}
                        <span class="ms-2">
                            <i class="fas fa-chart-line"></i> ${stockList.stock_count || 0} æª”è‚¡ç¥¨
                        </span>
                    </small>
                </div>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="editStockList('${stockList.id}')">
                            <i class="fas fa-edit"></i> ç·¨è¼¯
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="duplicateStockList('${stockList.id}')">
                            <i class="fas fa-copy"></i> è¤‡è£½
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteStockList('${stockList.id}')">
                            <i class="fas fa-trash"></i> åˆªé™¤
                        </a></li>
                    </ul>
                </div>
            </div>
        `;
        
        container.appendChild(item);
    });
}

// é¸æ“‡é¸è‚¡åˆ—è¡¨
async function selectStockList(stockListId) {
    try {
        const response = await fetch(`/api/stock-lists/${stockListId}`);
        const data = await response.json();
        
        if (data.status === 'success') {
            currentStockListId = stockListId;
            currentStockData = data.stock_list.stocks || [];
            displayStockEditor(data.stock_list);
            
            // æ›´æ–°é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('#stockLists .list-group-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.list-group-item').classList.add('active');
        }
    } catch (error) {
        console.error('è¼‰å…¥é¸è‚¡åˆ—è¡¨å¤±æ•—:', error);
        showAlert('è¼‰å…¥é¸è‚¡åˆ—è¡¨å¤±æ•—', 'danger');
    }
}

// é¡¯ç¤ºé¸è‚¡ç·¨è¼¯å™¨
function displayStockEditor(stockList) {
    const editor = document.getElementById('stockEditor');
    
    editor.innerHTML = `
        <div class="mb-3">
            <div class="row">
                <div class="col-md-8">
                    <input type="text" class="form-control" id="stockListName" value="${stockList.name}" placeholder="é¸è‚¡åˆ—è¡¨åç¨±">
                </div>
                <div class="col-md-4">
                    <button class="btn btn-outline-primary" onclick="saveStockList()">
                        <i class="fas fa-save"></i> å„²å­˜
                    </button>
                </div>
            </div>
        </div>
        
        <div class="mb-3">
            <textarea class="form-control" id="stockListDescription" rows="2" placeholder="æè¿°">${stockList.description || ''}</textarea>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-cogs"></i> é¸è‚¡æ¢ä»¶
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="stockConditions">
                            ${generateConditionsDisplay(stockList.conditions || [])}
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="openConditionEditor()">
                            <i class="fas fa-plus"></i> æ–°å¢æ¢ä»¶
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-list"></i> è‚¡ç¥¨åˆ—è¡¨ (${currentStockData.length})
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <button class="btn btn-sm btn-outline-secondary" onclick="addManualStock()">
                                <i class="fas fa-plus"></i> æ‰‹å‹•æ–°å¢
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="importFromExcel()">
                                <i class="fas fa-upload"></i> åŒ¯å…¥Excel
                            </button>
                        </div>
                        <div id="stockListDisplay" class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
                            ${generateStockListDisplay()}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// ç”Ÿæˆæ¢ä»¶é¡¯ç¤º
function generateConditionsDisplay(conditions) {
    if (!conditions || conditions.length === 0) {
        return '<p class="text-muted">å°šç„¡é¸è‚¡æ¢ä»¶</p>';
    }
    
    return conditions.map(condition => `
        <div class="border rounded p-2 mb-2">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>${condition.field}</strong> ${condition.operator} ${condition.value}
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="removeCondition('${condition.id}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `).join('');
}

// ç”Ÿæˆè‚¡ç¥¨åˆ—è¡¨é¡¯ç¤º
function generateStockListDisplay() {
    if (currentStockData.length === 0) {
        return '<p class="text-muted">å°šç„¡è‚¡ç¥¨</p>';
    }
    
    return currentStockData.map(stock => `
        <div class="d-flex justify-content-between align-items-center border-bottom py-1">
            <div>
                <strong>${stock.stock_id}</strong>
                <small class="text-muted">${stock.stock_name || ''}</small>
            </div>
            <button class="btn btn-sm btn-outline-danger" onclick="removeStock('${stock.stock_id}')">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `).join('');
}

// æ–°å¢é¸è‚¡åˆ—è¡¨
function createNewStockList() {
    const modal = new bootstrap.Modal(document.getElementById('newStockListModal'));
    modal.show();
}

// ç¢ºèªå»ºç«‹é¸è‚¡åˆ—è¡¨
async function confirmCreateStockList() {
    const name = document.getElementById('stockListName').value.trim();
    const description = document.getElementById('stockListDescription').value.trim();
    
    if (!name) {
        showAlert('è«‹è¼¸å…¥é¸è‚¡åˆ—è¡¨åç¨±', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/stock-lists', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name,
                description: description
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('newStockListModal')).hide();
            showAlert('é¸è‚¡åˆ—è¡¨å»ºç«‹æˆåŠŸ', 'success');
            loadStockLists();
        } else {
            showAlert(data.message || 'å»ºç«‹å¤±æ•—', 'danger');
        }
    } catch (error) {
        console.error('å»ºç«‹é¸è‚¡åˆ—è¡¨å¤±æ•—:', error);
        showAlert('å»ºç«‹é¸è‚¡åˆ—è¡¨å¤±æ•—', 'danger');
    }
}

// å„²å­˜é¸è‚¡åˆ—è¡¨
async function saveStockList() {
    if (!currentStockListId) {
        showAlert('è«‹å…ˆé¸æ“‡æˆ–å»ºç«‹é¸è‚¡åˆ—è¡¨', 'warning');
        return;
    }
    
    const name = document.getElementById('stockListName').value.trim();
    const description = document.getElementById('stockListDescription').value.trim();
    
    if (!name) {
        showAlert('è«‹è¼¸å…¥é¸è‚¡åˆ—è¡¨åç¨±', 'warning');
        return;
    }
    
    try {
        const response = await fetch(`/api/stock-lists/${currentStockListId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name,
                description: description,
                stocks: currentStockData
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showAlert('å„²å­˜æˆåŠŸ', 'success');
            loadStockLists();
        } else {
            showAlert(data.message || 'å„²å­˜å¤±æ•—', 'danger');
        }
    } catch (error) {
        console.error('å„²å­˜é¸è‚¡åˆ—è¡¨å¤±æ•—:', error);
        showAlert('å„²å­˜é¸è‚¡åˆ—è¡¨å¤±æ•—', 'danger');
    }
}

// é–‹å•Ÿæ¢ä»¶ç·¨è¼¯å™¨
function openConditionEditor() {
    const modal = new bootstrap.Modal(document.getElementById('stockConditionModal'));
    modal.show();
    loadConditionBuilder();
}

// è¼‰å…¥æ¢ä»¶å»ºæ§‹å™¨
function loadConditionBuilder() {
    const container = document.getElementById('conditionBuilder');
    container.innerHTML = `
        <div class="mb-3">
            <label class="form-label">é¸è‚¡æ¬„ä½</label>
            <select class="form-control" id="conditionField">
                <option value="stock_id">è‚¡ç¥¨ä»£ç¢¼</option>
                <option value="stock_name">è‚¡ç¥¨åç¨±</option>
                <option value="sector">ç”¢æ¥­åˆ†é¡</option>
                <option value="market_cap">å¸‚å€¼</option>
                <option value="price">è‚¡åƒ¹</option>
                <option value="volume">æˆäº¤é‡</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">æ¢ä»¶é‹ç®—ç¬¦</label>
            <select class="form-control" id="conditionOperator">
                <option value="equals">ç­‰æ–¼</option>
                <option value="contains">åŒ…å«</option>
                <option value="greater_than">å¤§æ–¼</option>
                <option value="less_than">å°æ–¼</option>
                <option value="between">ä»‹æ–¼</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">æ¢ä»¶å€¼</label>
            <input type="text" class="form-control" id="conditionValue" placeholder="è«‹è¼¸å…¥æ¢ä»¶å€¼">
        </div>
    `;
}

// æ–°å¢æ¢ä»¶
function addCondition() {
    conditionCounter++;
    const container = document.getElementById('conditionBuilder');
    
    const conditionDiv = document.createElement('div');
    conditionDiv.className = 'border rounded p-3 mb-3';
    conditionDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6>æ¢ä»¶ ${conditionCounter}</h6>
            <button class="btn btn-sm btn-outline-danger" onclick="this.parentElement.parentElement.remove()">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <div class="row">
            <div class="col-md-4">
                <select class="form-control" id="field_${conditionCounter}">
                    <option value="stock_id">è‚¡ç¥¨ä»£ç¢¼</option>
                    <option value="stock_name">è‚¡ç¥¨åç¨±</option>
                    <option value="sector">ç”¢æ¥­åˆ†é¡</option>
                    <option value="market_cap">å¸‚å€¼</option>
                    <option value="price">è‚¡åƒ¹</option>
                    <option value="volume">æˆäº¤é‡</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-control" id="operator_${conditionCounter}">
                    <option value="equals">ç­‰æ–¼</option>
                    <option value="contains">åŒ…å«</option>
                    <option value="greater_than">å¤§æ–¼</option>
                    <option value="less_than">å°æ–¼</option>
                    <option value="between">ä»‹æ–¼</option>
                </select>
            </div>
            <div class="col-md-5">
                <input type="text" class="form-control" id="value_${conditionCounter}" placeholder="æ¢ä»¶å€¼">
            </div>
        </div>
    `;
    
    container.appendChild(conditionDiv);
}

// å¥—ç”¨æ¢ä»¶
async function applyConditions() {
    try {
        // æ”¶é›†æ¢ä»¶
        const conditions = [];
        const conditionDivs = document.querySelectorAll('#conditionBuilder .border.rounded');
        
        conditionDivs.forEach((div, index) => {
            const field = div.querySelector('select').value;
            const operator = div.querySelectorAll('select')[1].value;
            const value = div.querySelector('input').value;
            
            if (value.trim()) {
                conditions.push({
                    id: `condition_${index}`,
                    field: field,
                    operator: operator,
                    value: value
                });
            }
        });
        
        // å¥—ç”¨æ¢ä»¶åˆ°è‚¡ç¥¨åˆ—è¡¨
        const response = await fetch('/api/stock-lists/apply-conditions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                conditions: conditions
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            currentStockData = data.stocks;
            bootstrap.Modal.getInstance(document.getElementById('stockConditionModal')).hide();
            showAlert(`æ¢ä»¶å¥—ç”¨æˆåŠŸï¼Œæ‰¾åˆ° ${currentStockData.length} æª”è‚¡ç¥¨`, 'success');
            
            // æ›´æ–°é¡¯ç¤º
            const stockListDisplay = document.getElementById('stockListDisplay');
            if (stockListDisplay) {
                stockListDisplay.innerHTML = generateStockListDisplay();
            }
        } else {
            showAlert(data.message || 'å¥—ç”¨æ¢ä»¶å¤±æ•—', 'danger');
        }
    } catch (error) {
        console.error('å¥—ç”¨æ¢ä»¶å¤±æ•—:', error);
        showAlert('å¥—ç”¨æ¢ä»¶å¤±æ•—', 'danger');
    }
}

// æ‰‹å‹•æ–°å¢è‚¡ç¥¨
function addManualStock() {
    const stockId = prompt('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼:');
    if (stockId && stockId.trim()) {
        const stock = {
            stock_id: stockId.trim(),
            stock_name: '',
            start_date: '',
            end_date: ''
        };
        
        currentStockData.push(stock);
        
        const stockListDisplay = document.getElementById('stockListDisplay');
        if (stockListDisplay) {
            stockListDisplay.innerHTML = generateStockListDisplay();
        }
        
        showAlert('è‚¡ç¥¨æ–°å¢æˆåŠŸ', 'success');
    }
}

// ç§»é™¤è‚¡ç¥¨
function removeStock(stockId) {
    currentStockData = currentStockData.filter(stock => stock.stock_id !== stockId);
    
    const stockListDisplay = document.getElementById('stockListDisplay');
    if (stockListDisplay) {
        stockListDisplay.innerHTML = generateStockListDisplay();
    }
    
    showAlert('è‚¡ç¥¨ç§»é™¤æˆåŠŸ', 'success');
}

// åŒ¯å…¥Excel
function importFromExcel() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.xlsx,.xls';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            uploadExcelFile(file);
        }
    };
    input.click();
}

// ä¸Šå‚³Excelæª”æ¡ˆ
async function uploadExcelFile(file) {
    try {
        const formData = new FormData();
        formData.append('file', file);
        
        const response = await fetch('/api/stock-lists/import-excel', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            currentStockData = data.stocks;
            
            const stockListDisplay = document.getElementById('stockListDisplay');
            if (stockListDisplay) {
                stockListDisplay.innerHTML = generateStockListDisplay();
            }
            
            showAlert(`æˆåŠŸåŒ¯å…¥ ${currentStockData.length} æª”è‚¡ç¥¨`, 'success');
        } else {
            showAlert(data.message || 'åŒ¯å…¥å¤±æ•—', 'danger');
        }
    } catch (error) {
        console.error('åŒ¯å…¥Excelå¤±æ•—:', error);
        showAlert('åŒ¯å…¥Excelå¤±æ•—', 'danger');
    }
}

// åŒ¯å‡ºåˆ°ç­–ç•¥
function exportToStrategy() {
    if (!currentStockListId || currentStockData.length === 0) {
        showAlert('è«‹å…ˆé¸æ“‡é¸è‚¡åˆ—è¡¨ä¸¦ç¢ºä¿æœ‰è‚¡ç¥¨è³‡æ–™', 'warning');
        return;
    }
    
    // è¼‰å…¥ç­–ç•¥åˆ—è¡¨
    loadStrategyList();
    
    const modal = new bootstrap.Modal(document.getElementById('exportToStrategyModal'));
    modal.show();
}

// è¼‰å…¥ç­–ç•¥åˆ—è¡¨
async function loadStrategyList() {
    try {
        const response = await fetch('/api/strategies/custom');
        const data = await response.json();
        
        if (data.status === 'success') {
            const select = document.getElementById('targetStrategy');
            select.innerHTML = '<option value="">è«‹é¸æ“‡ç­–ç•¥...</option>';
            
            data.strategies.forEach(strategy => {
                const option = document.createElement('option');
                option.value = strategy.id;
                option.textContent = strategy.name;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('è¼‰å…¥ç­–ç•¥åˆ—è¡¨å¤±æ•—:', error);
    }
}

// ç¢ºèªåŒ¯å‡ºåˆ°ç­–ç•¥
async function confirmExportToStrategy() {
    const strategyId = document.getElementById('targetStrategy').value;
    
    if (!strategyId) {
        showAlert('è«‹é¸æ“‡ç›®æ¨™ç­–ç•¥', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/stock-lists/export-to-strategy', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                stock_list_id: currentStockListId,
                strategy_id: strategyId,
                stocks: currentStockData
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('exportToStrategyModal')).hide();
            showAlert('åŒ¯å‡ºæˆåŠŸ', 'success');
            
            // è·³è½‰åˆ°ç­–ç•¥ç·¨è¼¯å™¨
            setTimeout(() => {
                window.location.href = `/strategy-editor?strategy_id=${strategyId}`;
            }, 1000);
        } else {
            showAlert(data.message || 'åŒ¯å‡ºå¤±æ•—', 'danger');
        }
    } catch (error) {
        console.error('åŒ¯å‡ºåˆ°ç­–ç•¥å¤±æ•—:', error);
        showAlert('åŒ¯å‡ºåˆ°ç­–ç•¥å¤±æ•—', 'danger');
    }
}

// åŒ¯å‡ºExcel
function exportToExcel() {
    if (!currentStockData || currentStockData.length === 0) {
        showAlert('æ²’æœ‰è‚¡ç¥¨è³‡æ–™å¯åŒ¯å‡º', 'warning');
        return;
    }
    
    // å»ºç«‹Excelå…§å®¹
    const excelData = currentStockData.map(stock => ({
        stock_id: stock.stock_id,
        stock_name: stock.stock_name || '',
        start_date: stock.start_date || '',
        end_date: stock.end_date || ''
    }));
    
    // ä¸‹è¼‰Excelæª”æ¡ˆ
    downloadExcel(excelData, 'stock_list');
}

// ä¸‹è¼‰Excelæª”æ¡ˆ
function downloadExcel(data, filename) {
    const worksheet = XLSX.utils.json_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "è‚¡ç¥¨åˆ—è¡¨");
    
    XLSX.writeFile(workbook, `${filename}_${new Date().toISOString().split('T')[0]}.xlsx`);
}

// ç·¨è¼¯é¸è‚¡åˆ—è¡¨
function editStockList(stockListId) {
    selectStockList(stockListId);
}

// è¤‡è£½é¸è‚¡åˆ—è¡¨
async function duplicateStockList(stockListId) {
    try {
        const response = await fetch(`/api/stock-lists/${stockListId}/duplicate`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showAlert('è¤‡è£½æˆåŠŸ', 'success');
            loadStockLists();
        } else {
            showAlert(data.message || 'è¤‡è£½å¤±æ•—', 'danger');
        }
    } catch (error) {
        console.error('è¤‡è£½é¸è‚¡åˆ—è¡¨å¤±æ•—:', error);
        showAlert('è¤‡è£½é¸è‚¡åˆ—è¡¨å¤±æ•—', 'danger');
    }
}

// åˆªé™¤é¸è‚¡åˆ—è¡¨
async function deleteStockList(stockListId) {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é¸è‚¡åˆ—è¡¨å—ï¼Ÿ')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/stock-lists/${stockListId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showAlert('åˆªé™¤æˆåŠŸ', 'success');
            loadStockLists();
            
            if (currentStockListId === stockListId) {
                currentStockListId = null;
                currentStockData = [];
                document.getElementById('stockEditor').innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-mouse-pointer fa-3x mb-3"></i>
                        <p>è«‹å¾å·¦å´é¸æ“‡ä¸€å€‹é¸è‚¡åˆ—è¡¨æˆ–å»ºç«‹æ–°çš„é¸è‚¡åˆ—è¡¨</p>
                    </div>
                `;
            }
        } else {
            showAlert(data.message || 'åˆªé™¤å¤±æ•—', 'danger');
        }
    } catch (error) {
        console.error('åˆªé™¤é¸è‚¡åˆ—è¡¨å¤±æ•—:', error);
        showAlert('åˆªé™¤é¸è‚¡åˆ—è¡¨å¤±æ•—', 'danger');
    }
}

// é‡æ–°æ•´ç†é¸è‚¡åˆ—è¡¨
function refreshStockLists() {
    loadStockLists();
}

// é¡¯ç¤ºæç¤ºè¨Šæ¯
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}
</script>

<!-- å¼•å…¥ XLSX å‡½å¼åº« -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
{% endblock %} 