{% extends "base.html" %}

{% block title %}é¦–é  - å°ç£è‚¡ç¥¨å›æ¸¬+è‡ªå‹•ä¸‹å–®ç³»çµ±{% endblock %}

{% block feature_nav %}
<div class="feature-nav">
    <h4><i class="fas fa-compass"></i> åŠŸèƒ½å€å°èˆª</h4>
    <!-- é¦–é åŠŸèƒ½å€ -->
    <div class="feature-section">
        <h5><i class="fas fa-home"></i> é¦–é åŠŸèƒ½</h5>
        <div class="feature-links">
            <a href="/#overview" class="feature-link">ç³»çµ±æ¦‚è¦½ğŸ”</a>
            <a href="/#quick-actions" class="feature-link">å¿«é€Ÿæ“ä½œğŸ”</a>
            <a href="/#strategies" class="feature-link">å¯ç”¨ç­–ç•¥ğŸ§ </a>
            <a href="/#system-status" class="feature-link">ç³»çµ±ç‹€æ…‹ğŸ§ª</a>
            <a href="/#recent-trades" class="feature-link">æœ€è¿‘äº¤æ˜“ğŸ’°</a>
        </div>
    </div>    
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">
                <i class="fas fa-chart-line text-primary"></i> 
                å°ç£è‚¡ç¥¨å›æ¸¬+è‡ªå‹•ä¸‹å–®ç³»çµ±
            </h1>
        </div>
    </div>
</div>

<div class="row">
    <!-- ç³»çµ±æ¦‚è¦½ -->
    <div class="col-md-6" id="overview">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> ç³»çµ±æ¦‚è¦½</h5>
            </div>
            <div class="card-body">
                <p>é€™æ˜¯ä¸€å€‹å®Œæ•´çš„å°ç£è‚¡ç¥¨å›æ¸¬ã€è‡ªå‹•ä¸‹å–®ã€ç­–ç•¥é–‹ç™¼ç³»çµ±ï¼Œæä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š</p>
                <ul>
                    <li><strong>å›æ¸¬åŠŸèƒ½ï¼š</strong>è‡ªå®šç¾©ç­–ç•¥ã€æ­·å²è³‡æ–™å›æ¸¬</li>
                    <li><strong>è‡ªå‹•ä¸‹å–®ï¼š</strong>åŸºæ–¼ç­–ç•¥é‚è¼¯çš„å³æ™‚è‡ªå‹•äº¤æ˜“</li>
                    <li><strong>å¤šç¨®è³‡æ–™ä¾†æºï¼š</strong>APIã€å¿«å–ã€Excelæª”æ¡ˆä¸Šå‚³</li>
                    <li><strong>è©³ç´°åˆ†æï¼š</strong>äº¤æ˜“è¨˜éŒ„ã€åœ–è¡¨åˆ†æã€ç¸¾æ•ˆçµ±è¨ˆ</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- å¿«é€Ÿæ“ä½œ -->
    <div class="col-md-6" id="quick-actions">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-bolt"></i> å¿«é€Ÿæ“ä½œ</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="/backtest" class="btn btn-primary">
                        <i class="fas fa-chart-bar"></i> é–‹å§‹å›æ¸¬
                    </a>
                    <a href="/auto-trading" class="btn btn-success">
                        <i class="fas fa-robot"></i> è‡ªå‹•ä¸‹å–®
                    </a>
                    <a href="/trading-records" class="btn btn-info">
                        <i class="fas fa-history"></i> æŸ¥çœ‹äº¤æ˜“è¨˜éŒ„
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <!-- ç­–ç•¥åˆ—è¡¨ -->
    <div class="col-md-6" id="strategies">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> å¯ç”¨ç­–ç•¥</h5>
            </div>
            <div class="card-body">
                <div id="strategies-container">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                        <p>è¼‰å…¥ç­–ç•¥ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç³»çµ±ç‹€æ…‹ -->
    <div class="col-md-6" id="system-status">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-server"></i> ç³»çµ±ç‹€æ…‹</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <div class="text-center">
                            <h4 class="text-success" id="api-status">
                                <i class="fas fa-check-circle"></i> æ­£å¸¸
                            </h4>
                            <small>APIé€£æ¥ç‹€æ…‹</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <h4 class="text-info" id="database-status">
                                <i class="fas fa-database"></i> æ­£å¸¸
                            </h4>
                            <small>è³‡æ–™åº«ç‹€æ…‹</small>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-6">
                        <div class="text-center">
                            <h4 class="text-warning" id="auto-trading-status">
                                <i class="fas fa-pause-circle"></i> åœæ­¢
                            </h4>
                            <small>è‡ªå‹•ä¸‹å–®ç‹€æ…‹</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <h4 class="text-primary" id="active-strategies">
                                <i class="fas fa-cogs"></i> 0
                            </h4>
                            <small>æ´»èºç­–ç•¥</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <!-- æœ€è¿‘äº¤æ˜“è¨˜éŒ„ -->
    <div class="col-12" id="recent-trades">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-history"></i> æœ€è¿‘äº¤æ˜“è¨˜éŒ„</h5>
                <a href="/trading-records" class="btn btn-sm btn-outline-primary">æŸ¥çœ‹å…¨éƒ¨</a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>è‚¡ç¥¨ä»£ç¢¼</th>
                                <th>ç­–ç•¥</th>
                                <th>æ–¹å‘</th>
                                <th>é€²å ´åƒ¹</th>
                                <th>å‡ºå ´åƒ¹</th>
                                <th>æç›Š</th>
                                <th>æç›Šç‡</th>
                            </tr>
                        </thead>
                        <tbody id="recent-trades">
                            <tr>
                                <td colspan="8" class="text-center text-muted">
                                    å°šç„¡äº¤æ˜“è¨˜éŒ„
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- è¼‰å…¥ä¸­ -->
<div class="loading">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
    </div>
    <p class="mt-2">è¼‰å…¥ä¸­...</p>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* ç­–ç•¥å¡ç‰‡æ¨£å¼ */
.strategy-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    height: 100%;
}

.strategy-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    border-color: #007bff;
}

.strategy-card .card-body {
    padding: 1rem;
}

.strategy-card h6 {
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.strategy-card small {
    font-size: 0.85rem;
    line-height: 1.3;
}

/* è¼‰å…¥å‹•ç•« */
.fa-spinner {
    color: #007bff;
}
</style>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // è¼‰å…¥ç­–ç•¥åˆ—è¡¨
    loadStrategies();
    
    // è¼‰å…¥æœ€è¿‘äº¤æ˜“è¨˜éŒ„
    loadRecentTrades();
    
    // æª¢æŸ¥ç³»çµ±ç‹€æ…‹
    checkSystemStatus();
});

// è¼‰å…¥ç­–ç•¥åˆ—è¡¨
function loadStrategies() {
    fetch('/api/strategies/custom')
        .then(response => {
            console.log('API å›æ‡‰ç‰©ä»¶:', response);
            return response.json();
        })
        .then(data => {
            console.log('API å›å‚³è³‡æ–™:', data);
            if (data.status === 'success' && data.strategies) {
                displayStrategies(data.strategies);
            } else {
                showNoStrategies();
            }
        })
        .catch(error => {
            console.error('è¼‰å…¥ç­–ç•¥åˆ—è¡¨å¤±æ•—:', error);
            showNoStrategies();
        });
}

// é¡¯ç¤ºç­–ç•¥åˆ—è¡¨
function displayStrategies(strategies) {
    var container = document.getElementById('strategies-container');
    if (!container) return;
    if (!strategies || strategies.length === 0) {
        showNoStrategies();
        return;
    }
    // åƒ…ä¿ç•™å·²ç¢ºèªçš„ç­–ç•¥
    var confirmed = strategies.filter(function(s) { return s.is_confirmed; });
    if (confirmed.length === 0) {
        showNoStrategies();
        return;
    }
    var html = '<div class="row">';
    confirmed.forEach(function(strategy) {
        var icon = '<i class="fas fa-check-circle fa-2x text-success mb-2"></i>';
        var label = `âœ… ${strategy.name} <span style=\"font-size:0.9em;color:#aaa;\">(å·²ç¢ºèª)</span>`;
        var desc = strategy.description ? `<small class="text-muted">${strategy.description}</small>` : '';
        html += `
            <div class="col-md-6 mb-3">
                <div class="card strategy-card" style="cursor:pointer;" onclick="window.location.href='/backtest?strategy=custom_${strategy.id}'">
                    <div class="card-body text-center">
                        ${icon}
                        <h6>${label}</h6>
                        ${desc}
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

// é¡¯ç¤ºç„¡ç­–ç•¥è¨Šæ¯
function showNoStrategies() {
    const container = $('#strategies-container');
    container.html(`
        <div class="text-center text-muted">
            <i class="fas fa-info-circle fa-2x mb-2"></i>
            <p>æš«ç„¡å¯ç”¨ç­–ç•¥</p>
            <a href="/strategy-editor" class="btn btn-sm btn-primary">
                <i class="fas fa-plus"></i> å»ºç«‹ç­–ç•¥
            </a>
        </div>
    `);
}

// é¡¯ç¤ºç­–ç•¥è³‡è¨Š
function showStrategyInfo(strategyId, strategyName) {
    // è·³è½‰åˆ°å›æ¸¬é é¢ä¸¦é è¨­é¸æ“‡è©²ç­–ç•¥
    window.location.href = `/backtest?strategy=custom_${strategyId}`;
}

// è¼‰å…¥æœ€è¿‘äº¤æ˜“è¨˜éŒ„
function loadRecentTrades() {
    fetch('/api/trades/recent')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success' && data.trades.length > 0) {
                displayRecentTrades(data.trades);
            }
        })
        .catch(error => {
            console.error('è¼‰å…¥æœ€è¿‘äº¤æ˜“è¨˜éŒ„å¤±æ•—:', error);
        });
}

// é¡¯ç¤ºæœ€è¿‘äº¤æ˜“è¨˜éŒ„
function displayRecentTrades(trades) {
    const tbody = $('#recent-trades');
    tbody.empty();
    
    trades.forEach(trade => {
        const row = `
            <tr>
                <td>${formatDate(trade.entry_date)}</td>
                <td>${trade.stock_id}</td>
                <td>${trade.strategy_name}</td>
                <td>
                    <span class="badge ${trade.trade_direction === 1 ? 'bg-success' : 'bg-danger'}">
                        ${trade.trade_direction === 1 ? 'åšå¤š' : 'åšç©º'}
                    </span>
                </td>
                <td>${formatNumber(trade.entry_price)}</td>
                <td>${formatNumber(trade.exit_price)}</td>
                <td class="${trade.net_profit_loss >= 0 ? 'text-success' : 'text-danger'}">
                    ${formatNumber(trade.net_profit_loss)}
                </td>
                <td class="${trade.profit_loss_rate >= 0 ? 'text-success' : 'text-danger'}">
                    ${formatPercentage(trade.profit_loss_rate)}
                </td>
            </tr>
        `;
        tbody.append(row);
    });
}

// æª¢æŸ¥ç³»çµ±ç‹€æ…‹
function checkSystemStatus() {
    fetch('/api/system/status')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                updateSystemStatus(data.status_info);
            }
        })
        .catch(error => {
            console.error('æª¢æŸ¥ç³»çµ±ç‹€æ…‹å¤±æ•—:', error);
        });
}

// æ›´æ–°ç³»çµ±ç‹€æ…‹
function updateSystemStatus(statusInfo) {
    // æ›´æ–°APIç‹€æ…‹
    if (statusInfo.api_status === 'normal') {
        $('#api-status').html('<i class="fas fa-check-circle"></i> æ­£å¸¸');
    } else {
        $('#api-status').html('<i class="fas fa-times-circle"></i> ç•°å¸¸');
    }
    
    // æ›´æ–°è³‡æ–™åº«ç‹€æ…‹
    if (statusInfo.database_status === 'normal') {
        $('#database-status').html('<i class="fas fa-database"></i> æ­£å¸¸');
    } else {
        $('#database-status').html('<i class="fas fa-exclamation-triangle"></i> ç•°å¸¸');
    }
    
    // æ›´æ–°è‡ªå‹•ä¸‹å–®ç‹€æ…‹
    if (statusInfo.auto_trading_status === 'running') {
        $('#auto-trading-status').html('<i class="fas fa-play-circle"></i> åŸ·è¡Œä¸­');
    } else {
        $('#auto-trading-status').html('<i class="fas fa-pause-circle"></i> åœæ­¢');
    }
    
    // æ›´æ–°æ´»èºç­–ç•¥æ•¸é‡
    $('#active-strategies').html(`<i class="fas fa-cogs"></i> ${statusInfo.active_strategies}`);
}
</script>
{% endblock %} 