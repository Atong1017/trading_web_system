{% extends "base.html" %}

{% block title %}策略編輯器{% endblock %}

{% block feature_nav %}
<div class="feature-nav">
    <h4><i class="fas fa-compass"></i> 功能區導航</h4>
    <!-- 策略編輯器功能區 -->
    <div class="feature-section">
        <h5><i class="fas fa-code"></i> 策略編輯器</h5>
        <div class="feature-links">
            <a href="/strategy-editor#mainEditor" class="feature-link">置頂🏠</a>
            <a href="/strategy-editor#code" class="feature-link">程式碼✏️ </a>
            <a href="/strategy-editor#test" class="feature-link">交易報表💰</a>
            <a href="/strategy-editor#parameters" class="feature-link">策略參數🛠️</a>
            <a href="#" class="feature-link" id="chartsLink" onclick="navigateChartsSection(event)">圖表分析📈</a>
            <!-- <a href="/strategy-editor#preview" class="feature-link">資料預覽🔍</a> -->
        </div>
    </div>    
</div>
{% endblock %}

{% block extra_css %}
<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/eclipse.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.css">
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<!-- Sortable.js -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
    .CodeMirror {
        height: 100%;
        font-family: 'Fira Code', 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.5;
    }
    
    .CodeMirror-gutters {
        background-color: #f8f9fa;
        border-right: 1px solid #dee2e6;
    }
    
    .CodeMirror-linenumber {
        color: #6c757d;
    }
    
    .CodeMirror-cursor {
        border-left: 2px solid #007bff;
    }
    
    .CodeMirror-selected {
        background-color: #e3f2fd;
    }
    
    .cm-s-monokai.CodeMirror {
        background-color: #272822;
        color: #f8f8f2;
    }
    
    .cm-s-eclipse.CodeMirror {
        background-color: #ffffff;
        color: #000000;
    }
    
    .cm-s-dracula.CodeMirror {
        background-color: #282a36;
        color: #f8f8f2;
    }
    
    .editor-toolbar {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 8px;
        display: flex;
        gap: 8px;
        align-items: center;
    }
    
    .theme-selector {
        margin-left: auto;
    }
    
    .fullscreen-editor {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 9999;
        background-color: white;
        display: flex;
        flex-direction: column;
    }
    
    .fullscreen-editor .CodeMirror {
        flex: 1;
    }
    
    .fullscreen-toolbar {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .fullscreen-toolbar h5 {
        margin: 0;
    }
    
    /* 拖拽排序樣式 */
    .sortable-ghost {
        opacity: 0.5;
        background-color: #f8f9fa;
        border: 2px dashed #dee2e6;
    }
    
    .sortable-chosen {
        background-color: #e3f2fd;
        border: 2px solid #2196f3;
        transform: rotate(2deg);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .sortable-drag {
        opacity: 0.8;
        transform: rotate(5deg);
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }
    
    /* 參數卡片美化 */
    .parameter-item .card {
        transition: all 0.3s ease;
        border-radius: 8px;
    }
    
    .parameter-item .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .parameter-item .card-title {
        color: #495057;
        font-weight: 600;
    }
    
    .parameter-item .form-label {
        font-weight: 500;
        color: #6c757d;
    }
    
    .parameter-item .form-control,
    .parameter-item .form-select {
        border-radius: 6px;
        border: 1px solid #dee2e6;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    .parameter-item .form-control:focus,
    .parameter-item .form-select:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    /* 參數類型標籤 */
    .parameter-type-badge {
        display: inline-block;
        padding: 2px 8px;
        font-size: 0.7rem;
        font-weight: 500;
        border-radius: 12px;
        text-transform: uppercase;
    }
    
    .parameter-type-badge.number {
        background-color: #e3f2fd;
        color: #1976d2;
    }
    
    .parameter-type-badge.text {
        background-color: #f3e5f5;
        color: #7b1fa2;
    }
    
    .parameter-type-badge.select {
        background-color: #e8f5e8;
        color: #388e3c;
    }
    
    .parameter-type-badge.boolean {
        background-color: #fff3e0;
        color: #f57c00;
    }
    
    .parameter-type-badge.dynamic {
        background-color: #fce4ec;
        color: #c2185b;
    }
    
    .parameter-type-badge.date {
        background-color: #e0f2f1;
        color: #00695c;
    }
    
    /* 側邊欄展開/縮起功能 */
    #sidebar {
        transition: all 0.3s ease;
    }
    
    #sidebar.collapsed {
        width: 60px !important;
        min-width: 60px !important;
        max-width: 60px !important;
    }
    
    #sidebar.collapsed .card-body {
        display: none;
    }
    
    #sidebar.collapsed .card-header h5 {
        display: none;
    }
    
    #sidebar.collapsed .card-header {
        padding: 0.5rem;
        text-align: center;
    }
    
    #sidebar.collapsed #toggleIcon {
        transform: rotate(180deg);
    }
    
    #mainEditor {
        transition: all 0.3s ease;
    }
    
    #mainEditor.expanded {
        width: calc(100% - 60px) !important;
        max-width: calc(100% - 60px) !important;
    }
    
    /* Jupyter 編輯器樣式 */
    .jupyter-cell {
        margin-bottom: 1rem;
        border: 1px solid #e1e4e8;
        border-radius: 6px;
        background-color: #ffffff;
        transition: all 0.2s ease;
    }
    
    .jupyter-cell:hover {
        border-color: #0366d6;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .jupyter-cell-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem;
        background-color: #f6f8fa;
        border-bottom: 1px solid #e1e4e8;
        border-radius: 6px 6px 0 0;
    }
    
    .jupyter-cell-number {
        font-size: 0.8rem;
        color: #586069;
        font-weight: 500;
    }
    
    .jupyter-cell-actions {
        display: flex;
        gap: 0.25rem;
    }
    
    .jupyter-cell-actions .btn {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
        transition: all 0.2s ease;
    }
    
    .jupyter-cell-actions .btn:hover {
        transform: scale(1.1);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .jupyter-cell-actions .btn:active {
        transform: scale(0.95);
    }
    
    .jupyter-cell-input {
        padding: 0.75rem;
        background-color: #ffffff;
    }
    
    .jupyter-cell-input .CodeMirror {
        border: none;
        background-color: transparent;
    }
    
    .jupyter-cell-output {
        padding: 0.75rem;
        background-color: #fafbfc;
        border-top: 1px solid #e1e4e8;
        border-radius: 0 0 6px 6px;
        min-height: 2rem;
    }
    
    .jupyter-cell-output:empty {
        display: none;
    }
    
    .jupyter-cell-output .output-item {
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background-color: #ffffff;
        border: 1px solid #e1e4e8;
        border-radius: 4px;
    }
    
    .jupyter-cell-output .output-item:last-child {
        margin-bottom: 0;
    }
    
    .jupyter-cell-output .output-stream {
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        white-space: pre-wrap;
        word-break: break-word;
    }
    
    .jupyter-cell-output .output-stream.stdout {
        color: #24292e;
    }
    
    .jupyter-cell-output .output-stream.stderr {
        color: #d73a49;
    }
    
    .jupyter-cell-output .output-error {
        color: #d73a49;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        white-space: pre-wrap;
        word-break: break-word;
    }
    
    .jupyter-cell-output .output-display {
        overflow-x: auto;
    }
    
    .jupyter-cell-output .output-display img {
        max-width: 100%;
        height: auto;
    }
    
    .jupyter-cell-output .output-display table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
    }
    
    .jupyter-cell-output .output-display table th,
    .jupyter-cell-output .output-display table td {
        border: 1px solid #e1e4e8;
        padding: 0.25rem 0.5rem;
        text-align: left;
    }
    
    .jupyter-cell-output .output-display table th {
        background-color: #f6f8fa;
        font-weight: 600;
    }
    
    .jupyter-cell.executing {
        border-color: #0366d6;
        box-shadow: 0 0 0 3px rgba(3, 102, 214, 0.1);
    }
    
    .jupyter-cell.executing .jupyter-cell-header {
        background-color: #0366d6;
        color: #ffffff;
    }
    
    .jupyter-cell.executing .jupyter-cell-number {
        color: #ffffff;
    }
    
    .jupyter-cell.executing .jupyter-cell-actions .btn {
        color: #ffffff;
        border-color: #ffffff;
    }
    
    .jupyter-cell.executing .jupyter-cell-actions .btn:hover {
        background-color: #ffffff;
        color: #0366d6;
    }
    
    .jupyter-cell.error {
        border-color: #d73a49;
        box-shadow: 0 0 0 3px rgba(215, 58, 73, 0.1);
    }
    
    .jupyter-cell.error .jupyter-cell-header {
        background-color: #d73a49;
        color: #ffffff;
    }
    
    .jupyter-cell.error .jupyter-cell-number {
        color: #ffffff;
    }
    
    .jupyter-cell.error .jupyter-cell-actions .btn {
        color: #ffffff;
        border-color: #ffffff;
    }
    
    .jupyter-cell.error .jupyter-cell-actions .btn:hover {
        background-color: #ffffff;
        color: #d73a49;
    }
    
    .jupyter-cell.success {
        border-color: #28a745;
        box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
    }
    
    .jupyter-cell.success .jupyter-cell-header {
        background-color: #28a745;
        color: #ffffff;
    }
    
    .jupyter-cell.success .jupyter-cell-number {
        color: #ffffff;
    }
    
    .jupyter-cell.success .jupyter-cell-actions .btn {
        color: #ffffff;
        border-color: #ffffff;
    }
    
    .jupyter-cell.success .jupyter-cell-actions .btn:hover {
        background-color: #ffffff;
        color: #28a745;
    }
    
    /* 策略參數橫向並排 */
    .strategy-params-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 12px 24px;
    }
    
    .strategy-params-grid .parameter-item {
        margin-bottom: 0.5rem;
    }
    
    .strategy-params-grid label.form-label {
        font-size: 0.95rem;
        font-weight: 500;
    }
    
    .strategy-params-grid .form-text {
        font-size: 0.85rem;
        color: #888;
    }
    
    @media (max-width: 600px) {
        .strategy-params-grid {
            grid-template-columns: 1fr;
        }
    }

    /* 深色主題支援 */
    body.dark-mode .editor-sidebar,
    body.dark-mode .card,
    body.dark-mode .card-body,
    body.dark-mode .jupyter-toolbar,
    body.dark-mode .jupyter-cell,
    body.dark-mode .jupyter-cell-header,
    body.dark-mode .jupyter-cell-input,
    body.dark-mode .jupyter-cell-output,
    body.dark-mode .editor-toolbar {
        background-color: #23272e !important;
        color: #f8f9fa !important;
        border-color: #444c56 !important;
    }
    body.dark-mode .jupyter-cell-output .output-item,
    body.dark-mode .jupyter-cell-output {
        background-color: #23272e !important;
        color: #f8f9fa !important;
        border-color: #444c56 !important;
    }
    body.dark-mode .jupyter-cell-header,
    body.dark-mode .editor-toolbar,
    body.dark-mode .jupyter-toolbar {
        background-color: #23272e !important;
        color: #f8f9fa !important;
        border-bottom: 1px solid #444c56 !important;
    }
    body.dark-mode .jupyter-cell-output .output-stream.stdout {
        color: #e6e6e6 !important;
    }
    body.dark-mode .jupyter-cell-output .output-stream.stderr,
    body.dark-mode .jupyter-cell-output .output-error {
        color: #ff6f6f !important;
    }
    body.dark-mode .jupyter-cell-output .output-display table th,
    body.dark-mode .jupyter-cell-output .output-display table td {
        background-color: #23272e !important;
        color: #f8f9fa !important;
        border-color: #444c56 !important;
    }
    body.dark-mode .jupyter-cell-output .output-display table th {
        background-color: #2d333b !important;
    }
    body.dark-mode .btn,
    body.dark-mode .form-control,
    body.dark-mode .form-select {
        background-color: #23272e !important;
        color: #f8f9fa !important;
        border-color: #444c56 !important;
    }
    body.dark-mode .btn-info {
        background-color: #17a2b8 !important;
        color: #fff !important;
    }
    body.dark-mode .btn-success {
        background-color: #28a745 !important;
        color: #fff !important;
    }
    body.dark-mode .btn-warning {
        background-color: #ffc107 !important;
        color: #23272e !important;
    }
    body.dark-mode .btn-outline-info,
    body.dark-mode .btn-outline-secondary,
    body.dark-mode .btn-outline-warning,
    body.dark-mode .btn-outline-dark {
        color: #f8f9fa !important;
        border-color: #888 !important;
    }
    body.dark-mode .bg-light,
    body.dark-mode .border-bottom,
    body.dark-mode .bg-light.border-bottom {
        background-color: #23272e !important;
        color: #f8f9fa !important;
        border-bottom: 1px solid #444c56 !important;
    }
    body.dark-mode .form-control:focus,
    body.dark-mode .form-select:focus {
        border-color: #80bdff !important;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.15) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- 左側策略管理清單 -->
        <div class="col-md-3 editor-sidebar" id="sidebar">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>策略管理</h5>
                    <button class="btn btn-sm btn-outline-secondary" id="toggleSidebar" title="展開/縮起側邊欄">
                        <i class="fas fa-chevron-left" id="toggleIcon"></i>
                    </button>
                </div>
                <div class="card-body" id="sidebarContent">
                    <div class="mb-3">
                        <button class="btn btn-primary btn-sm" onclick="createNewStrategy()">
                            <i class="fas fa-plus"></i> 新建策略
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <input type="text" class="form-control form-control-sm" id="searchStrategy" 
                               placeholder="搜尋策略..." onkeyup="searchStrategies()">
                    </div>
                    
                    <div id="strategyList" class="list-group">
                        <!-- 策略列表將在這裡動態載入 -->
                    </div>
                </div>
            </div>
        </div>
        <!-- 右側程式碼編輯區塊 -->
        <div class="col-md-9" id="mainEditor">
            <div class="editor-code-area">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 id="editorTitle">策略編輯器</h5>
                    <div>
                        <button class="btn btn-warning btn-sm" onclick="exportStrategy()">
                            <i class="fas fa-download"></i> 匯出/下載
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteStrategy()">
                            <i class="fas fa-trash"></i> 刪除
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 策略基本資訊 -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="strategyName" class="form-label">策略名稱</label>
                            <input type="text" class="form-control" id="strategyName" placeholder="輸入策略名稱">
                        </div>
                        <div class="col-md-6">
                            <label for="strategyDescription" class="form-label">策略描述</label>
                            <input type="text" class="form-control" id="strategyDescription" placeholder="輸入策略描述">
                        </div>
                    </div>
                    
                    <!-- 股票來源設定 -->
                    <div class="mb-3">
                        <label class="form-label">股票來源</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="stockSource" id="stockSourceExcel" value="excel" checked>
                                    <label class="form-check-label" for="stockSourceExcel">
                                        <i class="fas fa-file-excel"></i> Excel 檔案
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="stockSource" id="stockSourceList" value="stock_list">
                                    <label class="form-check-label" for="stockSourceList">
                                        <i class="fas fa-list"></i> 選股列表
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="stockSource" id="stockSourceCache" value="cache">
                                    <label class="form-check-label" for="stockSourceCache">
                                        <i class="fas fa-database"></i> 快取資料
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                    <div id="excelSourceConfig" class="stock-source-config" style="display: none;">
                                        <div class="input-group">
                                            <input type="file" class="form-control" id="excelFile" accept=".xlsx,.xls" style="display: none;">
                                            <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('excelFile').click()">
                                                <i class="fas fa-upload"></i> 選擇檔案
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="downloadExcelTemplate()">
                                                <i class="fas fa-download"></i> 下載範本
                                            </button>
                                        </div>
                                        <small class="form-text text-muted">上傳包含股票代碼和日期的 Excel 檔案，系統會從策略使用表格中取得對應的股價資料</small>
                                        <div id="excelFileInfo" class="mt-1" style="display: none;">
                                            <small class="text-success">
                                                <i class="fas fa-check"></i> <span id="excelFileName"></span>
                                            </small>
                                        </div>
                                </div>
                                <div id="stockListConfig" class="stock-source-config" style="display: none;">
                                    <select class="form-control" id="stockListSelect">
                                        <option value="">請選擇選股列表...</option>
                                    </select>
                                    <small class="text-muted">或 <a href="/stock-selector" target="_blank">建立新的選股列表</a></small>
                                </div>
                            </div>
                        </div>
                    </div>
                        
                        <!-- 測試設定 -->
                        <div class="mb-3">
                            <label class="form-label">測試設定</label>
                            <div class="row">
                                <div class="col-md-12">
                                    <label for="strategyDataTable">策略使用表格</label>
                                    <select class="form-control" id="strategyDataTable">
                                        <option value="auto">自動選擇</option>
                                        <option value="cache_files" disabled>--- 快取檔案 ---</option>
                                    </select>
                                    <small class="form-text text-muted">策略程式碼中要使用的資料表格</small>
                                    <button type="button" class="btn btn-sm btn-outline-secondary mt-1" onclick="refreshCacheFiles()">
                                        <i class="fas fa-sync-alt"></i> 重新整理快取檔案
                                    </button>
                                </div>
                            </div>
                        </div>
                    
                    <!-- Jupyter 風格程式碼編輯器 -->
                    <div class="mb-3" id="code">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label">
                                <i class="fas fa-code text-primary"></i> Jupyter 風格程式碼編輯器
                            </label>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#jupyterHelpCollapse">
                                    <i class="fas fa-question-circle"></i> 使用說明
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="toggleJupyterMode()" id="jupyterModeBtn">
                                    <i class="fas fa-play"></i> 切換 Jupyter 模式
                                </button>
                            </div>
                        </div>
                        
                        <!-- Jupyter 使用說明摺疊區塊 -->
                        <div class="collapse mb-3" id="jupyterHelpCollapse">
                            <div class="card card-body bg-light">
                                <h6><i class="fas fa-info-circle text-info"></i> Jupyter 風格編輯器使用說明</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-primary">可用模組：</h6>
                                        <ul class="list-unstyled">
                                            <li><strong>np</strong> - NumPy 數值計算</li>
                                            <li><strong>pd</strong> - Pandas 資料處理</li>
                                            <li><strong>pl</strong> - Polars 高效能資料處理</li>
                                            <li><strong>plt</strong> - Matplotlib 繪圖</li>
                                            <li><strong>sns</strong> - Seaborn 統計繪圖</li>
                                            <li><strong>go</strong> - Plotly 互動圖表</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-success">策略工具：</h6>
                                        <ul class="list-unstyled small">
                                            <li><strong>PriceUtils</strong> - 價格計算工具</li>
                                            <li><strong>Utils</strong> - 通用工具類別</li>
                                            <li><strong>TradeRecord</strong> - 交易記錄資料類別</li>
                                            <li><strong>HoldingPosition</strong> - 持有部位資料類別</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-lightbulb"></i> 提示：按 Shift+Enter 執行程式碼，Ctrl+Enter 執行並新增單元格
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Jupyter 編輯器容器 -->
                        <div id="jupyterEditor" class="border rounded" style="display: none;">
                            <div class="jupyter-toolbar d-flex justify-content-between align-items-center p-2 bg-light border-bottom">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="loadSampleData()">
                                        <i class="fas fa-download"></i> 載入範例資料
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="analyzeStrategyType()">
                                        <i class="fas fa-search"></i> 分析策略類型
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" onclick="clearAllOutputs()">
                                        <i class="fas fa-trash"></i> 清除輸出
                                    </button>
                                    <button class="btn btn-sm btn-outline-dark" onclick="clearJupyterVariables()">
                                        <i class="fas fa-broom"></i> 清除變數
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" onclick="showJupyterVariables()">
                                        <i class="fas fa-eye"></i> 查看變數
                                    </button>                                   
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-warning" onclick="exportJupyterNotebook()">
                                        <i class="fas fa-download"></i> 匯出
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="saveJupyterNotebook()">
                                        <i class="fas fa-save"></i> 儲存筆記本
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="saveJupyterStrategy()">
                                        <i class="fas fa-save"></i> 儲存策略
                                    </button>
                                    <button class="btn btn-info btn-sm" onclick="executeJupyterBacktest()">
                                        <i class="fas fa-play"></i> 測試
                                    </button>    
                                </div>
                            </div>
                            <div id="jupyterCells" class="p-2">
                                <!-- Jupyter 單元格將在這裡動態生成 -->
                            </div>
                        </div>
                        
                        <!-- 傳統程式碼編輯器 -->
                        <div id="traditionalEditor" class="border rounded">
                            <div class="editor-toolbar d-flex justify-content-between align-items-center">
                                <div class="d-flex gap-2">
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="templateDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fas fa-file-code"></i> 載入模板
                                        </button>
                                        <ul class="dropdown-menu" aria-labelledby="templateDropdown">                                            
                                            <li><a class="dropdown-item" href="#" onclick="loadTemplate('vectorized')">
                                                <i class="fas fa-rocket"></i> 向量化模板
                                                <small class="text-muted d-block">效能最佳，適用於簡單邏輯</small>
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="loadTemplate('state_machine')">
                                                <i class="fas fa-cogs"></i> 狀態機模板
                                                <small class="text-muted d-block">適用於複雜邏輯和狀態追蹤</small>
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="loadTemplate('mixed')">
                                                <i class="fas fa-layer-group"></i> 混合模式模板
                                                <small class="text-muted d-block">包含向量化和狀態機兩種模式</small>
                                            </a></li>
                                        </ul>
                                    </div>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="loadSampleData()">
                                        <i class="fas fa-download"></i> 載入範例資料
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="formatCode()">格式化</button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="validateCode()">驗證語法</button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleFullscreen()">
                                        <i class="fas fa-expand"></i> 全螢幕
                                    </button>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-success btn-sm" onclick="saveStrategy()">
                                        <i class="fas fa-save"></i> 儲存
                                    </button>
                                    <button class="btn btn-info btn-sm" onclick="testStrategy()">
                                        <i class="fas fa-play"></i> 測試
                                    </button>
                                </div>
                            </div>
                            <div id="codeEditorContainer" style="height: 800px; position: relative;">
                                <textarea id="strategyCode" placeholder="請輸入策略程式碼..."></textarea>
                            </div>
                        </div>
                    </div>
                        
                        <!-- 交易報表區域 -->
                        <div class="mb-3" id="test" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label">
                                    <i class="fas fa-chart-line text-primary"></i> 交易報表
                                </label>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="exportTradeReport()">
                                        <i class="fas fa-download"></i> 匯出報表
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#tradeReportCollapse">
                                        <i class="fas fa-chevron-down"></i> 展開/縮起
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 交易報表摺疊區塊 -->
                            <div class="collapse show" id="tradeReportCollapse">
                                <div class="card">
                                    <div class="card-body p-0">
                                        <!-- 交易統計摘要 -->
                                        <div class="row g-0 bg-light border-bottom">
                                            <div class="col-md-3 p-3 text-center">
                                                <div class="h5 mb-1 text-primary" id="totalTrades">0</div>
                                                <small class="text-muted">總交易次數</small>
                                            </div>
                                            <div class="col-md-3 p-3 text-center">
                                                <div class="h5 mb-1 text-success" id="winRate">0%</div>
                                                <small class="text-muted">勝率</small>
                                            </div>
                                            <div class="col-md-3 p-3 text-center">
                                                <div class="h5 mb-1" id="totalReturn">0%</div>
                                                <small class="text-muted">總報酬率</small>
                                            </div>
                                            <div class="col-md-3 p-3 text-center">
                                                <div class="h5 mb-1 text-danger" id="maxDrawdown">0%</div>
                                                <small class="text-muted">最大回撤</small>
                                            </div>
                                        </div>
                                        
                                        <!-- 交易記錄表格 -->
                                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                            <table class="table table-sm table-hover mb-0" id="tradeReportTable">
                                                <thead class="table-dark sticky-top">
                                                    <tr>
                                                        <th>進場日期</th>
                                                        <th>出場日期</th>
                                                        <th>股票代碼</th>
                                                        <th>股票名稱</th>
                                                        <th>進場價</th>
                                                        <th>出場價</th>
                                                        <th>股數</th>
                                                        <th>報酬</th>
                                                        <th>報酬率</th>
                                                        <th>持有天數</th>
                                                        <th>出場理由</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tradeReportBody">
                                                    <!-- 交易記錄將在這裡動態生成 -->
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                        <!-- 持有部位表格 -->
                                        <div class="mt-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <h6>持有未出場部位</h6>
                                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="exportHoldingPositionsReport()">
                                                    <i class="fas fa-download"></i> 匯出持有部位報表
                                                </button>
                                            </div>
                                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                                <table class="table table-sm table-hover mb-0" id="holdingPositionsTable">
                                                    <thead class="table-dark sticky-top">
                                                        <tr>
                                                            <th>進場日期</th>
                                                            <th>股票代碼</th>
                                                            <th>股票名稱</th>
                                                            <th>方向</th>
                                                            <th>進場價</th>
                                                            <th>當前價</th>
                                                            <th>股數</th>
                                                            <th>未實現損益</th>
                                                            <th>未實現損益率</th>
                                                            <th>持有天數</th>
                                                            <th>停利價</th>
                                                            <th>停損價</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="holdingPositionsBody">
                                                        <!-- 持有部位將在這裡動態生成 -->
                                                    </tbody>
                                                </table>
                                            </div>
                                            
                                            <!-- 無持有部位提示 -->
                                            <div id="noHoldingMessage" class="text-center text-muted py-3" style="display: none;">
                                                <i class="fas fa-hand-holding-usd fa-2x mb-2"></i>
                                                <p>目前沒有持有未出場的部位</p>
                                            </div>
                                        </div>
                                        
                                        <!-- 無交易記錄提示 -->
                                        <div id="noTradeMessage" class="text-center text-muted py-4" style="display: none;">
                                            <i class="fas fa-chart-line fa-2x mb-2"></i>
                                            <p>執行測試後將顯示交易記錄</p>
                                        </div>
                                    </div>
                                </div>
                                                    </div>
                    </div>
                    
                    <!-- 圖表分析區域 -->
                    <div class="mb-3" id="charts" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label">
                                <i class="fas fa-chart-bar text-info"></i> 圖表分析
                            </label>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary me-2" onclick="refreshCharts()">
                                    <i class="fas fa-sync-alt"></i> 重新整理
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="exportCharts()">
                                    <i class="fas fa-download"></i> 匯出圖表
                                </button>
                            </div>
                        </div>
                        <div id="chartsContainer" class="border rounded p-3" style="min-height: 320px;">
                            <!-- 圖表會在這裡動態生成 -->
                        </div>
                        <div id="noChartsMessage" class="text-center text-muted py-4" style="display: none;">
                            <i class="fas fa-chart-bar fa-2x mb-2"></i>
                            <p>執行測試後將顯示圖表分析</p>
                        </div>
                    </div>
                    
                    <!-- 參數配置 -->
                    <div class="mb-3" id="parameters">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label">策略參數</label>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="toggleParameterSort()" id="sortToggleBtn">
                                        <i class="fas fa-sort"></i> 排序模式
                                    </button>
                                    <button type="button" class="btn btn-sm btn-primary" onclick="addParameter()">
                                        <i class="fas fa-plus"></i> 新增參數
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 持有記錄功能開關 - 暫時隱藏 -->
                            <!-- <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="recordHoldingsSwitch" onchange="toggleRecordHoldings()">
                                    <label class="form-check-label" for="recordHoldingsSwitch">
                                        <i class="fas fa-hand-holding-usd me-2"></i>
                                        啟用持有未出場記錄功能
                                    </label>
                                </div>
                                <div class="form-text">
                                    啟用後將記錄策略中尚未出場的部位，包括未實現損益等資訊
                                </div>
                            </div> -->
                            
                        <div id="parameterConfig" class="border rounded p-3">
                                <div id="parameterContainer" class="strategy-params-grid">
                                    <!-- 參數會在這裡動態生成 -->
                                </div>
                                <div id="parameterEmpty" class="text-center text-muted py-4">
                                    <i class="fas fa-cog fa-2x mb-2"></i>
                                    <p>參數配置將根據程式碼自動生成</p>
                                </div>
                        </div>
                    </div>
                    
                    <!-- 資料預覽區域 -->
                    <div class="mb-3" id="preview">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label">資料預覽</label>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary" onclick="clearPreviewData()">
                                    <i class="fas fa-trash"></i> 清除
                                </button>
                            </div>
                        </div>
                        <div id="dataPreview" class="border rounded p-3" style="display: none;">
                            <div class="mb-2">
                                <strong>資料資訊：</strong>
                                <span id="dataInfo">載入中...</span>
                            </div>
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-striped" id="dataTable">
                                    <thead class="table-dark sticky-top">
                                        <!-- 表頭將動態生成 -->
                                    </thead>
                                    <tbody>
                                        <!-- 資料行將動態生成 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 測試結果 -->
            <div class="card mt-3" id="testResults" style="display: none;">
                <div class="card-header">
                    <h6>測試結果</h6>
                </div>
                <div class="card-body">
                    <div id="testOutput"></div>
                    </div>
                </div>
            </div>
            
            <!-- Jupyter 專用圖表容器 -->
            <div class="card mt-3" id="jupyterChartsSection" style="display: none;">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6><i class="fas fa-chart-bar text-primary"></i> 策略圖表</h6>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary me-2" onclick="refreshJupyterCharts()">
                                <i class="fas fa-sync-alt"></i> 重新整理
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportJupyterCharts()">
                                <i class="fas fa-download"></i> 匯出圖表
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="jupyterChartsContainer" class="border rounded p-3" style="min-height: 320px;">
                        <!-- Jupyter 圖表將在這裡動態生成 -->
                    </div>
                    <div id="jupyterNoChartsMessage" class="text-center text-muted py-4" style="display: none;">
                        <i class="fas fa-chart-bar fa-2x mb-2"></i>
                        <p>執行策略回測後將顯示圖表分析</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 新建策略對話框 -->
<div class="modal fade" id="newStrategyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">新建策略</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="newStrategyName" class="form-label">策略名稱</label>
                    <input type="text" class="form-control" id="newStrategyName" placeholder="輸入策略名稱">
                </div>
                <div class="mb-3">
                    <label for="newStrategyDescription" class="form-label">策略描述</label>
                    <textarea class="form-control" id="newStrategyDescription" rows="3" placeholder="輸入策略描述"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">編輯模式</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="editorMode" id="modeTraditional" value="traditional">
                        <label class="form-check-label" for="modeTraditional">
                            <i class="fas fa-file-code"></i> 傳統編輯器 <span class="text-muted small">（完整策略程式碼編輯）</span>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="editorMode" id="modeJupyter" value="jupyter" checked>
                        <label class="form-check-label" for="modeJupyter">
                            <i class="fas fa-play"></i> Jupyter 模式 <span class="text-muted small">（互動式單元格編輯）</span>
                        </label>
                    </div>
                </div>
                
                <div class="mb-3" id="strategyTypeSection">
                    <label class="form-label">策略類型</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="strategyType" id="typeVectorized" value="vectorized" checked>
                        <label class="form-check-label" for="typeVectorized">
                            向量化模板 <span class="text-muted small">（效能最佳，適用簡單邏輯）</span>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="strategyType" id="typeMixed" value="mixed">
                        <label class="form-check-label" for="typeMixed">
                            混合模式模板 <span class="text-muted small">（同時支援向量化與狀態機）</span>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="strategyType" id="typeStateMachine" value="state_machine">
                        <label class="form-check-label" for="typeStateMachine">
                            狀態機模板 <span class="text-muted small">（適用複雜邏輯與狀態追蹤）</span>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="strategyType" id="typeEmpty" value="empty">
                        <label class="form-check-label" for="typeEmpty">
                            空白策略
                        </label>
                    </div>
                </div>
                
                <div class="mb-3" id="jupyterStrategyTypeSection" style="display: none;">
                    <label class="form-label">Jupyter 策略類型</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="jupyterStrategyType" id="jupyterTypeVectorized" value="vectorized" checked>
                        <label class="form-check-label" for="jupyterTypeVectorized">
                            <i class="fas fa-rocket"></i> 向量化策略 <span class="text-muted small">（一次性計算所有信號）</span>
                        </label>
                    </div>
                    <!-- <div class="form-check">
                        <input class="form-check-input" type="radio" name="jupyterStrategyType" id="jupyterTypeStateMachine" value="state_machine">
                        <label class="form-check-label" for="jupyterTypeStateMachine">
                            <i class="fas fa-cogs"></i> 狀態機策略 <span class="text-muted small">（逐筆處理，追蹤狀態）</span>
                        </label>
                    </div> -->
                    <!-- <div class="form-check">
                        <input class="form-check-input" type="radio" name="jupyterStrategyType" id="jupyterTypeHybrid" value="hybrid">
                        <label class="form-check-label" for="jupyterTypeHybrid">
                            <i class="fas fa-layer-group"></i> 混合策略 <span class="text-muted small">（結合向量化和狀態機）</span>
                        </label>
                    </div> -->
                    <!-- <div class="form-check">
                        <input class="form-check-input" type="radio" name="jupyterStrategyType" id="jupyterTypeAnalysis" value="analysis">
                        <label class="form-check-label" for="jupyterTypeAnalysis">
                            <i class="fas fa-chart-line"></i> 分析模式 <span class="text-muted small">（純資料分析，無交易邏輯）</span>
                        </label>
                    </div> -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="confirmCreateStrategy()">建立</button>
            </div>
        </div>
    </div>
</div>

<!-- 匯出策略對話框 -->
<div class="modal fade" id="exportStrategyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">匯出策略</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="exportFileName" class="form-label">檔案名稱</label>
                    <input type="text" class="form-control" id="exportFileName" placeholder="輸入檔案名稱">
                </div>
                <div class="mb-3">
                    <label class="form-label">匯出格式</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="exportFormat" id="formatJson" value="json" checked>
                        <label class="form-check-label" for="formatJson">
                            JSON 格式
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="exportFormat" id="formatPython" value="python">
                        <label class="form-check-label" for="formatPython">
                            Python 檔案
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="confirmExportStrategy()">匯出</button>
            </div>
        </div>
    </div>
</div>

<!-- 範例資料選擇對話框 -->
<div class="modal fade" id="sampleDataModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">選擇範例資料</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>資料類型</h6>
                        <div class="list-group" id="dataTypeList">
                            <!-- 資料類型列表將動態載入 -->
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>資料參數</h6>
                        <div id="dataParams">
                            <p class="text-muted">請選擇資料類型</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="loadSelectedData()">載入資料</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- CodeMirror JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/trailingspace.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/wrap-lines.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/brace-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/indent-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/comment-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/anyword-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/search.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/searchcursor.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/jump-to-line.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/selection/active-line.min.js"></script>

<script>
let currentStrategyId = null;
let strategies = [];
let codeEditor = null;
let isFullscreen = false;
let currentPreviewData = null;
let selectedDataType = null;
let isSortMode = false;
let sortableInstance = null;

// 頁面載入時初始化
document.addEventListener('DOMContentLoaded', function() {
    loadStrategies();
    loadStockLists();
    loadCacheFiles();  // 載入快取檔案列表
    setupStockSourceHandlers();
    initializeCodeEditor();
    setupExcelFileHandlers();  // 設定 Excel 檔案處理器
    setupSidebarToggle();
    
    // 預設啟用 Jupyter 模式
    initializeJupyterMode();
    
    // 頁面載入時清除 Jupyter 輸出和變數
    clearJupyterSilently();
    
    // 頁面載入時根據radio預設值顯示正確div
    const checked = document.querySelector('input[name="stockSource"]:checked');
    if (checked) checked.dispatchEvent(new Event('change'));
});

// 初始化程式碼編輯器
function initializeCodeEditor() {
    const textarea = document.getElementById('strategyCode');
    // 若已存在，先銷毀
    if (window.codeEditor) {
        window.codeEditor.toTextArea();
        window.codeEditor = null;
    }
    // 建立 CodeMirror 實例
    // 根據當前主題設定 CodeMirror 主題
    const currentTheme = localStorage.getItem('theme') || 'light';
    const codeMirrorTheme = currentTheme === 'dark' ? 'monokai' : 'eclipse';
    
    window.codeEditor = CodeMirror.fromTextArea(textarea, {
        mode: 'python',
        theme: codeMirrorTheme,
        lineNumbers: true,
        lineWrapping: true,
        indentUnit: 4,
        tabSize: 4,
        indentWithTabs: false,
        autoCloseBrackets: true,
        matchBrackets: true,
        foldGutter: true,
        gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
        extraKeys: {
            'Tab': function(cm) {
                if (cm.somethingSelected()) {
                    cm.indentSelection('add');
                } else {
                    cm.replaceSelection('    ', 'end');
                }
            },
            'Enter': function(cm) {
                const cursor = cm.getCursor();
                const line = cm.getLine(cursor.line);
                const beforeCursor = line.slice(0, cursor.ch);
                // 自動縮排邏輯
                let indent = '';
                const match = beforeCursor.match(/^(\s*)/);
                if (match) {
                    indent = match[1];
                }
                // 檢查是否需要增加縮排
                if (beforeCursor.trim().endsWith(':')) {
                    indent += '    ';
                }
                cm.replaceSelection('\n' + indent, 'end');
            },
            'Ctrl-Space': 'autocomplete',
            'Ctrl-F': 'findPersistent',
            'Ctrl-H': 'replace',
            'Ctrl-/': function(cm) {
                cm.toggleComment();
            }
        },
        hintOptions: {
            completeSingle: false,
            alignWithWord: true
        }
    });
    // 設定編輯器大小
    window.codeEditor.setSize('100%', '100%');
    // 監聽內容變化
    window.codeEditor.on('change', function() {
        window.codeEditor.save();
    });
}

// 載入預設模板
function loadDefaultTemplate() {
    const defaultTemplate = `class MyStrategy:
    def __init__(self, parameters):
        self.parameters = parameters
        self.strategy_name = "我的策略"
        self.strategy_description = "自定義交易策略"
    
    def execute(self, data):
        """
        策略執行邏輯
        data: 股票資料 (polars DataFrame)
        """
        # 在這裡實作您的策略邏輯
        result = data.clone()
        
        # 範例：簡單的移動平均策略
        if len(data) > 20:
            result = result.with_columns([
                pl.col('close').rolling_mean(window_size=20).alias('ma20'),
                pl.col('close').rolling_mean(window_size=5).alias('ma5')
            ])
            
            # 產生買賣訊號
            result = result.with_columns([
                pl.when(pl.col('ma5') > pl.col('ma20'))
                .then(1)  # 買入訊號
                .otherwise(0).alias('signal')
            ])
        
        return result
    
    def get_parameters(self):
        """取得策略參數"""
        return self.parameters`;
    
    codeEditor.setValue(defaultTemplate);
}

// 切換全螢幕模式
function toggleFullscreen() {
    if (!window.codeEditor) {
        showAlert('編輯器尚未初始化', 'warning');
        return;
    }
    if (!isFullscreen) {
        // 進入全螢幕模式
        const container = document.getElementById('codeEditorContainer');
        const parent = container.parentElement;
        
        // 建立全螢幕容器
        const fullscreenDiv = document.createElement('div');
        fullscreenDiv.className = 'fullscreen-editor';
        fullscreenDiv.innerHTML = `
            <div class="fullscreen-toolbar">
                <h5>策略程式碼編輯器 - 全螢幕模式</h5>
                <div>
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleFullscreen()">
                        <i class="fas fa-compress"></i> 退出全螢幕
                    </button>
                </div>
            </div>
            <div id="fullscreenEditorContainer" style="flex: 1; position: relative;"></div>
        `;
        
        document.body.appendChild(fullscreenDiv);
        
        // 移動編輯器到全螢幕容器
        const fullscreenContainer = fullscreenDiv.querySelector('#fullscreenEditorContainer');
        fullscreenContainer.appendChild(container);
        
        // 重新設定編輯器大小
        codeEditor.setSize('100%', '100%');
        codeEditor.refresh();
        
        isFullscreen = true;
    } else {
        // 退出全螢幕模式
        const fullscreenDiv = document.querySelector('.fullscreen-editor');
        const container = document.getElementById('codeEditorContainer');
        const originalParent = document.querySelector('.border.rounded');
        
        // 移動編輯器回原位置
        originalParent.appendChild(container);
        
        // 移除全螢幕容器
        document.body.removeChild(fullscreenDiv);
        
        // 重新設定編輯器大小
        codeEditor.setSize('100%', '100%');
        codeEditor.refresh();
        
        isFullscreen = false;
    }
}

// 格式化程式碼
async function formatCode() {
    if (!codeEditor) return;
    
    const code = codeEditor.getValue();
    
    if (!code.trim()) {
        showAlert('請先輸入程式碼', 'warning');
        return;
    }
    
    try {
        showAlert('正在格式化程式碼...', 'info');
        
        const response = await fetch('/api/strategies/custom/format', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ code: code })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            codeEditor.setValue(result.formatted_code);
            showAlert('程式碼格式化完成', 'success');
        } else {
            showAlert(`格式化失敗: ${result.message}`, 'error');
        }
    } catch (error) {
        console.error('格式化程式碼失敗:', error);
        showAlert('格式化程式碼失敗，請檢查網路連線', 'error');
    }
}

// 驗證程式碼語法
function validateCode() {
    if (!codeEditor) return;
    
    const code = codeEditor.getValue();
    
    // 簡單的語法檢查
    const errors = [];
    
    // 檢查括號配對
    const brackets = { '(': 0, ')': 0, '[': 0, ']': 0, '{': 0, '}': 0 };
    for (let char of code) {
        if (brackets.hasOwnProperty(char)) {
            brackets[char]++;
        }
    }
    
    if (brackets['('] !== brackets[')']) {
        errors.push('括號 () 不配對');
    }
    if (brackets['['] !== brackets[']']) {
        errors.push('方括號 [] 不配對');
    }
    if (brackets['{'] !== brackets['}']) {
        errors.push('大括號 {} 不配對');
    }
    
    // 檢查縮排
    const lines = code.split('\n');
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        if (line.trim() && !line.startsWith(' ') && !line.startsWith('\t')) {
            // 檢查是否應該有縮排
            if (i > 0) {
                const prevLine = lines[i-1];
                if (prevLine.trim().endsWith(':')) {
                    errors.push(`第 ${i+1} 行可能需要縮排`);
                }
            }
        }
    }
    
    if (errors.length === 0) {
        showAlert('程式碼語法檢查通過', 'success');
    } else {
        showAlert('發現語法錯誤：' + errors.join(', '), 'warning');
    }
}

// 載入策略列表
async function loadStrategies() {
    try {
        const response = await fetch('/api/strategies/custom');
        const data = await response.json();
        
        if (data.status === 'success') {
            strategies = data.strategies;
            renderStrategyList();
        }
    } catch (error) {
        console.error('載入策略失敗:', error);
        showAlert('載入策略失敗', 'danger');
    }
}

// 載入快取檔案列表
async function loadCacheFiles() {
    try {
        const response = await fetch('/api/cache/files');
        const data = await response.json();
        
        if (data.status === 'success' && data.data.files.length > 0) {
            // 更新策略使用表格的下拉選單
            const select = document.getElementById('strategyDataTable');
            
            // 保留自動選擇選項
            const autoOption = select.options[0];
            
            // 清空選項
            select.innerHTML = '';
            
            // 重新添加自動選擇選項
            select.appendChild(autoOption);
            
            // 添加快取檔案分隔線
            const separatorOption = document.createElement('option');
            separatorOption.value = '';
            separatorOption.textContent = '--- 快取檔案 ---';
            separatorOption.disabled = true;
            separatorOption.style.fontWeight = 'bold';
            separatorOption.style.backgroundColor = '#f8f9fa';
            select.appendChild(separatorOption);
            
            // 按資料類型分組添加快取檔案
            if (data.data.grouped_files) {
                Object.keys(data.data.grouped_files).sort().forEach(dataType => {
                    const files = data.data.grouped_files[dataType];
                    
                    // 添加資料類型標題
                    const groupOption = document.createElement('option');
                    groupOption.value = '';
                    groupOption.textContent = `--- ${dataType} ---`;
                    groupOption.disabled = true;
                    groupOption.style.fontWeight = 'bold';
                    groupOption.style.backgroundColor = '#f8f9fa';
                    select.appendChild(groupOption);
                    
                    // 添加該類型下的所有檔案
                    files.forEach(fileInfo => {
                        const option = document.createElement('option');
                        option.value = fileInfo.cache_key;
                        // 使用友好的顯示名稱
                        const displayName = fileInfo.friendly_display_name || fileInfo.display_name;
                        option.textContent = `${displayName} (${fileInfo.size_mb}MB)`;
                        option.title = `檔案: ${fileInfo.filename}\n修改時間: ${fileInfo.modified_time}\n原始名稱: ${fileInfo.display_name}`;
                        select.appendChild(option);
                    });
                });
            }
        } else {
            // 如果沒有快取檔案，顯示提示
            const select = document.getElementById('strategyDataTable');
            const autoOption = select.options[0];
            
            // 清空選項
            select.innerHTML = '';
            
            // 重新添加自動選擇選項
            select.appendChild(autoOption);
            
            // 添加快取檔案分隔線
            const separatorOption = document.createElement('option');
            separatorOption.value = '';
            separatorOption.textContent = '--- 快取檔案 ---';
            separatorOption.disabled = true;
            separatorOption.style.fontWeight = 'bold';
            separatorOption.style.backgroundColor = '#f8f9fa';
            select.appendChild(separatorOption);
            
            const noFilesOption = document.createElement('option');
            noFilesOption.value = '';
            noFilesOption.textContent = '--- 無快取檔案 ---';
            noFilesOption.disabled = true;
            select.appendChild(noFilesOption);
        }
    } catch (error) {
        console.error('載入快取檔案失敗:', error);
    }
}

// 更新策略表格選項
function updateStrategyTableOptions(cacheFiles, groupedFiles) {
    const select = document.getElementById('strategyDataTable');
    
    // 保留前兩個選項（自動選擇和分隔線）
    const autoOption = select.options[0];
    const separatorOption = select.options[1];
    
    // 清空選項
    select.innerHTML = '';
    
    // 重新添加自動選擇選項
    select.appendChild(autoOption);
    select.appendChild(separatorOption);
    
    // 按資料類型分組添加快取檔案
    Object.keys(groupedFiles).sort().forEach(dataType => {
        const files = groupedFiles[dataType];
        
        // 添加資料類型標題
        const groupOption = document.createElement('option');
        groupOption.value = '';
        groupOption.textContent = `--- ${dataType} ---`;
        groupOption.disabled = true;
        groupOption.style.fontWeight = 'bold';
        groupOption.style.backgroundColor = '#f8f9fa';
        select.appendChild(groupOption);
        
        // 添加該類型下的所有檔案
        files.forEach(fileInfo => {
            const option = document.createElement('option');
            option.value = fileInfo.cache_key;
            // 使用友好的顯示名稱
            const displayName = fileInfo.friendly_display_name || fileInfo.display_name;
            option.textContent = `${displayName} (${fileInfo.size_mb}MB)`;
            option.title = `檔案: ${fileInfo.filename}\n修改時間: ${fileInfo.modified_time}\n原始名稱: ${fileInfo.display_name}`;
            select.appendChild(option);
        });
    });
    
    // 如果沒有快取檔案，顯示提示
    if (cacheFiles.length === 0) {
        const noFilesOption = document.createElement('option');
        noFilesOption.value = '';
        noFilesOption.textContent = '--- 無快取檔案 ---';
        noFilesOption.disabled = true;
        select.appendChild(noFilesOption);
    }
}

// 重新整理快取檔案
async function refreshCacheFiles() {
    try {
        showAlert('正在重新整理快取檔案...', 'info');
        await loadCacheFiles();
        showAlert('快取檔案重新整理完成', 'success');
    } catch (error) {
        console.error('重新整理快取檔案失敗:', error);
        showAlert('重新整理快取檔案失敗', 'danger');
    }
}

// 渲染策略列表
function renderStrategyList() {
    const container = document.getElementById('strategyList');
    container.innerHTML = '';
    
    // 分離已確認和未確認的策略
    const confirmedStrategies = [];
    const unconfirmedStrategies = [];
    
    strategies.forEach(strategy => {
        if (strategy.is_confirmed) {
            confirmedStrategies.push(strategy);
        } else {
            unconfirmedStrategies.push(strategy);
        }
    });
    
    // 先添加已確認的策略（顯示在上方）
    if (confirmedStrategies.length > 0) {
        // 添加已確認策略的分隔標題
        const confirmedHeader = document.createElement('div');
        confirmedHeader.className = 'list-group-item list-group-item-secondary';
        confirmedHeader.innerHTML = '<small class="text-muted"><strong>✅ 已確認策略</strong></small>';
        container.appendChild(confirmedHeader);
        
        confirmedStrategies.forEach(strategy => {
            const item = document.createElement('div');
            item.className = 'list-group-item list-group-item-action';
            item.onclick = () => loadStrategy(strategy.id);
            
            item.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">✅ ${strategy.name}</h6>
                        <small class="text-muted">${strategy.description}</small>
                    </div>
                    <small class="text-muted">${new Date(strategy.updated_at).toLocaleDateString()}</small>
                </div>
            `;
            
            container.appendChild(item);
        });
    }
    
    // 再添加未確認的策略
    if (unconfirmedStrategies.length > 0) {
        // 添加未確認策略的分隔標題
        const unconfirmedHeader = document.createElement('div');
        unconfirmedHeader.className = 'list-group-item list-group-item-secondary';
        unconfirmedHeader.innerHTML = '<small class="text-muted"><strong>📝 編輯中策略</strong></small>';
        container.appendChild(unconfirmedHeader);
        
        unconfirmedStrategies.forEach(strategy => {
            const item = document.createElement('div');
            item.className = 'list-group-item list-group-item-action';
            item.onclick = () => loadStrategy(strategy.id);
            
            item.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">📝 ${strategy.name}</h6>
                        <small class="text-muted">${strategy.description}</small>
                    </div>
                    <small class="text-muted">${new Date(strategy.updated_at).toLocaleDateString()}</small>
                </div>
            `;
            
            container.appendChild(item);
        });
    }
}

// 搜尋策略
function searchStrategies() {
    const keyword = document.getElementById('searchStrategy').value.toLowerCase();
    const items = document.querySelectorAll('#strategyList .list-group-item');
    
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        if (text.includes(keyword)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// 載入策略
async function loadStrategy(strategyId) {
    try {
        // 在載入新策略前，清除 Jupyter 輸出和變數
        await clearJupyterSilently();
        
        const response = await fetch(`/api/strategies/custom/${strategyId}`);
        const data = await response.json();
        if (data.status === 'success') {
            const strategy = data.strategy;
            currentStrategyId = strategy.id;
            document.getElementById('strategyName').value = strategy.name;
            document.getElementById('strategyDescription').value = strategy.description;
            document.getElementById('strategyCode').value = strategy.code;
            
            // 檢查策略的編輯模式
            const editorMode = strategy.editor_mode || 'jupyter';
            const jupyterStrategyType = strategy.jupyter_strategy_type || 'analysis';
            
            if (editorMode === 'traditional') {
                // 傳統模式
                isJupyterMode = false;
                const jupyterEditor = document.getElementById('jupyterEditor');
                const traditionalEditor = document.getElementById('traditionalEditor');
                const jupyterModeBtn = document.getElementById('jupyterModeBtn');
                
                if (jupyterEditor && traditionalEditor && jupyterModeBtn) {
                    jupyterEditor.style.display = 'none';
                    traditionalEditor.style.display = 'block';
                    jupyterModeBtn.innerHTML = '<i class="fas fa-play"></i> 切換 Jupyter 模式';
                    jupyterModeBtn.className = 'btn btn-sm btn-outline-secondary';
                }
                
                initializeCodeEditor();
                window.codeEditor.setValue(strategy.code);
            } else {
                // 預設使用 Jupyter 模式
                isJupyterMode = true;
                showJupyterEditor(); // <--- 取代 toggleJupyterMode()
                
                // 嘗試載入 Jupyter notebook 結構
                try {
                    const notebookResponse = await fetch(`/api/jupyter/notebook/${strategyId}`);
                    const notebookData = await notebookResponse.json();
                    
                    if (notebookData.status === 'success' && notebookData.notebook.cells) {
                        // 載入儲存的 cell 結構
                        loadJupyterNotebookFromBackend(notebookData.notebook);
                    } else {
                        // 如果沒有 cell 結構，使用合併的程式碼
                        loadStrategyCodeToJupyter(strategy.code, jupyterStrategyType);
                    }
                } catch (notebookError) {
                    console.warn('載入 Jupyter notebook 結構失敗，使用合併程式碼:', notebookError);
                    loadStrategyCodeToJupyter(strategy.code, jupyterStrategyType);
                }
            }
            
            document.getElementById('editorTitle').textContent = `編輯策略: ${strategy.name}`;
            updateParameterConfig(strategy.parameters);
        }
    } catch (error) {
        console.error('載入策略失敗:', error);
        showAlert('載入策略失敗', 'danger');
    }
}

// 更新參數配置
function updateParameterConfig(parameters) {
    const container = document.getElementById('parameterConfig');
    const parameterContainer = document.getElementById('parameterContainer');
    const parameterEmpty = document.getElementById('parameterEmpty');
    
    if (!parameters || Object.keys(parameters).length === 0) {
        if (parameterContainer) {
            parameterContainer.innerHTML = '';
        }
        if (parameterEmpty) {
            parameterEmpty.style.display = 'block';
        }
        return;
    }
    
    // 隱藏空狀態
    if (parameterEmpty) {
        parameterEmpty.style.display = 'none';
    }
    
    // 確保參數容器存在
    if (!parameterContainer) {
        container.innerHTML = `
            <div id="parameterContainer" class="strategy-params-grid">
                <!-- 參數會在這裡動態生成 -->
            </div>
            <div id="parameterEmpty" class="text-center text-muted py-4" style="display: none;">
                <i class="fas fa-cog fa-2x mb-2"></i>
                <p>參數配置將根據程式碼自動生成</p>
            </div>
        `;
    }
    
    // 清空現有參數
    const newParameterContainer = document.getElementById('parameterContainer');
    newParameterContainer.innerHTML = '';
    
    // 生成參數 HTML
    Object.entries(parameters).forEach(([key, config]) => {
        const parameterHtml = generateParameterHtml(key, config);
        newParameterContainer.insertAdjacentHTML('beforeend', parameterHtml);
    });
    
    // 如果排序模式開啟，初始化拖拽
    if (isSortMode) {
        initializeSortable();
    }
}

// 生成參數HTML
function generateParameterHtml(key, config) {
    return `
        <div class="parameter-item mb-2" data-key="${key}">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title mb-0 text-primary" style="font-size: 0.8rem;">${config.label || key}</h6>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeParameter('${key}')" style="font-size: 0.7rem;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="row g-1">
                        <div class="col-6">
                            <label class="form-label small text-muted" style="font-size: 0.7rem;">參數名稱</label>
                            <input type="text" class="form-control form-control-sm parameter-key" value="${key}" onchange="updateParameterKey('${key}', this.value)" style="font-size: 0.75rem;">
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted" style="font-size: 0.7rem;">顯示名稱</label>
                            <input type="text" class="form-control form-control-sm parameter-label" value="${config.label || ''}" onchange="updateParameterLabel('${key}', this.value)" style="font-size: 0.75rem;">
                        </div>
                    </div>
                    <div class="row g-1 mt-1">
                        <div class="col-6">
                            <label class="form-label small text-muted" style="font-size: 0.7rem;">類型</label>
                            <select class="form-select form-select-sm parameter-type" onchange="updateParameterType('${key}', this.value)" style="font-size: 0.75rem;">
                                <option value="number" ${config.type === 'number' ? 'selected' : ''}>數字</option>
                                <option value="text" ${config.type === 'text' ? 'selected' : ''}>文字</option>
                                <option value="select" ${config.type === 'select' ? 'selected' : ''}>選項</option>
                                <option value="boolean" ${config.type === 'boolean' ? 'selected' : ''}>布林值</option>
                                <option value="date" ${config.type === 'date' ? 'selected' : ''}>日期</option>
                                <option value="dynamic" ${config.type === 'dynamic' ? 'selected' : ''}>動態參數</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted" style="font-size: 0.7rem;">預設值</label>
                            ${config.type === 'boolean' ? 
                                `<div class="d-flex align-items-center">
                                    <div class="custom-toggle-switch ${config.default === true || config.default === 'true' || config.default === 1 ? 'active' : ''}" onclick="toggleCustomSwitch('default-${key}')">
                                        <input type="checkbox" class="parameter-default" id="default-${key}" 
                                               ${config.default === true || config.default === 'true' || config.default === 1 ? 'checked' : ''} 
                                               onchange="updateParameterDefault('${key}', this.checked)">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <label class="form-check-label small ms-2" style="font-size: 0.7rem;">啟用</label>
                                </div>` :
                                config.type === 'select' ?
                                `<select class="form-select form-select-sm parameter-default" onchange="updateParameterDefault('${key}', this.value)" style="font-size: 0.75rem;">
                                    <option value="">請選擇...</option>
                                    ${config.options ? config.options.map(opt => 
                                        `<option value="${opt.value}" ${opt.value === config.default ? 'selected' : ''}>${opt.label}</option>`
                                    ).join('') : ''}
                                </select>` :
                                config.type === 'date' ?
                                `<input type="date" class="form-control form-control-sm parameter-default" 
                                        value="${config.default || ''}" onchange="updateParameterDefault('${key}', this.value)" style="font-size: 0.75rem;">` :
                                `<input type="text" class="form-control form-control-sm parameter-default" 
                                        value="${config.default || ''}" onchange="updateParameterDefault('${key}', this.value)" style="font-size: 0.75rem;">`
                            }
                        </div>
                    </div>
                    <div class="row g-1 mt-1">
                        <div class="col-6">
                            <label class="form-label small text-muted" style="font-size: 0.7rem;">最小值</label>
                            <input type="number" class="form-control form-control-sm parameter-min" value="${config.min || ''}" onchange="updateParameterMin('${key}', this.value)" style="font-size: 0.75rem;">
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted" style="font-size: 0.7rem;">最大值</label>
                            <input type="number" class="form-control form-control-sm parameter-max" value="${config.max || ''}" onchange="updateParameterMax('${key}', this.value)" style="font-size: 0.75rem;">
                        </div>
                    </div>
                    <div class="row g-1 mt-1">
                        <div class="col-6">
                            <label class="form-label small text-muted" style="font-size: 0.7rem;">步長</label>
                            <input type="number" class="form-control form-control-sm parameter-step" value="${config.step || ''}" onchange="updateParameterStep('${key}', this.value)" style="font-size: 0.75rem;">
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted" style="font-size: 0.7rem;">增量</label>
                            <input type="number" class="form-control form-control-sm parameter-increment" value="${config.increment || ''}" onchange="updateParameterIncrement('${key}', this.value)" placeholder="動態參數增量" style="font-size: 0.75rem;">
                        </div>
                    </div>
                    <div class="row g-1 mt-1">
                        <div class="col-12">
                            <label class="form-label small text-muted" style="font-size: 0.7rem;">描述</label>
                            <input type="text" class="form-control form-control-sm parameter-description" value="${config.description || ''}" onchange="updateParameterDescription('${key}', this.value)" style="font-size: 0.75rem;">
                        </div>
                    </div>
                    <div class="w-100" id="dynamic-param-info-${key}" style="display: ${config.type === 'dynamic' ? 'block' : 'none'};">
                        <div class="alert alert-info alert-sm py-2" style="font-size: 0.7rem;">
                            <strong>動態參數說明：</strong><br>
                            • 初始值：${config.default || 0}<br>
                            • 增量：${config.increment || 1}<br>
                            • 每次不出場時自動增加，出場時重置為初始值
                        </div>
                    </div>
                    <div class="w-100" id="select-options-${key}" style="display: ${config.type === 'select' ? 'block' : 'none'};">
                        <div class="row g-1 mt-1">
                            <div class="col-12">
                                <label class="form-label small text-muted" style="font-size: 0.7rem;">選項設定</label>
                                <div class="d-flex gap-1">
                                    <input type="text" class="form-control form-control-sm parameter-options" 
                                           value="${config.options ? config.options.map(opt => `${opt.value}:${opt.label}`).join(';') : ''}" 
                                           onchange="updateParameterOptions('${key}', this.value)" 
                                           placeholder="格式: 值1:標籤1;值2:標籤2" style="font-size: 0.75rem;">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addSelectOption('${key}')" style="font-size: 0.7rem;">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div class="form-text" style="font-size: 0.65rem;">請使用格式：值:標籤，多個選項用分號分隔</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// 新增參數
function addNewParameter() {
    const newKey = `param_${Date.now()}`;
    const newConfig = {
        type: 'number',
        label: '新參數',
        default: 0,
        min: 0,
        max: 100,
        step: 1,
        description: '參數描述'
    };
    
    const container = document.getElementById('parameterContainer');
    if (!container) {
        // 如果沒有參數容器，重新初始化
        updateParameterConfig({});
        return;
    }
    
    const parameterHtml = generateParameterHtml(newKey, newConfig);
    container.insertAdjacentHTML('beforeend', parameterHtml);
    
    // 更新策略參數
    updateStrategyParameters();
    
    // 如果排序模式開啟，重新初始化拖拽
    if (isSortMode) {
        initializeSortable();
    }
}

// 移除參數
function removeParameter(key) {
    if (confirm('確定要移除這個參數嗎？')) {
        const element = document.querySelector(`[data-key="${key}"]`);
        if (element) {
            element.remove();
            updateStrategyParameters();
        }
    }
}

// 更新參數鍵名
function updateParameterKey(oldKey, newKey) {
    if (oldKey === newKey) return;
    
    const element = document.querySelector(`[data-key="${oldKey}"]`);
    if (element) {
        element.setAttribute('data-key', newKey);
        updateStrategyParameters();
    }
}

// 更新參數標籤
function updateParameterLabel(key, label) {
    updateStrategyParameters();
}

// 更新參數類型
function updateParameterType(key, type) {
    updateStrategyParameters();
    
    // 顯示/隱藏動態參數說明
    const infoElement = document.getElementById(`dynamic-param-info-${key}`);
    if (infoElement) {
        infoElement.style.display = type === 'dynamic' ? 'block' : 'none';
    }
    
    // 顯示/隱藏選項設定區域
    const optionsElement = document.getElementById(`select-options-${key}`);
    if (optionsElement) {
        optionsElement.style.display = type === 'select' ? 'block' : 'none';
    }
    
    // 更新預設值顯示方式
    const paramItem = document.querySelector(`[data-key="${key}"]`);
    if (paramItem) {
        // 找到包含預設值標籤的欄位 - 使用更簡單的方法
        let defaultContainer = null;
        const rows = paramItem.querySelectorAll('.row');
        if (rows.length >= 2) {
            const secondRow = rows[1];
            const cols = secondRow.querySelectorAll('.col-6');
            if (cols.length >= 2) {
                // 檢查第二個欄位是否包含預設值標籤
                const secondCol = cols[1];
                const label = secondCol.querySelector('label');
                if (label && label.textContent.includes('預設值')) {
                    defaultContainer = secondCol;
                }
            }
        }
        
        // 如果還是找不到，使用備用選擇器
        if (!defaultContainer) {
            defaultContainer = paramItem.querySelector('.row:nth-child(2) .col-6:nth-child(2)');
        }
        
        if (defaultContainer) {
            // 取得當前的預設值
            const currentDefault = paramItem.querySelector('.parameter-default');
            let currentValue = '';
            if (currentDefault && currentDefault.type === 'checkbox') {
                currentValue = currentDefault.checked;
            } else if (currentDefault && currentDefault.value) {
                currentValue = currentDefault.value;
            }
            
            if (type === 'boolean') {
                defaultContainer.innerHTML = `
                    <label class="form-label small text-muted" style="font-size: 0.7rem;">預設值</label>
                    <div class="d-flex align-items-center">
                        <div class="custom-toggle-switch ${currentValue ? 'active' : ''}" onclick="toggleCustomSwitch('default-${key}')">
                            <input type="checkbox" class="parameter-default" id="default-${key}" 
                                   ${currentValue ? 'checked' : ''}
                                   onchange="updateParameterDefault('${key}', this.checked)">
                            <div class="toggle-slider"></div>
                        </div>
                        <label class="form-check-label small ms-2" style="font-size: 0.7rem;">啟用</label>
                    </div>
                `;
            } else if (type === 'select') {
                // 取得當前的選項設定
                const currentOptions = window.currentStrategyParameters && window.currentStrategyParameters[key] ? window.currentStrategyParameters[key].options : [];
                const optionsHtml = currentOptions ? currentOptions.map(opt => 
                    `<option value="${opt.value}" ${opt.value === currentValue ? 'selected' : ''}>${opt.label}</option>`
                ).join('') : '';
                
                defaultContainer.innerHTML = `
                    <label class="form-label small text-muted" style="font-size: 0.7rem;">預設值</label>
                    <select class="form-select form-select-sm parameter-default" onchange="updateParameterDefault('${key}', this.value)" style="font-size: 0.75rem;">
                        <option value="">請選擇...</option>
                        ${optionsHtml}
                    </select>
                `;
                
                // 確保選項設定區域顯示
                if (optionsElement) {
                    optionsElement.style.display = 'block';
                }
            } else if (type === 'date') {
                defaultContainer.innerHTML = `
                    <label class="form-label small text-muted" style="font-size: 0.7rem;">預設值</label>
                    <input type="date" class="form-control form-control-sm parameter-default" 
                           value="${currentValue}" onchange="updateParameterDefault('${key}', this.value)" style="font-size: 0.75rem;">
                `;
            } else {
                defaultContainer.innerHTML = `
                    <label class="form-label small text-muted" style="font-size: 0.7rem;">預設值</label>
                    <input type="text" class="form-control form-control-sm parameter-default" 
                           value="${currentValue}" onchange="updateParameterDefault('${key}', this.value)" style="font-size: 0.75rem;">
                `;
            }
        }
    }
}

// 更新參數預設值
function updateParameterDefault(key, defaultValue) {
    updateStrategyParameters();
}

// 更新參數最小值
function updateParameterMin(key, min) {
    updateStrategyParameters();
}

// 更新參數最大值
function updateParameterMax(key, max) {
    updateStrategyParameters();
}

// 更新參數步長
function updateParameterStep(key, step) {
    updateStrategyParameters();
}

// 更新參數描述
function updateParameterDescription(key, description) {
    updateStrategyParameters();
}

// 更新參數選項
function updateParameterOptions(key, optionsString) {
    updateStrategyParameters();
    
    // 更新預設值下拉式選單
    const paramItem = document.querySelector(`[data-key="${key}"]`);
    if (paramItem) {
        const defaultSelect = paramItem.querySelector('.parameter-default');
        if (defaultSelect && defaultSelect.tagName === 'SELECT') {
            const currentValue = defaultSelect.value;
            
            // 解析選項字串
            const options = optionsString.split(';').map(opt => {
                const [value, label] = opt.split(':');
                return { value: value.trim(), label: label.trim() };
            }).filter(opt => opt.value && opt.label);
            
            // 重新生成選項
            const optionsHtml = options.map(opt => 
                `<option value="${opt.value}" ${opt.value === currentValue ? 'selected' : ''}>${opt.label}</option>`
            ).join('');
            
            defaultSelect.innerHTML = `<option value="">請選擇...</option>${optionsHtml}`;
        }
    }
}

// 新增選項
function addSelectOption(key) {
    const paramItem = document.querySelector(`[data-key="${key}"]`);
    if (paramItem) {
        const optionsInput = paramItem.querySelector('.parameter-options');
        const currentValue = optionsInput.value;
        const newOption = prompt('請輸入新選項 (格式: 值:標籤)', 'new_value:新選項');
        
        if (newOption && newOption.includes(':')) {
            const newValue = currentValue ? currentValue + ';' + newOption : newOption;
            optionsInput.value = newValue;
            updateParameterOptions(key, newValue);
        }
    }
}

// 更新策略參數
function updateStrategyParameters() {
    const parameters = {};
    const parameterItems = document.querySelectorAll('.parameter-item');
    
    parameterItems.forEach(item => {
        const key = item.getAttribute('data-key');
        const label = item.querySelector('.parameter-label').value;
        const type = item.querySelector('.parameter-type').value;
        const defaultElement = item.querySelector('.parameter-default');
        let defaultValue;
        if (defaultElement.type === 'checkbox') {
            defaultValue = defaultElement.checked;
        } else {
            defaultValue = defaultElement.value;
        }
        const min = item.querySelector('.parameter-min').value;
        const max = item.querySelector('.parameter-max').value;
        const step = item.querySelector('.parameter-step').value;
        const increment = item.querySelector('.parameter-increment').value;
        const description = item.querySelector('.parameter-description').value;
        
        // 取得選項設定（如果是選項類型）
        let options = undefined;
        if (type === 'select') {
            const optionsInput = item.querySelector('.parameter-options');
            if (optionsInput && optionsInput.value) {
                options = optionsInput.value.split(';').map(opt => {
                    const [value, label] = opt.split(':');
                    return { value: value.trim(), label: label.trim() };
                }).filter(opt => opt.value && opt.label);
            }
        }
        
        const paramConfig = {
            type: type,
            label: label,
            description: description
        };
        
        // 根據類型設定不同的屬性
        if (type === 'number') {
            paramConfig.default = parseFloat(defaultValue) || 0;
            paramConfig.min = parseFloat(min) || undefined;
            paramConfig.max = parseFloat(max) || undefined;
            paramConfig.step = parseFloat(step) || 1;
        } else if (type === 'dynamic') {
            paramConfig.default = parseFloat(defaultValue) || 0;
            paramConfig.increment = parseFloat(increment) || 1;
        } else if (type === 'boolean') {
            // 布林值特殊處理
            if (defaultValue === 'true' || defaultValue === '1' || defaultValue === true) {
                paramConfig.default = true;
            } else if (defaultValue === 'false' || defaultValue === '0' || defaultValue === false) {
                paramConfig.default = false;
            } else {
                paramConfig.default = false; // 預設為 false
            }
        } else if (type === 'select') {
            if (options && options.length > 0) {
                paramConfig.options = options;
                paramConfig.default = defaultValue || options[0].value; // 如果沒有預設值，使用第一個選項
            } else {
                // 如果沒有選項，提供預設選項
                const defaultOptions = [
                    { value: "option1", label: "選項1" },
                    { value: "option2", label: "選項2" }
                ];
                paramConfig.options = defaultOptions;
                paramConfig.default = defaultValue || defaultOptions[0].value; // 使用第一個選項作為預設值
            }
        } else if (type === 'date') {
            paramConfig.default = defaultValue;
        } else {
            paramConfig.default = defaultValue;
        }
        
        parameters[key] = paramConfig;
    });
    
    // 儲存到全域變數，供儲存策略時使用
    window.currentStrategyParameters = parameters;
}

// 新建策略
function createNewStrategy() {
    document.getElementById('newStrategyName').value = '';
    document.getElementById('newStrategyDescription').value = '';
    document.getElementById('modeJupyter').checked = true;
    document.getElementById('typeVectorized').checked = true;
    document.getElementById('jupyterTypeVectorized').checked = true;
    
    // 設定編輯模式切換事件
    setupEditorModeToggle();
    
    const modal = new bootstrap.Modal(document.getElementById('newStrategyModal'));
    modal.show();
}

// 設定編輯模式切換
function setupEditorModeToggle() {
    const traditionalMode = document.getElementById('modeTraditional');
    const jupyterMode = document.getElementById('modeJupyter');
    const strategyTypeSection = document.getElementById('strategyTypeSection');
    const jupyterStrategyTypeSection = document.getElementById('jupyterStrategyTypeSection');
    
    function toggleStrategyTypeSections() {
        if (traditionalMode.checked) {
            strategyTypeSection.style.display = 'block';
            jupyterStrategyTypeSection.style.display = 'none';
        } else {
            strategyTypeSection.style.display = 'none';
            jupyterStrategyTypeSection.style.display = 'block';
        }
    }
    
    // 移除舊的事件監聽器
    traditionalMode.removeEventListener('change', toggleStrategyTypeSections);
    jupyterMode.removeEventListener('change', toggleStrategyTypeSections);
    
    // 添加新的事件監聽器
    traditionalMode.addEventListener('change', toggleStrategyTypeSections);
    jupyterMode.addEventListener('change', toggleStrategyTypeSections);
    
    // 初始化顯示狀態
    toggleStrategyTypeSections();
}

// 確認新建策略
async function confirmCreateStrategy() {
    const name = document.getElementById('newStrategyName').value.trim();
    const description = document.getElementById('newStrategyDescription').value.trim();
    const editorMode = document.querySelector('input[name="editorMode"]:checked').value;
    
    if (!name) {
        showAlert('請輸入策略名稱', 'warning');
        return;
    }
    
    let strategyType = 'mixed';
    let jupyterStrategyType = 'analysis';
    
    if (editorMode === 'traditional') {
        strategyType = document.querySelector('input[name="strategyType"]:checked').value;
    } else {
        jupyterStrategyType = document.querySelector('input[name="jupyterStrategyType"]:checked').value;
    }
    
    try {
        const response = await fetch('/api/strategies/custom', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name,
                description: description,
                type: strategyType,
                editor_mode: editorMode,
                jupyter_strategy_type: jupyterStrategyType
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showAlert('策略建立成功', 'success');
            bootstrap.Modal.getInstance(document.getElementById('newStrategyModal')).hide();
            await loadStrategies();
            
            // 直接設定策略資訊，避免 loadStrategy 覆蓋編輯器設定
            currentStrategyId = data.strategy_id;
            document.getElementById('strategyName').value = name;
            document.getElementById('strategyDescription').value = description;
            document.getElementById('editorTitle').textContent = `編輯策略: ${name}`;
            
            // 根據編輯模式初始化編輯器
            if (editorMode === 'jupyter') {
                // 自動切換到 Jupyter 模式
                isJupyterMode = true;
                showJupyterEditor();
                
                // 根據 Jupyter 策略類型載入對應的範例程式碼
                loadJupyterStrategyTemplate(jupyterStrategyType);
            } else {
                // 傳統模式
                isJupyterMode = false;
                const jupyterEditor = document.getElementById('jupyterEditor');
                const traditionalEditor = document.getElementById('traditionalEditor');
                const jupyterModeBtn = document.getElementById('jupyterModeBtn');
                
                if (jupyterEditor && traditionalEditor && jupyterModeBtn) {
                    jupyterEditor.style.display = 'none';
                    traditionalEditor.style.display = 'block';
                    jupyterModeBtn.innerHTML = '<i class="fas fa-play"></i> 切換 Jupyter 模式';
                    jupyterModeBtn.className = 'btn btn-sm btn-outline-secondary';
                }
                
                initializeCodeEditor();
                window.codeEditor.setValue('');
            }
        } else {
            showAlert(data.message || '建立策略失敗', 'danger');
        }
    } catch (error) {
        console.error('建立策略失敗:', error);
        showAlert('建立策略失敗', 'danger');
    }
}

// 儲存策略
async function saveStrategy() {
    if (!currentStrategyId) {
        showAlert('請先選擇或建立策略', 'warning');
        return;
    }
    const name = document.getElementById('strategyName').value.trim();
    const description = document.getElementById('strategyDescription').value.trim();
    // 根據編輯模式取得程式碼
    let code = '';
    if (isJupyterMode) {
        code = window.jupyterMergedCode || '';
        window.jupyterMergedCode = undefined;
    } else {
        code = codeEditor ? codeEditor.getValue().trim() : document.getElementById('strategyCode').value.trim();
    }
    if (!name || !code) {
        showAlert('請填寫策略名稱和程式碼', 'warning');
        return;
    }
    // 取得當前編輯的參數
    updateStrategyParameters();
    const parameters = window.currentStrategyParameters || {};
    try {
        const response = await fetch(`/api/strategies/custom/${currentStrategyId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name,
                description: description,
                code: code,
                parameters: parameters
            })
        });
        const data = await response.json();
        if (data.status === 'success') {
            showAlert('策略儲存成功', 'success');
            await loadStrategies();
            window.dispatchEvent(new CustomEvent('strategyUpdated', {
                detail: {
                    strategyId: currentStrategyId,
                    action: 'updated'
                }
            }));
        } else {
            showAlert(data.message || '儲存策略失敗', 'danger');
        }
    } catch (error) {
        console.error('儲存策略失敗:', error);
        showAlert('儲存策略失敗', 'danger');
    }
}

// 測試策略
async function testStrategy() {
    if (!currentStrategyId) {
        showAlert('請先選擇策略', 'warning');
        return;
    }
    
    // 根據編輯模式取得程式碼
    let code = '';
    if (isJupyterMode) {
        // 優先用 window.jupyterMergedCode
        code = window.jupyterMergedCode || '';
        window.jupyterMergedCode = undefined;
    } else {
        code = codeEditor ? codeEditor.getValue().trim() : document.getElementById('strategyCode').value.trim();
    }
    const strategyTable = document.getElementById('strategyDataTable').value;
    const excelFile = document.getElementById('excelFile').files[0];
    
    if (!code) {
        showAlert('請輸入策略程式碼', 'warning');
        return;
    }
    
    // 檢查股票來源選擇
    const stockSource = document.querySelector('input[name="stockSource"]:checked');
    if (stockSource && stockSource.value === 'excel' && !excelFile) {
        showAlert('請選擇 Excel 檔案進行上傳', 'warning');
        return;
    }
    
    try {
        let response;
        
        // 使用 FormData 上傳資料
        const formData = new FormData();
        formData.append('strategy_id', currentStrategyId);
        formData.append('code', code);
        formData.append('strategy_table', strategyTable);
        
        // 添加持有記錄參數
        const recordHoldingsSwitch = document.getElementById('recordHoldingsSwitch');
        if (recordHoldingsSwitch) {
            formData.append('param-record_holdings', recordHoldingsSwitch.checked ? '1' : '0');
        }
        
        // 如果有 Excel 檔案，就上傳
        if (excelFile) {
            formData.append('excel_file', excelFile);
        }
        
        response = await fetch('/api/strategies/custom/test', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showTestResults(data.results);
        } else {
            showAlert(data.message || '測試策略失敗', 'danger');
        }
    } catch (error) {
        console.error('測試策略失敗:', error);
        showAlert('測試策略失敗', 'danger');
    }
}

// 顯示測試結果
function showTestResults(results) {
    const container = document.getElementById('testOutput');
    const resultsDiv = document.getElementById('testResults');
    const tradeReportSection = document.getElementById('test');
    
    let html = '';
    
    if (results.validation) {
        html += '<div class="alert alert-success">語法驗證通過</div>';
    } else {
        html += '<div class="alert alert-danger">語法驗證失敗</div>';
    }
    
    if (results.functions) {
        html += '<h6>檢測到的函數:</h6><ul>';
        results.functions.forEach(func => {
            html += `<li>${func}</li>`;
        });
        html += '</ul>';
    }
    
    if (results.errors) {
        html += '<h6>錯誤訊息:</h6><div class="alert alert-danger">';
        results.errors.forEach(error => {
            html += `<div>${error}</div>`;
        });
        html += '</div>';
    }
    
    // 顯示回測結果
    if (results.backtest_results) {
        html += '<h6>回測結果:</h6>';
        
        if (results.backtest_results.message) {
            html += `<div class="alert alert-info">${results.backtest_results.message}</div>`;
        } else {
            html += '<div class="table-responsive">';
            html += '<table class="table table-sm table-bordered">';
            html += '<tbody>';
            
            // 顯示資料來源資訊
            if (results.backtest_results.data_source !== undefined) {
                const sourceClass = results.backtest_results.data_source === '快取' ? 'text-success' : 
                                  results.backtest_results.data_source === 'API' ? 'text-info' : 'text-warning';
                html += `<tr><td>資料來源</td><td class="${sourceClass}">${results.backtest_results.data_source}</td></tr>`;
            }
            if (results.backtest_results.stock_id !== undefined) {
                html += `<tr><td>測試股票代碼</td><td>${results.backtest_results.stock_id}</td></tr>`;
            }
            if (results.backtest_results.data_type !== undefined) {
                html += `<tr><td>資料類型</td><td>${results.backtest_results.data_type}</td></tr>`;
            }
            if (results.backtest_results.date_range !== undefined) {
                html += `<tr><td>日期範圍</td><td>${results.backtest_results.date_range}</td></tr>`;
            }
            if (results.backtest_results.data_count !== undefined) {
                html += `<tr><td>資料筆數</td><td>${results.backtest_results.data_count}</td></tr>`;
            }
            if (results.backtest_results.strategy_table !== undefined) {
                html += `<tr><td>策略使用表格</td><td>${results.backtest_results.strategy_table}</td></tr>`;
            }
            
            if (results.backtest_results.total_trades !== undefined) {
                html += `<tr><td>總交易次數</td><td>${results.backtest_results.total_trades}</td></tr>`;
            }
            if (results.backtest_results.final_capital !== undefined) {
                html += `<tr><td>最終資金</td><td>${results.backtest_results.final_capital.toLocaleString()}</td></tr>`;
            }
            if (results.backtest_results.total_return !== undefined) {
                const returnClass = results.backtest_results.total_return >= 0 ? 'text-success' : 'text-danger';
                html += `<tr><td>總報酬率</td><td class="${returnClass}">${results.backtest_results.total_return.toFixed(2)}%</td></tr>`;
            }
            if (results.backtest_results.win_rate !== undefined) {
                html += `<tr><td>勝率</td><td>${results.backtest_results.win_rate.toFixed(2)}%</td></tr>`;
            }
            if (results.backtest_results.max_drawdown !== undefined) {
                html += `<tr><td>最大回撤</td><td class="text-danger">${results.backtest_results.max_drawdown.toFixed(2)}%</td></tr>`;
            }
            if (results.backtest_results.sharpe_ratio !== undefined) {
                html += `<tr><td>夏普比率</td><td>${results.backtest_results.sharpe_ratio.toFixed(2)}</td></tr>`;
            }
            
            html += '</tbody>';
            html += '</table>';
            html += '</div>';
        }
        
        // 顯示交易報表
        if (results.backtest_results.trade_records && results.backtest_results.trade_records.length > 0) {
            showTradeReport(results.backtest_results);
        } else {
            hideTradeReport();
        }
        
        // 顯示圖表分析
        if (results.backtest_results.charts && results.backtest_results.charts.length > 0) {
            showCharts(results.backtest_results.charts);
        } else {
            hideCharts();
        }
    } else {
        hideTradeReport();
        hideCharts();
    }
    
    container.innerHTML = html;
    resultsDiv.style.display = 'block';
}

// 顯示交易報表
function showTradeReport(backtestResults) {
    const tradeReportSection = document.getElementById('test');
    const totalTrades = document.getElementById('totalTrades');
    const winRate = document.getElementById('winRate');
    const totalReturn = document.getElementById('totalReturn');
    const maxDrawdown = document.getElementById('maxDrawdown');
    const tradeReportBody = document.getElementById('tradeReportBody');
    const noTradeMessage = document.getElementById('noTradeMessage');
    const holdingPositionsBody = document.getElementById('holdingPositionsBody');
    const noHoldingMessage = document.getElementById('noHoldingMessage');
    
    // 更新統計摘要
    if (backtestResults.total_trades !== undefined) {
        totalTrades.textContent = backtestResults.total_trades;
    }
    if (backtestResults.win_rate !== undefined) {
        winRate.textContent = backtestResults.win_rate.toFixed(2) + '%';
        winRate.className = backtestResults.win_rate >= 50 ? 'h5 mb-1 text-success' : 'h5 mb-1 text-danger';
    }
    if (backtestResults.total_return !== undefined) {
        totalReturn.textContent = backtestResults.total_return.toFixed(2) + '%';
        totalReturn.className = backtestResults.total_return >= 0 ? 'h5 mb-1 text-success' : 'h5 mb-1 text-danger';
    }
    if (backtestResults.max_drawdown !== undefined) {
        maxDrawdown.textContent = backtestResults.max_drawdown.toFixed(2) + '%';
    }
    
    // 顯示交易記錄表格
    if (backtestResults.trade_records && backtestResults.trade_records.length > 0) {
        let tableHtml = '';
        
        backtestResults.trade_records.forEach(trade => {
            const profitLossClass = trade.profit_loss >= 0 ? 'text-success' : 'text-danger';
            const profitLossRateClass = trade.profit_loss_rate >= 0 ? 'text-success' : 'text-danger';
            
            tableHtml += `
                <tr>
                    <td>${formatDate(trade.entry_date)}</td>
                    <td>${formatDate(trade.exit_date)}</td>
                    <td>${trade.stock_id}</td>
                    <td>${trade.stock_name}</td>
                    <td>${trade.entry_price.toFixed(2)}</td>
                    <td>${trade.exit_price.toFixed(2)}</td>
                    <td>${trade.shares.toLocaleString()}</td>
                    <td class="${profitLossClass}">${trade.profit_loss.toLocaleString()}</td>
                    <td class="${profitLossRateClass}">${trade.profit_loss_rate.toFixed(2)}%</td>
                    <td>${trade.holding_days}</td>
                    <td>${trade.exit_reason || '-'}</td>
                </tr>
            `;
        });
        
        tradeReportBody.innerHTML = tableHtml;
        document.getElementById('tradeReportTable').style.display = 'table';
        noTradeMessage.style.display = 'none';
    } else {
        document.getElementById('tradeReportTable').style.display = 'none';
        noTradeMessage.style.display = 'block';
    }
    
    // 顯示持有部位表格
    if (backtestResults.holding_positions && backtestResults.holding_positions.length > 0) {
        let holdingTableHtml = '';
        
        backtestResults.holding_positions.forEach(position => {
            const unrealizedClass = position.unrealized_profit_loss >= 0 ? 'text-success' : 'text-danger';
            const unrealizedRateClass = position.unrealized_profit_loss_rate >= 0 ? 'text-success' : 'text-danger';
            
            holdingTableHtml += `
                <tr>
                    <td>${formatDate(position.entry_date)}</td>
                    <td>${position.stock_id}</td>
                    <td>${position.stock_name}</td>
                    <td>${position.trade_direction}</td>
                    <td>${position.entry_price.toFixed(2)}</td>
                    <td>${position.current_price.toFixed(2)}</td>
                    <td>${position.shares.toLocaleString()}</td>
                    <td class="${unrealizedClass}">${position.unrealized_profit_loss.toLocaleString()}</td>
                    <td class="${unrealizedRateClass}">${position.unrealized_profit_loss_rate.toFixed(2)}%</td>
                    <td>${position.holding_days}</td>
                    <td>${position.take_profit_price ? position.take_profit_price.toFixed(2) : '-'}</td>
                    <td>${position.stop_loss_price ? position.stop_loss_price.toFixed(2) : '-'}</td>
                </tr>
            `;
        });
        
        holdingPositionsBody.innerHTML = holdingTableHtml;
        document.getElementById('holdingPositionsTable').style.display = 'table';
        noHoldingMessage.style.display = 'none';
    } else {
        document.getElementById('holdingPositionsTable').style.display = 'none';
        noHoldingMessage.style.display = 'block';
    }
    
    tradeReportSection.style.display = 'block';
}

// 隱藏交易報表
function hideTradeReport() {
    const tradeReportSection = document.getElementById('test');
    const holdingPositionsTable = document.getElementById('holdingPositionsTable');
    const noHoldingMessage = document.getElementById('noHoldingMessage');
    
    tradeReportSection.style.display = 'none';
    if (holdingPositionsTable) {
        holdingPositionsTable.style.display = 'none';
    }
    if (noHoldingMessage) {
        noHoldingMessage.style.display = 'none';
    }
    
    // 同時隱藏圖表分析
    hideCharts();
}

// 顯示圖表分析
function showCharts(charts) {
    const chartsSection = document.getElementById('charts');
    const chartsContainer = document.getElementById('chartsContainer');
    const noChartsMessage = document.getElementById('noChartsMessage');
    
    if (!charts || charts.length === 0) {
        chartsSection.style.display = 'none';
        noChartsMessage.style.display = 'block';
        return;
    }
    
    chartsSection.style.display = 'block';
    noChartsMessage.style.display = 'none';
    chartsContainer.innerHTML = '';
    
    charts.forEach((chart, index) => {
        const chartDiv = document.createElement('div');
        chartDiv.className = 'mb-3';
        chartDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">${chart.title || `圖表 ${index + 1}`}</h6>
                <button class="btn btn-sm btn-outline-secondary" onclick="downloadChart('${chart.id || index}')">
                    <i class="fas fa-download"></i> 下載
                </button>
            </div>
            <div class="chart-wrapper" style="height: 400px; border: 1px solid #dee2e6; border-radius: 4px;">
                ${chart.html || chart.content || '<p class="text-muted text-center py-5">圖表載入中...</p>'}
            </div>
        `;
        chartsContainer.appendChild(chartDiv);

        // 讓 chart.html 內的 <script> 能執行
        const scripts = chartDiv.querySelectorAll('script');
        scripts.forEach(oldScript => {
            const newScript = document.createElement('script');
            if (oldScript.src) {
                newScript.src = oldScript.src;
            } else {
                newScript.textContent = oldScript.textContent;
            }
            oldScript.parentNode.replaceChild(newScript, oldScript);
        });
    });
}

// 隱藏圖表分析
function hideCharts() {
    const chartsSection = document.getElementById('charts');
    const noChartsMessage = document.getElementById('noChartsMessage');
    
    chartsSection.style.display = 'none';
    if (noChartsMessage) {
        noChartsMessage.style.display = 'none';
    }
}

// 重新整理圖表
function refreshCharts() {
    if (currentStrategyId) {
        showAlert('正在重新整理圖表...', 'info');
        // 這裡可以重新呼叫測試策略的 API 來取得最新的圖表
        testStrategy();
    } else {
        showAlert('請先選擇策略', 'warning');
    }
}

// 匯出圖表
function exportCharts() {
    const chartsContainer = document.getElementById('chartsContainer');
    if (!chartsContainer || chartsContainer.children.length === 0) {
        showAlert('沒有可匯出的圖表', 'warning');
        return;
    }
    
    // 建立包含所有圖表的 HTML 檔案
    let htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>策略圖表分析</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .chart-section { margin-bottom: 30px; page-break-inside: avoid; }
                .chart-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
                .chart-wrapper { border: 1px solid #ccc; padding: 10px; }
            </style>
        </head>
        <body>
            <h1>策略圖表分析報告</h1>
            <p>生成時間: ${new Date().toLocaleString('zh-TW')}</p>
    `;
    
    const chartSections = chartsContainer.querySelectorAll('.chart-wrapper');
    chartSections.forEach((section, index) => {
        const title = section.previousElementSibling?.querySelector('h6')?.textContent || `圖表 ${index + 1}`;
        htmlContent += `
            <div class="chart-section">
                <div class="chart-title">${title}</div>
                <div class="chart-wrapper">
                    ${section.innerHTML}
                </div>
            </div>
        `;
    });
    
    htmlContent += '</body></html>';
    
    // 下載 HTML 檔案
    const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `策略圖表分析_${new Date().toISOString().slice(0, 10)}.html`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAlert('圖表匯出成功', 'success');
}

// 下載單個圖表
function downloadChart(chartId) {
    // 這裡可以實作下載單個圖表的功能
    showAlert('下載功能開發中...', 'info');
}

// 匯出交易報表
function exportTradeReport() {
    const table = document.getElementById('tradeReportTable');
    if (!table) {
        showAlert('沒有可匯出的交易報表', 'warning');
        return;
    }
    
    // 建立 CSV 內容
    let csvContent = '進場日期,出場日期,股票代碼,股票名稱,進場價,出場價,股數,報酬,報酬率,持有天數,出場理由\n';
    
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const rowData = Array.from(cells).map(cell => {
            // 移除 HTML 標籤和特殊字符
            let text = cell.textContent.trim();
            // 如果包含逗號，用引號包圍
            if (text.includes(',')) {
                text = `"${text}"`;
            }
            return text;
        });
        csvContent += rowData.join(',') + '\n';
    });
    
    // 下載 CSV 檔案
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `交易報表_${new Date().toISOString().slice(0, 10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAlert('交易報表匯出成功', 'success');
}

// 匯出持有部位報表
function exportHoldingPositionsReport() {
    const table = document.getElementById('holdingPositionsTable');
    if (!table) {
        showAlert('沒有可匯出的持有部位報表', 'warning');
        return;
    }
    
    // 建立 CSV 內容
    let csvContent = '進場日期,股票代碼,股票名稱,方向,進場價,當前價,股數,未實現損益,未實現損益率,持有天數,停利價,停損價\n';
    
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const rowData = Array.from(cells).map(cell => {
            // 移除 HTML 標籤和特殊字符
            let text = cell.textContent.trim();
            // 如果包含逗號，用引號包圍
            if (text.includes(',')) {
                text = `"${text}"`;
            }
            return text;
        });
        csvContent += rowData.join(',') + '\n';
    });
    
    // 下載 CSV 檔案
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `持有部位報表_${new Date().toISOString().slice(0, 10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAlert('持有部位報表匯出成功', 'success');
}

// 格式化日期
function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('zh-TW');
}

// 載入模板
async function loadTemplate(templateType = 'mixed') {
    try {
        const response = await fetch(`/api/strategies/custom/template?type=${templateType}`);
        const data = await response.json();
        
        if (data.status === 'success') {
            if (codeEditor) {
                codeEditor.setValue(data.template);
            } else {
                document.getElementById('strategyCode').value = data.template;
            }
            
            let templateName = '混合模式模板';
            if (templateType === 'vectorized') {
                templateName = '向量化模板';
            } else if (templateType === 'state_machine') {
                templateName = '狀態機模板';
            }
            
            showAlert(`${templateName}載入成功`, 'success');
        }
    } catch (error) {
        console.error('載入模板失敗:', error);
        showAlert('載入模板失敗', 'danger');
    }
}

// 驗證語法
async function validateCode() {
    const code = codeEditor ? codeEditor.getValue().trim() : document.getElementById('strategyCode').value.trim();
    
    if (!code) {
        showAlert('請輸入程式碼', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/strategies/custom/validate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ code: code })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showAlert('語法驗證通過', 'success');
        } else {
            showAlert(data.message || '語法驗證失敗', 'danger');
        }
    } catch (error) {
        console.error('驗證失敗:', error);
        showAlert('驗證失敗', 'danger');
    }
}

// 匯出策略
function exportStrategy() {
    if (!currentStrategyId) {
        showAlert('請先選擇策略', 'warning');
        return;
    }
    
    const strategy = strategies.find(s => s.id === currentStrategyId);
    if (strategy) {
        document.getElementById('exportFileName').value = strategy.name;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('exportStrategyModal'));
    modal.show();
}

// 確認匯出策略
async function confirmExportStrategy() {
    if (!currentStrategyId) {
        showAlert('請先選擇策略', 'warning');
        return;
    }
    
    const fileName = document.getElementById('exportFileName').value.trim();
    const format = document.querySelector('input[name="exportFormat"]:checked').value;
    
    if (!fileName) {
        showAlert('請輸入檔案名稱', 'warning');
        return;
    }
    
    try {
        const response = await fetch(`/api/strategies/custom/${currentStrategyId}/export`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                file_name: fileName,
                format: format
            })
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${fileName}.${format === 'json' ? 'json' : 'py'}`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showAlert('策略匯出成功，策略已設為確認版', 'success');
            bootstrap.Modal.getInstance(document.getElementById('exportStrategyModal')).hide();
        } else {
            const data = await response.json();
            showAlert(data.message || '匯出策略失敗', 'danger');
        }
    } catch (error) {
        console.error('匯出策略失敗:', error);
        showAlert('匯出策略失敗', 'danger');
    }
}

// 刪除策略
async function deleteStrategy() {
    if (!currentStrategyId) {
        showAlert('請先選擇策略', 'warning');
        return;
    }
    
    if (!confirm('確定要刪除這個策略嗎？此操作無法復原。')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/strategies/custom/${currentStrategyId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showAlert('策略刪除成功', 'success');
            currentStrategyId = null;
            
            // 清空編輯器
            document.getElementById('strategyName').value = '';
            document.getElementById('strategyDescription').value = '';
            if (codeEditor) {
                codeEditor.setValue('');
            } else {
                document.getElementById('strategyCode').value = '';
            }
            document.getElementById('editorTitle').textContent = '策略編輯器';
            document.getElementById('parameterConfig').innerHTML = '<p class="text-muted">參數配置將根據程式碼自動生成</p>';
            document.getElementById('testResults').style.display = 'none';
            
            // 重新載入策略列表
            await loadStrategies();
        } else {
            showAlert(data.message || '刪除策略失敗', 'danger');
        }
    } catch (error) {
        console.error('刪除策略失敗:', error);
        showAlert('刪除策略失敗', 'danger');
    }
}

// 顯示提示訊息
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}

// 載入範例資料
function loadSampleData() {
    // Jupyter 模式與傳統模式都彈出 sampleDataModal
    const modal = new bootstrap.Modal(document.getElementById('sampleDataModal'));
    modal.show();
    loadDataTypeList();
}

// 載入資料類型列表
async function loadDataTypeList() {
    try {
        const response = await fetch('/api/sample-data/types');
        const data = await response.json();
        
        if (data.status === 'success') {
            const container = document.getElementById('dataTypeList');
            container.innerHTML = '';
            
            data.types.forEach(type => {
                const item = document.createElement('div');
                item.className = 'list-group-item list-group-item-action';
                item.onclick = () => selectDataType(type);
                
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${type.name}</h6>
                            <small class="text-muted">${type.description}</small>
                        </div>
                        <span class="badge bg-primary">${type.category}</span>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }
    } catch (error) {
        console.error('載入資料類型失敗:', error);
        showAlert('載入資料類型失敗', 'danger');
    }
}

// 選擇資料類型
function selectDataType(type) {
    selectedDataType = type;
    
    // 更新選中狀態
    document.querySelectorAll('#dataTypeList .list-group-item').forEach(item => {
        item.classList.remove('active');
    });
    event.target.closest('.list-group-item').classList.add('active');
    
    // 顯示參數設定
    showDataParams(type);
}

// 顯示資料參數
function showDataParams(type) {
    const container = document.getElementById('dataParams');
    
    let html = `<h6>${type.name}</h6><p class="text-muted">${type.description}</p>`;
    
    if (type.parameters) {
        html += '<div class="mb-3">';
        Object.entries(type.parameters).forEach(([key, param]) => {
            html += `
                <div class="mb-2">
                    <label class="form-label">${param.label}</label>
                    ${generateParamInput(key, param)}
                </div>
            `;
        });
        html += '</div>';
    }
    
    container.innerHTML = html;
}

// 生成參數輸入欄位
function generateParamInput(key, param) {
    switch (param.type) {
        case 'text':
            return `<input type="text" class="form-control" id="param_${key}" value="${param.default || ''}" placeholder="${param.placeholder || ''}">`;
        case 'number':
            return `<input type="number" class="form-control" id="param_${key}" value="${param.default || ''}" min="${param.min || ''}" max="${param.max || ''}" step="${param.step || ''}">`;
        case 'select':
            let options = '';
            param.options.forEach(option => {
                const selected = option.value === param.default ? 'selected' : '';
                options += `<option value="${option.value}" ${selected}>${option.label}</option>`;
            });
            return `<select class="form-control" id="param_${key}">${options}</select>`;
        case 'date':
            return `<input type="date" class="form-control" id="param_${key}" value="${param.default || ''}">`;
        default:
            return `<input type="text" class="form-control" id="param_${key}" value="${param.default || ''}">`;
    }
}

// 載入選中的資料
async function loadSelectedData() {
    if (!selectedDataType) {
        showAlert('請選擇資料類型', 'warning');
        return;
    }
    
    // 顯示載入狀態
    const loadButton = document.querySelector('#sampleDataModal .btn-primary');
    const originalText = loadButton.textContent;
    loadButton.textContent = '載入中...';
    loadButton.disabled = true;
    
    // 顯示載入提示
    showAlert('正在載入資料，請稍候...', 'info');
    
    try {
        // 收集參數
        const params = {};
        if (selectedDataType.parameters) {
            Object.keys(selectedDataType.parameters).forEach(key => {
                const input = document.getElementById(`param_${key}`);
                if (input) {
                    params[key] = input.value;
                }
            });
        }
        
        // 設定 20 秒超時
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 20000); // 20秒超時
        
        const response = await fetch('/api/sample-data/load', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                data_type: selectedDataType.id,
                parameters: params
            }),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        const data = await response.json();
        if (data.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('sampleDataModal')).hide();
            
            // 限制預覽資料量
            let previewData = data.data;
            if (previewData && previewData.length > 100) {
                previewData = previewData.slice(0, 100);
                showAlert(`資料載入成功！共 ${data.data.length} 筆資料`, 'success');
            } else {
                const dataCount = data.data ? data.data.length : 0;
                showAlert(`資料載入成功！共 ${dataCount} 筆資料`, 'success');
            }
            
            if (isJupyterMode) {
                // Jupyter 模式：插入 cell
                let code = `# 載入範例資料\ndf = pd.DataFrame(${JSON.stringify(previewData)})\nprint(f"載入 {len(previewData)} 筆資料")\ndf.head()`;
                const cellId = addJupyterCell(code);
                setTimeout(() => { executeJupyterCell(cellId); }, 100);
            } else {
                // 傳統模式：預覽
                currentPreviewData = previewData;
                displayPreviewData(previewData);
            }
        } else {
            showAlert(data.message || '載入資料失敗', 'danger');
        }
    } catch (error) {
        console.error('載入資料失敗:', error);
        
        if (error.name === 'AbortError') {
            showAlert('載入超時（20秒），請嘗試減少資料量或稍後再試', 'warning');
        } else {
            showAlert('載入資料失敗: ' + error.message, 'danger');
        }
    } finally {
        // 恢復按鈕狀態
        loadButton.textContent = originalText;
        loadButton.disabled = false;
    }
}

// 顯示預覽資料
function displayPreviewData(data) {
    const previewDiv = document.getElementById('dataPreview');
    const infoSpan = document.getElementById('dataInfo');
    const table = document.getElementById('dataTable');
    
    // 顯示資料資訊
    infoSpan.textContent = `共 ${data.length} 筆資料，${Object.keys(data[0] || {}).length} 個欄位`;
    
    // 生成表頭
    const thead = table.querySelector('thead');
    thead.innerHTML = '';
    const headerRow = document.createElement('tr');
    
    Object.keys(data[0] || {}).forEach(column => {
        const th = document.createElement('th');
        th.textContent = column;
        th.style.fontSize = '12px';
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    
    // 生成資料行
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';
    
    data.slice(0, 100).forEach(row => { // 只顯示前100筆
        const tr = document.createElement('tr');
        Object.values(row).forEach(value => {
            const td = document.createElement('td');
            td.textContent = formatCellValue(value);
            td.style.fontSize = '12px';
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
    
    if (data.length > 100) {
        const infoRow = document.createElement('tr');
        const infoCell = document.createElement('td');
        infoCell.colSpan = Object.keys(data[0] || {}).length;
        infoCell.textContent = `... 還有 ${data.length - 100} 筆資料`;
        infoCell.className = 'text-muted text-center';
        infoCell.style.fontSize = '12px';
        infoRow.appendChild(infoCell);
        tbody.appendChild(infoRow);
    }
    
    // 顯示預覽區域
    previewDiv.style.display = 'block';
}

// 格式化單元格值
function formatCellValue(value) {
    if (value === null || value === undefined) {
        return '-';
    }
    
    if (typeof value === 'number') {
        return value.toLocaleString();
    }
    
    if (typeof value === 'string' && value.length > 50) {
        return value.substring(0, 50) + '...';
    }
    
    return String(value);
}

// 清除預覽資料
function clearPreviewData() {
    currentPreviewData = null;
    document.getElementById('dataPreview').style.display = 'none';
    showAlert('預覽資料已清除', 'info');
}

// 設定股票來源處理器
function setupStockSourceHandlers() {
    function hideAllSourceConfigs() {
        document.getElementById('excelSourceConfig').style.display = 'none';
        document.getElementById('stockListConfig').style.display = 'none';
    }
    document.getElementById('stockSourceExcel').addEventListener('change', function() {
        hideAllSourceConfigs();
        document.getElementById('excelSourceConfig').style.display = 'block';
    });
    document.getElementById('stockSourceList').addEventListener('change', function() {
        hideAllSourceConfigs();
        document.getElementById('stockListConfig').style.display = 'block';
    });
}

// 載入選股列表
async function loadStockLists() {
    try {
        const response = await fetch('/api/stock-lists');
        const data = await response.json();
        
        if (data.status === 'success') {
            const select = document.getElementById('stockListSelect');
            select.innerHTML = '<option value="">請選擇選股列表...</option>';
            
            data.stock_lists.forEach(stockList => {
                const option = document.createElement('option');
                option.value = stockList.id;
                option.textContent = `${stockList.name} (${stockList.stock_count} 檔股票)`;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('載入選股列表失敗:', error);
    }
}

// 取得股票來源設定
function getStockSourceConfig() {
    const stockSource = document.querySelector('input[name="stockSource"]:checked').value;
    
    if (stockSource === 'excel') {
        return {
            type: 'excel',
            config: {
                required_columns: ['stock_id', 'startdate', 'enddate']
            }
        };
    } else if (stockSource === 'stock_list') {
        const stockListId = document.getElementById('stockListSelect').value;
        return {
            type: 'stock_list',
            config: {
                stock_list_id: stockListId
            }
        };
    } else if (stockSource === 'cache') {
        const cacheFile = document.getElementById('cacheFileSelect').value;
        return {
            type: 'cache',
            config: {
                cache_file: cacheFile
            }
        };
    }
    
    return null;
}

// 設定 Excel 檔案處理器
function setupExcelFileHandlers() {
    const excelFileInput = document.getElementById('excelFile');
    // 處理檔案選擇
    excelFileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // 顯示檔案資訊
            document.getElementById('excelFileName').textContent = file.name;
            document.getElementById('excelFileInfo').style.display = 'block';
            showAlert(`已選擇檔案: ${file.name}`, 'success');
        }
    });
}

// 下載 Excel 範本
async function downloadExcelTemplate() {
    try {
        const response = await fetch('/api/strategies/custom/excel-template');
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'strategy_test_template.xlsx';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showAlert('Excel 範本下載成功', 'success');
        } else {
            showAlert('下載範本失敗', 'danger');
        }
    } catch (error) {
        console.error('下載範本失敗:', error);
        showAlert('下載範本失敗', 'danger');
    }
}

// 更新參數增量
function updateParameterIncrement(key, increment) {
    updateStrategyParameters();
}

// 更新參數描述
function updateParameterDescription(key, description) {
    updateStrategyParameters();
}

// 更新參數選項
function updateParameterOptions(key, optionsString) {
    updateStrategyParameters();
}

// 新增選項
function addSelectOption(key) {
    const paramItem = document.querySelector(`[data-key="${key}"]`);
    if (paramItem) {
        const optionsInput = paramItem.querySelector('.parameter-options');
        const currentValue = optionsInput.value;
        const newOption = prompt('請輸入新選項 (格式: 值:標籤)', 'new_value:新選項');
        
        if (newOption && newOption.includes(':')) {
            const newValue = currentValue ? currentValue + ';' + newOption : newOption;
            optionsInput.value = newValue;
            updateParameterOptions(key, newValue);
        }
    }
}

// 切換排序模式
function toggleParameterSort() {
    isSortMode = !isSortMode;
    const btn = document.getElementById('sortToggleBtn');
    
    if (isSortMode) {
        btn.innerHTML = '<i class="fas fa-check"></i> 完成排序';
        btn.className = 'btn btn-sm btn-success me-2';
        initializeSortable();
        showAlert('拖拽參數卡片可重新排序', 'info');
    } else {
        btn.innerHTML = '<i class="fas fa-sort"></i> 排序模式';
        btn.className = 'btn btn-sm btn-outline-secondary me-2';
        destroySortable();
        showAlert('排序完成', 'success');
    }
}

// 初始化拖拽排序
function initializeSortable() {
    const container = document.getElementById('parameterContainer');
    if (!container) return;
    
    // 銷毀現有的實例
    if (sortableInstance) {
        sortableInstance.destroy();
    }
    
    // 建立新的 Sortable 實例
    sortableInstance = new Sortable(container, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        dragClass: 'sortable-drag',
        onEnd: function(evt) {
            // 排序完成後更新參數順序
            updateStrategyParameters();
        }
    });
    
    // 為每個參數卡片加入拖拽提示
    const parameterItems = container.querySelectorAll('.parameter-item');
    parameterItems.forEach(item => {
        item.style.cursor = 'grab';
        item.setAttribute('title', '拖拽可重新排序');
    });
}

// 銷毀拖拽排序
function destroySortable() {
    if (sortableInstance) {
        sortableInstance.destroy();
        sortableInstance = null;
    }
    
    // 移除拖拽提示
    const parameterItems = document.querySelectorAll('.parameter-item');
    parameterItems.forEach(item => {
        item.style.cursor = 'default';
        item.removeAttribute('title');
    });
}

// 新增參數（別名函數）
function addParameter() {
    addNewParameter();
}

// 側邊欄切換功能
function setupSidebarToggle() {
    const toggleBtn = document.getElementById('toggleSidebar');
    const sidebar = document.getElementById('sidebar');
    const mainEditor = document.getElementById('mainEditor');
    const toggleIcon = document.getElementById('toggleIcon');
    
    if (toggleBtn && sidebar && mainEditor) {
        toggleBtn.addEventListener('click', function() {
            sidebar.classList.toggle('collapsed');
            mainEditor.classList.toggle('expanded');
            
            // 更新圖標
            if (sidebar.classList.contains('collapsed')) {
                toggleIcon.className = 'fas fa-chevron-right';
                toggleBtn.title = '展開側邊欄';
            } else {
                toggleIcon.className = 'fas fa-chevron-left';
                toggleBtn.title = '縮起側邊欄';
            }
            
            // 重新整理程式碼編輯器大小
            if (window.codeEditor) {
                setTimeout(() => {
                    window.codeEditor.refresh();
                }, 300);
            }
        });
    }
}

// 切換持有記錄功能
function toggleRecordHoldings() {
    const switchElement = document.getElementById('recordHoldingsSwitch');
    const isEnabled = switchElement.checked;
    
    // 更新策略參數
    if (window.strategyParameters) {
        window.strategyParameters['record_holdings'] = isEnabled ? 1 : 0;
    }
    
    // 顯示提示訊息
    if (isEnabled) {
        showAlert('已啟用持有未出場記錄功能', 'success');
    } else {
        showAlert('已停用持有未出場記錄功能', 'info');
    }
}

// ==================== Jupyter 編輯器功能 ====================

let jupyterCells = [];
let jupyterCellCounter = 0;
let isJupyterMode = false;
let jupyterCellEditors = {};

// 切換 Jupyter 模式
function toggleJupyterMode() {
    isJupyterMode = !isJupyterMode;
    const jupyterEditor = document.getElementById('jupyterEditor');
    const traditionalEditor = document.getElementById('traditionalEditor');
    const jupyterModeBtn = document.getElementById('jupyterModeBtn');
    
    if (isJupyterMode) {
        jupyterEditor.style.display = 'block';
        traditionalEditor.style.display = 'none';
        jupyterModeBtn.innerHTML = '<i class="fas fa-file-code"></i> 切換傳統模式';
        jupyterModeBtn.className = 'btn btn-sm btn-outline-primary';
        
        // 初始化 Jupyter 編輯器
        if (jupyterCells.length === 0) {
            // 添加預設的範例單元格
            addJupyterCell(`# 歡迎使用 Jupyter 風格策略編輯器！
# 這個編輯器支援即時程式碼執行和圖表顯示

# 載入必要的模組
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

print("模組載入完成！")`);
            
            addJupyterCell(`# 生成範例股票資料
dates = pd.date_range('2024-01-01', '2024-12-31', freq='D')
np.random.seed(42)

# 模擬股價資料
close_prices = 100 + np.cumsum(np.random.normal(0, 0.5, len(dates)))
df = pd.DataFrame({
    'date': dates,
    'close': close_prices,
    'volume': np.random.uniform(1000000, 5000000, len(dates))
})

print(f"生成 {len(df)} 筆股票資料")
df.head()`);
            
            addJupyterCell(`# 計算技術指標
df['ma5'] = df['close'].rolling(5).mean()
df['ma20'] = df['close'].rolling(20).mean()
df['ma60'] = df['close'].rolling(60).mean()

# 計算日報酬率
df['daily_return'] = df['close'].pct_change()

print("技術指標計算完成")
df.tail()`);
            
            addJupyterCell(`# 繪製股價和移動平均線圖
plt.figure(figsize=(12, 6))
plt.plot(df['date'], df['close'], label='收盤價', linewidth=2)
plt.plot(df['date'], df['ma5'], label='5日均線', alpha=0.7)
plt.plot(df['date'], df['ma20'], label='20日均線', alpha=0.7)
plt.plot(df['date'], df['ma60'], label='60日均線', alpha=0.7)

plt.title('股票價格與移動平均線', fontsize=14)
plt.xlabel('日期')
plt.ylabel('價格')
plt.legend()
plt.grid(True, alpha=0.3)
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()`);
        }
    } else {
        jupyterEditor.style.display = 'none';
        traditionalEditor.style.display = 'block';
        jupyterModeBtn.innerHTML = '<i class="fas fa-play"></i> 切換 Jupyter 模式';
        jupyterModeBtn.className = 'btn btn-sm btn-outline-secondary';
    }
}

// 初始化 Jupyter 模式（頁面載入時自動啟用）
function initializeJupyterMode() {
    isJupyterMode = true;
    // 初始化全域變數狀態
    window.jupyterGlobalVariables = {};
    const jupyterEditor = document.getElementById('jupyterEditor');
    const traditionalEditor = document.getElementById('traditionalEditor');
    const jupyterModeBtn = document.getElementById('jupyterModeBtn');
    
    if (jupyterEditor && traditionalEditor && jupyterModeBtn) {
        jupyterEditor.style.display = 'block';
        traditionalEditor.style.display = 'none';
        jupyterModeBtn.innerHTML = '<i class="fas fa-file-code"></i> 切換傳統模式';
        jupyterModeBtn.className = 'btn btn-sm btn-outline-primary';
        
        // 初始化 Jupyter 編輯器
        if (jupyterCells.length === 0) {
            // 添加預設的範例單元格
            addJupyterCell(`# 歡迎使用 Jupyter 風格策略編輯器！
# 這個編輯器支援即時程式碼執行和圖表顯示

# 載入必要的模組
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

print("模組載入完成！")`);
            
            addJupyterCell(`# 生成範例股票資料
dates = pd.date_range('2024-01-01', '2024-12-31', freq='D')
np.random.seed(42)

# 模擬股價資料
close_prices = 100 + np.cumsum(np.random.normal(0, 0.5, len(dates)))
df = pd.DataFrame({
    'date': dates,
    'close': close_prices,
    'volume': np.random.uniform(1000000, 5000000, len(dates))
})

print(f"生成 {len(df)} 筆股票資料")
df.head()`);
            
            addJupyterCell(`# 計算技術指標
df['ma5'] = df['close'].rolling(5).mean()
df['ma20'] = df['close'].rolling(20).mean()
df['ma60'] = df['close'].rolling(60).mean()

# 計算日報酬率
df['daily_return'] = df['close'].pct_change()

print("技術指標計算完成")
df.tail()`);
            
            addJupyterCell(`# 繪製股價和移動平均線圖
plt.figure(figsize=(12, 6))
plt.plot(df['date'], df['close'], label='收盤價', linewidth=2)
plt.plot(df['date'], df['ma5'], label='5日均線', alpha=0.7)
plt.plot(df['date'], df['ma20'], label='20日均線', alpha=0.7)
plt.plot(df['date'], df['ma60'], label='60日均線', alpha=0.7)

plt.title('股票價格與移動平均線', fontsize=14)
plt.xlabel('日期')
plt.ylabel('價格')
plt.legend()
plt.grid(True, alpha=0.3)
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()`);
        }
    }
}

// 新增 Jupyter 單元格
function addJupyterCell(code = '', afterCellId = null) {
    console.log('建立 cell，內容：', code); // 除錯用
    jupyterCellCounter++;
    const cellId = `cell_${jupyterCellCounter}`;
    
    const cellHtml = `
        <div class="jupyter-cell" id="${cellId}" data-cell-id="${cellId}">
            <div class="jupyter-cell-header">
                <span class="jupyter-cell-number">In [${jupyterCellCounter}]:</span>
                <div class="jupyter-cell-actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="executeJupyterCell('${cellId}')" title="執行 (Shift+Enter)">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="addJupyterCell('', '${cellId}')" title="在下方新增 (Ctrl+Enter)">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="moveJupyterCellUp('${cellId}')" title="向上移動 (Ctrl+Up)">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="moveJupyterCellDown('${cellId}')" title="向下移動 (Ctrl+Down)">
                        <i class="fas fa-arrow-down"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteJupyterCell('${cellId}')" title="刪除">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="jupyter-cell-input">
                <textarea class="jupyter-code-input" id="input_${cellId}" placeholder="輸入程式碼...">${code}</textarea>
            </div>
            <div class="jupyter-cell-output" id="output_${cellId}">
                <!-- 輸出將在這裡顯示 -->
            </div>
        </div>
    `;
    
    const cellsContainer = document.getElementById('jupyterCells');
    if (afterCellId) {
        // 插入到指定 cell 下方
        const afterCell = document.getElementById(afterCellId);
        if (afterCell && afterCell.nextSibling) {
            afterCell.parentNode.insertBefore(document.createRange().createContextualFragment(cellHtml), afterCell.nextSibling);
        } else if (afterCell) {
            afterCell.insertAdjacentHTML('afterend', cellHtml);
        } else {
            cellsContainer.insertAdjacentHTML('beforeend', cellHtml);
        }
        // 在 jupyterCells 陣列中插入對應位置
        const idx = jupyterCells.indexOf(afterCellId);
        if (idx !== -1) {
            jupyterCells.splice(idx + 1, 0, cellId);
        } else {
            jupyterCells.push(cellId);
        }
    } else {
        // 預設加在最下方
        cellsContainer.insertAdjacentHTML('beforeend', cellHtml);
        jupyterCells.push(cellId);
    }
    // 初始化 CodeMirror 編輯器
    const textarea = document.getElementById(`input_${cellId}`);
    const editor = CodeMirror.fromTextArea(textarea, {
        mode: 'python',
        theme: 'eclipse',
        lineNumbers: true,
        lineWrapping: true,
        indentUnit: 4,
        tabSize: 4,
        indentWithTabs: false,
        autoCloseBrackets: true,
        matchBrackets: true,
        foldGutter: true,
        gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
        extraKeys: {
            'Shift-Enter': function(cm) {
                executeJupyterCell(cellId);
            },
            'Ctrl-Enter': function(cm) {
                addJupyterCell('', cellId);
            },
            'Ctrl-Up': function(cm) {
                moveJupyterCellUp(cellId);
            },
            'Ctrl-Down': function(cm) {
                moveJupyterCellDown(cellId);
            },
            'Tab': function(cm) {
                if (cm.somethingSelected()) {
                    cm.indentSelection('add');
                } else {
                    cm.replaceSelection('    ', 'end');
                }
            }
        }
    });
    jupyterCellEditors[cellId] = editor;
    // 設定編輯器大小
    editor.setSize('100%', 'auto');
    editor.refresh();
    return cellId;
}

// 執行 Jupyter 單元格
async function executeJupyterCell(cellId) {
    const cell = document.getElementById(cellId);
    const editor = jupyterCellEditors[cellId];
    const outputContainer = document.getElementById(`output_${cellId}`);
    if (!editor) return;
    const code = editor.getValue().trim();
    if (!code) return;
    // 設定執行狀態
    cell.className = 'jupyter-cell executing';
    // 清空輸出
    outputContainer.innerHTML = '<div class="output-item"><div class="output-stream stdout">執行中...</div></div>';
    try {
        // 取得策略參數
        updateStrategyParameters();
        const parameters = window.currentStrategyParameters || {};
        
        // 只在第一個 cell 或沒有全域變數時傳送資料來源
        const strategyTable = document.getElementById('strategyDataTable').value;
        const excelFile = document.getElementById('excelFile').files[0];
        const formData = new FormData();
        formData.append('code', code);
        formData.append('cell_id', cellId);
        
        // 檢查是否為第一個 cell 或沒有全域變數
        const isFirstCell = cellId === jupyterCells[0];
        const hasGlobalVariables = window.jupyterGlobalVariables && Object.keys(window.jupyterGlobalVariables).length > 0;
        
        if (isFirstCell || !hasGlobalVariables) {
            // 只在第一次載入時傳送資料來源
            formData.append('strategy_table', strategyTable);
            if (excelFile) {
                formData.append('excel_file', excelFile);
            }
            console.log('傳送資料來源：', { strategyTable, hasExcelFile: !!excelFile });
        } else {
            // 後續 cell 不傳送資料來源，避免覆蓋已修改的變數
            formData.append('strategy_table', '');
            console.log('跳過資料來源傳送，使用現有全域變數');
        }
        
        // 添加策略參數
        formData.append('parameters', JSON.stringify(parameters));
        
        const response = await fetch('/api/jupyter/execute', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        if (data.status === 'success') {
            displayJupyterOutputs(outputContainer, data.outputs);
            cell.className = 'jupyter-cell success';
            
            // 更新全域變數狀態（假設執行成功後有變數）
            if (!window.jupyterGlobalVariables) {
                window.jupyterGlobalVariables = {};
            }
            // 標記為有全域變數存在
            window.jupyterGlobalVariables.hasVariables = true;
        } else {
            outputContainer.innerHTML = `<div class="output-item"><div class="output-error">錯誤: ${data.error}</div></div>`;
            cell.className = 'jupyter-cell error';
        }
    } catch (error) {
        console.error('執行 Jupyter 單元格失敗:', error);
        outputContainer.innerHTML = `<div class="output-item"><div class="output-error">執行失敗: ${error.message}</div></div>`;
        cell.className = 'jupyter-cell error';
    }
}

// 執行並新增單元格
function executeAndAddCell(cellId) {
    executeJupyterCell(cellId).then(() => {
        addJupyterCell();
    });
}

// 刪除 Jupyter 單元格
function deleteJupyterCell(cellId) {
    if (jupyterCells.length <= 1) {
        showAlert('至少需要保留一個單元格', 'warning');
        return;
    }
    
    if (confirm('確定要刪除這個單元格嗎？')) {
        const cell = document.getElementById(cellId);
        const editor = jupyterCellEditors[cellId];
        
        if (editor) {
            editor.toTextArea();
            delete jupyterCellEditors[cellId];
        }
        
        cell.remove();
        
        // 從陣列中移除
        const index = jupyterCells.indexOf(cellId);
        if (index > -1) {
            jupyterCells.splice(index, 1);
        }
        
        // 重新編號
        renumberJupyterCells();
    }
}

// 重新編號 Jupyter 單元格
function renumberJupyterCells() {
    jupyterCells.forEach((cellId, index) => {
        const cell = document.getElementById(cellId);
        const numberSpan = cell.querySelector('.jupyter-cell-number');
        if (numberSpan) {
            numberSpan.textContent = `In [${index + 1}]:`;
        }
    });
}

// 向上移動 Jupyter 單元格
function moveJupyterCellUp(cellId) {
    const currentIndex = jupyterCells.indexOf(cellId);
    if (currentIndex > 0) {
        // 交換陣列中的位置
        [jupyterCells[currentIndex], jupyterCells[currentIndex - 1]] = 
        [jupyterCells[currentIndex - 1], jupyterCells[currentIndex]];
        
        // 移動 DOM 元素
        const cellsContainer = document.getElementById('jupyterCells');
        const currentCell = document.getElementById(cellId);
        const previousCell = document.getElementById(jupyterCells[currentIndex]);
        
        if (currentCell && previousCell) {
            cellsContainer.insertBefore(currentCell, previousCell);
        }
        
        // 重新編號
        renumberJupyterCells();
        
        console.log(`Cell ${cellId} 已向上移動`);
    } else {
        showAlert('已經是第一個單元格', 'info');
    }
}

// 向下移動 Jupyter 單元格
function moveJupyterCellDown(cellId) {
    const currentIndex = jupyterCells.indexOf(cellId);
    if (currentIndex < jupyterCells.length - 1) {
        // 交換陣列中的位置
        [jupyterCells[currentIndex], jupyterCells[currentIndex + 1]] = 
        [jupyterCells[currentIndex + 1], jupyterCells[currentIndex]];
        
        // 移動 DOM 元素
        const cellsContainer = document.getElementById('jupyterCells');
        const currentCell = document.getElementById(cellId);
        const nextCell = document.getElementById(jupyterCells[currentIndex]);
        
        if (currentCell && nextCell) {
            cellsContainer.insertBefore(currentCell, nextCell.nextSibling);
        }
        
        // 重新編號
        renumberJupyterCells();
        
        console.log(`Cell ${cellId} 已向下移動`);
    } else {
        showAlert('已經是最後一個單元格', 'info');
    }
}

// 顯示 Jupyter 輸出
function displayJupyterOutputs(container, outputs) {
    container.innerHTML = '';
    
    if (!outputs || outputs.length === 0) {
        return;
    }
    
    outputs.forEach(output => {
        const outputItem = document.createElement('div');
        outputItem.className = 'output-item';
        
        switch (output.output_type) {
            case 'stream':
                const streamDiv = document.createElement('div');
                streamDiv.className = `output-stream ${output.name}`;
                streamDiv.textContent = output.text.join('\n');
                outputItem.appendChild(streamDiv);
                break;
                
            case 'error':
                const errorDiv = document.createElement('div');
                errorDiv.className = 'output-error';
                errorDiv.innerHTML = `
                    <strong>${output.ename}:</strong> ${output.evalue}<br>
                    ${output.traceback.join('\n')}
                `;
                outputItem.appendChild(errorDiv);
                break;
                
            case 'display_data':
                const displayDiv = document.createElement('div');
                displayDiv.className = 'output-display';
                
                if (output.data['image/png']) {
                    // 顯示圖片
                    const img = document.createElement('img');
                    img.src = `data:image/png;base64,${output.data['image/png']}`;
                    img.alt = 'Generated Chart';
                    displayDiv.appendChild(img);
                } else if (output.data['text/html']) {
                    // 顯示 HTML
                    displayDiv.innerHTML = output.data['text/html'];
                } else if (output.data['text/plain']) {
                    // 顯示純文字
                    const pre = document.createElement('pre');
                    pre.textContent = output.data['text/plain'];
                    displayDiv.appendChild(pre);
                }
                
                outputItem.appendChild(displayDiv);
                break;
                
            case 'execute_result':
                const resultDiv = document.createElement('div');
                resultDiv.className = 'output-display';
                resultDiv.innerHTML = `<pre>${output.data['text/plain']}</pre>`;
                outputItem.appendChild(resultDiv);
                break;
        }
        
        container.appendChild(outputItem);
    });
}

// 清除所有輸出
function clearAllOutputs() {
    jupyterCells.forEach(cellId => {
        const outputContainer = document.getElementById(`output_${cellId}`);
        if (outputContainer) {
            outputContainer.innerHTML = '';
        }
        
        const cell = document.getElementById(cellId);
        cell.className = 'jupyter-cell';
    });
}

// 清除 Jupyter 輸出
function clearJupyterOutputs() {
    // 清除所有單元格的輸出
    jupyterCells.forEach(cellId => {
        const outputDiv = document.getElementById(`output_${cellId}`);
        if (outputDiv) {
            outputDiv.innerHTML = '';
        }
    });
}

// 清除 Jupyter 全域變數
async function clearJupyterVariables() {
    if (!isJupyterMode) {
        showAlert('此功能僅適用於 Jupyter 模式', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/jupyter/clear-variables', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showAlert('全域變數已清除', 'success');
        } else {
            showAlert('清除變數失敗', 'danger');
        }
    } catch (error) {
        console.error('清除變數失敗:', error);
        showAlert('清除變數失敗', 'danger');
    }
}

// 清除 Jupyter 輸出和變數（靜默模式，不顯示提示）
async function clearJupyterSilently() {
    // 清除輸出（不管是否為 Jupyter 模式）
    clearJupyterOutputs();
    
    // 如果是 Jupyter 模式，也清除變數
    if (isJupyterMode) {
        try {
            await fetch('/api/jupyter/clear-variables', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
        } catch (error) {
            console.warn('清除 Jupyter 變數失敗:', error);
        }
    }
}

// 查看 Jupyter 全域變數
async function showJupyterVariables() {
    if (!isJupyterMode) {
        showAlert('此功能僅適用於 Jupyter 模式', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/jupyter/variables', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            // 更新全域變數狀態
            window.jupyterGlobalVariables = data.variables.reduce((acc, varName) => {
                acc[varName] = true;
                return acc;
            }, {});
            
            let message = `當前載入的變數 (共 ${data.count} 個):\n`;
            if (data.variables.length > 0) {
                message += data.variables.join(', ');
            } else {
                message += '無';
            }
            message += `\n\n檔案路徑: ${data.file_path}`;
            
            // 使用 alert 顯示，或者可以改為更美觀的 modal
            alert(message);
        } else {
            showAlert('獲取變數失敗', 'danger');
        }
    } catch (error) {
        console.error('獲取變數失敗:', error);
        showAlert('獲取變數失敗', 'danger');
    }
}

// 執行 Jupyter 策略回測
async function executeJupyterBacktest() {
    if (!isJupyterMode) {
        showAlert('此功能僅適用於 Jupyter 模式', 'warning');
        return;
    }
    
    // 收集所有單元格的程式碼
    let allCode = '';
    jupyterCells.forEach(cellId => {
        const editor = jupyterCellEditors[cellId];
        if (editor) {
            allCode += editor.getValue() + '\n\n';
        }
    });
    
    if (!allCode.trim()) {
        showAlert('請先在單元格中輸入策略程式碼', 'warning');
        return;
    }
    
    // 取得策略參數
    updateStrategyParameters();
    const parameters = window.currentStrategyParameters || {};
    
    // 取得當前資料來源
    const strategyTable = document.getElementById('strategyDataTable').value;
    const excelFile = document.getElementById('excelFile').files[0];
    
    try {
        showAlert('正在執行策略回測...', 'info');
        
        // 準備請求資料
        const requestData = {
            strategy_code: allCode,
            parameters: parameters,
            strategy_table: strategyTable
        };
        
        // 如果有 Excel 檔案，轉換為 base64
        if (excelFile) {
            const reader = new FileReader();
            reader.onload = async function(e) {
                requestData.excel_file = e.target.result;
                
                const response = await fetch('/api/jupyter/strategy-backtest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    // 顯示回測結果
                    displayJupyterBacktestResults(data.result);
                    showAlert('策略回測執行成功', 'success');
                } else {
                    showAlert(`策略回測失敗: ${data.error}`, 'danger');
                }
            };
            reader.readAsDataURL(excelFile);
        } else {
            // 沒有 Excel 檔案，直接發送請求
            const response = await fetch('/api/jupyter/strategy-backtest', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                // 顯示回測結果
                displayJupyterBacktestResults(data.result);
                showAlert('策略回測執行成功', 'success');
            } else {
                showAlert(`策略回測失敗: ${data.error}`, 'danger');
            }
        }
    } catch (error) {
        console.error('執行策略回測失敗:', error);
        showAlert('執行策略回測失敗', 'danger');
    }
}

// 顯示 Jupyter 回測結果
function displayJupyterBacktestResults(data) {
    console.log('Jupyter 回測結果:', data);
    console.log('資料類型:', typeof data);
    console.log('資料鍵值:', Object.keys(data));
    
    // 檢查資料結構
    if (data && typeof data === 'object') {
        console.log('trade_records:', data.trade_records);
        console.log('holding_positions:', data.holding_positions);
        console.log('backtest_statistics:', data.backtest_statistics);
        console.log('charts:', data.charts);
        console.log('result_df:', data.result_df);
        console.log('strategy_info:', data.strategy_info);
    }
    
    // 顯示交易記錄
    if (data.trade_records && data.trade_records.length > 0) {
        console.log('顯示交易記錄:', data.trade_records.length, '筆');
        // 將資料轉換為 showTradeReport 期望的格式
        const backtestResults = {
            trade_records: data.trade_records,
            holding_positions: data.holding_positions || [],
            total_trades: data.backtest_statistics?.total_trades || data.trade_records.length,
            win_rate: data.backtest_statistics?.win_rate || 0,
            total_return: data.backtest_statistics?.total_return || 0,
            max_drawdown: data.backtest_statistics?.max_drawdown || 0
        };
        showTradeReport(backtestResults);
    } else {
        console.log('沒有交易記錄');
        showAlert('沒有產生任何交易記錄', 'info');
    }
    
    // 顯示回測統計
    if (data.backtest_statistics) {
        console.log('顯示回測統計:', data.backtest_statistics);
        displayBacktestStatistics(data.backtest_statistics);
    } else {
        console.log('沒有回測統計');
    }
    
    // 顯示圖表
    if (data.charts && data.charts.length > 0) {
        console.log('顯示圖表:', data.charts.length, '個');
        displayJupyterCharts(data.charts);
    } else {
        console.log('沒有圖表');
    }
    
    // 顯示結果資料
    if (data.result_df) {
        console.log('顯示結果資料');
        displayResultData(data.result_df);
    } else {
        console.log('沒有結果資料');
    }
    
    // 顯示策略資訊
    if (data.strategy_info) {
        console.log('顯示策略資訊:', data.strategy_info);
        displayStrategyInfo(data.strategy_info);
    } else {
        console.log('沒有策略資訊');
    }
}

// 顯示回測統計
function displayBacktestStatistics(stats) {
    const container = document.getElementById('chartsContainer');
    if (!container) return;
    
    console.log('顯示統計資料:', stats);
    
    let html = '<div class="row mb-3">';
    html += '<div class="col-12"><h6>回測統計</h6></div>';
    
    if (stats.total_trades !== undefined) {
        html += `<div class="col-md-3"><div class="card"><div class="card-body text-center">`;
        html += `<h5 class="text-primary">${stats.total_trades}</h5><small>總交易次數</small></div></div></div>`;
    }
    
    if (stats.win_rate !== undefined) {
        const winRateClass = stats.win_rate >= 50 ? 'text-success' : 'text-danger';
        html += `<div class="col-md-3"><div class="card"><div class="card-body text-center">`;
        html += `<h5 class="${winRateClass}">${stats.win_rate.toFixed(2)}%</h5><small>勝率</small></div></div></div>`;
    }
    
    if (stats.total_return !== undefined) {
        const returnClass = stats.total_return >= 0 ? 'text-success' : 'text-danger';
        html += `<div class="col-md-3"><div class="card"><div class="card-body text-center">`;
        html += `<h5 class="${returnClass}">${stats.total_return.toFixed(2)}%</h5><small>總報酬率</small></div></div></div>`;
    }
    
    if (stats.max_drawdown !== undefined) {
        html += `<div class="col-md-3"><div class="card"><div class="card-body text-center">`;
        html += `<h5 class="text-danger">${stats.max_drawdown.toFixed(2)}%</h5><small>最大回撤</small></div></div></div>`;
    }
    
    // 添加更多統計資訊
    if (stats.total_profit_loss !== undefined) {
        const profitClass = stats.total_profit_loss >= 0 ? 'text-success' : 'text-danger';
        html += `<div class="col-md-3"><div class="card"><div class="card-body text-center">`;
        html += `<h5 class="${profitClass}">${stats.total_profit_loss.toLocaleString()}</h5><small>總損益</small></div></div></div>`;
    }
    
    if (stats.sharpe_ratio !== undefined) {
        html += `<div class="col-md-3"><div class="card"><div class="card-body text-center">`;
        html += `<h5 class="text-info">${stats.sharpe_ratio.toFixed(2)}</h5><small>夏普比率</small></div></div></div>`;
    }
    
    html += '</div>';
    container.insertAdjacentHTML('beforeend', html);
}

// 顯示圖表
function displayCharts(charts) {
    const container = document.getElementById('chartsContainer');
    if (!container) return;
    
    // 先清空容器
    container.innerHTML = '';
    
    if (!charts || charts.length === 0) {
        let html = '<div class="row mb-3">';
        html += '<div class="col-12"><h6>策略圖表</h6></div>';
        html += '<div class="col-12"><div class="alert alert-info">沒有可顯示的圖表</div></div>';
        html += '</div>';
        container.insertAdjacentHTML('beforeend', html);
        return;
    }
    
    let html = '<div class="row mb-3">';
    html += '<div class="col-12"><h6>策略圖表</h6></div>';
    
    charts.forEach((chart, index) => {
        html += '<div class="col-12 mb-3">';
        html += '<div class="card">';
        html += `<div class="card-header"><h6>${chart.title || chart.id}</h6></div>`;
        html += '<div class="card-body">';
        if (chart.html) {
            html += chart.html;
        } else {
            html += '<div class="alert alert-warning">圖表內容載入失敗</div>';
        }
        html += '</div>';
        html += '</div>';
        html += '</div>';
    });
    
    html += '</div>';
    container.insertAdjacentHTML('beforeend', html);
    
    // 讓 chart.html 內的 <script> 能執行
    const scripts = container.querySelectorAll('script');
    scripts.forEach(oldScript => {
        const newScript = document.createElement('script');
        if (oldScript.src) {
            newScript.src = oldScript.src;
        } else {
            newScript.textContent = oldScript.textContent;
        }
        oldScript.parentNode.replaceChild(newScript, oldScript);
    });
}

// 顯示 Jupyter 圖表
function displayJupyterCharts(charts) {
    const container = document.getElementById('jupyterChartsContainer');
    const section = document.getElementById('jupyterChartsSection');
    const noChartsMessage = document.getElementById('jupyterNoChartsMessage');
    
    if (!container) {
        console.error('找不到 jupyterChartsContainer');
        return;
    }
    
    // 顯示圖表區域
    if (section) section.style.display = 'block';
    if (noChartsMessage) noChartsMessage.style.display = 'none';
    
    // 先清空容器
    container.innerHTML = '';
    
    if (!charts || charts.length === 0) {
        let html = '<div class="row mb-3">';
        html += '<div class="col-12"><h6>策略圖表</h6></div>';
        html += '<div class="col-12"><div class="alert alert-info">沒有可顯示的圖表</div></div>';
        html += '</div>';
        container.insertAdjacentHTML('beforeend', html);
        return;
    }
    
    console.log('開始生成 Jupyter 圖表 HTML');
    
    let html = '<div class="row mb-3">';
    html += '<div class="col-12"><h6>策略圖表</h6></div>';
    
    charts.forEach((chart, index) => {
        console.log(`處理圖表 ${index}:`, chart);
        html += '<div class="col-12 mb-3">';
        html += '<div class="card">';
        html += `<div class="card-header"><h6>${chart.title || chart.id || `圖表 ${index + 1}`}</h6></div>`;
        html += '<div class="card-body">';
        if (chart.html) {
            console.log(`圖表 ${index} HTML 長度:`, chart.html.length);
            html += chart.html;
        } else {
            console.log(`圖表 ${index} 沒有 HTML 內容`);
            html += '<div class="alert alert-warning">圖表內容載入失敗</div>';
        }
        html += '</div>';
        html += '</div>';
        html += '</div>';
    });
    
    html += '</div>';
    container.insertAdjacentHTML('beforeend', html);
    
    console.log('Jupyter 圖表 HTML 生成完成，開始處理 script 標籤');
    
    // 讓 chart.html 內的 <script> 能執行
    const scripts = container.querySelectorAll('script');
    console.log('找到 script 標籤數量:', scripts.length);
    scripts.forEach((oldScript, index) => {
        console.log(`處理 script ${index}:`, oldScript.src || '內聯腳本');
        const newScript = document.createElement('script');
        if (oldScript.src) {
            newScript.src = oldScript.src;
        } else {
            newScript.textContent = oldScript.textContent;
        }
        oldScript.parentNode.replaceChild(newScript, oldScript);
    });
    
    console.log('Jupyter 圖表顯示完成');
}

// 重新整理 Jupyter 圖表
function refreshJupyterCharts() {
    const container = document.getElementById('jupyterChartsContainer');
    if (container) {
        container.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> 重新整理中...</div>';
        setTimeout(() => {
            container.innerHTML = '<div class="alert alert-info">請重新執行策略回測以顯示圖表</div>';
        }, 1000);
    }
}

// 匯出 Jupyter 圖表
function exportJupyterCharts() {
    const container = document.getElementById('jupyterChartsContainer');
    if (!container || container.children.length === 0) {
        showAlert('沒有可匯出的圖表', 'warning');
        return;
    }
    
    // 這裡可以實作圖表匯出功能
    showAlert('圖表匯出功能開發中', 'info');
}

// 顯示結果資料
function displayResultData(resultData) {
    const container = document.getElementById('dataPreview');
    if (!container) return;
    
    if (resultData && resultData.length > 0) {
        const table = document.getElementById('dataTable');
        if (table) {
            // 生成表格
            let html = '<thead class="table-dark sticky-top"><tr>';
            const columns = Object.keys(resultData[0]);
            columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            resultData.slice(0, 10).forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    html += `<td>${row[col]}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody>';
            
            table.innerHTML = html;
            container.style.display = 'block';
            document.getElementById('dataInfo').textContent = `顯示 ${resultData.length} 筆資料的前 10 筆`;
        }
    }
}

// 顯示策略資訊
function displayStrategyInfo(strategyInfo) {
    const container = document.getElementById('chartsContainer');
    if (!container) return;
    
    let html = '<div class="row mb-3">';
    html += '<div class="col-12"><h6>策略資訊</h6></div>';
    
    if (strategyInfo.strategy_name) {
        html += `<div class="col-md-6"><div class="card"><div class="card-body">`;
        html += `<h6>策略名稱</h6><p>${strategyInfo.strategy_name}</p></div></div></div>`;
    }
    
    if (strategyInfo.strategy_description) {
        html += `<div class="col-md-6"><div class="card"><div class="card-body">`;
        html += `<h6>策略描述</h6><p>${strategyInfo.strategy_description}</p></div></div></div>`;
    }
    
    html += '</div>';
    container.insertAdjacentHTML('beforeend', html);
}

// 分析策略類型
async function analyzeStrategyType() {
    if (!isJupyterMode) {
        showAlert('此功能僅適用於 Jupyter 模式', 'warning');
        return;
    }
    
    // 收集所有單元格的程式碼
    let allCode = '';
    jupyterCells.forEach(cellId => {
        const editor = jupyterCellEditors[cellId];
        if (editor) {
            allCode += editor.getValue() + '\n\n';
        }
    });
    
    if (!allCode.trim()) {
        showAlert('請先在單元格中輸入策略程式碼', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/jupyter/analyze-strategy', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                code: allCode
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            const strategyType = data.strategy_type;
            const analysis = data.analysis;
            
            // 顯示分析結果
            let resultHtml = `
                <div class="alert alert-info">
                    <h6><i class="fas fa-search"></i> 策略類型分析結果</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>策略類型：</strong>
                            <span class="badge bg-primary">${getStrategyTypeDisplayName(strategyType)}</span>
                        </div>
                        <div class="col-md-6">
                            <strong>分析狀態：</strong>
                            <span class="badge bg-success">${analysis.description}</span>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>狀態機函數：</strong>
                            <span class="badge ${analysis.has_should_entry ? 'bg-success' : 'bg-secondary'}">
                                ${analysis.has_should_entry ? '✓ 找到 should_entry' : '✗ 未找到 should_entry'}
                            </span>
                        </div>
                        <div class="col-md-6">
                            <strong>向量化函數：</strong>
                            <span class="badge ${analysis.has_calculate_entry_signals ? 'bg-success' : 'bg-secondary'}">
                                ${analysis.has_calculate_entry_signals ? '✓ 找到 calculate_entry_signals' : '✗ 未找到 calculate_entry_signals'}
                            </span>
                        </div>
                    </div>
                    <hr>
                    <div>
                        <strong>發現的函數：</strong>
                        <div class="mt-2">
                            ${analysis.functions_found.length > 0 ? 
                                analysis.functions_found.map(func => `<span class="badge bg-light text-dark me-1">${func}</span>`).join('') :
                                '<span class="text-muted">未發現任何函數</span>'
                            }
                        </div>
                    </div>
                </div>
            `;
            
            // 在最後一個單元格後新增分析結果單元格
            const analysisCell = document.createElement('div');
            analysisCell.className = 'jupyter-cell analysis-result mb-3';
            analysisCell.innerHTML = `
                <div class="jupyter-input">
                    <div class="cell-header">
                        <span class="cell-number">分析結果</span>
                        <div class="cell-actions">
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.parentElement.parentElement.remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="jupyter-output" style="display: block;">
                        ${resultHtml}
                    </div>
                </div>
            `;
            
            document.getElementById('jupyterCells').appendChild(analysisCell);
            
            showAlert(`策略類型分析完成：${getStrategyTypeDisplayName(strategyType)}`, 'success');
        } else {
            showAlert(data.error || '分析策略類型失敗', 'danger');
        }
    } catch (error) {
        console.error('分析策略類型失敗:', error);
        showAlert('分析策略類型失敗', 'danger');
    }
}

// 取得策略類型顯示名稱
function getStrategyTypeDisplayName(strategyType) {
    const typeNames = {
        'state_machine': '狀態機策略',
        'vectorized': '向量化策略',
        'mixed': '混合式策略',
        'unknown': '未知類型'
    };
    return typeNames[strategyType] || strategyType;
}



// 儲存 Jupyter 策略到後端
async function saveJupyterStrategy() {
    if (!currentStrategyId) {
        showAlert('請先選擇或建立策略', 'warning');
        return;
    }
    
    // 合併所有 cell 程式碼
    let code = '';
    const cells = [];
    
    jupyterCells.forEach(cellId => {
        const editor = jupyterCellEditors[cellId];
        if (editor) {
            const cellCode = editor.getValue();
            code += cellCode + '\n\n';
            
            // 收集 cell 結構資訊
            const outputContainer = document.getElementById(`output_${cellId}`);
            cells.push({
                id: cellId,
                code: cellCode,
                outputs: outputContainer ? outputContainer.innerHTML : '',
                metadata: {
                    cell_type: 'code',
                    execution_count: 1
                }
            });
        }
    });
    code = code.trim();
    
    // 設定到全域變數，讓 saveStrategy 能正確取得
    window.jupyterMergedCode = code;
    
    try {
        // 1. 儲存 cell 結構到 Jupyter notebook API
        const notebookResponse = await fetch(`/api/jupyter/notebook/${currentStrategyId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                cells: cells
            })
        });
        
        const notebookResult = await notebookResponse.json();
        if (notebookResult.status === 'success') {
            console.log('Jupyter notebook 結構儲存成功');
        } else {
            console.warn('Jupyter notebook 結構儲存失敗:', notebookResult.error);
        }
        
        // 2. 儲存合併後的程式碼到策略 API
        await saveStrategy();
        
        showAlert('Jupyter 策略儲存成功', 'success');
        
    } catch (error) {
        console.error('儲存 Jupyter 策略失敗:', error);
        showAlert('儲存 Jupyter 策略失敗', 'danger');
    }
}

// 儲存 Jupyter 筆記本（本地+後端）
async function saveJupyterNotebook() {
    if (!currentStrategyId) {
        showAlert('請先選擇或建立策略', 'warning');
        return;
    }
    const notebook = {
        cells: jupyterCells.map(cellId => {
            const editor = jupyterCellEditors[cellId];
            return {
                id: cellId,
                code: editor ? editor.getValue() : '',
                outputs: document.getElementById(`output_${cellId}`).innerHTML
            };
        }),
        metadata: {
            created: new Date().toISOString(),
            total_cells: jupyterCells.length
        }
    };
    // 儲存到 localStorage
    localStorage.setItem('jupyter_notebook', JSON.stringify(notebook));
    // 同步儲存到後端
    try {
        const response = await fetch(`/api/jupyter/notebook/${currentStrategyId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cells: notebook.cells })
        });
        const data = await response.json();
        if (data.status === 'success') {
            showAlert('筆記本已儲存（本地+後端）', 'success');
        } else {
            showAlert('本地已儲存，但後端儲存失敗: ' + (data.error || '未知錯誤'), 'warning');
        }
    } catch (error) {
        showAlert('本地已儲存，但後端儲存失敗: ' + error, 'warning');
    }
}

// 匯出 Jupyter 筆記本
function exportJupyterNotebook() {
    const notebook = {
        cells: jupyterCells.map(cellId => {
            const editor = jupyterCellEditors[cellId];
            return {
                id: cellId,
                code: editor ? editor.getValue() : '',
                outputs: document.getElementById(`output_${cellId}`).innerHTML
            };
        }),
        metadata: {
            created: new Date().toISOString(),
            total_cells: jupyterCells.length
        }
    };
    
    // 下載 JSON 檔案
    const blob = new Blob([JSON.stringify(notebook, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `jupyter_notebook_${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showAlert('筆記本匯出成功', 'success');
}

// 載入 Jupyter 筆記本（本地）
function loadJupyterNotebook(notebookData) {
    // 清除現有單元格
    jupyterCells.forEach(cellId => {
        const editor = jupyterCellEditors[cellId];
        if (editor) {
            editor.toTextArea();
            delete jupyterCellEditors[cellId];
        }
    });
    jupyterCells = [];
    document.getElementById('jupyterCells').innerHTML = '';
    jupyterCellCounter = 0; // <--- 新增：每次載入歸零
    // 載入筆記本單元格
    if (notebookData.cells && notebookData.cells.length > 0) {
        notebookData.cells.forEach(cellData => {
            const cellId = addJupyterCell(cellData.code);
            
            // 恢復輸出
            if (cellData.outputs) {
                const outputContainer = document.getElementById(`output_${cellId}`);
                outputContainer.innerHTML = cellData.outputs;
            }
        });
    } else {
        addJupyterCell('');
    }
    showAlert('筆記本載入成功', 'success');
}

// 從後端載入 Jupyter notebook 結構
function loadJupyterNotebookFromBackend(notebookData) {
    // 清除現有單元格
    jupyterCells.forEach(cellId => {
        const editor = jupyterCellEditors[cellId];
        if (editor) {
            editor.toTextArea();
            delete jupyterCellEditors[cellId];
        }
    });
    jupyterCells = [];
    document.getElementById('jupyterCells').innerHTML = '';
    jupyterCellCounter = 0;
    
    // 載入筆記本單元格
    if (notebookData.cells && notebookData.cells.length > 0) {
        notebookData.cells.forEach(cellData => {
            const cellId = addJupyterCell(cellData.code || '');
            
            // 恢復輸出
            if (cellData.outputs) {
                const outputContainer = document.getElementById(`output_${cellId}`);
                if (outputContainer) {
                    outputContainer.innerHTML = cellData.outputs;
                }
            }
        });
    } else {
        addJupyterCell('');
    }
    
    console.log(`從後端載入 Jupyter notebook，共 ${notebookData.cells ? notebookData.cells.length : 0} 個 cell`);
}

// 載入策略程式碼到 Jupyter 編輯器
function loadStrategyCodeToJupyter(strategyCode, strategyType) {
    // 清除現有單元格
    jupyterCells.forEach(cellId => {
        const editor = jupyterCellEditors[cellId];
        if (editor) {
            editor.toTextArea();
            delete jupyterCellEditors[cellId];
        }
    });
    jupyterCells = [];
    document.getElementById('jupyterCells').innerHTML = '';
    jupyterCellCounter = 0; // <--- 每次載入歸零
    if (strategyCode && strategyCode.trim()) {
        // 支援多 cell 載入：以 # %% 或 # <cell> 為分隔符
        let cellBlocks = strategyCode.split(/(?:^|\n)\s*# ?(?:%%|<cell>)(?:\s|$)/g);
        cellBlocks = cellBlocks.map(block => block.trim()).filter(block => block.length > 0);
        if (cellBlocks.length > 0) {
            cellBlocks.forEach(code => addJupyterCell(code));
            showAlert(cellBlocks.length > 1 ? '多單元格策略程式碼已載入到 Jupyter 編輯器' : '策略程式碼已載入到 Jupyter 編輯器', 'success');
        } else {
            // 若 code 有內容但沒分隔符，直接建立一個 cell 並顯示內容
            addJupyterCell(strategyCode);
            showAlert('策略程式碼已載入到 Jupyter 編輯器', 'success');
        }
    } else {
        // 如果沒有程式碼，載入對應的模板
        loadJupyterStrategyTemplate(strategyType);
    }
}

// 載入 Jupyter 策略模板
function loadJupyterStrategyTemplate(strategyType) {
    // 清除現有單元格
    jupyterCells.forEach(cellId => {
        const editor = jupyterCellEditors[cellId];
        if (editor) {
            editor.toTextArea();
            delete jupyterCellEditors[cellId];
        }
    });
    jupyterCells = [];
    document.getElementById('jupyterCells').innerHTML = '';
    jupyterCellCounter = 0; // <--- 新增：每次載入歸零
    // 根據策略類型載入對應的模板
    switch (strategyType) {
        case 'vectorized':
            loadVectorizedJupyterTemplate();
            break;
        case 'state_machine':
            loadStateMachineJupyterTemplate();
            break;
        case 'hybrid':
            loadHybridJupyterTemplate();
            break;
        case 'analysis':
        default:
            loadAnalysisJupyterTemplate();
            break;
    }
    // 若載入後 cell 數為 0，強制建立一個空 cell
    if (jupyterCells.length === 0) {
        addJupyterCell('');
    }
}

// 載入向量化策略模板
function loadVectorizedJupyterTemplate() {
    addJupyterCell(`# 向量化策略模板
# 這個策略使用向量化計算，一次性處理所有資料

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt

print("向量化策略模板載入完成！")`);
    
    addJupyterCell(`# 載入或生成股票資料
# 這裡可以載入實際的股票資料或使用範例資料

# 生成範例股票資料
dates = pd.date_range('2024-01-01', '2024-12-31', freq='D')
np.random.seed(42)

close_prices = 100 + np.cumsum(np.random.normal(0, 0.5, len(dates)))
df = pd.DataFrame({
    'date': dates,
    'close': close_prices,
    'volume': np.random.uniform(1000000, 5000000, len(dates))
})

print(f"載入 {len(df)} 筆股票資料")
df.head()`);
    
    addJupyterCell(`# 計算技術指標（向量化）
# 一次性計算所有技術指標

df['ma5'] = df['close'].rolling(5).mean()
df['ma20'] = df['close'].rolling(20).mean()
df['ma60'] = df['close'].rolling(60).mean()

# 計算布林通道
df['bb_upper'] = df['ma20'] + 2 * df['close'].rolling(20).std()
df['bb_lower'] = df['ma20'] - 2 * df['close'].rolling(20).std()

# 計算 RSI
delta = df['close'].diff()
gain = (delta.where(delta > 0, 0)).rolling(window=14).mean()
loss = (-delta.where(delta < 0, 0)).rolling(window=14).mean()
rs = gain / loss
df['rsi'] = 100 - (100 / (1 + rs))

print("技術指標計算完成")
df.tail()`);
    
    addJupyterCell(`# 向量化信號生成
# 一次性生成所有交易信號

# 移動平均交叉信號
df['ma_cross_signal'] = np.where(
    (df['ma5'] > df['ma20']) & (df['ma5'].shift(1) <= df['ma20'].shift(1)), 
    1,  # 買入信號
    np.where(
        (df['ma5'] < df['ma20']) & (df['ma5'].shift(1) >= df['ma20'].shift(1)), 
        -1,  # 賣出信號
        0  # 無信號
    )
)

# RSI 超買超賣信號
df['rsi_signal'] = np.where(
    df['rsi'] < 30, 1,  # RSI 超賣，買入信號
    np.where(df['rsi'] > 70, -1, 0)  # RSI 超買，賣出信號
)

# 布林通道突破信號
df['bb_signal'] = np.where(
    df['close'] < df['bb_lower'], 1,  # 價格突破下軌，買入信號
    np.where(df['close'] > df['bb_upper'], -1, 0)  # 價格突破上軌，賣出信號
)

# 綜合信號
df['combined_signal'] = df['ma_cross_signal'] + df['rsi_signal'] + df['bb_signal']

print("信號生成完成")
print(f"買入信號數量: {(df['combined_signal'] > 0).sum()}")
print(f"賣出信號數量: {(df['combined_signal'] < 0).sum()}")
df[['date', 'close', 'ma_cross_signal', 'rsi_signal', 'bb_signal', 'combined_signal']].tail()`);
    
    addJupyterCell(`# 策略回測（向量化）
# 計算策略報酬

# 計算日報酬率
df['daily_return'] = df['close'].pct_change()

# 策略報酬率（假設信號為 1 時買入，-1 時賣出）
df['strategy_return'] = df['combined_signal'].shift(1) * df['daily_return']

# 累積報酬率
df['cumulative_return'] = (1 + df['daily_return']).cumprod()
df['strategy_cumulative_return'] = (1 + df['strategy_return']).cumprod()

# 計算策略績效指標
total_return = df['strategy_cumulative_return'].iloc[-1] - 1
annual_return = (1 + total_return) ** (252 / len(df)) - 1
volatility = df['strategy_return'].std() * np.sqrt(252)
sharpe_ratio = annual_return / volatility if volatility > 0 else 0

print(f"總報酬率: {total_return:.2%}")
print(f"年化報酬率: {annual_return:.2%}")
print(f"年化波動率: {volatility:.2%}")
print(f"夏普比率: {sharpe_ratio:.2f}")`);
    
    addJupyterCell(`# 繪製策略績效圖
plt.figure(figsize=(15, 10))

# 子圖 1: 股價和移動平均線
plt.subplot(3, 1, 1)
plt.plot(df['date'], df['close'], label='收盤價', linewidth=2)
plt.plot(df['date'], df['ma5'], label='5日均線', alpha=0.7)
plt.plot(df['date'], df['ma20'], label='20日均線', alpha=0.7)
plt.plot(df['date'], df['ma60'], label='60日均線', alpha=0.7)

# 標記買賣信號
buy_signals = df[df['combined_signal'] > 0]
sell_signals = df[df['combined_signal'] < 0]

plt.scatter(buy_signals['date'], buy_signals['close'], 
           color='green', marker='^', s=100, label='買入信號', alpha=0.7)
plt.scatter(sell_signals['date'], sell_signals['close'], 
           color='red', marker='v', s=100, label='賣出信號', alpha=0.7)

plt.title('向量化策略 - 股價與信號', fontsize=14)
plt.ylabel('價格')
plt.legend()
plt.grid(True, alpha=0.3)

# 子圖 2: RSI 指標
plt.subplot(3, 1, 2)
plt.plot(df['date'], df['rsi'], label='RSI', linewidth=2)
plt.axhline(y=70, color='r', linestyle='--', alpha=0.7, label='超買線')
plt.axhline(y=30, color='g', linestyle='--', alpha=0.7, label='超賣線')
plt.title('RSI 指標', fontsize=14)
plt.ylabel('RSI')
plt.legend()
plt.grid(True, alpha=0.3)

# 子圖 3: 累積報酬率
plt.subplot(3, 1, 3)
plt.plot(df['date'], df['cumulative_return'], label='買入持有', linewidth=2)
plt.plot(df['date'], df['strategy_cumulative_return'], label='策略報酬', linewidth=2)
plt.title('策略績效比較', fontsize=14)
plt.xlabel('日期')
plt.ylabel('累積報酬率')
plt.legend()
plt.grid(True, alpha=0.3)

plt.tight_layout()
plt.show()`);
}

// 載入狀態機策略模板
function loadStateMachineJupyterTemplate() {
    addJupyterCell(`# 狀態機策略模板
# 這個策略使用狀態機模式，逐筆處理資料並追蹤狀態

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from enum import Enum

class PositionState(Enum):
    CASH = "現金"
    LONG = "做多"
    SHORT = "做空"

print("狀態機策略模板載入完成！")`);
    
    addJupyterCell(`# 載入或生成股票資料
# 這裡可以載入實際的股票資料或使用範例資料

# 生成範例股票資料
dates = pd.date_range('2024-01-01', '2024-12-31', freq='D')
np.random.seed(42)

close_prices = 100 + np.cumsum(np.random.normal(0, 0.5, len(dates)))
df = pd.DataFrame({
    'date': dates,
    'close': close_prices,
    'volume': np.random.uniform(1000000, 5000000, len(dates))
})

print(f"載入 {len(df)} 筆股票資料")
df.head()`);
    
    addJupyterCell(`# 計算技術指標
df['ma5'] = df['close'].rolling(5).mean()
df['ma20'] = df['close'].rolling(20).mean()
df['ma60'] = df['close'].rolling(60).mean()

# 計算 RSI
delta = df['close'].diff()
gain = (delta.where(delta > 0, 0)).rolling(window=14).mean()
loss = (-delta.where(delta < 0, 0)).rolling(window=14).mean()
rs = gain / loss
df['rsi'] = 100 - (100 / (1 + rs))

print("技術指標計算完成")
df.tail()`);
    
    addJupyterCell(`# 狀態機策略邏輯
class StateMachineStrategy:
    def __init__(self):
        self.position = PositionState.CASH
        self.entry_price = 0
        self.entry_date = None
        self.trades = []
        self.current_capital = 100000  # 初始資金 10 萬
        
    def should_entry(self, row):
        """判斷是否應該進場"""
        if self.position != PositionState.CASH:
            return False
            
        # 進場條件：5日均線 > 20日均線 且 RSI < 70
        return (row['ma5'] > row['ma20'] and 
                row['rsi'] < 70 and 
                row['ma5'] > row['ma5'].shift(1))  # 均線向上
    
    def should_exit(self, row):
        """判斷是否應該出場"""
        if self.position == PositionState.CASH:
            return False
            
        # 出場條件：5日均線 < 20日均線 或 RSI > 80
        return (row['ma5'] < row['ma20'] or 
                row['rsi'] > 80)
    
    def execute_trade(self, row, action):
        """執行交易"""
        if action == 'entry' and self.position == PositionState.CASH:
            self.position = PositionState.LONG
            self.entry_price = row['close']
            self.entry_date = row['date']
            print(f"買入: {row['date'].strftime('%Y-%m-%d')} 價格: {row['close']:.2f}")
            
        elif action == 'exit' and self.position == PositionState.LONG:
            exit_price = row['close']
            profit_loss = exit_price - self.entry_price
            profit_rate = (profit_loss / self.entry_price) * 100
            
            self.trades.append({
                'entry_date': self.entry_date,
                'exit_date': row['date'],
                'entry_price': self.entry_price,
                'exit_price': exit_price,
                'profit_loss': profit_loss,
                'profit_rate': profit_rate
            })
            
            self.position = PositionState.CASH
            self.entry_price = 0
            self.entry_date = None
            
            print(f"賣出: {row['date'].strftime('%Y-%m-%d')} 價格: {exit_price:.2f} 損益: {profit_loss:.2f} ({profit_rate:.2f}%)")

# 建立策略實例
strategy = StateMachineStrategy()
print("狀態機策略實例建立完成")`);
    
    addJupyterCell(`# 執行狀態機策略
# 逐筆處理資料

for index, row in df.iterrows():
    if strategy.should_entry(row):
        strategy.execute_trade(row, 'entry')
    elif strategy.should_exit(row):
        strategy.execute_trade(row, 'exit')

# 如果最後還有持倉，強制平倉
if strategy.position == PositionState.LONG:
    last_row = df.iloc[-1]
    strategy.execute_trade(last_row, 'exit')

print(f"策略執行完成，共執行 {len(strategy.trades)} 筆交易")`);
    
    addJupyterCell(`# 分析交易結果
if strategy.trades:
    trades_df = pd.DataFrame(strategy.trades)
    
    print("交易記錄:")
    print(trades_df)
    
    # 計算績效指標
    total_trades = len(trades_df)
    winning_trades = len(trades_df[trades_df['profit_loss'] > 0])
    losing_trades = len(trades_df[trades_df['profit_loss'] < 0])
    
    win_rate = (winning_trades / total_trades) * 100 if total_trades > 0 else 0
    total_profit = trades_df['profit_loss'].sum()
    avg_profit = trades_df['profit_loss'].mean()
    max_profit = trades_df['profit_loss'].max()
    max_loss = trades_df['profit_loss'].min()
    
    print(f"\\n績效統計:")
    print(f"總交易次數: {total_trades}")
    print(f"獲利交易: {winning_trades}")
    print(f"虧損交易: {losing_trades}")
    print(f"勝率: {win_rate:.2f}%")
    print(f"總損益: {total_profit:.2f}")
    print(f"平均損益: {avg_profit:.2f}")
    print(f"最大獲利: {max_profit:.2f}")
    print(f"最大虧損: {max_loss:.2f}")
    
    # 繪製交易結果
    plt.figure(figsize=(15, 10))
    
    # 子圖 1: 股價和交易點位
    plt.subplot(2, 1, 1)
    plt.plot(df['date'], df['close'], label='收盤價', linewidth=2)
    
    # 標記買賣點位
    for trade in strategy.trades:
        plt.scatter(trade['entry_date'], trade['entry_price'], 
                   color='green', marker='^', s=100, alpha=0.7)
        plt.scatter(trade['exit_date'], trade['exit_price'], 
                   color='red', marker='v', s=100, alpha=0.7)
    
    plt.title('狀態機策略 - 交易點位', fontsize=14)
    plt.ylabel('價格')
    plt.legend()
    plt.grid(True, alpha=0.3)
    
    # 子圖 2: 累積損益
    plt.subplot(2, 1, 2)
    cumulative_profit = trades_df['profit_loss'].cumsum()
    plt.plot(trades_df['exit_date'], cumulative_profit, 
             label='累積損益', linewidth=2, marker='o')
    plt.title('累積損益曲線', fontsize=14)
    plt.xlabel('日期')
    plt.ylabel('累積損益')
    plt.legend()
    plt.grid(True, alpha=0.3)
    
    plt.tight_layout()
    plt.show()
    
else:
    print("沒有執行任何交易")`);
}

// 載入混合策略模板
function loadHybridJupyterTemplate() {
    addJupyterCell(`# 混合策略模板
# 結合向量化和狀態機的優勢

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from enum import Enum

class PositionState(Enum):
    CASH = "現金"
    LONG = "做多"
    SHORT = "做空"

print("混合策略模板載入完成！")`);
    
    addJupyterCell(`# 載入或生成股票資料
dates = pd.date_range('2024-01-01', '2024-12-31', freq='D')
np.random.seed(42)

close_prices = 100 + np.cumsum(np.random.normal(0, 0.5, len(dates)))
df = pd.DataFrame({
    'date': dates,
    'close': close_prices,
    'volume': np.random.uniform(1000000, 5000000, len(dates))
})

print(f"載入 {len(df)} 筆股票資料")
df.head()`);
    
    addJupyterCell(`# 向量化計算技術指標
df['ma5'] = df['close'].rolling(5).mean()
df['ma20'] = df['close'].rolling(20).mean()
df['ma60'] = df['close'].rolling(60).mean()

# 計算布林通道
df['bb_upper'] = df['ma20'] + 2 * df['close'].rolling(20).std()
df['bb_lower'] = df['ma20'] - 2 * df['close'].rolling(20).std()

# 計算 RSI
delta = df['close'].diff()
gain = (delta.where(delta > 0, 0)).rolling(window=14).mean()
loss = (-delta.where(delta < 0, 0)).rolling(window=14).mean()
rs = gain / loss
df['rsi'] = 100 - (100 / (1 + rs))

# 計算 MACD
exp1 = df['close'].ewm(span=12).mean()
exp2 = df['close'].ewm(span=26).mean()
df['macd'] = exp1 - exp2
df['macd_signal'] = df['macd'].ewm(span=9).mean()
df['macd_histogram'] = df['macd'] - df['macd_signal']

print("技術指標計算完成")
df.tail()`);
    
    addJupyterCell(`# 向量化信號生成
# 使用向量化計算生成初步信號

# 移動平均交叉信號
df['ma_cross_signal'] = np.where(
    (df['ma5'] > df['ma20']) & (df['ma5'].shift(1) <= df['ma20'].shift(1)), 
    1,  # 買入信號
    np.where(
        (df['ma5'] < df['ma20']) & (df['ma5'].shift(1) >= df['ma20'].shift(1)), 
        -1,  # 賣出信號
        0  # 無信號
    )
)

# RSI 信號
df['rsi_signal'] = np.where(
    df['rsi'] < 30, 1,  # RSI 超賣，買入信號
    np.where(df['rsi'] > 70, -1, 0)  # RSI 超買，賣出信號
)

# MACD 信號
df['macd_signal'] = np.where(
    (df['macd'] > df['macd_signal']) & (df['macd'].shift(1) <= df['macd_signal'].shift(1)), 
    1,  # MACD 金叉，買入信號
    np.where(
        (df['macd'] < df['macd_signal']) & (df['macd'].shift(1) >= df['macd_signal'].shift(1)), 
        -1,  # MACD 死叉，賣出信號
        0  # 無信號
    )
)

# 綜合信號（向量化）
df['vector_signal'] = df['ma_cross_signal'] + df['rsi_signal'] + df['macd_signal']

print("向量化信號生成完成")
print(f"向量化買入信號: {(df['vector_signal'] > 0).sum()}")
print(f"向量化賣出信號: {(df['vector_signal'] < 0).sum()}")`);
    
    addJupyterCell(`# 狀態機信號過濾
# 使用狀態機邏輯過濾和優化向量化信號

class HybridStrategy:
    def __init__(self):
        self.position = PositionState.CASH
        self.entry_price = 0
        self.entry_date = None
        self.trades = []
        
    def should_entry(self, row):
        """判斷是否應該進場（結合向量化和狀態機邏輯）"""
        if self.position != PositionState.CASH:
            return False
            
        # 向量化信號條件
        vector_condition = row['vector_signal'] > 0
        
        # 狀態機確認條件
        state_condition = (
            row['ma5'] > row['ma20'] and  # 均線多頭排列
            row['rsi'] < 70 and  # RSI 未超買
            row['close'] > row['bb_lower'] and  # 價格在布林通道內
            row['macd_histogram'] > 0  # MACD 柱狀圖為正
        )
        
        return vector_condition and state_condition
    
    def should_exit(self, row):
        """判斷是否應該出場"""
        if self.position == PositionState.CASH:
            return False
            
        # 向量化信號條件
        vector_condition = row['vector_signal'] < 0
        
        # 狀態機條件
        state_condition = (
            row['ma5'] < row['ma20'] or  # 均線空頭排列
            row['rsi'] > 80 or  # RSI 超買
            row['close'] < row['bb_lower'] or  # 價格跌破布林下軌
            row['macd_histogram'] < 0  # MACD 柱狀圖為負
        )
        
        return vector_condition or state_condition
    
    def execute_trade(self, row, action):
        """執行交易"""
        if action == 'entry' and self.position == PositionState.CASH:
            self.position = PositionState.LONG
            self.entry_price = row['close']
            self.entry_date = row['date']
            print(f"買入: {row['date'].strftime('%Y-%m-%d')} 價格: {row['close']:.2f}")
            
        elif action == 'exit' and self.position == PositionState.LONG:
            exit_price = row['close']
            profit_loss = exit_price - self.entry_price
            profit_rate = (profit_loss / self.entry_price) * 100
            
            self.trades.append({
                'entry_date': self.entry_date,
                'exit_date': row['date'],
                'entry_price': self.entry_price,
                'exit_price': exit_price,
                'profit_loss': profit_loss,
                'profit_rate': profit_rate
            })
            
            self.position = PositionState.CASH
            self.entry_price = 0
            self.entry_date = None
            
            print(f"賣出: {row['date'].strftime('%Y-%m-%d')} 價格: {exit_price:.2f} 損益: {profit_loss:.2f} ({profit_rate:.2f}%)")

# 建立混合策略實例
hybrid_strategy = HybridStrategy()
print("混合策略實例建立完成")`);
    
    addJupyterCell(`# 執行混合策略
# 結合向量化和狀態機的執行邏輯

for index, row in df.iterrows():
    if hybrid_strategy.should_entry(row):
        hybrid_strategy.execute_trade(row, 'entry')
    elif hybrid_strategy.should_exit(row):
        hybrid_strategy.execute_trade(row, 'exit')

# 如果最後還有持倉，強制平倉
if hybrid_strategy.position == PositionState.LONG:
    last_row = df.iloc[-1]
    hybrid_strategy.execute_trade(last_row, 'exit')

print(f"混合策略執行完成，共執行 {len(hybrid_strategy.trades)} 筆交易")`);
    
    addJupyterCell(`# 混合策略績效分析
if hybrid_strategy.trades:
    trades_df = pd.DataFrame(hybrid_strategy.trades)
    
    print("交易記錄:")
    print(trades_df)
    
    # 計算績效指標
    total_trades = len(trades_df)
    winning_trades = len(trades_df[trades_df['profit_loss'] > 0])
    losing_trades = len(trades_df[trades_df['profit_loss'] < 0])
    
    win_rate = (winning_trades / total_trades) * 100 if total_trades > 0 else 0
    total_profit = trades_df['profit_loss'].sum()
    avg_profit = trades_df['profit_loss'].mean()
    max_profit = trades_df['profit_loss'].max()
    max_loss = trades_df['profit_loss'].min()
    
    print(f"\\n混合策略績效統計:")
    print(f"總交易次數: {total_trades}")
    print(f"獲利交易: {winning_trades}")
    print(f"虧損交易: {losing_trades}")
    print(f"勝率: {win_rate:.2f}%")
    print(f"總損益: {total_profit:.2f}")
    print(f"平均損益: {avg_profit:.2f}")
    print(f"最大獲利: {max_profit:.2f}")
    print(f"最大虧損: {max_loss:.2f}")
    
    # 繪製混合策略結果
    plt.figure(figsize=(15, 12))
    
    # 子圖 1: 股價和交易點位
    plt.subplot(3, 1, 1)
    plt.plot(df['date'], df['close'], label='收盤價', linewidth=2)
    plt.plot(df['date'], df['ma5'], label='5日均線', alpha=0.7)
    plt.plot(df['date'], df['ma20'], label='20日均線', alpha=0.7)
    
    # 標記買賣點位
    for trade in hybrid_strategy.trades:
        plt.scatter(trade['entry_date'], trade['entry_price'], 
                   color='green', marker='^', s=100, alpha=0.7)
        plt.scatter(trade['exit_date'], trade['exit_price'], 
                   color='red', marker='v', s=100, alpha=0.7)
    
    plt.title('混合策略 - 股價與交易點位', fontsize=14)
    plt.ylabel('價格')
    plt.legend()
    plt.grid(True, alpha=0.3)
    
    # 子圖 2: RSI 指標
    plt.subplot(3, 1, 2)
    plt.plot(df['date'], df['rsi'], label='RSI', linewidth=2)
    plt.axhline(y=70, color='r', linestyle='--', alpha=0.7, label='超買線')
    plt.axhline(y=30, color='g', linestyle='--', alpha=0.7, label='超賣線')
    plt.title('RSI 指標', fontsize=14)
    plt.ylabel('RSI')
    plt.legend()
    plt.grid(True, alpha=0.3)
    
    # 子圖 3: 累積損益
    plt.subplot(3, 1, 3)
    cumulative_profit = trades_df['profit_loss'].cumsum()
    plt.plot(trades_df['exit_date'], cumulative_profit, 
             label='累積損益', linewidth=2, marker='o')
    plt.title('混合策略累積損益', fontsize=14)
    plt.xlabel('日期')
    plt.ylabel('累積損益')
    plt.legend()
    plt.grid(True, alpha=0.3)
    
    plt.tight_layout()
    plt.show()
    
else:
    print("沒有執行任何交易")`);
}

// 載入分析模式模板
function loadAnalysisJupyterTemplate() {
    addJupyterCell(`# 資料分析模式模板
# 純資料分析，無交易邏輯

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

print("資料分析模式模板載入完成！")`);
    
    addJupyterCell(`# 載入或生成股票資料
dates = pd.date_range('2024-01-01', '2024-12-31', freq='D')
np.random.seed(42)

close_prices = 100 + np.cumsum(np.random.normal(0, 0.5, len(dates)))
df = pd.DataFrame({
    'date': dates,
    'close': close_prices,
    'volume': np.random.uniform(1000000, 5000000, len(dates))
})

print(f"載入 {len(df)} 筆股票資料")
df.head()`);
    
    addJupyterCell(`# 基本統計分析
print("基本統計資訊:")
print(df.describe())

print("\\n資料形狀:", df.shape)
print("資料類型:")
print(df.dtypes)

print("\\n前 5 筆資料:")
print(df.head())

print("\\n後 5 筆資料:")
print(df.tail())`);
    
    addJupyterCell(`# 計算技術指標
# 移動平均線
df['ma5'] = df['close'].rolling(5).mean()
df['ma10'] = df['close'].rolling(10).mean()
df['ma20'] = df['close'].rolling(20).mean()
df['ma60'] = df['close'].rolling(60).mean()

# 日報酬率
df['daily_return'] = df['close'].pct_change()

# 波動率（20日滾動）
df['volatility'] = df['daily_return'].rolling(20).std() * np.sqrt(252)

# RSI
delta = df['close'].diff()
gain = (delta.where(delta > 0, 0)).rolling(window=14).mean()
loss = (-delta.where(delta < 0, 0)).rolling(window=14).mean()
rs = gain / loss
df['rsi'] = 100 - (100 / (1 + rs))

# 布林通道
df['bb_upper'] = df['ma20'] + 2 * df['close'].rolling(20).std()
df['bb_lower'] = df['ma20'] - 2 * df['close'].rolling(20).std()
df['bb_width'] = (df['bb_upper'] - df['bb_lower']) / df['ma20']

print("技術指標計算完成")
df.tail()`);
    
    addJupyterCell(`# 價格走勢分析
plt.figure(figsize=(15, 12))

# 子圖 1: 股價和移動平均線
plt.subplot(3, 1, 1)
plt.plot(df['date'], df['close'], label='收盤價', linewidth=2)
plt.plot(df['date'], df['ma5'], label='5日均線', alpha=0.7)
plt.plot(df['date'], df['ma10'], label='10日均線', alpha=0.7)
plt.plot(df['date'], df['ma20'], label='20日均線', alpha=0.7)
plt.plot(df['date'], df['ma60'], label='60日均線', alpha=0.7)

plt.title('股票價格與移動平均線', fontsize=14)
plt.ylabel('價格')
plt.legend()
plt.grid(True, alpha=0.3)

# 子圖 2: 布林通道
plt.subplot(3, 1, 2)
plt.plot(df['date'], df['close'], label='收盤價', linewidth=2)
plt.plot(df['date'], df['bb_upper'], label='布林上軌', linestyle='--', alpha=0.7)
plt.plot(df['date'], df['bb_lower'], label='布林下軌', linestyle='--', alpha=0.7)
plt.fill_between(df['date'], df['bb_upper'], df['bb_lower'], alpha=0.1)

plt.title('布林通道', fontsize=14)
plt.ylabel('價格')
plt.legend()
plt.grid(True, alpha=0.3)

# 子圖 3: RSI 指標
plt.subplot(3, 1, 3)
plt.plot(df['date'], df['rsi'], label='RSI', linewidth=2)
plt.axhline(y=70, color='r', linestyle='--', alpha=0.7, label='超買線')
plt.axhline(y=30, color='g', linestyle='--', alpha=0.7, label='超賣線')
plt.axhline(y=50, color='gray', linestyle='-', alpha=0.5, label='中位線')

plt.title('RSI 指標', fontsize=14)
plt.xlabel('日期')
plt.ylabel('RSI')
plt.legend()
plt.grid(True, alpha=0.3)

plt.tight_layout()
plt.show()`);
    
    addJupyterCell(`# 報酬率分析
plt.figure(figsize=(15, 10))

# 子圖 1: 日報酬率分布
plt.subplot(2, 2, 1)
plt.hist(df['daily_return'].dropna(), bins=50, alpha=0.7, edgecolor='black')
plt.title('日報酬率分布')
plt.xlabel('日報酬率')
plt.ylabel('頻率')
plt.grid(True, alpha=0.3)

# 子圖 2: 累積報酬率
plt.subplot(2, 2, 2)
cumulative_return = (1 + df['daily_return']).cumprod()
plt.plot(df['date'], cumulative_return, linewidth=2)
plt.title('累積報酬率')
plt.xlabel('日期')
plt.ylabel('累積報酬率')
plt.grid(True, alpha=0.3)

# 子圖 3: 波動率
plt.subplot(2, 2, 3)
plt.plot(df['date'], df['volatility'], linewidth=2)
plt.title('20日滾動波動率')
plt.xlabel('日期')
plt.ylabel('年化波動率')
plt.grid(True, alpha=0.3)

# 子圖 4: 報酬率 vs 波動率散點圖
plt.subplot(2, 2, 4)
plt.scatter(df['volatility'], df['daily_return'], alpha=0.5)
plt.title('報酬率 vs 波動率')
plt.xlabel('波動率')
plt.ylabel('日報酬率')
plt.grid(True, alpha=0.3)

plt.tight_layout()
plt.show()`);
    
    addJupyterCell(`# 統計分析報告
# 計算各種統計指標

# 基本統計
total_return = (df['close'].iloc[-1] / df['close'].iloc[0]) - 1
annual_return = (1 + total_return) ** (252 / len(df)) - 1
volatility = df['daily_return'].std() * np.sqrt(252)
sharpe_ratio = annual_return / volatility if volatility > 0 else 0

# 最大回撤
cumulative_return = (1 + df['daily_return']).cumprod()
rolling_max = cumulative_return.expanding().max()
drawdown = (cumulative_return - rolling_max) / rolling_max
max_drawdown = drawdown.min()

# 偏度和峰度
skewness = df['daily_return'].skew()
kurtosis = df['daily_return'].kurtosis()

print("=== 股票資料統計分析報告 ===")
print(f"分析期間: {df['date'].iloc[0].strftime('%Y-%m-%d')} 至 {df['date'].iloc[-1].strftime('%Y-%m-%d')}")
print(f"資料筆數: {len(df)}")
print(f"\\n=== 報酬率統計 ===")
print(f"總報酬率: {total_return:.2%}")
print(f"年化報酬率: {annual_return:.2%}")
print(f"年化波動率: {volatility:.2%}")
print(f"夏普比率: {sharpe_ratio:.2f}")
print(f"最大回撤: {max_drawdown:.2%}")
print(f"\\n=== 分布統計 ===")
print(f"偏度: {skewness:.2f}")
print(f"峰度: {kurtosis:.2f}")
print(f"\\n=== 價格統計 ===")
print(f"最高價: {df['close'].max():.2f}")
print(f"最低價: {df['close'].min():.2f}")
print(f"平均價: {df['close'].mean():.2f}")
print(f"價格標準差: {df['close'].std():.2f}")`);
}

// 新增：顯示 Jupyter 編輯器的輔助函式
function showJupyterEditor() {
    const jupyterEditor = document.getElementById('jupyterEditor');
    const traditionalEditor = document.getElementById('traditionalEditor');
    const jupyterModeBtn = document.getElementById('jupyterModeBtn');
    if (jupyterEditor && traditionalEditor && jupyterModeBtn) {
        jupyterEditor.style.display = 'block';
        traditionalEditor.style.display = 'none';
        jupyterModeBtn.innerHTML = '<i class="fas fa-file-code"></i> 切換傳統模式';
        jupyterModeBtn.className = 'btn btn-sm btn-outline-primary';
    }
}

// 圖表導航函數
function navigateChartsSection(e) {
    e.preventDefault();
    if (isJupyterMode) {
        location.hash = '#jupyterChartsSection';
        // 顯示 Jupyter 區塊
        const jupyterChartsSection = document.getElementById('jupyterChartsSection');
        if (jupyterChartsSection) jupyterChartsSection.style.display = 'block';
    } else {
        location.hash = '#charts';
        // 顯示傳統圖表區塊
        const chartsSection = document.getElementById('charts');
        if (chartsSection) chartsSection.style.display = 'block';
        const noChartsMessage = document.getElementById('noChartsMessage');
        if (noChartsMessage && chartsSection.querySelectorAll('.chart-wrapper').length === 0) {
            noChartsMessage.style.display = 'block';
        }
    }
}
</script>
{% endblock %}