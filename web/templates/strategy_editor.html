{% extends "base.html" %}

{% block title %}ç­–ç•¥ç·¨è¼¯å™¨{% endblock %}

{% block feature_nav %}
<div class="feature-nav">
    <h4><i class="fas fa-compass"></i> åŠŸèƒ½å€å°èˆª</h4>
    <!-- ç­–ç•¥ç·¨è¼¯å™¨åŠŸèƒ½å€ -->
    <div class="feature-section">
        <h5><i class="fas fa-code"></i> ç­–ç•¥ç·¨è¼¯å™¨</h5>
        <div class="feature-links">
            <a href="/strategy-editor#mainEditor" class="feature-link">ç½®é ‚ğŸ </a>
            <a href="/strategy-editor#code" class="feature-link">ç¨‹å¼ç¢¼âœï¸ </a>
            <a href="/strategy-editor#test" class="feature-link">äº¤æ˜“å ±è¡¨ğŸ’°</a>
            <a href="/strategy-editor#parameters" class="feature-link">ç­–ç•¥åƒæ•¸ğŸ› ï¸</a>
            <a href="#" class="feature-link" id="chartsLink" onclick="navigateChartsSection(event)">åœ–è¡¨åˆ†æğŸ“ˆ</a>
            <!-- <a href="/strategy-editor#preview" class="feature-link">è³‡æ–™é è¦½ğŸ”</a> -->
        </div>
    </div>    
</div>
{% endblock %}

{% block extra_css %}
<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/eclipse.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.css">
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<!-- Sortable.js -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
    .CodeMirror {
        height: 100%;
        font-family: 'Fira Code', 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.5;
    }
    
    .CodeMirror-gutters {
        background-color: #f8f9fa;
        border-right: 1px solid #dee2e6;
    }
    
    .CodeMirror-linenumber {
        color: #6c757d;
    }
    
    .CodeMirror-cursor {
        border-left: 2px solid #007bff;
    }
    
    .CodeMirror-selected {
        background-color: #e3f2fd;
    }
    
    .cm-s-monokai.CodeMirror {
        background-color: #272822;
        color: #f8f8f2;
    }
    
    .cm-s-eclipse.CodeMirror {
        background-color: #ffffff;
        color: #000000;
    }
    
    .cm-s-dracula.CodeMirror {
        background-color: #282a36;
        color: #f8f8f2;
    }
    
    .editor-toolbar {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 8px;
        display: flex;
        gap: 8px;
        align-items: center;
    }
    
    .theme-selector {
        margin-left: auto;
    }
    
    .fullscreen-editor {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 9999;
        background-color: white;
        display: flex;
        flex-direction: column;
    }
    
    .fullscreen-editor .CodeMirror {
        flex: 1;
    }
    
    .fullscreen-toolbar {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .fullscreen-toolbar h5 {
        margin: 0;
    }
    
    /* æ‹–æ‹½æ’åºæ¨£å¼ */
    .sortable-ghost {
        opacity: 0.5;
        background-color: #f8f9fa;
        border: 2px dashed #dee2e6;
    }
    
    .sortable-chosen {
        background-color: #e3f2fd;
        border: 2px solid #2196f3;
        transform: rotate(2deg);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .sortable-drag {
        opacity: 0.8;
        transform: rotate(5deg);
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }
    
    /* åƒæ•¸å¡ç‰‡ç¾åŒ– */
    .parameter-item .card {
        transition: all 0.3s ease;
        border-radius: 8px;
    }
    
    .parameter-item .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .parameter-item .card-title {
        color: #495057;
        font-weight: 600;
    }
    
    .parameter-item .form-label {
        font-weight: 500;
        color: #6c757d;
    }
    
    .parameter-item .form-control,
    .parameter-item .form-select {
        border-radius: 6px;
        border: 1px solid #dee2e6;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    .parameter-item .form-control:focus,
    .parameter-item .form-select:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    /* åƒæ•¸é¡å‹æ¨™ç±¤ */
    .parameter-type-badge {
        display: inline-block;
        padding: 2px 8px;
        font-size: 0.7rem;
        font-weight: 500;
        border-radius: 12px;
        text-transform: uppercase;
    }
    
    .parameter-type-badge.number {
        background-color: #e3f2fd;
        color: #1976d2;
    }
    
    .parameter-type-badge.text {
        background-color: #f3e5f5;
        color: #7b1fa2;
    }
    
    .parameter-type-badge.select {
        background-color: #e8f5e8;
        color: #388e3c;
    }
    
    .parameter-type-badge.boolean {
        background-color: #fff3e0;
        color: #f57c00;
    }
    
    .parameter-type-badge.dynamic {
        background-color: #fce4ec;
        color: #c2185b;
    }
    
    .parameter-type-badge.date {
        background-color: #e0f2f1;
        color: #00695c;
    }
    
    /* å´é‚Šæ¬„å±•é–‹/ç¸®èµ·åŠŸèƒ½ */
    #sidebar {
        transition: all 0.3s ease;
    }
    
    #sidebar.collapsed {
        width: 60px !important;
        min-width: 60px !important;
        max-width: 60px !important;
    }
    
    #sidebar.collapsed .card-body {
        display: none;
    }
    
    #sidebar.collapsed .card-header h5 {
        display: none;
    }
    
    #sidebar.collapsed .card-header {
        padding: 0.5rem;
        text-align: center;
    }
    
    #sidebar.collapsed #toggleIcon {
        transform: rotate(180deg);
    }
    
    #mainEditor {
        transition: all 0.3s ease;
    }
    
    #mainEditor.expanded {
        width: calc(100% - 60px) !important;
        max-width: calc(100% - 60px) !important;
    }
    
    /* Jupyter ç·¨è¼¯å™¨æ¨£å¼ */
    .jupyter-cell {
        margin-bottom: 1rem;
        border: 1px solid #e1e4e8;
        border-radius: 6px;
        background-color: #ffffff;
        transition: all 0.2s ease;
    }
    
    .jupyter-cell:hover {
        border-color: #0366d6;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .jupyter-cell-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem;
        background-color: #f6f8fa;
        border-bottom: 1px solid #e1e4e8;
        border-radius: 6px 6px 0 0;
    }
    
    .jupyter-cell-number {
        font-size: 0.8rem;
        color: #586069;
        font-weight: 500;
    }
    
    .jupyter-cell-actions {
        display: flex;
        gap: 0.25rem;
    }
    
    .jupyter-cell-actions .btn {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
        transition: all 0.2s ease;
    }
    
    .jupyter-cell-actions .btn:hover {
        transform: scale(1.1);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .jupyter-cell-actions .btn:active {
        transform: scale(0.95);
    }
    
    .jupyter-cell-input {
        padding: 0.75rem;
        background-color: #ffffff;
    }
    
    .jupyter-cell-input .CodeMirror {
        border: none;
        background-color: transparent;
    }
    
    .jupyter-cell-output {
        padding: 0.75rem;
        background-color: #fafbfc;
        border-top: 1px solid #e1e4e8;
        border-radius: 0 0 6px 6px;
        min-height: 2rem;
    }
    
    .jupyter-cell-output:empty {
        display: none;
    }
    
    .jupyter-cell-output .output-item {
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background-color: #ffffff;
        border: 1px solid #e1e4e8;
        border-radius: 4px;
    }
    
    .jupyter-cell-output .output-item:last-child {
        margin-bottom: 0;
    }
    
    .jupyter-cell-output .output-stream {
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        white-space: pre-wrap;
        word-break: break-word;
    }
    
    .jupyter-cell-output .output-stream.stdout {
        color: #24292e;
    }
    
    .jupyter-cell-output .output-stream.stderr {
        color: #d73a49;
    }
    
    .jupyter-cell-output .output-error {
        color: #d73a49;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        white-space: pre-wrap;
        word-break: break-word;
    }
    
    .jupyter-cell-output .output-display {
        overflow-x: auto;
    }
    
    .jupyter-cell-output .output-display img {
        max-width: 100%;
        height: auto;
    }
    
    .jupyter-cell-output .output-display table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
    }
    
    .jupyter-cell-output .output-display table th,
    .jupyter-cell-output .output-display table td {
        border: 1px solid #e1e4e8;
        padding: 0.25rem 0.5rem;
        text-align: left;
    }
    
    .jupyter-cell-output .output-display table th {
        background-color: #f6f8fa;
        font-weight: 600;
    }
    
    .jupyter-cell.executing {
        border-color: #0366d6;
        box-shadow: 0 0 0 3px rgba(3, 102, 214, 0.1);
    }
    
    .jupyter-cell.executing .jupyter-cell-header {
        background-color: #0366d6;
        color: #ffffff;
    }
    
    .jupyter-cell.executing .jupyter-cell-number {
        color: #ffffff;
    }
    
    .jupyter-cell.executing .jupyter-cell-actions .btn {
        color: #ffffff;
        border-color: #ffffff;
    }
    
    .jupyter-cell.executing .jupyter-cell-actions .btn:hover {
        background-color: #ffffff;
        color: #0366d6;
    }
    
    .jupyter-cell.error {
        border-color: #d73a49;
        box-shadow: 0 0 0 3px rgba(215, 58, 73, 0.1);
    }
    
    .jupyter-cell.error .jupyter-cell-header {
        background-color: #d73a49;
        color: #ffffff;
    }
    
    .jupyter-cell.error .jupyter-cell-number {
        color: #ffffff;
    }
    
    .jupyter-cell.error .jupyter-cell-actions .btn {
        color: #ffffff;
        border-color: #ffffff;
    }
    
    .jupyter-cell.error .jupyter-cell-actions .btn:hover {
        background-color: #ffffff;
        color: #d73a49;
    }
    
    .jupyter-cell.success {
        border-color: #28a745;
        box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
    }
    
    .jupyter-cell.success .jupyter-cell-header {
        background-color: #28a745;
        color: #ffffff;
    }
    
    .jupyter-cell.success .jupyter-cell-number {
        color: #ffffff;
    }
    
    .jupyter-cell.success .jupyter-cell-actions .btn {
        color: #ffffff;
        border-color: #ffffff;
    }
    
    .jupyter-cell.success .jupyter-cell-actions .btn:hover {
        background-color: #ffffff;
        color: #28a745;
    }
    
    /* ç­–ç•¥åƒæ•¸æ©«å‘ä¸¦æ’ */
    .strategy-params-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 12px 24px;
    }
    
    .strategy-params-grid .parameter-item {
        margin-bottom: 0.5rem;
    }
    
    .strategy-params-grid label.form-label {
        font-size: 0.95rem;
        font-weight: 500;
    }
    
    .strategy-params-grid .form-text {
        font-size: 0.85rem;
        color: #888;
    }
    
    @media (max-width: 600px) {
        .strategy-params-grid {
            grid-template-columns: 1fr;
        }
    }

    /* æ·±è‰²ä¸»é¡Œæ”¯æ´ */
    body.dark-mode .editor-sidebar,
    body.dark-mode .card,
    body.dark-mode .card-body,
    body.dark-mode .jupyter-toolbar,
    body.dark-mode .jupyter-cell,
    body.dark-mode .jupyter-cell-header,
    body.dark-mode .jupyter-cell-input,
    body.dark-mode .jupyter-cell-output,
    body.dark-mode .editor-toolbar {
        background-color: #23272e !important;
        color: #f8f9fa !important;
        border-color: #444c56 !important;
    }
    body.dark-mode .jupyter-cell-output .output-item,
    body.dark-mode .jupyter-cell-output {
        background-color: #23272e !important;
        color: #f8f9fa !important;
        border-color: #444c56 !important;
    }
    body.dark-mode .jupyter-cell-header,
    body.dark-mode .editor-toolbar,
    body.dark-mode .jupyter-toolbar {
        background-color: #23272e !important;
        color: #f8f9fa !important;
        border-bottom: 1px solid #444c56 !important;
    }
    body.dark-mode .jupyter-cell-output .output-stream.stdout {
        color: #e6e6e6 !important;
    }
    body.dark-mode .jupyter-cell-output .output-stream.stderr,
    body.dark-mode .jupyter-cell-output .output-error {
        color: #ff6f6f !important;
    }
    body.dark-mode .jupyter-cell-output .output-display table th,
    body.dark-mode .jupyter-cell-output .output-display table td {
        background-color: #23272e !important;
        color: #f8f9fa !important;
        border-color: #444c56 !important;
    }
    body.dark-mode .jupyter-cell-output .output-display table th {
        background-color: #2d333b !important;
    }
    body.dark-mode .btn,
    body.dark-mode .form-control,
    body.dark-mode .form-select {
        background-color: #23272e !important;
        color: #f8f9fa !important;
        border-color: #444c56 !important;
    }
    body.dark-mode .btn-info {
        background-color: #17a2b8 !important;
        color: #fff !important;
    }
    body.dark-mode .btn-success {
        background-color: #28a745 !important;
        color: #fff !important;
    }
    body.dark-mode .btn-warning {
        background-color: #ffc107 !important;
        color: #23272e !important;
    }
    body.dark-mode .btn-outline-info,
    body.dark-mode .btn-outline-secondary,
    body.dark-mode .btn-outline-warning,
    body.dark-mode .btn-outline-dark {
        color: #f8f9fa !important;
        border-color: #888 !important;
    }
    body.dark-mode .bg-light,
    body.dark-mode .border-bottom,
    body.dark-mode .bg-light.border-bottom {
        background-color: #23272e !important;
        color: #f8f9fa !important;
        border-bottom: 1px solid #444c56 !important;
    }
    body.dark-mode .form-control:focus,
    body.dark-mode .form-select:focus {
        border-color: #80bdff !important;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.15) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- å·¦å´ç­–ç•¥ç®¡ç†æ¸…å–® -->
        <div class="col-md-3 editor-sidebar" id="sidebar">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>ç­–ç•¥ç®¡ç†</h5>
                    <button class="btn btn-sm btn-outline-secondary" id="toggleSidebar" title="å±•é–‹/ç¸®èµ·å´é‚Šæ¬„">
                        <i class="fas fa-chevron-left" id="toggleIcon"></i>
                    </button>
                </div>
                <div class="card-body" id="sidebarContent">
                    <div class="mb-3">
                        <button class="btn btn-primary btn-sm" onclick="createNewStrategy()">
                            <i class="fas fa-plus"></i> æ–°å»ºç­–ç•¥
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <input type="text" class="form-control form-control-sm" id="searchStrategy" 
                               placeholder="æœå°‹ç­–ç•¥..." onkeyup="searchStrategies()">
                    </div>
                    
                    <div id="strategyList" class="list-group">
                        <!-- ç­–ç•¥åˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
                    </div>
                </div>
            </div>
        </div>
        <!-- å³å´ç¨‹å¼ç¢¼ç·¨è¼¯å€å¡Š -->
        <div class="col-md-9" id="mainEditor">
            <div class="editor-code-area">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 id="editorTitle">ç­–ç•¥ç·¨è¼¯å™¨</h5>
                    <div>
                        <button class="btn btn-warning btn-sm" onclick="exportStrategy()">
                            <i class="fas fa-download"></i> åŒ¯å‡º/ä¸‹è¼‰
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteStrategy()">
                            <i class="fas fa-trash"></i> åˆªé™¤
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- ç­–ç•¥åŸºæœ¬è³‡è¨Š -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="strategyName" class="form-label">ç­–ç•¥åç¨±</label>
                            <input type="text" class="form-control" id="strategyName" placeholder="è¼¸å…¥ç­–ç•¥åç¨±">
                        </div>
                        <div class="col-md-6">
                            <label for="strategyDescription" class="form-label">ç­–ç•¥æè¿°</label>
                            <input type="text" class="form-control" id="strategyDescription" placeholder="è¼¸å…¥ç­–ç•¥æè¿°">
                        </div>
                    </div>
                    
                    <!-- è‚¡ç¥¨ä¾†æºè¨­å®š -->
                    <div class="mb-3">
                        <label class="form-label">è‚¡ç¥¨ä¾†æº</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="stockSource" id="stockSourceExcel" value="excel" checked>
                                    <label class="form-check-label" for="stockSourceExcel">
                                        <i class="fas fa-file-excel"></i> Excel æª”æ¡ˆ
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="stockSource" id="stockSourceList" value="stock_list">
                                    <label class="form-check-label" for="stockSourceList">
                                        <i class="fas fa-list"></i> é¸è‚¡åˆ—è¡¨
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="stockSource" id="stockSourceCache" value="cache">
                                    <label class="form-check-label" for="stockSourceCache">
                                        <i class="fas fa-database"></i> å¿«å–è³‡æ–™
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                    <div id="excelSourceConfig" class="stock-source-config" style="display: none;">
                                        <div class="input-group">
                                            <input type="file" class="form-control" id="excelFile" accept=".xlsx,.xls" style="display: none;">
                                            <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('excelFile').click()">
                                                <i class="fas fa-upload"></i> é¸æ“‡æª”æ¡ˆ
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="downloadExcelTemplate()">
                                                <i class="fas fa-download"></i> ä¸‹è¼‰ç¯„æœ¬
                                            </button>
                                        </div>
                                        <small class="form-text text-muted">ä¸Šå‚³åŒ…å«è‚¡ç¥¨ä»£ç¢¼å’Œæ—¥æœŸçš„ Excel æª”æ¡ˆï¼Œç³»çµ±æœƒå¾ç­–ç•¥ä½¿ç”¨è¡¨æ ¼ä¸­å–å¾—å°æ‡‰çš„è‚¡åƒ¹è³‡æ–™</small>
                                        <div id="excelFileInfo" class="mt-1" style="display: none;">
                                            <small class="text-success">
                                                <i class="fas fa-check"></i> <span id="excelFileName"></span>
                                            </small>
                                        </div>
                                </div>
                                <div id="stockListConfig" class="stock-source-config" style="display: none;">
                                    <select class="form-control" id="stockListSelect">
                                        <option value="">è«‹é¸æ“‡é¸è‚¡åˆ—è¡¨...</option>
                                    </select>
                                    <small class="text-muted">æˆ– <a href="/stock-selector" target="_blank">å»ºç«‹æ–°çš„é¸è‚¡åˆ—è¡¨</a></small>
                                </div>
                            </div>
                        </div>
                    </div>
                        
                        <!-- æ¸¬è©¦è¨­å®š -->
                        <div class="mb-3">
                            <label class="form-label">æ¸¬è©¦è¨­å®š</label>
                            <div class="row">
                                <div class="col-md-12">
                                    <label for="strategyDataTable">ç­–ç•¥ä½¿ç”¨è¡¨æ ¼</label>
                                    <select class="form-control" id="strategyDataTable">
                                        <option value="auto">è‡ªå‹•é¸æ“‡</option>
                                        <option value="cache_files" disabled>--- å¿«å–æª”æ¡ˆ ---</option>
                                    </select>
                                    <small class="form-text text-muted">ç­–ç•¥ç¨‹å¼ç¢¼ä¸­è¦ä½¿ç”¨çš„è³‡æ–™è¡¨æ ¼</small>
                                    <button type="button" class="btn btn-sm btn-outline-secondary mt-1" onclick="refreshCacheFiles()">
                                        <i class="fas fa-sync-alt"></i> é‡æ–°æ•´ç†å¿«å–æª”æ¡ˆ
                                    </button>
                                </div>
                            </div>
                        </div>
                    
                    <!-- Jupyter é¢¨æ ¼ç¨‹å¼ç¢¼ç·¨è¼¯å™¨ -->
                    <div class="mb-3" id="code">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label">
                                <i class="fas fa-code text-primary"></i> Jupyter é¢¨æ ¼ç¨‹å¼ç¢¼ç·¨è¼¯å™¨
                            </label>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#jupyterHelpCollapse">
                                    <i class="fas fa-question-circle"></i> ä½¿ç”¨èªªæ˜
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="toggleJupyterMode()" id="jupyterModeBtn">
                                    <i class="fas fa-play"></i> åˆ‡æ› Jupyter æ¨¡å¼
                                </button>
                            </div>
                        </div>
                        
                        <!-- Jupyter ä½¿ç”¨èªªæ˜æ‘ºç–Šå€å¡Š -->
                        <div class="collapse mb-3" id="jupyterHelpCollapse">
                            <div class="card card-body bg-light">
                                <h6><i class="fas fa-info-circle text-info"></i> Jupyter é¢¨æ ¼ç·¨è¼¯å™¨ä½¿ç”¨èªªæ˜</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-primary">å¯ç”¨æ¨¡çµ„ï¼š</h6>
                                        <ul class="list-unstyled">
                                            <li><strong>np</strong> - NumPy æ•¸å€¼è¨ˆç®—</li>
                                            <li><strong>pd</strong> - Pandas è³‡æ–™è™•ç†</li>
                                            <li><strong>pl</strong> - Polars é«˜æ•ˆèƒ½è³‡æ–™è™•ç†</li>
                                            <li><strong>plt</strong> - Matplotlib ç¹ªåœ–</li>
                                            <li><strong>sns</strong> - Seaborn çµ±è¨ˆç¹ªåœ–</li>
                                            <li><strong>go</strong> - Plotly äº’å‹•åœ–è¡¨</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-success">ç­–ç•¥å·¥å…·ï¼š</h6>
                                        <ul class="list-unstyled small">
                                            <li><strong>PriceUtils</strong> - åƒ¹æ ¼è¨ˆç®—å·¥å…·</li>
                                            <li><strong>Utils</strong> - é€šç”¨å·¥å…·é¡åˆ¥</li>
                                            <li><strong>TradeRecord</strong> - äº¤æ˜“è¨˜éŒ„è³‡æ–™é¡åˆ¥</li>
                                            <li><strong>HoldingPosition</strong> - æŒæœ‰éƒ¨ä½è³‡æ–™é¡åˆ¥</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-lightbulb"></i> æç¤ºï¼šæŒ‰ Shift+Enter åŸ·è¡Œç¨‹å¼ç¢¼ï¼ŒCtrl+Enter åŸ·è¡Œä¸¦æ–°å¢å–®å…ƒæ ¼
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Jupyter ç·¨è¼¯å™¨å®¹å™¨ -->
                        <div id="jupyterEditor" class="border rounded" style="display: none;">
                            <div class="jupyter-toolbar d-flex justify-content-between align-items-center p-2 bg-light border-bottom">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="loadSampleData()">
                                        <i class="fas fa-download"></i> è¼‰å…¥ç¯„ä¾‹è³‡æ–™
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="analyzeStrategyType()">
                                        <i class="fas fa-search"></i> åˆ†æç­–ç•¥é¡å‹
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" onclick="clearAllOutputs()">
                                        <i class="fas fa-trash"></i> æ¸…é™¤è¼¸å‡º
                                    </button>
                                    <button class="btn btn-sm btn-outline-dark" onclick="clearJupyterVariables()">
                                        <i class="fas fa-broom"></i> æ¸…é™¤è®Šæ•¸
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" onclick="showJupyterVariables()">
                                        <i class="fas fa-eye"></i> æŸ¥çœ‹è®Šæ•¸
                                    </button>                                   
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-warning" onclick="exportJupyterNotebook()">
                                        <i class="fas fa-download"></i> åŒ¯å‡º
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="saveJupyterNotebook()">
                                        <i class="fas fa-save"></i> å„²å­˜ç­†è¨˜æœ¬
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="saveJupyterStrategy()">
                                        <i class="fas fa-save"></i> å„²å­˜ç­–ç•¥
                                    </button>
                                    <button class="btn btn-info btn-sm" onclick="executeJupyterBacktest()">
                                        <i class="fas fa-play"></i> æ¸¬è©¦
                                    </button>    
                                </div>
                            </div>
                            <div id="jupyterCells" class="p-2">
                                <!-- Jupyter å–®å…ƒæ ¼å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                            </div>
                        </div>
                        
                        <!-- å‚³çµ±ç¨‹å¼ç¢¼ç·¨è¼¯å™¨ -->
                        <div id="traditionalEditor" class="border rounded">
                            <div class="editor-toolbar d-flex justify-content-between align-items-center">
                                <div class="d-flex gap-2">
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="templateDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fas fa-file-code"></i> è¼‰å…¥æ¨¡æ¿
                                        </button>
                                        <ul class="dropdown-menu" aria-labelledby="templateDropdown">                                            
                                            <li><a class="dropdown-item" href="#" onclick="loadTemplate('vectorized')">
                                                <i class="fas fa-rocket"></i> å‘é‡åŒ–æ¨¡æ¿
                                                <small class="text-muted d-block">æ•ˆèƒ½æœ€ä½³ï¼Œé©ç”¨æ–¼ç°¡å–®é‚è¼¯</small>
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="loadTemplate('state_machine')">
                                                <i class="fas fa-cogs"></i> ç‹€æ…‹æ©Ÿæ¨¡æ¿
                                                <small class="text-muted d-block">é©ç”¨æ–¼è¤‡é›œé‚è¼¯å’Œç‹€æ…‹è¿½è¹¤</small>
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="loadTemplate('mixed')">
                                                <i class="fas fa-layer-group"></i> æ··åˆæ¨¡å¼æ¨¡æ¿
                                                <small class="text-muted d-block">åŒ…å«å‘é‡åŒ–å’Œç‹€æ…‹æ©Ÿå…©ç¨®æ¨¡å¼</small>
                                            </a></li>
                                        </ul>
                                    </div>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="loadSampleData()">
                                        <i class="fas fa-download"></i> è¼‰å…¥ç¯„ä¾‹è³‡æ–™
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="formatCode()">æ ¼å¼åŒ–</button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="validateCode()">é©—è­‰èªæ³•</button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleFullscreen()">
                                        <i class="fas fa-expand"></i> å…¨è¢å¹•
                                    </button>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-success btn-sm" onclick="saveStrategy()">
                                        <i class="fas fa-save"></i> å„²å­˜
                                    </button>
                                    <button class="btn btn-info btn-sm" onclick="testStrategy()">
                                        <i class="fas fa-play"></i> æ¸¬è©¦
                                    </button>
                                </div>
                            </div>
                            <div id="codeEditorContainer" style="height: 800px; position: relative;">
                                <textarea id="strategyCode" placeholder="è«‹è¼¸å…¥ç­–ç•¥ç¨‹å¼ç¢¼..."></textarea>
                            </div>
                        </div>
                    </div>
                        
                        <!-- äº¤æ˜“å ±è¡¨å€åŸŸ -->
                        <div class="mb-3" id="test" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label">
                                    <i class="fas fa-chart-line text-primary"></i> äº¤æ˜“å ±è¡¨
                                </label>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="exportTradeReport()">
                                        <i class="fas fa-download"></i> åŒ¯å‡ºå ±è¡¨
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#tradeReportCollapse">
                                        <i class="fas fa-chevron-down"></i> å±•é–‹/ç¸®èµ·
                                    </button>
                                </div>
                            </div>
                            
                            <!-- äº¤æ˜“å ±è¡¨æ‘ºç–Šå€å¡Š -->
                            <div class="collapse show" id="tradeReportCollapse">
                                <div class="card">
                                    <div class="card-body p-0">
                                        <!-- äº¤æ˜“çµ±è¨ˆæ‘˜è¦ -->
                                        <div class="row g-0 bg-light border-bottom">
                                            <div class="col-md-3 p-3 text-center">
                                                <div class="h5 mb-1 text-primary" id="totalTrades">0</div>
                                                <small class="text-muted">ç¸½äº¤æ˜“æ¬¡æ•¸</small>
                                            </div>
                                            <div class="col-md-3 p-3 text-center">
                                                <div class="h5 mb-1 text-success" id="winRate">0%</div>
                                                <small class="text-muted">å‹ç‡</small>
                                            </div>
                                            <div class="col-md-3 p-3 text-center">
                                                <div class="h5 mb-1" id="totalReturn">0%</div>
                                                <small class="text-muted">ç¸½å ±é…¬ç‡</small>
                                            </div>
                                            <div class="col-md-3 p-3 text-center">
                                                <div class="h5 mb-1 text-danger" id="maxDrawdown">0%</div>
                                                <small class="text-muted">æœ€å¤§å›æ’¤</small>
                                            </div>
                                        </div>
                                        
                                        <!-- äº¤æ˜“è¨˜éŒ„è¡¨æ ¼ -->
                                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                            <table class="table table-sm table-hover mb-0" id="tradeReportTable">
                                                <thead class="table-dark sticky-top">
                                                    <tr>
                                                        <th>é€²å ´æ—¥æœŸ</th>
                                                        <th>å‡ºå ´æ—¥æœŸ</th>
                                                        <th>è‚¡ç¥¨ä»£ç¢¼</th>
                                                        <th>è‚¡ç¥¨åç¨±</th>
                                                        <th>é€²å ´åƒ¹</th>
                                                        <th>å‡ºå ´åƒ¹</th>
                                                        <th>è‚¡æ•¸</th>
                                                        <th>å ±é…¬</th>
                                                        <th>å ±é…¬ç‡</th>
                                                        <th>æŒæœ‰å¤©æ•¸</th>
                                                        <th>å‡ºå ´ç†ç”±</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tradeReportBody">
                                                    <!-- äº¤æ˜“è¨˜éŒ„å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                        <!-- æŒæœ‰éƒ¨ä½è¡¨æ ¼ -->
                                        <div class="mt-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <h6>æŒæœ‰æœªå‡ºå ´éƒ¨ä½</h6>
                                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="exportHoldingPositionsReport()">
                                                    <i class="fas fa-download"></i> åŒ¯å‡ºæŒæœ‰éƒ¨ä½å ±è¡¨
                                                </button>
                                            </div>
                                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                                <table class="table table-sm table-hover mb-0" id="holdingPositionsTable">
                                                    <thead class="table-dark sticky-top">
                                                        <tr>
                                                            <th>é€²å ´æ—¥æœŸ</th>
                                                            <th>è‚¡ç¥¨ä»£ç¢¼</th>
                                                            <th>è‚¡ç¥¨åç¨±</th>
                                                            <th>æ–¹å‘</th>
                                                            <th>é€²å ´åƒ¹</th>
                                                            <th>ç•¶å‰åƒ¹</th>
                                                            <th>è‚¡æ•¸</th>
                                                            <th>æœªå¯¦ç¾æç›Š</th>
                                                            <th>æœªå¯¦ç¾æç›Šç‡</th>
                                                            <th>æŒæœ‰å¤©æ•¸</th>
                                                            <th>åœåˆ©åƒ¹</th>
                                                            <th>åœæåƒ¹</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="holdingPositionsBody">
                                                        <!-- æŒæœ‰éƒ¨ä½å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                                                    </tbody>
                                                </table>
                                            </div>
                                            
                                            <!-- ç„¡æŒæœ‰éƒ¨ä½æç¤º -->
                                            <div id="noHoldingMessage" class="text-center text-muted py-3" style="display: none;">
                                                <i class="fas fa-hand-holding-usd fa-2x mb-2"></i>
                                                <p>ç›®å‰æ²’æœ‰æŒæœ‰æœªå‡ºå ´çš„éƒ¨ä½</p>
                                            </div>
                                        </div>
                                        
                                        <!-- ç„¡äº¤æ˜“è¨˜éŒ„æç¤º -->
                                        <div id="noTradeMessage" class="text-center text-muted py-4" style="display: none;">
                                            <i class="fas fa-chart-line fa-2x mb-2"></i>
                                            <p>åŸ·è¡Œæ¸¬è©¦å¾Œå°‡é¡¯ç¤ºäº¤æ˜“è¨˜éŒ„</p>
                                        </div>
                                    </div>
                                </div>
                                                    </div>
                    </div>
                    
                    <!-- åœ–è¡¨åˆ†æå€åŸŸ -->
                    <div class="mb-3" id="charts" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label">
                                <i class="fas fa-chart-bar text-info"></i> åœ–è¡¨åˆ†æ
                            </label>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary me-2" onclick="refreshCharts()">
                                    <i class="fas fa-sync-alt"></i> é‡æ–°æ•´ç†
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="exportCharts()">
                                    <i class="fas fa-download"></i> åŒ¯å‡ºåœ–è¡¨
                                </button>
                            </div>
                        </div>
                        <div id="chartsContainer" class="border rounded p-3" style="min-height: 320px;">
                            <!-- åœ–è¡¨æœƒåœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                        </div>
                        <div id="noChartsMessage" class="text-center text-muted py-4" style="display: none;">
                            <i class="fas fa-chart-bar fa-2x mb-2"></i>
                            <p>åŸ·è¡Œæ¸¬è©¦å¾Œå°‡é¡¯ç¤ºåœ–è¡¨åˆ†æ</p>
                        </div>
                    </div>
                    
                    <!-- åƒæ•¸é…ç½® -->
                    <div class="mb-3" id="parameters">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label">ç­–ç•¥åƒæ•¸</label>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="toggleParameterSort()" id="sortToggleBtn">
                                        <i class="fas fa-sort"></i> æ’åºæ¨¡å¼
                                    </button>
                                    <button type="button" class="btn btn-sm btn-primary" onclick="addParameter()">
                                        <i class="fas fa-plus"></i> æ–°å¢åƒæ•¸
                                    </button>
                                </div>
                            </div>
                            
                            <!-- æŒæœ‰è¨˜éŒ„åŠŸèƒ½é–‹é—œ - æš«æ™‚éš±è— -->
                            <!-- <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="recordHoldingsSwitch" onchange="toggleRecordHoldings()">
                                    <label class="form-check-label" for="recordHoldingsSwitch">
                                        <i class="fas fa-hand-holding-usd me-2"></i>
                                        å•Ÿç”¨æŒæœ‰æœªå‡ºå ´è¨˜éŒ„åŠŸèƒ½
                                    </label>
                                </div>
                                <div class="form-text">
                                    å•Ÿç”¨å¾Œå°‡è¨˜éŒ„ç­–ç•¥ä¸­å°šæœªå‡ºå ´çš„éƒ¨ä½ï¼ŒåŒ…æ‹¬æœªå¯¦ç¾æç›Šç­‰è³‡è¨Š
                                </div>
                            </div> -->
                            
                        <div id="parameterConfig" class="border rounded p-3">
                                <div id="parameterContainer" class="strategy-params-grid">
                                    <!-- åƒæ•¸æœƒåœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                                </div>
                                <div id="parameterEmpty" class="text-center text-muted py-4">
                                    <i class="fas fa-cog fa-2x mb-2"></i>
                                    <p>åƒæ•¸é…ç½®å°‡æ ¹æ“šç¨‹å¼ç¢¼è‡ªå‹•ç”Ÿæˆ</p>
                                </div>
                        </div>
                    </div>
                    
                    <!-- è³‡æ–™é è¦½å€åŸŸ -->
                    <div class="mb-3" id="preview">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label">è³‡æ–™é è¦½</label>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary" onclick="clearPreviewData()">
                                    <i class="fas fa-trash"></i> æ¸…é™¤
                                </button>
                            </div>
                        </div>
                        <div id="dataPreview" class="border rounded p-3" style="display: none;">
                            <div class="mb-2">
                                <strong>è³‡æ–™è³‡è¨Šï¼š</strong>
                                <span id="dataInfo">è¼‰å…¥ä¸­...</span>
                            </div>
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-striped" id="dataTable">
                                    <thead class="table-dark sticky-top">
                                        <!-- è¡¨é ­å°‡å‹•æ…‹ç”Ÿæˆ -->
                                    </thead>
                                    <tbody>
                                        <!-- è³‡æ–™è¡Œå°‡å‹•æ…‹ç”Ÿæˆ -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ¸¬è©¦çµæœ -->
            <div class="card mt-3" id="testResults" style="display: none;">
                <div class="card-header">
                    <h6>æ¸¬è©¦çµæœ</h6>
                </div>
                <div class="card-body">
                    <div id="testOutput"></div>
                    </div>
                </div>
            </div>
            
            <!-- Jupyter å°ˆç”¨åœ–è¡¨å®¹å™¨ -->
            <div class="card mt-3" id="jupyterChartsSection" style="display: none;">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6><i class="fas fa-chart-bar text-primary"></i> ç­–ç•¥åœ–è¡¨</h6>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary me-2" onclick="refreshJupyterCharts()">
                                <i class="fas fa-sync-alt"></i> é‡æ–°æ•´ç†
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportJupyterCharts()">
                                <i class="fas fa-download"></i> åŒ¯å‡ºåœ–è¡¨
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="jupyterChartsContainer" class="border rounded p-3" style="min-height: 320px;">
                        <!-- Jupyter åœ–è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                    <div id="jupyterNoChartsMessage" class="text-center text-muted py-4" style="display: none;">
                        <i class="fas fa-chart-bar fa-2x mb-2"></i>
                        <p>åŸ·è¡Œç­–ç•¥å›æ¸¬å¾Œå°‡é¡¯ç¤ºåœ–è¡¨åˆ†æ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ–°å»ºç­–ç•¥å°è©±æ¡† -->
<div class="modal fade" id="newStrategyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ–°å»ºç­–ç•¥</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="newStrategyName" class="form-label">ç­–ç•¥åç¨±</label>
                    <input type="text" class="form-control" id="newStrategyName" placeholder="è¼¸å…¥ç­–ç•¥åç¨±">
                </div>
                <div class="mb-3">
                    <label for="newStrategyDescription" class="form-label">ç­–ç•¥æè¿°</label>
                    <textarea class="form-control" id="newStrategyDescription" rows="3" placeholder="è¼¸å…¥ç­–ç•¥æè¿°"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">ç·¨è¼¯æ¨¡å¼</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="editorMode" id="modeTraditional" value="traditional">
                        <label class="form-check-label" for="modeTraditional">
                            <i class="fas fa-file-code"></i> å‚³çµ±ç·¨è¼¯å™¨ <span class="text-muted small">ï¼ˆå®Œæ•´ç­–ç•¥ç¨‹å¼ç¢¼ç·¨è¼¯ï¼‰</span>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="editorMode" id="modeJupyter" value="jupyter" checked>
                        <label class="form-check-label" for="modeJupyter">
                            <i class="fas fa-play"></i> Jupyter æ¨¡å¼ <span class="text-muted small">ï¼ˆäº’å‹•å¼å–®å…ƒæ ¼ç·¨è¼¯ï¼‰</span>
                        </label>
                    </div>
                </div>
                
                <div class="mb-3" id="strategyTypeSection">
                    <label class="form-label">ç­–ç•¥é¡å‹</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="strategyType" id="typeVectorized" value="vectorized" checked>
                        <label class="form-check-label" for="typeVectorized">
                            å‘é‡åŒ–æ¨¡æ¿ <span class="text-muted small">ï¼ˆæ•ˆèƒ½æœ€ä½³ï¼Œé©ç”¨ç°¡å–®é‚è¼¯ï¼‰</span>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="strategyType" id="typeMixed" value="mixed">
                        <label class="form-check-label" for="typeMixed">
                            æ··åˆæ¨¡å¼æ¨¡æ¿ <span class="text-muted small">ï¼ˆåŒæ™‚æ”¯æ´å‘é‡åŒ–èˆ‡ç‹€æ…‹æ©Ÿï¼‰</span>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="strategyType" id="typeStateMachine" value="state_machine">
                        <label class="form-check-label" for="typeStateMachine">
                            ç‹€æ…‹æ©Ÿæ¨¡æ¿ <span class="text-muted small">ï¼ˆé©ç”¨è¤‡é›œé‚è¼¯èˆ‡ç‹€æ…‹è¿½è¹¤ï¼‰</span>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="strategyType" id="typeEmpty" value="empty">
                        <label class="form-check-label" for="typeEmpty">
                            ç©ºç™½ç­–ç•¥
                        </label>
                    </div>
                </div>
                
                <div class="mb-3" id="jupyterStrategyTypeSection" style="display: none;">
                    <label class="form-label">Jupyter ç­–ç•¥é¡å‹</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="jupyterStrategyType" id="jupyterTypeVectorized" value="vectorized" checked>
                        <label class="form-check-label" for="jupyterTypeVectorized">
                            <i class="fas fa-rocket"></i> å‘é‡åŒ–ç­–ç•¥ <span class="text-muted small">ï¼ˆä¸€æ¬¡æ€§è¨ˆç®—æ‰€æœ‰ä¿¡è™Ÿï¼‰</span>
                        </label>
                    </div>
                    <!-- <div class="form-check">
                        <input class="form-check-input" type="radio" name="jupyterStrategyType" id="jupyterTypeStateMachine" value="state_machine">
                        <label class="form-check-label" for="jupyterTypeStateMachine">
                            <i class="fas fa-cogs"></i> ç‹€æ…‹æ©Ÿç­–ç•¥ <span class="text-muted small">ï¼ˆé€ç­†è™•ç†ï¼Œè¿½è¹¤ç‹€æ…‹ï¼‰</span>
                        </label>
                    </div> -->
                    <!-- <div class="form-check">
                        <input class="form-check-input" type="radio" name="jupyterStrategyType" id="jupyterTypeHybrid" value="hybrid">
                        <label class="form-check-label" for="jupyterTypeHybrid">
                            <i class="fas fa-layer-group"></i> æ··åˆç­–ç•¥ <span class="text-muted small">ï¼ˆçµåˆå‘é‡åŒ–å’Œç‹€æ…‹æ©Ÿï¼‰</span>
                        </label>
                    </div> -->
                    <!-- <div class="form-check">
                        <input class="form-check-input" type="radio" name="jupyterStrategyType" id="jupyterTypeAnalysis" value="analysis">
                        <label class="form-check-label" for="jupyterTypeAnalysis">
                            <i class="fas fa-chart-line"></i> åˆ†ææ¨¡å¼ <span class="text-muted small">ï¼ˆç´”è³‡æ–™åˆ†æï¼Œç„¡äº¤æ˜“é‚è¼¯ï¼‰</span>
                        </label>
                    </div> -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="confirmCreateStrategy()">å»ºç«‹</button>
            </div>
        </div>
    </div>
</div>

<!-- åŒ¯å‡ºç­–ç•¥å°è©±æ¡† -->
<div class="modal fade" id="exportStrategyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">åŒ¯å‡ºç­–ç•¥</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="exportFileName" class="form-label">æª”æ¡ˆåç¨±</label>
                    <input type="text" class="form-control" id="exportFileName" placeholder="è¼¸å…¥æª”æ¡ˆåç¨±">
                </div>
                <div class="mb-3">
                    <label class="form-label">åŒ¯å‡ºæ ¼å¼</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="exportFormat" id="formatJson" value="json" checked>
                        <label class="form-check-label" for="formatJson">
                            JSON æ ¼å¼
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="exportFormat" id="formatPython" value="python">
                        <label class="form-check-label" for="formatPython">
                            Python æª”æ¡ˆ
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="confirmExportStrategy()">åŒ¯å‡º</button>
            </div>
        </div>
    </div>
</div>

<!-- ç¯„ä¾‹è³‡æ–™é¸æ“‡å°è©±æ¡† -->
<div class="modal fade" id="sampleDataModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">é¸æ“‡ç¯„ä¾‹è³‡æ–™</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>è³‡æ–™é¡å‹</h6>
                        <div class="list-group" id="dataTypeList">
                            <!-- è³‡æ–™é¡å‹åˆ—è¡¨å°‡å‹•æ…‹è¼‰å…¥ -->
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>è³‡æ–™åƒæ•¸</h6>
                        <div id="dataParams">
                            <p class="text-muted">è«‹é¸æ“‡è³‡æ–™é¡å‹</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="loadSelectedData()">è¼‰å…¥è³‡æ–™</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- CodeMirror JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/trailingspace.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/wrap-lines.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/brace-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/indent-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/comment-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/anyword-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/search.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/searchcursor.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/jump-to-line.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/selection/active-line.min.js"></script>

<script>
let currentStrategyId = null;
let strategies = [];
let codeEditor = null;
let isFullscreen = false;
let currentPreviewData = null;
let selectedDataType = null;
let isSortMode = false;
let sortableInstance = null;

// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadStrategies();
    loadStockLists();
    loadCacheFiles();  // è¼‰å…¥å¿«å–æª”æ¡ˆåˆ—è¡¨
    setupStockSourceHandlers();
    initializeCodeEditor();
    setupExcelFileHandlers();  // è¨­å®š Excel æª”æ¡ˆè™•ç†å™¨
    setupSidebarToggle();
    
    // é è¨­å•Ÿç”¨ Jupyter æ¨¡å¼
    initializeJupyterMode();
    
    // é é¢è¼‰å…¥æ™‚æ¸…é™¤ Jupyter è¼¸å‡ºå’Œè®Šæ•¸
    clearJupyterSilently();
    
    // é é¢è¼‰å…¥æ™‚æ ¹æ“šradioé è¨­å€¼é¡¯ç¤ºæ­£ç¢ºdiv
    const checked = document.querySelector('input[name="stockSource"]:checked');
    if (checked) checked.dispatchEvent(new Event('change'));
});

// åˆå§‹åŒ–ç¨‹å¼ç¢¼ç·¨è¼¯å™¨
function initializeCodeEditor() {
    const textarea = document.getElementById('strategyCode');
    // è‹¥å·²å­˜åœ¨ï¼Œå…ˆéŠ·æ¯€
    if (window.codeEditor) {
        window.codeEditor.toTextArea();
        window.codeEditor = null;
    }
    // å»ºç«‹ CodeMirror å¯¦ä¾‹
    // æ ¹æ“šç•¶å‰ä¸»é¡Œè¨­å®š CodeMirror ä¸»é¡Œ
    const currentTheme = localStorage.getItem('theme') || 'light';
    const codeMirrorTheme = currentTheme === 'dark' ? 'monokai' : 'eclipse';
    
    window.codeEditor = CodeMirror.fromTextArea(textarea, {
        mode: 'python',
        theme: codeMirrorTheme,
        lineNumbers: true,
        lineWrapping: true,
        indentUnit: 4,
        tabSize: 4,
        indentWithTabs: false,
        autoCloseBrackets: true,
        matchBrackets: true,
        foldGutter: true,
        gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
        extraKeys: {
            'Tab': function(cm) {
                if (cm.somethingSelected()) {
                    cm.indentSelection('add');
                } else {
                    cm.replaceSelection('    ', 'end');
                }
            },
            'Enter': function(cm) {
                const cursor = cm.getCursor();
                const line = cm.getLine(cursor.line);
                const beforeCursor = line.slice(0, cursor.ch);
                // è‡ªå‹•ç¸®æ’é‚è¼¯
                let indent = '';
                const match = beforeCursor.match(/^(\s*)/);
                if (match) {
                    indent = match[1];
                }
                // æª¢æŸ¥æ˜¯å¦éœ€è¦å¢åŠ ç¸®æ’
                if (beforeCursor.trim().endsWith(':')) {
                    indent += '    ';
                }
                cm.replaceSelection('\n' + indent, 'end');
            },
            'Ctrl-Space': 'autocomplete',
            'Ctrl-F': 'findPersistent',
            'Ctrl-H': 'replace',
            'Ctrl-/': function(cm) {
                cm.toggleComment();
            }
        },
        hintOptions: {
            completeSingle: false,
            alignWithWord: true
        }
    });
    // è¨­å®šç·¨è¼¯å™¨å¤§å°
    window.codeEditor.setSize('100%', '100%');
    // ç›£è½å…§å®¹è®ŠåŒ–
    window.codeEditor.on('change', function() {
        window.codeEditor.save();
    });
}

// è¼‰å…¥é è¨­æ¨¡æ¿
function loadDefaultTemplate() {
    const defaultTemplate = `class MyStrategy:
    def __init__(self, parameters):
        self.parameters = parameters
        self.strategy_name = "æˆ‘çš„ç­–ç•¥"
        self.strategy_description = "è‡ªå®šç¾©äº¤æ˜“ç­–ç•¥"
    
    def execute(self, data):
        """
        ç­–ç•¥åŸ·è¡Œé‚è¼¯
        data: è‚¡ç¥¨è³‡æ–™ (polars DataFrame)
        """
        # åœ¨é€™è£¡å¯¦ä½œæ‚¨çš„ç­–ç•¥é‚è¼¯
        result = data.clone()
        
        # ç¯„ä¾‹ï¼šç°¡å–®çš„ç§»å‹•å¹³å‡ç­–ç•¥
        if len(data) > 20:
            result = result.with_columns([
                pl.col('close').rolling_mean(window_size=20).alias('ma20'),
                pl.col('close').rolling_mean(window_size=5).alias('ma5')
            ])
            
            # ç”¢ç”Ÿè²·è³£è¨Šè™Ÿ
            result = result.with_columns([
                pl.when(pl.col('ma5') > pl.col('ma20'))
                .then(1)  # è²·å…¥è¨Šè™Ÿ
                .otherwise(0).alias('signal')
            ])
        
        return result
    
    def get_parameters(self):
        """å–å¾—ç­–ç•¥åƒæ•¸"""
        return self.parameters`;
    
    codeEditor.setValue(defaultTemplate);
}

// åˆ‡æ›å…¨è¢å¹•æ¨¡å¼
function toggleFullscreen() {
    if (!window.codeEditor) {
        showAlert('ç·¨è¼¯å™¨å°šæœªåˆå§‹åŒ–', 'warning');
        return;
    }
    if (!isFullscreen) {
        // é€²å…¥å…¨è¢å¹•æ¨¡å¼
        const container = document.getElementById('codeEditorContainer');
        const parent = container.parentElement;
        
        // å»ºç«‹å…¨è¢å¹•å®¹å™¨
        const fullscreenDiv = document.createElement('div');
        fullscreenDiv.className = 'fullscreen-editor';
        fullscreenDiv.innerHTML = `
            <div class="fullscreen-toolbar">
                <h5>ç­–ç•¥ç¨‹å¼ç¢¼ç·¨è¼¯å™¨ - å…¨è¢å¹•æ¨¡å¼</h5>
                <div>
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleFullscreen()">
                        <i class="fas fa-compress"></i> é€€å‡ºå…¨è¢å¹•
                    </button>
                </div>
            </div>
            <div id="fullscreenEditorContainer" style="flex: 1; position: relative;"></div>
        `;
        
        document.body.appendChild(fullscreenDiv);
        
        // ç§»å‹•ç·¨è¼¯å™¨åˆ°å…¨è¢å¹•å®¹å™¨
        const fullscreenContainer = fullscreenDiv.querySelector('#fullscreenEditorContainer');
        fullscreenContainer.appendChild(container);
        
        // é‡æ–°è¨­å®šç·¨è¼¯å™¨å¤§å°
        codeEditor.setSize('100%', '100%');
        codeEditor.refresh();
        
        isFullscreen = true;
    } else {
        // é€€å‡ºå…¨è¢å¹•æ¨¡å¼
        const fullscreenDiv = document.querySelector('.fullscreen-editor');
        const container = document.getElementById('codeEditorContainer');
        const originalParent = document.querySelector('.border.rounded');
        
        // ç§»å‹•ç·¨è¼¯å™¨å›åŸä½ç½®
        originalParent.appendChild(container);
        
        // ç§»é™¤å…¨è¢å¹•å®¹å™¨
        document.body.removeChild(fullscreenDiv);
        
        // é‡æ–°è¨­å®šç·¨è¼¯å™¨å¤§å°
        codeEditor.setSize('100%', '100%');
        codeEditor.refresh();
        
        isFullscreen = false;
    }
}

// æ ¼å¼åŒ–ç¨‹å¼ç¢¼
async function formatCode() {
    if (!codeEditor) return;
    
    const code = codeEditor.getValue();
    
    if (!code.trim()) {
        showAlert('è«‹å…ˆè¼¸å…¥ç¨‹å¼ç¢¼', 'warning');
        return;
    }
    
    try {
        showAlert('æ­£åœ¨æ ¼å¼åŒ–ç¨‹å¼ç¢¼...', 'info');
        
        const response = await fetch('/api/strategies/custom/format', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ code: code })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            codeEditor.setValue(result.formatted_code);
            showAlert('ç¨‹å¼ç¢¼æ ¼å¼åŒ–å®Œæˆ', 'success');
        } else {
            showAlert(`æ ¼å¼åŒ–å¤±æ•—: ${result.message}`, 'error');
        }
    } catch (error) {
        console.error('æ ¼å¼åŒ–ç¨‹å¼ç¢¼å¤±æ•—:', error);
        showAlert('æ ¼å¼åŒ–ç¨‹å¼ç¢¼å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š', 'error');
    }
}

// é©—è­‰ç¨‹å¼ç¢¼èªæ³•
function validateCode() {
    if (!codeEditor) return;
    
    const code = codeEditor.getValue();
    
    // ç°¡å–®çš„èªæ³•æª¢æŸ¥
    const errors = [];
    
    // æª¢æŸ¥æ‹¬è™Ÿé…å°
    const brackets = { '(': 0, ')': 0, '[': 0, ']': 0, '{': 0, '}': 0 };
    for (let char of code) {
        if (brackets.hasOwnProperty(char)) {
            brackets[char]++;
        }
    }
    
    if (brackets['('] !== brackets[')']) {
        errors.push('æ‹¬è™Ÿ () ä¸é…å°');
    }
    if (brackets['['] !== brackets[']']) {
        errors.push('æ–¹æ‹¬è™Ÿ [] ä¸é…å°');
    }
    if (brackets['{'] !== brackets['}']) {
        errors.push('å¤§æ‹¬è™Ÿ {} ä¸é…å°');
    }
    
    // æª¢æŸ¥ç¸®æ’
    const lines = code.split('\n');
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        if (line.trim() && !line.startsWith(' ') && !line.startsWith('\t')) {
            // æª¢æŸ¥æ˜¯å¦æ‡‰è©²æœ‰ç¸®æ’
            if (i > 0) {
                const prevLine = lines[i-1];
                if (prevLine.trim().endsWith(':')) {
                    errors.push(`ç¬¬ ${i+1} è¡Œå¯èƒ½éœ€è¦ç¸®æ’`);
                }
            }
        }
    }
    
    if (errors.length === 0) {
        showAlert('ç¨‹å¼ç¢¼èªæ³•æª¢æŸ¥é€šé', 'success');
    } else {
        showAlert('ç™¼ç¾èªæ³•éŒ¯èª¤ï¼š' + errors.join(', '), 'warning');
    }
}

// è¼‰å…¥ç­–ç•¥åˆ—è¡¨
async function loadStrategies() {
    try {
        const response = await fetch('/api/strategies/custom');
        const data = await response.json();
        
        if (data.status === 'success') {
            strategies = data.strategies;
            renderStrategyList();
        }
    } catch (error) {
        console.error('è¼‰å…¥ç­–ç•¥å¤±æ•—:', error);
        showAlert('è¼‰å…¥ç­–ç•¥å¤±æ•—', 'danger');
    }
}

// è¼‰å…¥å¿«å–æª”æ¡ˆåˆ—è¡¨
async function loadCacheFiles() {
    try {
        const response = await fetch('/api/cache/files');
        const data = await response.json();
        
        if (data.status === 'success' && data.data.files.length > 0) {
            // æ›´æ–°ç­–ç•¥ä½¿ç”¨è¡¨æ ¼çš„ä¸‹æ‹‰é¸å–®
            const select = document.getElementById('strategyDataTable');
            
            // ä¿ç•™è‡ªå‹•é¸æ“‡é¸é …
            const autoOption = select.options[0];
            
            // æ¸…ç©ºé¸é …
            select.innerHTML = '';
            
            // é‡æ–°æ·»åŠ è‡ªå‹•é¸æ“‡é¸é …
            select.appendChild(autoOption);
            
            // æ·»åŠ å¿«å–æª”æ¡ˆåˆ†éš”ç·š
            const separatorOption = document.createElement('option');
            separatorOption.value = '';
            separatorOption.textContent = '--- å¿«å–æª”æ¡ˆ ---';
            separatorOption.disabled = true;
            separatorOption.style.fontWeight = 'bold';
            separatorOption.style.backgroundColor = '#f8f9fa';
            select.appendChild(separatorOption);
            
            // æŒ‰è³‡æ–™é¡å‹åˆ†çµ„æ·»åŠ å¿«å–æª”æ¡ˆ
            if (data.data.grouped_files) {
                Object.keys(data.data.grouped_files).sort().forEach(dataType => {
                    const files = data.data.grouped_files[dataType];
                    
                    // æ·»åŠ è³‡æ–™é¡å‹æ¨™é¡Œ
                    const groupOption = document.createElement('option');
                    groupOption.value = '';
                    groupOption.textContent = `--- ${dataType} ---`;
                    groupOption.disabled = true;
                    groupOption.style.fontWeight = 'bold';
                    groupOption.style.backgroundColor = '#f8f9fa';
                    select.appendChild(groupOption);
                    
                    // æ·»åŠ è©²é¡å‹ä¸‹çš„æ‰€æœ‰æª”æ¡ˆ
                    files.forEach(fileInfo => {
                        const option = document.createElement('option');
                        option.value = fileInfo.cache_key;
                        // ä½¿ç”¨å‹å¥½çš„é¡¯ç¤ºåç¨±
                        const displayName = fileInfo.friendly_display_name || fileInfo.display_name;
                        option.textContent = `${displayName} (${fileInfo.size_mb}MB)`;
                        option.title = `æª”æ¡ˆ: ${fileInfo.filename}\nä¿®æ”¹æ™‚é–“: ${fileInfo.modified_time}\nåŸå§‹åç¨±: ${fileInfo.display_name}`;
                        select.appendChild(option);
                    });
                });
            }
        } else {
            // å¦‚æœæ²’æœ‰å¿«å–æª”æ¡ˆï¼Œé¡¯ç¤ºæç¤º
            const select = document.getElementById('strategyDataTable');
            const autoOption = select.options[0];
            
            // æ¸…ç©ºé¸é …
            select.innerHTML = '';
            
            // é‡æ–°æ·»åŠ è‡ªå‹•é¸æ“‡é¸é …
            select.appendChild(autoOption);
            
            // æ·»åŠ å¿«å–æª”æ¡ˆåˆ†éš”ç·š
            const separatorOption = document.createElement('option');
            separatorOption.value = '';
            separatorOption.textContent = '--- å¿«å–æª”æ¡ˆ ---';
            separatorOption.disabled = true;
            separatorOption.style.fontWeight = 'bold';
            separatorOption.style.backgroundColor = '#f8f9fa';
            select.appendChild(separatorOption);
            
            const noFilesOption = document.createElement('option');
            noFilesOption.value = '';
            noFilesOption.textContent = '--- ç„¡å¿«å–æª”æ¡ˆ ---';
            noFilesOption.disabled = true;
            select.appendChild(noFilesOption);
        }
    } catch (error) {
        console.error('è¼‰å…¥å¿«å–æª”æ¡ˆå¤±æ•—:', error);
    }
}

// æ›´æ–°ç­–ç•¥è¡¨æ ¼é¸é …
function updateStrategyTableOptions(cacheFiles, groupedFiles) {
    const select = document.getElementById('strategyDataTable');
    
    // ä¿ç•™å‰å…©å€‹é¸é …ï¼ˆè‡ªå‹•é¸æ“‡å’Œåˆ†éš”ç·šï¼‰
    const autoOption = select.options[0];
    const separatorOption = select.options[1];
    
    // æ¸…ç©ºé¸é …
    select.innerHTML = '';
    
    // é‡æ–°æ·»åŠ è‡ªå‹•é¸æ“‡é¸é …
    select.appendChild(autoOption);
    select.appendChild(separatorOption);
    
    // æŒ‰è³‡æ–™é¡å‹åˆ†çµ„æ·»åŠ å¿«å–æª”æ¡ˆ
    Object.keys(groupedFiles).sort().forEach(dataType => {
        const files = groupedFiles[dataType];
        
        // æ·»åŠ è³‡æ–™é¡å‹æ¨™é¡Œ
        const groupOption = document.createElement('option');
        groupOption.value = '';
        groupOption.textContent = `--- ${dataType} ---`;
        groupOption.disabled = true;
        groupOption.style.fontWeight = 'bold';
        groupOption.style.backgroundColor = '#f8f9fa';
        select.appendChild(groupOption);
        
        // æ·»åŠ è©²é¡å‹ä¸‹çš„æ‰€æœ‰æª”æ¡ˆ
        files.forEach(fileInfo => {
            const option = document.createElement('option');
            option.value = fileInfo.cache_key;
            // ä½¿ç”¨å‹å¥½çš„é¡¯ç¤ºåç¨±
            const displayName = fileInfo.friendly_display_name || fileInfo.display_name;
            option.textContent = `${displayName} (${fileInfo.size_mb}MB)`;
            option.title = `æª”æ¡ˆ: ${fileInfo.filename}\nä¿®æ”¹æ™‚é–“: ${fileInfo.modified_time}\nåŸå§‹åç¨±: ${fileInfo.display_name}`;
            select.appendChild(option);
        });
    });
    
    // å¦‚æœæ²’æœ‰å¿«å–æª”æ¡ˆï¼Œé¡¯ç¤ºæç¤º
    if (cacheFiles.length === 0) {
        const noFilesOption = document.createElement('option');
        noFilesOption.value = '';
        noFilesOption.textContent = '--- ç„¡å¿«å–æª”æ¡ˆ ---';
        noFilesOption.disabled = true;
        select.appendChild(noFilesOption);
    }
}

// é‡æ–°æ•´ç†å¿«å–æª”æ¡ˆ
async function refreshCacheFiles() {
    try {
        showAlert('æ­£åœ¨é‡æ–°æ•´ç†å¿«å–æª”æ¡ˆ...', 'info');
        await loadCacheFiles();
        showAlert('å¿«å–æª”æ¡ˆé‡æ–°æ•´ç†å®Œæˆ', 'success');
    } catch (error) {
        console.error('é‡æ–°æ•´ç†å¿«å–æª”æ¡ˆå¤±æ•—:', error);
        showAlert('é‡æ–°æ•´ç†å¿«å–æª”æ¡ˆå¤±æ•—', 'danger');
    }
}

// æ¸²æŸ“ç­–ç•¥åˆ—è¡¨
function renderStrategyList() {
    const container = document.getElementById('strategyList');
    container.innerHTML = '';
    
    // åˆ†é›¢å·²ç¢ºèªå’Œæœªç¢ºèªçš„ç­–ç•¥
    const confirmedStrategies = [];
    const unconfirmedStrategies = [];
    
    strategies.forEach(strategy => {
        if (strategy.is_confirmed) {
            confirmedStrategies.push(strategy);
        } else {
            unconfirmedStrategies.push(strategy);
        }
    });
    
    // å…ˆæ·»åŠ å·²ç¢ºèªçš„ç­–ç•¥ï¼ˆé¡¯ç¤ºåœ¨ä¸Šæ–¹ï¼‰
    if (confirmedStrategies.length > 0) {
        // æ·»åŠ å·²ç¢ºèªç­–ç•¥çš„åˆ†éš”æ¨™é¡Œ
        const confirmedHeader = document.createElement('div');
        confirmedHeader.className = 'list-group-item list-group-item-secondary';
        confirmedHeader.innerHTML = '<small class="text-muted"><strong>âœ… å·²ç¢ºèªç­–ç•¥</strong></small>';
        container.appendChild(confirmedHeader);
        
        confirmedStrategies.forEach(strategy => {
            const item = document.createElement('div');
            item.className = 'list-group-item list-group-item-action';
            item.onclick = () => loadStrategy(strategy.id);
            
            item.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">âœ… ${strategy.name}</h6>
                        <small class="text-muted">${strategy.description}</small>
                    </div>
                    <small class="text-muted">${new Date(strategy.updated_at).toLocaleDateString()}</small>
                </div>
            `;
            
            container.appendChild(item);
        });
    }
    
    // å†æ·»åŠ æœªç¢ºèªçš„ç­–ç•¥
    if (unconfirmedStrategies.length > 0) {
        // æ·»åŠ æœªç¢ºèªç­–ç•¥çš„åˆ†éš”æ¨™é¡Œ
        const unconfirmedHeader = document.createElement('div');
        unconfirmedHeader.className = 'list-group-item list-group-item-secondary';
        unconfirmedHeader.innerHTML = '<small class="text-muted"><strong>ğŸ“ ç·¨è¼¯ä¸­ç­–ç•¥</strong></small>';
        container.appendChild(unconfirmedHeader);
        
        unconfirmedStrategies.forEach(strategy => {
            const item = document.createElement('div');
            item.className = 'list-group-item list-group-item-action';
            item.onclick = () => loadStrategy(strategy.id);
            
            item.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">ğŸ“ ${strategy.name}</h6>
                        <small class="text-muted">${strategy.description}</small>
                    </div>
                    <small class="text-muted">${new Date(strategy.updated_at).toLocaleDateString()}</small>
                </div>
            `;
            
            container.appendChild(item);
        });
    }
}

// æœå°‹ç­–ç•¥
function searchStrategies() {
    const keyword = document.getElementById('searchStrategy').value.toLowerCase();
    const items = document.querySelectorAll('#strategyList .list-group-item');
    
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        if (text.includes(keyword)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// è¼‰å…¥ç­–ç•¥
async function loadStrategy(strategyId) {
    try {
        // åœ¨è¼‰å…¥æ–°ç­–ç•¥å‰ï¼Œæ¸…é™¤ Jupyter è¼¸å‡ºå’Œè®Šæ•¸
        await clearJupyterSilently();
        
        const response = await fetch(`/api/strategies/custom/${strategyId}`);
        const data = await response.json();
        if (data.status === 'success') {
            const strategy = data.strategy;
            currentStrategyId = strategy.id;
            document.getElementById('strategyName').value = strategy.name;
            document.getElementById('strategyDescription').value = strategy.description;
            document.getElementById('strategyCode').value = strategy.code;
            
            // æª¢æŸ¥ç­–ç•¥çš„ç·¨è¼¯æ¨¡å¼
            const editorMode = strategy.editor_mode || 'jupyter';
            const jupyterStrategyType = strategy.jupyter_strategy_type || 'analysis';
            
            if (editorMode === 'traditional') {
                // å‚³çµ±æ¨¡å¼
                isJupyterMode = false;
                const jupyterEditor = document.getElementById('jupyterEditor');
                const traditionalEditor = document.getElementById('traditionalEditor');
                const jupyterModeBtn = document.getElementById('jupyterModeBtn');
                
                if (jupyterEditor && traditionalEditor && jupyterModeBtn) {
                    jupyterEditor.style.display = 'none';
                    traditionalEditor.style.display = 'block';
                    jupyterModeBtn.innerHTML = '<i class="fas fa-play"></i> åˆ‡æ› Jupyter æ¨¡å¼';
                    jupyterModeBtn.className = 'btn btn-sm btn-outline-secondary';
                }
                
                initializeCodeEditor();
                window.codeEditor.setValue(strategy.code);
            } else {
                // é è¨­ä½¿ç”¨ Jupyter æ¨¡å¼
                isJupyterMode = true;
                showJupyterEditor(); // <--- å–ä»£ toggleJupyterMode()
                
                // å˜—è©¦è¼‰å…¥ Jupyter notebook çµæ§‹
                try {
                    const notebookResponse = await fetch(`/api/jupyter/notebook/${strategyId}`);
                    const notebookData = await notebookResponse.json();
                    
                    if (notebookData.status === 'success' && notebookData.notebook.cells) {
                        // è¼‰å…¥å„²å­˜çš„ cell çµæ§‹
                        loadJupyterNotebookFromBackend(notebookData.notebook);
                    } else {
                        // å¦‚æœæ²’æœ‰ cell çµæ§‹ï¼Œä½¿ç”¨åˆä½µçš„ç¨‹å¼ç¢¼
                        loadStrategyCodeToJupyter(strategy.code, jupyterStrategyType);
                    }
                } catch (notebookError) {
                    console.warn('è¼‰å…¥ Jupyter notebook çµæ§‹å¤±æ•—ï¼Œä½¿ç”¨åˆä½µç¨‹å¼ç¢¼:', notebookError);
                    loadStrategyCodeToJupyter(strategy.code, jupyterStrategyType);
                }
            }
            
            document.getElementById('editorTitle').textContent = `ç·¨è¼¯ç­–ç•¥: ${strategy.name}`;
            updateParameterConfig(strategy.parameters);
        }
    } catch (error) {
        console.error('è¼‰å…¥ç­–ç•¥å¤±æ•—:', error);
        showAlert('è¼‰å…¥ç­–ç•¥å¤±æ•—', 'danger');
    }
}

// æ›´æ–°åƒæ•¸é…ç½®
function updateParameterConfig(parameters) {
    const container = document.getElementById('parameterConfig');
    const parameterContainer = document.getElementById('parameterContainer');
    const parameterEmpty = document.getElementById('parameterEmpty');
    
    if (!parameters || Object.keys(parameters).length === 0) {
        if (parameterContainer) {
            parameterContainer.innerHTML = '';
        }
        if (parameterEmpty) {
            parameterEmpty.style.display = 'block';
        }
        return;
    }
    
    // éš±è—ç©ºç‹€æ…‹
    if (parameterEmpty) {
        parameterEmpty.style.display = 'none';
    }
    
    // ç¢ºä¿åƒæ•¸å®¹å™¨å­˜åœ¨
    if (!parameterContainer) {
        container.innerHTML = `
            <div id="parameterContainer" class="strategy-params-grid">
                <!-- åƒæ•¸æœƒåœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
            </div>
            <div id="parameterEmpty" class="text-center text-muted py-4" style="display: none;">
                <i class="fas fa-cog fa-2x mb-2"></i>
                <p>åƒæ•¸é…ç½®å°‡æ ¹æ“šç¨‹å¼ç¢¼è‡ªå‹•ç”Ÿæˆ</p>
            </div>
        `;
    }
    
    // æ¸…ç©ºç¾æœ‰åƒæ•¸
    const newParameterContainer = document.getElementById('parameterContainer');
    newParameterContainer.innerHTML = '';
    
    // ç”Ÿæˆåƒæ•¸ HTML
    Object.entries(parameters).forEach(([key, config]) => {
        const parameterHtml = generateParameterHtml(key, config);
        newParameterContainer.insertAdjacentHTML('beforeend', parameterHtml);
    });
    
    // å¦‚æœæ’åºæ¨¡å¼é–‹å•Ÿï¼Œåˆå§‹åŒ–æ‹–æ‹½
    if (isSortMode) {
        initializeSortable();
    }
}

// ç”Ÿæˆåƒæ•¸HTML
function generateParameterHtml(key, config) {
    return `
        <div class="parameter-item mb-2" data-key="${key}">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title mb-0 text-primary" style="font-size: 0.8rem;">${config.label || key}</h6>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeParameter('${key}')" style="font-size: 0.7rem;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="row g-1">
                        <div class="col-6">
                            <label class="form-label small text-muted" style="font-size: 0.7rem;">åƒæ•¸åç¨±</label>
                            <input type="text" class="form-control form-control-sm parameter-key" value="${key}" onchange="updateParameterKey('${key}', this.value)" style="font-size: 0.75rem;">
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted" style="font-size: 0.7rem;">é¡¯ç¤ºåç¨±</label>
                            <input type="text" class="form-control form-control-sm parameter-label" value="${config.label || ''}" onchange="updateParameterLabel('${key}', this.value)" style="font-size: 0.75rem;">
                        </div>
                    </div>
                    <div class="row g-1 mt-1">
                        <div class="col-6">
                            <label class="form-label small text-muted" style="font-size: 0.7rem;">é¡å‹</label>
                            <select class="form-select form-select-sm parameter-type" onchange="updateParameterType('${key}', this.value)" style="font-size: 0.75rem;">
                                <option value="number" ${config.type === 'number' ? 'selected' : ''}>æ•¸å­—</option>
                                <option value="text" ${config.type === 'text' ? 'selected' : ''}>æ–‡å­—</option>
                                <option value="select" ${config.type === 'select' ? 'selected' : ''}>é¸é …</option>
                                <option value="boolean" ${config.type === 'boolean' ? 'selected' : ''}>å¸ƒæ—å€¼</option>
                                <option value="date" ${config.type === 'date' ? 'selected' : ''}>æ—¥æœŸ</option>
                                <option value="dynamic" ${config.type === 'dynamic' ? 'selected' : ''}>å‹•æ…‹åƒæ•¸</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted" style="font-size: 0.7rem;">é è¨­å€¼</label>
                            ${config.type === 'boolean' ? 
                                `<div class="d-flex align-items-center">
                                    <div class="custom-toggle-switch ${config.default === true || config.default === 'true' || config.default === 1 ? 'active' : ''}" onclick="toggleCustomSwitch('default-${key}')">
                                        <input type="checkbox" class="parameter-default" id="default-${key}" 
                                               ${config.default === true || config.default === 'true' || config.default === 1 ? 'checked' : ''} 
                                               onchange="updateParameterDefault('${key}', this.checked)">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <label class="form-check-label small ms-2" style="font-size: 0.7rem;">å•Ÿç”¨</label>
                                </div>` :
                                config.type === 'select' ?
                                `<select class="form-select form-select-sm parameter-default" onchange="updateParameterDefault('${key}', this.value)" style="font-size: 0.75rem;">
                                    <option value="">è«‹é¸æ“‡...</option>
                                    ${config.options ? config.options.map(opt => 
                                        `<option value="${opt.value}" ${opt.value === config.default ? 'selected' : ''}>${opt.label}</option>`
                                    ).join('') : ''}
                                </select>` :
                                config.type === 'date' ?
                                `<input type="date" class="form-control form-control-sm parameter-default" 
                                        value="${config.default || ''}" onchange="updateParameterDefault('${key}', this.value)" style="font-size: 0.75rem;">` :
                                `<input type="text" class="form-control form-control-sm parameter-default" 
                                        value="${config.default || ''}" onchange="updateParameterDefault('${key}', this.value)" style="font-size: 0.75rem;">`
                            }
                        </div>
                    </div>
                    <div class="row g-1 mt-1">
                        <div class="col-6">
                            <label class="form-label small text-muted" style="font-size: 0.7rem;">æœ€å°å€¼</label>
                            <input type="number" class="form-control form-control-sm parameter-min" value="${config.min || ''}" onchange="updateParameterMin('${key}', this.value)" style="font-size: 0.75rem;">
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted" style="font-size: 0.7rem;">æœ€å¤§å€¼</label>
                            <input type="number" class="form-control form-control-sm parameter-max" value="${config.max || ''}" onchange="updateParameterMax('${key}', this.value)" style="font-size: 0.75rem;">
                        </div>
                    </div>
                    <div class="row g-1 mt-1">
                        <div class="col-6">
                            <label class="form-label small text-muted" style="font-size: 0.7rem;">æ­¥é•·</label>
                            <input type="number" class="form-control form-control-sm parameter-step" value="${config.step || ''}" onchange="updateParameterStep('${key}', this.value)" style="font-size: 0.75rem;">
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted" style="font-size: 0.7rem;">å¢é‡</label>
                            <input type="number" class="form-control form-control-sm parameter-increment" value="${config.increment || ''}" onchange="updateParameterIncrement('${key}', this.value)" placeholder="å‹•æ…‹åƒæ•¸å¢é‡" style="font-size: 0.75rem;">
                        </div>
                    </div>
                    <div class="row g-1 mt-1">
                        <div class="col-12">
                            <label class="form-label small text-muted" style="font-size: 0.7rem;">æè¿°</label>
                            <input type="text" class="form-control form-control-sm parameter-description" value="${config.description || ''}" onchange="updateParameterDescription('${key}', this.value)" style="font-size: 0.75rem;">
                        </div>
                    </div>
                    <div class="w-100" id="dynamic-param-info-${key}" style="display: ${config.type === 'dynamic' ? 'block' : 'none'};">
                        <div class="alert alert-info alert-sm py-2" style="font-size: 0.7rem;">
                            <strong>å‹•æ…‹åƒæ•¸èªªæ˜ï¼š</strong><br>
                            â€¢ åˆå§‹å€¼ï¼š${config.default || 0}<br>
                            â€¢ å¢é‡ï¼š${config.increment || 1}<br>
                            â€¢ æ¯æ¬¡ä¸å‡ºå ´æ™‚è‡ªå‹•å¢åŠ ï¼Œå‡ºå ´æ™‚é‡ç½®ç‚ºåˆå§‹å€¼
                        </div>
                    </div>
                    <div class="w-100" id="select-options-${key}" style="display: ${config.type === 'select' ? 'block' : 'none'};">
                        <div class="row g-1 mt-1">
                            <div class="col-12">
                                <label class="form-label small text-muted" style="font-size: 0.7rem;">é¸é …è¨­å®š</label>
                                <div class="d-flex gap-1">
                                    <input type="text" class="form-control form-control-sm parameter-options" 
                                           value="${config.options ? config.options.map(opt => `${opt.value}:${opt.label}`).join(';') : ''}" 
                                           onchange="updateParameterOptions('${key}', this.value)" 
                                           placeholder="æ ¼å¼: å€¼1:æ¨™ç±¤1;å€¼2:æ¨™ç±¤2" style="font-size: 0.75rem;">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addSelectOption('${key}')" style="font-size: 0.7rem;">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div class="form-text" style="font-size: 0.65rem;">è«‹ä½¿ç”¨æ ¼å¼ï¼šå€¼:æ¨™ç±¤ï¼Œå¤šå€‹é¸é …ç”¨åˆ†è™Ÿåˆ†éš”</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// æ–°å¢åƒæ•¸
function addNewParameter() {
    const newKey = `param_${Date.now()}`;
    const newConfig = {
        type: 'number',
        label: 'æ–°åƒæ•¸',
        default: 0,
        min: 0,
        max: 100,
        step: 1,
        description: 'åƒæ•¸æè¿°'
    };
    
    const container = document.getElementById('parameterContainer');
    if (!container) {
        // å¦‚æœæ²’æœ‰åƒæ•¸å®¹å™¨ï¼Œé‡æ–°åˆå§‹åŒ–
        updateParameterConfig({});
        return;
    }
    
    const parameterHtml = generateParameterHtml(newKey, newConfig);
    container.insertAdjacentHTML('beforeend', parameterHtml);
    
    // æ›´æ–°ç­–ç•¥åƒæ•¸
    updateStrategyParameters();
    
    // å¦‚æœæ’åºæ¨¡å¼é–‹å•Ÿï¼Œé‡æ–°åˆå§‹åŒ–æ‹–æ‹½
    if (isSortMode) {
        initializeSortable();
    }
}

// ç§»é™¤åƒæ•¸
function removeParameter(key) {
    if (confirm('ç¢ºå®šè¦ç§»é™¤é€™å€‹åƒæ•¸å—ï¼Ÿ')) {
        const element = document.querySelector(`[data-key="${key}"]`);
        if (element) {
            element.remove();
            updateStrategyParameters();
        }
    }
}

// æ›´æ–°åƒæ•¸éµå
function updateParameterKey(oldKey, newKey) {
    if (oldKey === newKey) return;
    
    const element = document.querySelector(`[data-key="${oldKey}"]`);
    if (element) {
        element.setAttribute('data-key', newKey);
        updateStrategyParameters();
    }
}

// æ›´æ–°åƒæ•¸æ¨™ç±¤
function updateParameterLabel(key, label) {
    updateStrategyParameters();
}

// æ›´æ–°åƒæ•¸é¡å‹
function updateParameterType(key, type) {
    updateStrategyParameters();
    
    // é¡¯ç¤º/éš±è—å‹•æ…‹åƒæ•¸èªªæ˜
    const infoElement = document.getElementById(`dynamic-param-info-${key}`);
    if (infoElement) {
        infoElement.style.display = type === 'dynamic' ? 'block' : 'none';
    }
    
    // é¡¯ç¤º/éš±è—é¸é …è¨­å®šå€åŸŸ
    const optionsElement = document.getElementById(`select-options-${key}`);
    if (optionsElement) {
        optionsElement.style.display = type === 'select' ? 'block' : 'none';
    }
    
    // æ›´æ–°é è¨­å€¼é¡¯ç¤ºæ–¹å¼
    const paramItem = document.querySelector(`[data-key="${key}"]`);
    if (paramItem) {
        // æ‰¾åˆ°åŒ…å«é è¨­å€¼æ¨™ç±¤çš„æ¬„ä½ - ä½¿ç”¨æ›´ç°¡å–®çš„æ–¹æ³•
        let defaultContainer = null;
        const rows = paramItem.querySelectorAll('.row');
        if (rows.length >= 2) {
            const secondRow = rows[1];
            const cols = secondRow.querySelectorAll('.col-6');
            if (cols.length >= 2) {
                // æª¢æŸ¥ç¬¬äºŒå€‹æ¬„ä½æ˜¯å¦åŒ…å«é è¨­å€¼æ¨™ç±¤
                const secondCol = cols[1];
                const label = secondCol.querySelector('label');
                if (label && label.textContent.includes('é è¨­å€¼')) {
                    defaultContainer = secondCol;
                }
            }
        }
        
        // å¦‚æœé‚„æ˜¯æ‰¾ä¸åˆ°ï¼Œä½¿ç”¨å‚™ç”¨é¸æ“‡å™¨
        if (!defaultContainer) {
            defaultContainer = paramItem.querySelector('.row:nth-child(2) .col-6:nth-child(2)');
        }
        
        if (defaultContainer) {
            // å–å¾—ç•¶å‰çš„é è¨­å€¼
            const currentDefault = paramItem.querySelector('.parameter-default');
            let currentValue = '';
            if (currentDefault && currentDefault.type === 'checkbox') {
                currentValue = currentDefault.checked;
            } else if (currentDefault && currentDefault.value) {
                currentValue = currentDefault.value;
            }
            
            if (type === 'boolean') {
                defaultContainer.innerHTML = `
                    <label class="form-label small text-muted" style="font-size: 0.7rem;">é è¨­å€¼</label>
                    <div class="d-flex align-items-center">
                        <div class="custom-toggle-switch ${currentValue ? 'active' : ''}" onclick="toggleCustomSwitch('default-${key}')">
                            <input type="checkbox" class="parameter-default" id="default-${key}" 
                                   ${currentValue ? 'checked' : ''}
                                   onchange="updateParameterDefault('${key}', this.checked)">
                            <div class="toggle-slider"></div>
                        </div>
                        <label class="form-check-label small ms-2" style="font-size: 0.7rem;">å•Ÿç”¨</label>
                    </div>
                `;
            } else if (type === 'select') {
                // å–å¾—ç•¶å‰çš„é¸é …è¨­å®š
                const currentOptions = window.currentStrategyParameters && window.currentStrategyParameters[key] ? window.currentStrategyParameters[key].options : [];
                const optionsHtml = currentOptions ? currentOptions.map(opt => 
                    `<option value="${opt.value}" ${opt.value === currentValue ? 'selected' : ''}>${opt.label}</option>`
                ).join('') : '';
                
                defaultContainer.innerHTML = `
                    <label class="form-label small text-muted" style="font-size: 0.7rem;">é è¨­å€¼</label>
                    <select class="form-select form-select-sm parameter-default" onchange="updateParameterDefault('${key}', this.value)" style="font-size: 0.75rem;">
                        <option value="">è«‹é¸æ“‡...</option>
                        ${optionsHtml}
                    </select>
                `;
                
                // ç¢ºä¿é¸é …è¨­å®šå€åŸŸé¡¯ç¤º
                if (optionsElement) {
                    optionsElement.style.display = 'block';
                }
            } else if (type === 'date') {
                defaultContainer.innerHTML = `
                    <label class="form-label small text-muted" style="font-size: 0.7rem;">é è¨­å€¼</label>
                    <input type="date" class="form-control form-control-sm parameter-default" 
                           value="${currentValue}" onchange="updateParameterDefault('${key}', this.value)" style="font-size: 0.75rem;">
                `;
            } else {
                defaultContainer.innerHTML = `
                    <label class="form-label small text-muted" style="font-size: 0.7rem;">é è¨­å€¼</label>
                    <input type="text" class="form-control form-control-sm parameter-default" 
                           value="${currentValue}" onchange="updateParameterDefault('${key}', this.value)" style="font-size: 0.75rem;">
                `;
            }
        }
    }
}

// æ›´æ–°åƒæ•¸é è¨­å€¼
function updateParameterDefault(key, defaultValue) {
    updateStrategyParameters();
}

// æ›´æ–°åƒæ•¸æœ€å°å€¼
function updateParameterMin(key, min) {
    updateStrategyParameters();
}

// æ›´æ–°åƒæ•¸æœ€å¤§å€¼
function updateParameterMax(key, max) {
    updateStrategyParameters();
}

// æ›´æ–°åƒæ•¸æ­¥é•·
function updateParameterStep(key, step) {
    updateStrategyParameters();
}

// æ›´æ–°åƒæ•¸æè¿°
function updateParameterDescription(key, description) {
    updateStrategyParameters();
}

// æ›´æ–°åƒæ•¸é¸é …
function updateParameterOptions(key, optionsString) {
    updateStrategyParameters();
    
    // æ›´æ–°é è¨­å€¼ä¸‹æ‹‰å¼é¸å–®
    const paramItem = document.querySelector(`[data-key="${key}"]`);
    if (paramItem) {
        const defaultSelect = paramItem.querySelector('.parameter-default');
        if (defaultSelect && defaultSelect.tagName === 'SELECT') {
            const currentValue = defaultSelect.value;
            
            // è§£æé¸é …å­—ä¸²
            const options = optionsString.split(';').map(opt => {
                const [value, label] = opt.split(':');
                return { value: value.trim(), label: label.trim() };
            }).filter(opt => opt.value && opt.label);
            
            // é‡æ–°ç”Ÿæˆé¸é …
            const optionsHtml = options.map(opt => 
                `<option value="${opt.value}" ${opt.value === currentValue ? 'selected' : ''}>${opt.label}</option>`
            ).join('');
            
            defaultSelect.innerHTML = `<option value="">è«‹é¸æ“‡...</option>${optionsHtml}`;
        }
    }
}

// æ–°å¢é¸é …
function addSelectOption(key) {
    const paramItem = document.querySelector(`[data-key="${key}"]`);
    if (paramItem) {
        const optionsInput = paramItem.querySelector('.parameter-options');
        const currentValue = optionsInput.value;
        const newOption = prompt('è«‹è¼¸å…¥æ–°é¸é … (æ ¼å¼: å€¼:æ¨™ç±¤)', 'new_value:æ–°é¸é …');
        
        if (newOption && newOption.includes(':')) {
            const newValue = currentValue ? currentValue + ';' + newOption : newOption;
            optionsInput.value = newValue;
            updateParameterOptions(key, newValue);
        }
    }
}

// æ›´æ–°ç­–ç•¥åƒæ•¸
function updateStrategyParameters() {
    const parameters = {};
    const parameterItems = document.querySelectorAll('.parameter-item');
    
    parameterItems.forEach(item => {
        const key = item.getAttribute('data-key');
        const label = item.querySelector('.parameter-label').value;
        const type = item.querySelector('.parameter-type').value;
        const defaultElement = item.querySelector('.parameter-default');
        let defaultValue;
        if (defaultElement.type === 'checkbox') {
            defaultValue = defaultElement.checked;
        } else {
            defaultValue = defaultElement.value;
        }
        const min = item.querySelector('.parameter-min').value;
        const max = item.querySelector('.parameter-max').value;
        const step = item.querySelector('.parameter-step').value;
        const increment = item.querySelector('.parameter-increment').value;
        const description = item.querySelector('.parameter-description').value;
        
        // å–å¾—é¸é …è¨­å®šï¼ˆå¦‚æœæ˜¯é¸é …é¡å‹ï¼‰
        let options = undefined;
        if (type === 'select') {
            const optionsInput = item.querySelector('.parameter-options');
            if (optionsInput && optionsInput.value) {
                options = optionsInput.value.split(';').map(opt => {
                    const [value, label] = opt.split(':');
                    return { value: value.trim(), label: label.trim() };
                }).filter(opt => opt.value && opt.label);
            }
        }
        
        const paramConfig = {
            type: type,
            label: label,
            description: description
        };
        
        // æ ¹æ“šé¡å‹è¨­å®šä¸åŒçš„å±¬æ€§
        if (type === 'number') {
            paramConfig.default = parseFloat(defaultValue) || 0;
            paramConfig.min = parseFloat(min) || undefined;
            paramConfig.max = parseFloat(max) || undefined;
            paramConfig.step = parseFloat(step) || 1;
        } else if (type === 'dynamic') {
            paramConfig.default = parseFloat(defaultValue) || 0;
            paramConfig.increment = parseFloat(increment) || 1;
        } else if (type === 'boolean') {
            // å¸ƒæ—å€¼ç‰¹æ®Šè™•ç†
            if (defaultValue === 'true' || defaultValue === '1' || defaultValue === true) {
                paramConfig.default = true;
            } else if (defaultValue === 'false' || defaultValue === '0' || defaultValue === false) {
                paramConfig.default = false;
            } else {
                paramConfig.default = false; // é è¨­ç‚º false
            }
        } else if (type === 'select') {
            if (options && options.length > 0) {
                paramConfig.options = options;
                paramConfig.default = defaultValue || options[0].value; // å¦‚æœæ²’æœ‰é è¨­å€¼ï¼Œä½¿ç”¨ç¬¬ä¸€å€‹é¸é …
            } else {
                // å¦‚æœæ²’æœ‰é¸é …ï¼Œæä¾›é è¨­é¸é …
                const defaultOptions = [
                    { value: "option1", label: "é¸é …1" },
                    { value: "option2", label: "é¸é …2" }
                ];
                paramConfig.options = defaultOptions;
                paramConfig.default = defaultValue || defaultOptions[0].value; // ä½¿ç”¨ç¬¬ä¸€å€‹é¸é …ä½œç‚ºé è¨­å€¼
            }
        } else if (type === 'date') {
            paramConfig.default = defaultValue;
        } else {
            paramConfig.default = defaultValue;
        }
        
        parameters[key] = paramConfig;
    });
    
    // å„²å­˜åˆ°å…¨åŸŸè®Šæ•¸ï¼Œä¾›å„²å­˜ç­–ç•¥æ™‚ä½¿ç”¨
    window.currentStrategyParameters = parameters;
}

// æ–°å»ºç­–ç•¥
function createNewStrategy() {
    document.getElementById('newStrategyName').value = '';
    document.getElementById('newStrategyDescription').value = '';
    document.getElementById('modeJupyter').checked = true;
    document.getElementById('typeVectorized').checked = true;
    document.getElementById('jupyterTypeVectorized').checked = true;
    
    // è¨­å®šç·¨è¼¯æ¨¡å¼åˆ‡æ›äº‹ä»¶
    setupEditorModeToggle();
    
    const modal = new bootstrap.Modal(document.getElementById('newStrategyModal'));
    modal.show();
}

// è¨­å®šç·¨è¼¯æ¨¡å¼åˆ‡æ›
function setupEditorModeToggle() {
    const traditionalMode = document.getElementById('modeTraditional');
    const jupyterMode = document.getElementById('modeJupyter');
    const strategyTypeSection = document.getElementById('strategyTypeSection');
    const jupyterStrategyTypeSection = document.getElementById('jupyterStrategyTypeSection');
    
    function toggleStrategyTypeSections() {
        if (traditionalMode.checked) {
            strategyTypeSection.style.display = 'block';
            jupyterStrategyTypeSection.style.display = 'none';
        } else {
            strategyTypeSection.style.display = 'none';
            jupyterStrategyTypeSection.style.display = 'block';
        }
    }
    
    // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨
    traditionalMode.removeEventListener('change', toggleStrategyTypeSections);
    jupyterMode.removeEventListener('change', toggleStrategyTypeSections);
    
    // æ·»åŠ æ–°çš„äº‹ä»¶ç›£è½å™¨
    traditionalMode.addEventListener('change', toggleStrategyTypeSections);
    jupyterMode.addEventListener('change', toggleStrategyTypeSections);
    
    // åˆå§‹åŒ–é¡¯ç¤ºç‹€æ…‹
    toggleStrategyTypeSections();
}

// ç¢ºèªæ–°å»ºç­–ç•¥
async function confirmCreateStrategy() {
    const name = document.getElementById('newStrategyName').value.trim();
    const description = document.getElementById('newStrategyDescription').value.trim();
    const editorMode = document.querySelector('input[name="editorMode"]:checked').value;
    
    if (!name) {
        showAlert('è«‹è¼¸å…¥ç­–ç•¥åç¨±', 'warning');
        return;
    }
    
    let strategyType = 'mixed';
    let jupyterStrategyType = 'analysis';
    
    if (editorMode === 'traditional') {
        strategyType = document.querySelector('input[name="strategyType"]:checked').value;
    } else {
        jupyterStrategyType = document.querySelector('input[name="jupyterStrategyType"]:checked').value;
    }
    
    try {
        const response = await fetch('/api/strategies/custom', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name,
                description: description,
                type: strategyType,
                editor_mode: editorMode,
                jupyter_strategy_type: jupyterStrategyType
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showAlert('ç­–ç•¥å»ºç«‹æˆåŠŸ', 'success');
            bootstrap.Modal.getInstance(document.getElementById('newStrategyModal')).hide();
            await loadStrategies();
            
            // ç›´æ¥è¨­å®šç­–ç•¥è³‡è¨Šï¼Œé¿å… loadStrategy è¦†è“‹ç·¨è¼¯å™¨è¨­å®š
            currentStrategyId = data.strategy_id;
            document.getElementById('strategyName').value = name;
            document.getElementById('strategyDescription').value = description;
            document.getElementById('editorTitle').textContent = `ç·¨è¼¯ç­–ç•¥: ${name}`;
            
            // æ ¹æ“šç·¨è¼¯æ¨¡å¼åˆå§‹åŒ–ç·¨è¼¯å™¨
            if (editorMode === 'jupyter') {
                // è‡ªå‹•åˆ‡æ›åˆ° Jupyter æ¨¡å¼
                isJupyterMode = true;
                showJupyterEditor();
                
                // æ ¹æ“š Jupyter ç­–ç•¥é¡å‹è¼‰å…¥å°æ‡‰çš„ç¯„ä¾‹ç¨‹å¼ç¢¼
                loadJupyterStrategyTemplate(jupyterStrategyType);
            } else {
                // å‚³çµ±æ¨¡å¼
                isJupyterMode = false;
                const jupyterEditor = document.getElementById('jupyterEditor');
                const traditionalEditor = document.getElementById('traditionalEditor');
                const jupyterModeBtn = document.getElementById('jupyterModeBtn');
                
                if (jupyterEditor && traditionalEditor && jupyterModeBtn) {
                    jupyterEditor.style.display = 'none';
                    traditionalEditor.style.display = 'block';
                    jupyterModeBtn.innerHTML = '<i class="fas fa-play"></i> åˆ‡æ› Jupyter æ¨¡å¼';
                    jupyterModeBtn.className = 'btn btn-sm btn-outline-secondary';
                }
                
                initializeCodeEditor();
                window.codeEditor.setValue('');
            }
        } else {
            showAlert(data.message || 'å»ºç«‹ç­–ç•¥å¤±æ•—', 'danger');
        }
    } catch (error) {
        console.error('å»ºç«‹ç­–ç•¥å¤±æ•—:', error);
        showAlert('å»ºç«‹ç­–ç•¥å¤±æ•—', 'danger');
    }
}

// å„²å­˜ç­–ç•¥
async function saveStrategy() {
    if (!currentStrategyId) {
        showAlert('è«‹å…ˆé¸æ“‡æˆ–å»ºç«‹ç­–ç•¥', 'warning');
        return;
    }
    const name = document.getElementById('strategyName').value.trim();
    const description = document.getElementById('strategyDescription').value.trim();
    // æ ¹æ“šç·¨è¼¯æ¨¡å¼å–å¾—ç¨‹å¼ç¢¼
    let code = '';
    if (isJupyterMode) {
        code = window.jupyterMergedCode || '';
        window.jupyterMergedCode = undefined;
    } else {
        code = codeEditor ? codeEditor.getValue().trim() : document.getElementById('strategyCode').value.trim();
    }
    if (!name || !code) {
        showAlert('è«‹å¡«å¯«ç­–ç•¥åç¨±å’Œç¨‹å¼ç¢¼', 'warning');
        return;
    }
    // å–å¾—ç•¶å‰ç·¨è¼¯çš„åƒæ•¸
    updateStrategyParameters();
    const parameters = window.currentStrategyParameters || {};
    try {
        const response = await fetch(`/api/strategies/custom/${currentStrategyId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name,
                description: description,
                code: code,
                parameters: parameters
            })
        });
        const data = await response.json();
        if (data.status === 'success') {
            showAlert('ç­–ç•¥å„²å­˜æˆåŠŸ', 'success');
            await loadStrategies();
            window.dispatchEvent(new CustomEvent('strategyUpdated', {
                detail: {
                    strategyId: currentStrategyId,
                    action: 'updated'
                }
            }));
        } else {
            showAlert(data.message || 'å„²å­˜ç­–ç•¥å¤±æ•—', 'danger');
        }
    } catch (error) {
        console.error('å„²å­˜ç­–ç•¥å¤±æ•—:', error);
        showAlert('å„²å­˜ç­–ç•¥å¤±æ•—', 'danger');
    }
}

// æ¸¬è©¦ç­–ç•¥
async function testStrategy() {
    if (!currentStrategyId) {
        showAlert('è«‹å…ˆé¸æ“‡ç­–ç•¥', 'warning');
        return;
    }
    
    // æ ¹æ“šç·¨è¼¯æ¨¡å¼å–å¾—ç¨‹å¼ç¢¼
    let code = '';
    if (isJupyterMode) {
        // å„ªå…ˆç”¨ window.jupyterMergedCode
        code = window.jupyterMergedCode || '';
        window.jupyterMergedCode = undefined;
    } else {
        code = codeEditor ? codeEditor.getValue().trim() : document.getElementById('strategyCode').value.trim();
    }
    const strategyTable = document.getElementById('strategyDataTable').value;
    const excelFile = document.getElementById('excelFile').files[0];
    
    if (!code) {
        showAlert('è«‹è¼¸å…¥ç­–ç•¥ç¨‹å¼ç¢¼', 'warning');
        return;
    }
    
    // æª¢æŸ¥è‚¡ç¥¨ä¾†æºé¸æ“‡
    const stockSource = document.querySelector('input[name="stockSource"]:checked');
    if (stockSource && stockSource.value === 'excel' && !excelFile) {
        showAlert('è«‹é¸æ“‡ Excel æª”æ¡ˆé€²è¡Œä¸Šå‚³', 'warning');
        return;
    }
    
    try {
        let response;
        
        // ä½¿ç”¨ FormData ä¸Šå‚³è³‡æ–™
        const formData = new FormData();
        formData.append('strategy_id', currentStrategyId);
        formData.append('code', code);
        formData.append('strategy_table', strategyTable);
        
        // æ·»åŠ æŒæœ‰è¨˜éŒ„åƒæ•¸
        const recordHoldingsSwitch = document.getElementById('recordHoldingsSwitch');
        if (recordHoldingsSwitch) {
            formData.append('param-record_holdings', recordHoldingsSwitch.checked ? '1' : '0');
        }
        
        // å¦‚æœæœ‰ Excel æª”æ¡ˆï¼Œå°±ä¸Šå‚³
        if (excelFile) {
            formData.append('excel_file', excelFile);
        }
        
        response = await fetch('/api/strategies/custom/test', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showTestResults(data.results);
        } else {
            showAlert(data.message || 'æ¸¬è©¦ç­–ç•¥å¤±æ•—', 'danger');
        }
    } catch (error) {
        console.error('æ¸¬è©¦ç­–ç•¥å¤±æ•—:', error);
        showAlert('æ¸¬è©¦ç­–ç•¥å¤±æ•—', 'danger');
    }
}

// é¡¯ç¤ºæ¸¬è©¦çµæœ
function showTestResults(results) {
    const container = document.getElementById('testOutput');
    const resultsDiv = document.getElementById('testResults');
    const tradeReportSection = document.getElementById('test');
    
    let html = '';
    
    if (results.validation) {
        html += '<div class="alert alert-success">èªæ³•é©—è­‰é€šé</div>';
    } else {
        html += '<div class="alert alert-danger">èªæ³•é©—è­‰å¤±æ•—</div>';
    }
    
    if (results.functions) {
        html += '<h6>æª¢æ¸¬åˆ°çš„å‡½æ•¸:</h6><ul>';
        results.functions.forEach(func => {
            html += `<li>${func}</li>`;
        });
        html += '</ul>';
    }
    
    if (results.errors) {
        html += '<h6>éŒ¯èª¤è¨Šæ¯:</h6><div class="alert alert-danger">';
        results.errors.forEach(error => {
            html += `<div>${error}</div>`;
        });
        html += '</div>';
    }
    
    // é¡¯ç¤ºå›æ¸¬çµæœ
    if (results.backtest_results) {
        html += '<h6>å›æ¸¬çµæœ:</h6>';
        
        if (results.backtest_results.message) {
            html += `<div class="alert alert-info">${results.backtest_results.message}</div>`;
        } else {
            html += '<div class="table-responsive">';
            html += '<table class="table table-sm table-bordered">';
            html += '<tbody>';
            
            // é¡¯ç¤ºè³‡æ–™ä¾†æºè³‡è¨Š
            if (results.backtest_results.data_source !== undefined) {
                const sourceClass = results.backtest_results.data_source === 'å¿«å–' ? 'text-success' : 
                                  results.backtest_results.data_source === 'API' ? 'text-info' : 'text-warning';
                html += `<tr><td>è³‡æ–™ä¾†æº</td><td class="${sourceClass}">${results.backtest_results.data_source}</td></tr>`;
            }
            if (results.backtest_results.stock_id !== undefined) {
                html += `<tr><td>æ¸¬è©¦è‚¡ç¥¨ä»£ç¢¼</td><td>${results.backtest_results.stock_id}</td></tr>`;
            }
            if (results.backtest_results.data_type !== undefined) {
                html += `<tr><td>è³‡æ–™é¡å‹</td><td>${results.backtest_results.data_type}</td></tr>`;
            }
            if (results.backtest_results.date_range !== undefined) {
                html += `<tr><td>æ—¥æœŸç¯„åœ</td><td>${results.backtest_results.date_range}</td></tr>`;
            }
            if (results.backtest_results.data_count !== undefined) {
                html += `<tr><td>è³‡æ–™ç­†æ•¸</td><td>${results.backtest_results.data_count}</td></tr>`;
            }
            if (results.backtest_results.strategy_table !== undefined) {
                html += `<tr><td>ç­–ç•¥ä½¿ç”¨è¡¨æ ¼</td><td>${results.backtest_results.strategy_table}</td></tr>`;
            }
            
            if (results.backtest_results.total_trades !== undefined) {
                html += `<tr><td>ç¸½äº¤æ˜“æ¬¡æ•¸</td><td>${results.backtest_results.total_trades}</td></tr>`;
            }
            if (results.backtest_results.final_capital !== undefined) {
                html += `<tr><td>æœ€çµ‚è³‡é‡‘</td><td>${results.backtest_results.final_capital.toLocaleString()}</td></tr>`;
            }
            if (results.backtest_results.total_return !== undefined) {
                const returnClass = results.backtest_results.total_return >= 0 ? 'text-success' : 'text-danger';
                html += `<tr><td>ç¸½å ±é…¬ç‡</td><td class="${returnClass}">${results.backtest_results.total_return.toFixed(2)}%</td></tr>`;
            }
            if (results.backtest_results.win_rate !== undefined) {
                html += `<tr><td>å‹ç‡</td><td>${results.backtest_results.win_rate.toFixed(2)}%</td></tr>`;
            }
            if (results.backtest_results.max_drawdown !== undefined) {
                html += `<tr><td>æœ€å¤§å›æ’¤</td><td class="text-danger">${results.backtest_results.max_drawdown.toFixed(2)}%</td></tr>`;
            }
            if (results.backtest_results.sharpe_ratio !== undefined) {
                html += `<tr><td>å¤æ™®æ¯”ç‡</td><td>${results.backtest_results.sharpe_ratio.toFixed(2)}</td></tr>`;
            }
            
            html += '</tbody>';
            html += '</table>';
            html += '</div>';
        }
        
        // é¡¯ç¤ºäº¤æ˜“å ±è¡¨
        if (results.backtest_results.trade_records && results.backtest_results.trade_records.length > 0) {
            showTradeReport(results.backtest_results);
        } else {
            hideTradeReport();
        }
        
        // é¡¯ç¤ºåœ–è¡¨åˆ†æ
        if (results.backtest_results.charts && results.backtest_results.charts.length > 0) {
            showCharts(results.backtest_results.charts);
        } else {
            hideCharts();
        }
    } else {
        hideTradeReport();
        hideCharts();
    }
    
    container.innerHTML = html;
    resultsDiv.style.display = 'block';
}

// é¡¯ç¤ºäº¤æ˜“å ±è¡¨
function showTradeReport(backtestResults) {
    const tradeReportSection = document.getElementById('test');
    const totalTrades = document.getElementById('totalTrades');
    const winRate = document.getElementById('winRate');
    const totalReturn = document.getElementById('totalReturn');
    const maxDrawdown = document.getElementById('maxDrawdown');
    const tradeReportBody = document.getElementById('tradeReportBody');
    const noTradeMessage = document.getElementById('noTradeMessage');
    const holdingPositionsBody = document.getElementById('holdingPositionsBody');
    const noHoldingMessage = document.getElementById('noHoldingMessage');
    
    // æ›´æ–°çµ±è¨ˆæ‘˜è¦
    if (backtestResults.total_trades !== undefined) {
        totalTrades.textContent = backtestResults.total_trades;
    }
    if (backtestResults.win_rate !== undefined) {
        winRate.textContent = backtestResults.win_rate.toFixed(2) + '%';
        winRate.className = backtestResults.win_rate >= 50 ? 'h5 mb-1 text-success' : 'h5 mb-1 text-danger';
    }
    if (backtestResults.total_return !== undefined) {
        totalReturn.textContent = backtestResults.total_return.toFixed(2) + '%';
        totalReturn.className = backtestResults.total_return >= 0 ? 'h5 mb-1 text-success' : 'h5 mb-1 text-danger';
    }
    if (backtestResults.max_drawdown !== undefined) {
        maxDrawdown.textContent = backtestResults.max_drawdown.toFixed(2) + '%';
    }
    
    // é¡¯ç¤ºäº¤æ˜“è¨˜éŒ„è¡¨æ ¼
    if (backtestResults.trade_records && backtestResults.trade_records.length > 0) {
        let tableHtml = '';
        
        backtestResults.trade_records.forEach(trade => {
            const profitLossClass = trade.profit_loss >= 0 ? 'text-success' : 'text-danger';
            const profitLossRateClass = trade.profit_loss_rate >= 0 ? 'text-success' : 'text-danger';
            
            tableHtml += `
                <tr>
                    <td>${formatDate(trade.entry_date)}</td>
                    <td>${formatDate(trade.exit_date)}</td>
                    <td>${trade.stock_id}</td>
                    <td>${trade.stock_name}</td>
                    <td>${trade.entry_price.toFixed(2)}</td>
                    <td>${trade.exit_price.toFixed(2)}</td>
                    <td>${trade.shares.toLocaleString()}</td>
                    <td class="${profitLossClass}">${trade.profit_loss.toLocaleString()}</td>
                    <td class="${profitLossRateClass}">${trade.profit_loss_rate.toFixed(2)}%</td>
                    <td>${trade.holding_days}</td>
                    <td>${trade.exit_reason || '-'}</td>
                </tr>
            `;
        });
        
        tradeReportBody.innerHTML = tableHtml;
        document.getElementById('tradeReportTable').style.display = 'table';
        noTradeMessage.style.display = 'none';
    } else {
        document.getElementById('tradeReportTable').style.display = 'none';
        noTradeMessage.style.display = 'block';
    }
    
    // é¡¯ç¤ºæŒæœ‰éƒ¨ä½è¡¨æ ¼
    if (backtestResults.holding_positions && backtestResults.holding_positions.length > 0) {
        let holdingTableHtml = '';
        
        backtestResults.holding_positions.forEach(position => {
            const unrealizedClass = position.unrealized_profit_loss >= 0 ? 'text-success' : 'text-danger';
            const unrealizedRateClass = position.unrealized_profit_loss_rate >= 0 ? 'text-success' : 'text-danger';
            
            holdingTableHtml += `
                <tr>
                    <td>${formatDate(position.entry_date)}</td>
                    <td>${position.stock_id}</td>
                    <td>${position.stock_name}</td>
                    <td>${position.trade_direction}</td>
                    <td>${position.entry_price.toFixed(2)}</td>
                    <td>${position.current_price.toFixed(2)}</td>
                    <td>${position.shares.toLocaleString()}</td>
                    <td class="${unrealizedClass}">${position.unrealized_profit_loss.toLocaleString()}</td>
                    <td class="${unrealizedRateClass}">${position.unrealized_profit_loss_rate.toFixed(2)}%</td>
                    <td>${position.holding_days}</td>
                    <td>${position.take_profit_price ? position.take_profit_price.toFixed(2) : '-'}</td>
                    <td>${position.stop_loss_price ? position.stop_loss_price.toFixed(2) : '-'}</td>
                </tr>
            `;
        });
        
        holdingPositionsBody.innerHTML = holdingTableHtml;
        document.getElementById('holdingPositionsTable').style.display = 'table';
        noHoldingMessage.style.display = 'none';
    } else {
        document.getElementById('holdingPositionsTable').style.display = 'none';
        noHoldingMessage.style.display = 'block';
    }
    
    tradeReportSection.style.display = 'block';
}

// éš±è—äº¤æ˜“å ±è¡¨
function hideTradeReport() {
    const tradeReportSection = document.getElementById('test');
    const holdingPositionsTable = document.getElementById('holdingPositionsTable');
    const noHoldingMessage = document.getElementById('noHoldingMessage');
    
    tradeReportSection.style.display = 'none';
    if (holdingPositionsTable) {
        holdingPositionsTable.style.display = 'none';
    }
    if (noHoldingMessage) {
        noHoldingMessage.style.display = 'none';
    }
    
    // åŒæ™‚éš±è—åœ–è¡¨åˆ†æ
    hideCharts();
}

// é¡¯ç¤ºåœ–è¡¨åˆ†æ
function showCharts(charts) {
    const chartsSection = document.getElementById('charts');
    const chartsContainer = document.getElementById('chartsContainer');
    const noChartsMessage = document.getElementById('noChartsMessage');
    
    if (!charts || charts.length === 0) {
        chartsSection.style.display = 'none';
        noChartsMessage.style.display = 'block';
        return;
    }
    
    chartsSection.style.display = 'block';
    noChartsMessage.style.display = 'none';
    chartsContainer.innerHTML = '';
    
    charts.forEach((chart, index) => {
        const chartDiv = document.createElement('div');
        chartDiv.className = 'mb-3';
        chartDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">${chart.title || `åœ–è¡¨ ${index + 1}`}</h6>
                <button class="btn btn-sm btn-outline-secondary" onclick="downloadChart('${chart.id || index}')">
                    <i class="fas fa-download"></i> ä¸‹è¼‰
                </button>
            </div>
            <div class="chart-wrapper" style="height: 400px; border: 1px solid #dee2e6; border-radius: 4px;">
                ${chart.html || chart.content || '<p class="text-muted text-center py-5">åœ–è¡¨è¼‰å…¥ä¸­...</p>'}
            </div>
        `;
        chartsContainer.appendChild(chartDiv);

        // è®“ chart.html å…§çš„ <script> èƒ½åŸ·è¡Œ
        const scripts = chartDiv.querySelectorAll('script');
        scripts.forEach(oldScript => {
            const newScript = document.createElement('script');
            if (oldScript.src) {
                newScript.src = oldScript.src;
            } else {
                newScript.textContent = oldScript.textContent;
            }
            oldScript.parentNode.replaceChild(newScript, oldScript);
        });
    });
}

// éš±è—åœ–è¡¨åˆ†æ
function hideCharts() {
    const chartsSection = document.getElementById('charts');
    const noChartsMessage = document.getElementById('noChartsMessage');
    
    chartsSection.style.display = 'none';
    if (noChartsMessage) {
        noChartsMessage.style.display = 'none';
    }
}

// é‡æ–°æ•´ç†åœ–è¡¨
function refreshCharts() {
    if (currentStrategyId) {
        showAlert('æ­£åœ¨é‡æ–°æ•´ç†åœ–è¡¨...', 'info');
        // é€™è£¡å¯ä»¥é‡æ–°å‘¼å«æ¸¬è©¦ç­–ç•¥çš„ API ä¾†å–å¾—æœ€æ–°çš„åœ–è¡¨
        testStrategy();
    } else {
        showAlert('è«‹å…ˆé¸æ“‡ç­–ç•¥', 'warning');
    }
}

// åŒ¯å‡ºåœ–è¡¨
function exportCharts() {
    const chartsContainer = document.getElementById('chartsContainer');
    if (!chartsContainer || chartsContainer.children.length === 0) {
        showAlert('æ²’æœ‰å¯åŒ¯å‡ºçš„åœ–è¡¨', 'warning');
        return;
    }
    
    // å»ºç«‹åŒ…å«æ‰€æœ‰åœ–è¡¨çš„ HTML æª”æ¡ˆ
    let htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>ç­–ç•¥åœ–è¡¨åˆ†æ</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .chart-section { margin-bottom: 30px; page-break-inside: avoid; }
                .chart-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
                .chart-wrapper { border: 1px solid #ccc; padding: 10px; }
            </style>
        </head>
        <body>
            <h1>ç­–ç•¥åœ–è¡¨åˆ†æå ±å‘Š</h1>
            <p>ç”Ÿæˆæ™‚é–“: ${new Date().toLocaleString('zh-TW')}</p>
    `;
    
    const chartSections = chartsContainer.querySelectorAll('.chart-wrapper');
    chartSections.forEach((section, index) => {
        const title = section.previousElementSibling?.querySelector('h6')?.textContent || `åœ–è¡¨ ${index + 1}`;
        htmlContent += `
            <div class="chart-section">
                <div class="chart-title">${title}</div>
                <div class="chart-wrapper">
                    ${section.innerHTML}
                </div>
            </div>
        `;
    });
    
    htmlContent += '</body></html>';
    
    // ä¸‹è¼‰ HTML æª”æ¡ˆ
    const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `ç­–ç•¥åœ–è¡¨åˆ†æ_${new Date().toISOString().slice(0, 10)}.html`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAlert('åœ–è¡¨åŒ¯å‡ºæˆåŠŸ', 'success');
}

// ä¸‹è¼‰å–®å€‹åœ–è¡¨
function downloadChart(chartId) {
    // é€™è£¡å¯ä»¥å¯¦ä½œä¸‹è¼‰å–®å€‹åœ–è¡¨çš„åŠŸèƒ½
    showAlert('ä¸‹è¼‰åŠŸèƒ½é–‹ç™¼ä¸­...', 'info');
}

// åŒ¯å‡ºäº¤æ˜“å ±è¡¨
function exportTradeReport() {
    const table = document.getElementById('tradeReportTable');
    if (!table) {
        showAlert('æ²’æœ‰å¯åŒ¯å‡ºçš„äº¤æ˜“å ±è¡¨', 'warning');
        return;
    }
    
    // å»ºç«‹ CSV å…§å®¹
    let csvContent = 'é€²å ´æ—¥æœŸ,å‡ºå ´æ—¥æœŸ,è‚¡ç¥¨ä»£ç¢¼,è‚¡ç¥¨åç¨±,é€²å ´åƒ¹,å‡ºå ´åƒ¹,è‚¡æ•¸,å ±é…¬,å ±é…¬ç‡,æŒæœ‰å¤©æ•¸,å‡ºå ´ç†ç”±\n';
    
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const rowData = Array.from(cells).map(cell => {
            // ç§»é™¤ HTML æ¨™ç±¤å’Œç‰¹æ®Šå­—ç¬¦
            let text = cell.textContent.trim();
            // å¦‚æœåŒ…å«é€—è™Ÿï¼Œç”¨å¼•è™ŸåŒ…åœ
            if (text.includes(',')) {
                text = `"${text}"`;
            }
            return text;
        });
        csvContent += rowData.join(',') + '\n';
    });
    
    // ä¸‹è¼‰ CSV æª”æ¡ˆ
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `äº¤æ˜“å ±è¡¨_${new Date().toISOString().slice(0, 10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAlert('äº¤æ˜“å ±è¡¨åŒ¯å‡ºæˆåŠŸ', 'success');
}

// åŒ¯å‡ºæŒæœ‰éƒ¨ä½å ±è¡¨
function exportHoldingPositionsReport() {
    const table = document.getElementById('holdingPositionsTable');
    if (!table) {
        showAlert('æ²’æœ‰å¯åŒ¯å‡ºçš„æŒæœ‰éƒ¨ä½å ±è¡¨', 'warning');
        return;
    }
    
    // å»ºç«‹ CSV å…§å®¹
    let csvContent = 'é€²å ´æ—¥æœŸ,è‚¡ç¥¨ä»£ç¢¼,è‚¡ç¥¨åç¨±,æ–¹å‘,é€²å ´åƒ¹,ç•¶å‰åƒ¹,è‚¡æ•¸,æœªå¯¦ç¾æç›Š,æœªå¯¦ç¾æç›Šç‡,æŒæœ‰å¤©æ•¸,åœåˆ©åƒ¹,åœæåƒ¹\n';
    
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const rowData = Array.from(cells).map(cell => {
            // ç§»é™¤ HTML æ¨™ç±¤å’Œç‰¹æ®Šå­—ç¬¦
            let text = cell.textContent.trim();
            // å¦‚æœåŒ…å«é€—è™Ÿï¼Œç”¨å¼•è™ŸåŒ…åœ
            if (text.includes(',')) {
                text = `"${text}"`;
            }
            return text;
        });
        csvContent += rowData.join(',') + '\n';
    });
    
    // ä¸‹è¼‰ CSV æª”æ¡ˆ
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `æŒæœ‰éƒ¨ä½å ±è¡¨_${new Date().toISOString().slice(0, 10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAlert('æŒæœ‰éƒ¨ä½å ±è¡¨åŒ¯å‡ºæˆåŠŸ', 'success');
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('zh-TW');
}

// è¼‰å…¥æ¨¡æ¿
async function loadTemplate(templateType = 'mixed') {
    try {
        const response = await fetch(`/api/strategies/custom/template?type=${templateType}`);
        const data = await response.json();
        
        if (data.status === 'success') {
            if (codeEditor) {
                codeEditor.setValue(data.template);
            } else {
                document.getElementById('strategyCode').value = data.template;
            }
            
            let templateName = 'æ··åˆæ¨¡å¼æ¨¡æ¿';
            if (templateType === 'vectorized') {
                templateName = 'å‘é‡åŒ–æ¨¡æ¿';
            } else if (templateType === 'state_machine') {
                templateName = 'ç‹€æ…‹æ©Ÿæ¨¡æ¿';
            }
            
            showAlert(`${templateName}è¼‰å…¥æˆåŠŸ`, 'success');
        }
    } catch (error) {
        console.error('è¼‰å…¥æ¨¡æ¿å¤±æ•—:', error);
        showAlert('è¼‰å…¥æ¨¡æ¿å¤±æ•—', 'danger');
    }
}

// é©—è­‰èªæ³•
async function validateCode() {
    const code = codeEditor ? codeEditor.getValue().trim() : document.getElementById('strategyCode').value.trim();
    
    if (!code) {
        showAlert('è«‹è¼¸å…¥ç¨‹å¼ç¢¼', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/strategies/custom/validate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ code: code })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showAlert('èªæ³•é©—è­‰é€šé', 'success');
        } else {
            showAlert(data.message || 'èªæ³•é©—è­‰å¤±æ•—', 'danger');
        }
    } catch (error) {
        console.error('é©—è­‰å¤±æ•—:', error);
        showAlert('é©—è­‰å¤±æ•—', 'danger');
    }
}

// åŒ¯å‡ºç­–ç•¥
function exportStrategy() {
    if (!currentStrategyId) {
        showAlert('è«‹å…ˆé¸æ“‡ç­–ç•¥', 'warning');
        return;
    }
    
    const strategy = strategies.find(s => s.id === currentStrategyId);
    if (strategy) {
        document.getElementById('exportFileName').value = strategy.name;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('exportStrategyModal'));
    modal.show();
}

// ç¢ºèªåŒ¯å‡ºç­–ç•¥
async function confirmExportStrategy() {
    if (!currentStrategyId) {
        showAlert('è«‹å…ˆé¸æ“‡ç­–ç•¥', 'warning');
        return;
    }
    
    const fileName = document.getElementById('exportFileName').value.trim();
    const format = document.querySelector('input[name="exportFormat"]:checked').value;
    
    if (!fileName) {
        showAlert('è«‹è¼¸å…¥æª”æ¡ˆåç¨±', 'warning');
        return;
    }
    
    try {
        const response = await fetch(`/api/strategies/custom/${currentStrategyId}/export`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                file_name: fileName,
                format: format
            })
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${fileName}.${format === 'json' ? 'json' : 'py'}`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showAlert('ç­–ç•¥åŒ¯å‡ºæˆåŠŸï¼Œç­–ç•¥å·²è¨­ç‚ºç¢ºèªç‰ˆ', 'success');
            bootstrap.Modal.getInstance(document.getElementById('exportStrategyModal')).hide();
        } else {
            const data = await response.json();
            showAlert(data.message || 'åŒ¯å‡ºç­–ç•¥å¤±æ•—', 'danger');
        }
    } catch (error) {
        console.error('åŒ¯å‡ºç­–ç•¥å¤±æ•—:', error);
        showAlert('åŒ¯å‡ºç­–ç•¥å¤±æ•—', 'danger');
    }
}

// åˆªé™¤ç­–ç•¥
async function deleteStrategy() {
    if (!currentStrategyId) {
        showAlert('è«‹å…ˆé¸æ“‡ç­–ç•¥', 'warning');
        return;
    }
    
    if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ç­–ç•¥å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/strategies/custom/${currentStrategyId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showAlert('ç­–ç•¥åˆªé™¤æˆåŠŸ', 'success');
            currentStrategyId = null;
            
            // æ¸…ç©ºç·¨è¼¯å™¨
            document.getElementById('strategyName').value = '';
            document.getElementById('strategyDescription').value = '';
            if (codeEditor) {
                codeEditor.setValue('');
            } else {
                document.getElementById('strategyCode').value = '';
            }
            document.getElementById('editorTitle').textContent = 'ç­–ç•¥ç·¨è¼¯å™¨';
            document.getElementById('parameterConfig').innerHTML = '<p class="text-muted">åƒæ•¸é…ç½®å°‡æ ¹æ“šç¨‹å¼ç¢¼è‡ªå‹•ç”Ÿæˆ</p>';
            document.getElementById('testResults').style.display = 'none';
            
            // é‡æ–°è¼‰å…¥ç­–ç•¥åˆ—è¡¨
            await loadStrategies();
        } else {
            showAlert(data.message || 'åˆªé™¤ç­–ç•¥å¤±æ•—', 'danger');
        }
    } catch (error) {
        console.error('åˆªé™¤ç­–ç•¥å¤±æ•—:', error);
        showAlert('åˆªé™¤ç­–ç•¥å¤±æ•—', 'danger');
    }
}

// é¡¯ç¤ºæç¤ºè¨Šæ¯
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}

// è¼‰å…¥ç¯„ä¾‹è³‡æ–™
function loadSampleData() {
    // Jupyter æ¨¡å¼èˆ‡å‚³çµ±æ¨¡å¼éƒ½å½ˆå‡º sampleDataModal
    const modal = new bootstrap.Modal(document.getElementById('sampleDataModal'));
    modal.show();
    loadDataTypeList();
}

// è¼‰å…¥è³‡æ–™é¡å‹åˆ—è¡¨
async function loadDataTypeList() {
    try {
        const response = await fetch('/api/sample-data/types');
        const data = await response.json();
        
        if (data.status === 'success') {
            const container = document.getElementById('dataTypeList');
            container.innerHTML = '';
            
            data.types.forEach(type => {
                const item = document.createElement('div');
                item.className = 'list-group-item list-group-item-action';
                item.onclick = () => selectDataType(type);
                
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${type.name}</h6>
                            <small class="text-muted">${type.description}</small>
                        </div>
                        <span class="badge bg-primary">${type.category}</span>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }
    } catch (error) {
        console.error('è¼‰å…¥è³‡æ–™é¡å‹å¤±æ•—:', error);
        showAlert('è¼‰å…¥è³‡æ–™é¡å‹å¤±æ•—', 'danger');
    }
}

// é¸æ“‡è³‡æ–™é¡å‹
function selectDataType(type) {
    selectedDataType = type;
    
    // æ›´æ–°é¸ä¸­ç‹€æ…‹
    document.querySelectorAll('#dataTypeList .list-group-item').forEach(item => {
        item.classList.remove('active');
    });
    event.target.closest('.list-group-item').classList.add('active');
    
    // é¡¯ç¤ºåƒæ•¸è¨­å®š
    showDataParams(type);
}

// é¡¯ç¤ºè³‡æ–™åƒæ•¸
function showDataParams(type) {
    const container = document.getElementById('dataParams');
    
    let html = `<h6>${type.name}</h6><p class="text-muted">${type.description}</p>`;
    
    if (type.parameters) {
        html += '<div class="mb-3">';
        Object.entries(type.parameters).forEach(([key, param]) => {
            html += `
                <div class="mb-2">
                    <label class="form-label">${param.label}</label>
                    ${generateParamInput(key, param)}
                </div>
            `;
        });
        html += '</div>';
    }
    
    container.innerHTML = html;
}

// ç”Ÿæˆåƒæ•¸è¼¸å…¥æ¬„ä½
function generateParamInput(key, param) {
    switch (param.type) {
        case 'text':
            return `<input type="text" class="form-control" id="param_${key}" value="${param.default || ''}" placeholder="${param.placeholder || ''}">`;
        case 'number':
            return `<input type="number" class="form-control" id="param_${key}" value="${param.default || ''}" min="${param.min || ''}" max="${param.max || ''}" step="${param.step || ''}">`;
        case 'select':
            let options = '';
            param.options.forEach(option => {
                const selected = option.value === param.default ? 'selected' : '';
                options += `<option value="${option.value}" ${selected}>${option.label}</option>`;
            });
            return `<select class="form-control" id="param_${key}">${options}</select>`;
        case 'date':
            return `<input type="date" class="form-control" id="param_${key}" value="${param.default || ''}">`;
        default:
            return `<input type="text" class="form-control" id="param_${key}" value="${param.default || ''}">`;
    }
}

// è¼‰å…¥é¸ä¸­çš„è³‡æ–™
async function loadSelectedData() {
    if (!selectedDataType) {
        showAlert('è«‹é¸æ“‡è³‡æ–™é¡å‹', 'warning');
        return;
    }
    
    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    const loadButton = document.querySelector('#sampleDataModal .btn-primary');
    const originalText = loadButton.textContent;
    loadButton.textContent = 'è¼‰å…¥ä¸­...';
    loadButton.disabled = true;
    
    // é¡¯ç¤ºè¼‰å…¥æç¤º
    showAlert('æ­£åœ¨è¼‰å…¥è³‡æ–™ï¼Œè«‹ç¨å€™...', 'info');
    
    try {
        // æ”¶é›†åƒæ•¸
        const params = {};
        if (selectedDataType.parameters) {
            Object.keys(selectedDataType.parameters).forEach(key => {
                const input = document.getElementById(`param_${key}`);
                if (input) {
                    params[key] = input.value;
                }
            });
        }
        
        // è¨­å®š 20 ç§’è¶…æ™‚
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 20000); // 20ç§’è¶…æ™‚
        
        const response = await fetch('/api/sample-data/load', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                data_type: selectedDataType.id,
                parameters: params
            }),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        const data = await response.json();
        if (data.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('sampleDataModal')).hide();
            
            // é™åˆ¶é è¦½è³‡æ–™é‡
            let previewData = data.data;
            if (previewData && previewData.length > 100) {
                previewData = previewData.slice(0, 100);
                showAlert(`è³‡æ–™è¼‰å…¥æˆåŠŸï¼å…± ${data.data.length} ç­†è³‡æ–™`, 'success');
            } else {
                const dataCount = data.data ? data.data.length : 0;
                showAlert(`è³‡æ–™è¼‰å…¥æˆåŠŸï¼å…± ${dataCount} ç­†è³‡æ–™`, 'success');
            }
            
            if (isJupyterMode) {
                // Jupyter æ¨¡å¼ï¼šæ’å…¥ cell
                let code = `# è¼‰å…¥ç¯„ä¾‹è³‡æ–™\ndf = pd.DataFrame(${JSON.stringify(previewData)})\nprint(f"è¼‰å…¥ {len(previewData)} ç­†è³‡æ–™")\ndf.head()`;
                const cellId = addJupyterCell(code);
                setTimeout(() => { executeJupyterCell(cellId); }, 100);
            } else {
                // å‚³çµ±æ¨¡å¼ï¼šé è¦½
                currentPreviewData = previewData;
                displayPreviewData(previewData);
            }
        } else {
            showAlert(data.message || 'è¼‰å…¥è³‡æ–™å¤±æ•—', 'danger');
        }
    } catch (error) {
        console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
        
        if (error.name === 'AbortError') {
            showAlert('è¼‰å…¥è¶…æ™‚ï¼ˆ20ç§’ï¼‰ï¼Œè«‹å˜—è©¦æ¸›å°‘è³‡æ–™é‡æˆ–ç¨å¾Œå†è©¦', 'warning');
        } else {
            showAlert('è¼‰å…¥è³‡æ–™å¤±æ•—: ' + error.message, 'danger');
        }
    } finally {
        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
        loadButton.textContent = originalText;
        loadButton.disabled = false;
    }
}

// é¡¯ç¤ºé è¦½è³‡æ–™
function displayPreviewData(data) {
    const previewDiv = document.getElementById('dataPreview');
    const infoSpan = document.getElementById('dataInfo');
    const table = document.getElementById('dataTable');
    
    // é¡¯ç¤ºè³‡æ–™è³‡è¨Š
    infoSpan.textContent = `å…± ${data.length} ç­†è³‡æ–™ï¼Œ${Object.keys(data[0] || {}).length} å€‹æ¬„ä½`;
    
    // ç”Ÿæˆè¡¨é ­
    const thead = table.querySelector('thead');
    thead.innerHTML = '';
    const headerRow = document.createElement('tr');
    
    Object.keys(data[0] || {}).forEach(column => {
        const th = document.createElement('th');
        th.textContent = column;
        th.style.fontSize = '12px';
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    
    // ç”Ÿæˆè³‡æ–™è¡Œ
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';
    
    data.slice(0, 100).forEach(row => { // åªé¡¯ç¤ºå‰100ç­†
        const tr = document.createElement('tr');
        Object.values(row).forEach(value => {
            const td = document.createElement('td');
            td.textContent = formatCellValue(value);
            td.style.fontSize = '12px';
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
    
    if (data.length > 100) {
        const infoRow = document.createElement('tr');
        const infoCell = document.createElement('td');
        infoCell.colSpan = Object.keys(data[0] || {}).length;
        infoCell.textContent = `... é‚„æœ‰ ${data.length - 100} ç­†è³‡æ–™`;
        infoCell.className = 'text-muted text-center';
        infoCell.style.fontSize = '12px';
        infoRow.appendChild(infoCell);
        tbody.appendChild(infoRow);
    }
    
    // é¡¯ç¤ºé è¦½å€åŸŸ
    previewDiv.style.display = 'block';
}

// æ ¼å¼åŒ–å–®å…ƒæ ¼å€¼
function formatCellValue(value) {
    if (value === null || value === undefined) {
        return '-';
    }
    
    if (typeof value === 'number') {
        return value.toLocaleString();
    }
    
    if (typeof value === 'string' && value.length > 50) {
        return value.substring(0, 50) + '...';
    }
    
    return String(value);
}

// æ¸…é™¤é è¦½è³‡æ–™
function clearPreviewData() {
    currentPreviewData = null;
    document.getElementById('dataPreview').style.display = 'none';
    showAlert('é è¦½è³‡æ–™å·²æ¸…é™¤', 'info');
}

// è¨­å®šè‚¡ç¥¨ä¾†æºè™•ç†å™¨
function setupStockSourceHandlers() {
    function hideAllSourceConfigs() {
        document.getElementById('excelSourceConfig').style.display = 'none';
        document.getElementById('stockListConfig').style.display = 'none';
    }
    document.getElementById('stockSourceExcel').addEventListener('change', function() {
        hideAllSourceConfigs();
        document.getElementById('excelSourceConfig').style.display = 'block';
    });
    document.getElementById('stockSourceList').addEventListener('change', function() {
        hideAllSourceConfigs();
        document.getElementById('stockListConfig').style.display = 'block';
    });
}

// è¼‰å…¥é¸è‚¡åˆ—è¡¨
async function loadStockLists() {
    try {
        const response = await fetch('/api/stock-lists');
        const data = await response.json();
        
        if (data.status === 'success') {
            const select = document.getElementById('stockListSelect');
            select.innerHTML = '<option value="">è«‹é¸æ“‡é¸è‚¡åˆ—è¡¨...</option>';
            
            data.stock_lists.forEach(stockList => {
                const option = document.createElement('option');
                option.value = stockList.id;
                option.textContent = `${stockList.name} (${stockList.stock_count} æª”è‚¡ç¥¨)`;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('è¼‰å…¥é¸è‚¡åˆ—è¡¨å¤±æ•—:', error);
    }
}

// å–å¾—è‚¡ç¥¨ä¾†æºè¨­å®š
function getStockSourceConfig() {
    const stockSource = document.querySelector('input[name="stockSource"]:checked').value;
    
    if (stockSource === 'excel') {
        return {
            type: 'excel',
            config: {
                required_columns: ['stock_id', 'startdate', 'enddate']
            }
        };
    } else if (stockSource === 'stock_list') {
        const stockListId = document.getElementById('stockListSelect').value;
        return {
            type: 'stock_list',
            config: {
                stock_list_id: stockListId
            }
        };
    } else if (stockSource === 'cache') {
        const cacheFile = document.getElementById('cacheFileSelect').value;
        return {
            type: 'cache',
            config: {
                cache_file: cacheFile
            }
        };
    }
    
    return null;
}

// è¨­å®š Excel æª”æ¡ˆè™•ç†å™¨
function setupExcelFileHandlers() {
    const excelFileInput = document.getElementById('excelFile');
    // è™•ç†æª”æ¡ˆé¸æ“‡
    excelFileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // é¡¯ç¤ºæª”æ¡ˆè³‡è¨Š
            document.getElementById('excelFileName').textContent = file.name;
            document.getElementById('excelFileInfo').style.display = 'block';
            showAlert(`å·²é¸æ“‡æª”æ¡ˆ: ${file.name}`, 'success');
        }
    });
}

// ä¸‹è¼‰ Excel ç¯„æœ¬
async function downloadExcelTemplate() {
    try {
        const response = await fetch('/api/strategies/custom/excel-template');
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'strategy_test_template.xlsx';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showAlert('Excel ç¯„æœ¬ä¸‹è¼‰æˆåŠŸ', 'success');
        } else {
            showAlert('ä¸‹è¼‰ç¯„æœ¬å¤±æ•—', 'danger');
        }
    } catch (error) {
        console.error('ä¸‹è¼‰ç¯„æœ¬å¤±æ•—:', error);
        showAlert('ä¸‹è¼‰ç¯„æœ¬å¤±æ•—', 'danger');
    }
}

// æ›´æ–°åƒæ•¸å¢é‡
function updateParameterIncrement(key, increment) {
    updateStrategyParameters();
}

// æ›´æ–°åƒæ•¸æè¿°
function updateParameterDescription(key, description) {
    updateStrategyParameters();
}

// æ›´æ–°åƒæ•¸é¸é …
function updateParameterOptions(key, optionsString) {
    updateStrategyParameters();
}

// æ–°å¢é¸é …
function addSelectOption(key) {
    const paramItem = document.querySelector(`[data-key="${key}"]`);
    if (paramItem) {
        const optionsInput = paramItem.querySelector('.parameter-options');
        const currentValue = optionsInput.value;
        const newOption = prompt('è«‹è¼¸å…¥æ–°é¸é … (æ ¼å¼: å€¼:æ¨™ç±¤)', 'new_value:æ–°é¸é …');
        
        if (newOption && newOption.includes(':')) {
            const newValue = currentValue ? currentValue + ';' + newOption : newOption;
            optionsInput.value = newValue;
            updateParameterOptions(key, newValue);
        }
    }
}

// åˆ‡æ›æ’åºæ¨¡å¼
function toggleParameterSort() {
    isSortMode = !isSortMode;
    const btn = document.getElementById('sortToggleBtn');
    
    if (isSortMode) {
        btn.innerHTML = '<i class="fas fa-check"></i> å®Œæˆæ’åº';
        btn.className = 'btn btn-sm btn-success me-2';
        initializeSortable();
        showAlert('æ‹–æ‹½åƒæ•¸å¡ç‰‡å¯é‡æ–°æ’åº', 'info');
    } else {
        btn.innerHTML = '<i class="fas fa-sort"></i> æ’åºæ¨¡å¼';
        btn.className = 'btn btn-sm btn-outline-secondary me-2';
        destroySortable();
        showAlert('æ’åºå®Œæˆ', 'success');
    }
}

// åˆå§‹åŒ–æ‹–æ‹½æ’åº
function initializeSortable() {
    const container = document.getElementById('parameterContainer');
    if (!container) return;
    
    // éŠ·æ¯€ç¾æœ‰çš„å¯¦ä¾‹
    if (sortableInstance) {
        sortableInstance.destroy();
    }
    
    // å»ºç«‹æ–°çš„ Sortable å¯¦ä¾‹
    sortableInstance = new Sortable(container, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        dragClass: 'sortable-drag',
        onEnd: function(evt) {
            // æ’åºå®Œæˆå¾Œæ›´æ–°åƒæ•¸é †åº
            updateStrategyParameters();
        }
    });
    
    // ç‚ºæ¯å€‹åƒæ•¸å¡ç‰‡åŠ å…¥æ‹–æ‹½æç¤º
    const parameterItems = container.querySelectorAll('.parameter-item');
    parameterItems.forEach(item => {
        item.style.cursor = 'grab';
        item.setAttribute('title', 'æ‹–æ‹½å¯é‡æ–°æ’åº');
    });
}

// éŠ·æ¯€æ‹–æ‹½æ’åº
function destroySortable() {
    if (sortableInstance) {
        sortableInstance.destroy();
        sortableInstance = null;
    }
    
    // ç§»é™¤æ‹–æ‹½æç¤º
    const parameterItems = document.querySelectorAll('.parameter-item');
    parameterItems.forEach(item => {
        item.style.cursor = 'default';
        item.removeAttribute('title');
    });
}

// æ–°å¢åƒæ•¸ï¼ˆåˆ¥åå‡½æ•¸ï¼‰
function addParameter() {
    addNewParameter();
}

// å´é‚Šæ¬„åˆ‡æ›åŠŸèƒ½
function setupSidebarToggle() {
    const toggleBtn = document.getElementById('toggleSidebar');
    const sidebar = document.getElementById('sidebar');
    const mainEditor = document.getElementById('mainEditor');
    const toggleIcon = document.getElementById('toggleIcon');
    
    if (toggleBtn && sidebar && mainEditor) {
        toggleBtn.addEventListener('click', function() {
            sidebar.classList.toggle('collapsed');
            mainEditor.classList.toggle('expanded');
            
            // æ›´æ–°åœ–æ¨™
            if (sidebar.classList.contains('collapsed')) {
                toggleIcon.className = 'fas fa-chevron-right';
                toggleBtn.title = 'å±•é–‹å´é‚Šæ¬„';
            } else {
                toggleIcon.className = 'fas fa-chevron-left';
                toggleBtn.title = 'ç¸®èµ·å´é‚Šæ¬„';
            }
            
            // é‡æ–°æ•´ç†ç¨‹å¼ç¢¼ç·¨è¼¯å™¨å¤§å°
            if (window.codeEditor) {
                setTimeout(() => {
                    window.codeEditor.refresh();
                }, 300);
            }
        });
    }
}

// åˆ‡æ›æŒæœ‰è¨˜éŒ„åŠŸèƒ½
function toggleRecordHoldings() {
    const switchElement = document.getElementById('recordHoldingsSwitch');
    const isEnabled = switchElement.checked;
    
    // æ›´æ–°ç­–ç•¥åƒæ•¸
    if (window.strategyParameters) {
        window.strategyParameters['record_holdings'] = isEnabled ? 1 : 0;
    }
    
    // é¡¯ç¤ºæç¤ºè¨Šæ¯
    if (isEnabled) {
        showAlert('å·²å•Ÿç”¨æŒæœ‰æœªå‡ºå ´è¨˜éŒ„åŠŸèƒ½', 'success');
    } else {
        showAlert('å·²åœç”¨æŒæœ‰æœªå‡ºå ´è¨˜éŒ„åŠŸèƒ½', 'info');
    }
}

// ==================== Jupyter ç·¨è¼¯å™¨åŠŸèƒ½ ====================

let jupyterCells = [];
let jupyterCellCounter = 0;
let isJupyterMode = false;
let jupyterCellEditors = {};

// åˆ‡æ› Jupyter æ¨¡å¼
function toggleJupyterMode() {
    isJupyterMode = !isJupyterMode;
    const jupyterEditor = document.getElementById('jupyterEditor');
    const traditionalEditor = document.getElementById('traditionalEditor');
    const jupyterModeBtn = document.getElementById('jupyterModeBtn');
    
    if (isJupyterMode) {
        jupyterEditor.style.display = 'block';
        traditionalEditor.style.display = 'none';
        jupyterModeBtn.innerHTML = '<i class="fas fa-file-code"></i> åˆ‡æ›å‚³çµ±æ¨¡å¼';
        jupyterModeBtn.className = 'btn btn-sm btn-outline-primary';
        
        // åˆå§‹åŒ– Jupyter ç·¨è¼¯å™¨
        if (jupyterCells.length === 0) {
            // æ·»åŠ é è¨­çš„ç¯„ä¾‹å–®å…ƒæ ¼
            addJupyterCell(`# æ­¡è¿ä½¿ç”¨ Jupyter é¢¨æ ¼ç­–ç•¥ç·¨è¼¯å™¨ï¼
# é€™å€‹ç·¨è¼¯å™¨æ”¯æ´å³æ™‚ç¨‹å¼ç¢¼åŸ·è¡Œå’Œåœ–è¡¨é¡¯ç¤º

# è¼‰å…¥å¿…è¦çš„æ¨¡çµ„
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

print("æ¨¡çµ„è¼‰å…¥å®Œæˆï¼")`);
            
            addJupyterCell(`# ç”Ÿæˆç¯„ä¾‹è‚¡ç¥¨è³‡æ–™
dates = pd.date_range('2024-01-01', '2024-12-31', freq='D')
np.random.seed(42)

# æ¨¡æ“¬è‚¡åƒ¹è³‡æ–™
close_prices = 100 + np.cumsum(np.random.normal(0, 0.5, len(dates)))
df = pd.DataFrame({
    'date': dates,
    'close': close_prices,
    'volume': np.random.uniform(1000000, 5000000, len(dates))
})

print(f"ç”Ÿæˆ {len(df)} ç­†è‚¡ç¥¨è³‡æ–™")
df.head()`);
            
            addJupyterCell(`# è¨ˆç®—æŠ€è¡“æŒ‡æ¨™
df['ma5'] = df['close'].rolling(5).mean()
df['ma20'] = df['close'].rolling(20).mean()
df['ma60'] = df['close'].rolling(60).mean()

# è¨ˆç®—æ—¥å ±é…¬ç‡
df['daily_return'] = df['close'].pct_change()

print("æŠ€è¡“æŒ‡æ¨™è¨ˆç®—å®Œæˆ")
df.tail()`);
            
            addJupyterCell(`# ç¹ªè£½è‚¡åƒ¹å’Œç§»å‹•å¹³å‡ç·šåœ–
plt.figure(figsize=(12, 6))
plt.plot(df['date'], df['close'], label='æ”¶ç›¤åƒ¹', linewidth=2)
plt.plot(df['date'], df['ma5'], label='5æ—¥å‡ç·š', alpha=0.7)
plt.plot(df['date'], df['ma20'], label='20æ—¥å‡ç·š', alpha=0.7)
plt.plot(df['date'], df['ma60'], label='60æ—¥å‡ç·š', alpha=0.7)

plt.title('è‚¡ç¥¨åƒ¹æ ¼èˆ‡ç§»å‹•å¹³å‡ç·š', fontsize=14)
plt.xlabel('æ—¥æœŸ')
plt.ylabel('åƒ¹æ ¼')
plt.legend()
plt.grid(True, alpha=0.3)
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()`);
        }
    } else {
        jupyterEditor.style.display = 'none';
        traditionalEditor.style.display = 'block';
        jupyterModeBtn.innerHTML = '<i class="fas fa-play"></i> åˆ‡æ› Jupyter æ¨¡å¼';
        jupyterModeBtn.className = 'btn btn-sm btn-outline-secondary';
    }
}

// åˆå§‹åŒ– Jupyter æ¨¡å¼ï¼ˆé é¢è¼‰å…¥æ™‚è‡ªå‹•å•Ÿç”¨ï¼‰
function initializeJupyterMode() {
    isJupyterMode = true;
    // åˆå§‹åŒ–å…¨åŸŸè®Šæ•¸ç‹€æ…‹
    window.jupyterGlobalVariables = {};
    const jupyterEditor = document.getElementById('jupyterEditor');
    const traditionalEditor = document.getElementById('traditionalEditor');
    const jupyterModeBtn = document.getElementById('jupyterModeBtn');
    
    if (jupyterEditor && traditionalEditor && jupyterModeBtn) {
        jupyterEditor.style.display = 'block';
        traditionalEditor.style.display = 'none';
        jupyterModeBtn.innerHTML = '<i class="fas fa-file-code"></i> åˆ‡æ›å‚³çµ±æ¨¡å¼';
        jupyterModeBtn.className = 'btn btn-sm btn-outline-primary';
        
        // åˆå§‹åŒ– Jupyter ç·¨è¼¯å™¨
        if (jupyterCells.length === 0) {
            // æ·»åŠ é è¨­çš„ç¯„ä¾‹å–®å…ƒæ ¼
            addJupyterCell(`# æ­¡è¿ä½¿ç”¨ Jupyter é¢¨æ ¼ç­–ç•¥ç·¨è¼¯å™¨ï¼
# é€™å€‹ç·¨è¼¯å™¨æ”¯æ´å³æ™‚ç¨‹å¼ç¢¼åŸ·è¡Œå’Œåœ–è¡¨é¡¯ç¤º

# è¼‰å…¥å¿…è¦çš„æ¨¡çµ„
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

print("æ¨¡çµ„è¼‰å…¥å®Œæˆï¼")`);
            
            addJupyterCell(`# ç”Ÿæˆç¯„ä¾‹è‚¡ç¥¨è³‡æ–™
dates = pd.date_range('2024-01-01', '2024-12-31', freq='D')
np.random.seed(42)

# æ¨¡æ“¬è‚¡åƒ¹è³‡æ–™
close_prices = 100 + np.cumsum(np.random.normal(0, 0.5, len(dates)))
df = pd.DataFrame({
    'date': dates,
    'close': close_prices,
    'volume': np.random.uniform(1000000, 5000000, len(dates))
})

print(f"ç”Ÿæˆ {len(df)} ç­†è‚¡ç¥¨è³‡æ–™")
df.head()`);
            
            addJupyterCell(`# è¨ˆç®—æŠ€è¡“æŒ‡æ¨™
df['ma5'] = df['close'].rolling(5).mean()
df['ma20'] = df['close'].rolling(20).mean()
df['ma60'] = df['close'].rolling(60).mean()

# è¨ˆç®—æ—¥å ±é…¬ç‡
df['daily_return'] = df['close'].pct_change()

print("æŠ€è¡“æŒ‡æ¨™è¨ˆç®—å®Œæˆ")
df.tail()`);
            
            addJupyterCell(`# ç¹ªè£½è‚¡åƒ¹å’Œç§»å‹•å¹³å‡ç·šåœ–
plt.figure(figsize=(12, 6))
plt.plot(df['date'], df['close'], label='æ”¶ç›¤åƒ¹', linewidth=2)
plt.plot(df['date'], df['ma5'], label='5æ—¥å‡ç·š', alpha=0.7)
plt.plot(df['date'], df['ma20'], label='20æ—¥å‡ç·š', alpha=0.7)
plt.plot(df['date'], df['ma60'], label='60æ—¥å‡ç·š', alpha=0.7)

plt.title('è‚¡ç¥¨åƒ¹æ ¼èˆ‡ç§»å‹•å¹³å‡ç·š', fontsize=14)
plt.xlabel('æ—¥æœŸ')
plt.ylabel('åƒ¹æ ¼')
plt.legend()
plt.grid(True, alpha=0.3)
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()`);
        }
    }
}

// æ–°å¢ Jupyter å–®å…ƒæ ¼
function addJupyterCell(code = '', afterCellId = null) {
    console.log('å»ºç«‹ cellï¼Œå…§å®¹ï¼š', code); // é™¤éŒ¯ç”¨
    jupyterCellCounter++;
    const cellId = `cell_${jupyterCellCounter}`;
    
    const cellHtml = `
        <div class="jupyter-cell" id="${cellId}" data-cell-id="${cellId}">
            <div class="jupyter-cell-header">
                <span class="jupyter-cell-number">In [${jupyterCellCounter}]:</span>
                <div class="jupyter-cell-actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="executeJupyterCell('${cellId}')" title="åŸ·è¡Œ (Shift+Enter)">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="addJupyterCell('', '${cellId}')" title="åœ¨ä¸‹æ–¹æ–°å¢ (Ctrl+Enter)">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="moveJupyterCellUp('${cellId}')" title="å‘ä¸Šç§»å‹• (Ctrl+Up)">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="moveJupyterCellDown('${cellId}')" title="å‘ä¸‹ç§»å‹• (Ctrl+Down)">
                        <i class="fas fa-arrow-down"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteJupyterCell('${cellId}')" title="åˆªé™¤">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="jupyter-cell-input">
                <textarea class="jupyter-code-input" id="input_${cellId}" placeholder="è¼¸å…¥ç¨‹å¼ç¢¼...">${code}</textarea>
            </div>
            <div class="jupyter-cell-output" id="output_${cellId}">
                <!-- è¼¸å‡ºå°‡åœ¨é€™è£¡é¡¯ç¤º -->
            </div>
        </div>
    `;
    
    const cellsContainer = document.getElementById('jupyterCells');
    if (afterCellId) {
        // æ’å…¥åˆ°æŒ‡å®š cell ä¸‹æ–¹
        const afterCell = document.getElementById(afterCellId);
        if (afterCell && afterCell.nextSibling) {
            afterCell.parentNode.insertBefore(document.createRange().createContextualFragment(cellHtml), afterCell.nextSibling);
        } else if (afterCell) {
            afterCell.insertAdjacentHTML('afterend', cellHtml);
        } else {
            cellsContainer.insertAdjacentHTML('beforeend', cellHtml);
        }
        // åœ¨ jupyterCells é™£åˆ—ä¸­æ’å…¥å°æ‡‰ä½ç½®
        const idx = jupyterCells.indexOf(afterCellId);
        if (idx !== -1) {
            jupyterCells.splice(idx + 1, 0, cellId);
        } else {
            jupyterCells.push(cellId);
        }
    } else {
        // é è¨­åŠ åœ¨æœ€ä¸‹æ–¹
        cellsContainer.insertAdjacentHTML('beforeend', cellHtml);
        jupyterCells.push(cellId);
    }
    // åˆå§‹åŒ– CodeMirror ç·¨è¼¯å™¨
    const textarea = document.getElementById(`input_${cellId}`);
    const editor = CodeMirror.fromTextArea(textarea, {
        mode: 'python',
        theme: 'eclipse',
        lineNumbers: true,
        lineWrapping: true,
        indentUnit: 4,
        tabSize: 4,
        indentWithTabs: false,
        autoCloseBrackets: true,
        matchBrackets: true,
        foldGutter: true,
        gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
        extraKeys: {
            'Shift-Enter': function(cm) {
                executeJupyterCell(cellId);
            },
            'Ctrl-Enter': function(cm) {
                addJupyterCell('', cellId);
            },
            'Ctrl-Up': function(cm) {
                moveJupyterCellUp(cellId);
            },
            'Ctrl-Down': function(cm) {
                moveJupyterCellDown(cellId);
            },
            'Tab': function(cm) {
                if (cm.somethingSelected()) {
                    cm.indentSelection('add');
                } else {
                    cm.replaceSelection('    ', 'end');
                }
            }
        }
    });
    jupyterCellEditors[cellId] = editor;
    // è¨­å®šç·¨è¼¯å™¨å¤§å°
    editor.setSize('100%', 'auto');
    editor.refresh();
    return cellId;
}

// åŸ·è¡Œ Jupyter å–®å…ƒæ ¼
async function executeJupyterCell(cellId) {
    const cell = document.getElementById(cellId);
    const editor = jupyterCellEditors[cellId];
    const outputContainer = document.getElementById(`output_${cellId}`);
    if (!editor) return;
    const code = editor.getValue().trim();
    if (!code) return;
    // è¨­å®šåŸ·è¡Œç‹€æ…‹
    cell.className = 'jupyter-cell executing';
    // æ¸…ç©ºè¼¸å‡º
    outputContainer.innerHTML = '<div class="output-item"><div class="output-stream stdout">åŸ·è¡Œä¸­...</div></div>';
    try {
        // å–å¾—ç­–ç•¥åƒæ•¸
        updateStrategyParameters();
        const parameters = window.currentStrategyParameters || {};
        
        // åªåœ¨ç¬¬ä¸€å€‹ cell æˆ–æ²’æœ‰å…¨åŸŸè®Šæ•¸æ™‚å‚³é€è³‡æ–™ä¾†æº
        const strategyTable = document.getElementById('strategyDataTable').value;
        const excelFile = document.getElementById('excelFile').files[0];
        const formData = new FormData();
        formData.append('code', code);
        formData.append('cell_id', cellId);
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºç¬¬ä¸€å€‹ cell æˆ–æ²’æœ‰å…¨åŸŸè®Šæ•¸
        const isFirstCell = cellId === jupyterCells[0];
        const hasGlobalVariables = window.jupyterGlobalVariables && Object.keys(window.jupyterGlobalVariables).length > 0;
        
        if (isFirstCell || !hasGlobalVariables) {
            // åªåœ¨ç¬¬ä¸€æ¬¡è¼‰å…¥æ™‚å‚³é€è³‡æ–™ä¾†æº
            formData.append('strategy_table', strategyTable);
            if (excelFile) {
                formData.append('excel_file', excelFile);
            }
            console.log('å‚³é€è³‡æ–™ä¾†æºï¼š', { strategyTable, hasExcelFile: !!excelFile });
        } else {
            // å¾ŒçºŒ cell ä¸å‚³é€è³‡æ–™ä¾†æºï¼Œé¿å…è¦†è“‹å·²ä¿®æ”¹çš„è®Šæ•¸
            formData.append('strategy_table', '');
            console.log('è·³éè³‡æ–™ä¾†æºå‚³é€ï¼Œä½¿ç”¨ç¾æœ‰å…¨åŸŸè®Šæ•¸');
        }
        
        // æ·»åŠ ç­–ç•¥åƒæ•¸
        formData.append('parameters', JSON.stringify(parameters));
        
        const response = await fetch('/api/jupyter/execute', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        if (data.status === 'success') {
            displayJupyterOutputs(outputContainer, data.outputs);
            cell.className = 'jupyter-cell success';
            
            // æ›´æ–°å…¨åŸŸè®Šæ•¸ç‹€æ…‹ï¼ˆå‡è¨­åŸ·è¡ŒæˆåŠŸå¾Œæœ‰è®Šæ•¸ï¼‰
            if (!window.jupyterGlobalVariables) {
                window.jupyterGlobalVariables = {};
            }
            // æ¨™è¨˜ç‚ºæœ‰å…¨åŸŸè®Šæ•¸å­˜åœ¨
            window.jupyterGlobalVariables.hasVariables = true;
        } else {
            outputContainer.innerHTML = `<div class="output-item"><div class="output-error">éŒ¯èª¤: ${data.error}</div></div>`;
            cell.className = 'jupyter-cell error';
        }
    } catch (error) {
        console.error('åŸ·è¡Œ Jupyter å–®å…ƒæ ¼å¤±æ•—:', error);
        outputContainer.innerHTML = `<div class="output-item"><div class="output-error">åŸ·è¡Œå¤±æ•—: ${error.message}</div></div>`;
        cell.className = 'jupyter-cell error';
    }
}

// åŸ·è¡Œä¸¦æ–°å¢å–®å…ƒæ ¼
function executeAndAddCell(cellId) {
    executeJupyterCell(cellId).then(() => {
        addJupyterCell();
    });
}

// åˆªé™¤ Jupyter å–®å…ƒæ ¼
function deleteJupyterCell(cellId) {
    if (jupyterCells.length <= 1) {
        showAlert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹å–®å…ƒæ ¼', 'warning');
        return;
    }
    
    if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å–®å…ƒæ ¼å—ï¼Ÿ')) {
        const cell = document.getElementById(cellId);
        const editor = jupyterCellEditors[cellId];
        
        if (editor) {
            editor.toTextArea();
            delete jupyterCellEditors[cellId];
        }
        
        cell.remove();
        
        // å¾é™£åˆ—ä¸­ç§»é™¤
        const index = jupyterCells.indexOf(cellId);
        if (index > -1) {
            jupyterCells.splice(index, 1);
        }
        
        // é‡æ–°ç·¨è™Ÿ
        renumberJupyterCells();
    }
}

// é‡æ–°ç·¨è™Ÿ Jupyter å–®å…ƒæ ¼
function renumberJupyterCells() {
    jupyterCells.forEach((cellId, index) => {
        const cell = document.getElementById(cellId);
        const numberSpan = cell.querySelector('.jupyter-cell-number');
        if (numberSpan) {
            numberSpan.textContent = `In [${index + 1}]:`;
        }
    });
}

// å‘ä¸Šç§»å‹• Jupyter å–®å…ƒæ ¼
function moveJupyterCellUp(cellId) {
    const currentIndex = jupyterCells.indexOf(cellId);
    if (currentIndex > 0) {
        // äº¤æ›é™£åˆ—ä¸­çš„ä½ç½®
        [jupyterCells[currentIndex], jupyterCells[currentIndex - 1]] = 
        [jupyterCells[currentIndex - 1], jupyterCells[currentIndex]];
        
        // ç§»å‹• DOM å…ƒç´ 
        const cellsContainer = document.getElementById('jupyterCells');
        const currentCell = document.getElementById(cellId);
        const previousCell = document.getElementById(jupyterCells[currentIndex]);
        
        if (currentCell && previousCell) {
            cellsContainer.insertBefore(currentCell, previousCell);
        }
        
        // é‡æ–°ç·¨è™Ÿ
        renumberJupyterCells();
        
        console.log(`Cell ${cellId} å·²å‘ä¸Šç§»å‹•`);
    } else {
        showAlert('å·²ç¶“æ˜¯ç¬¬ä¸€å€‹å–®å…ƒæ ¼', 'info');
    }
}

// å‘ä¸‹ç§»å‹• Jupyter å–®å…ƒæ ¼
function moveJupyterCellDown(cellId) {
    const currentIndex = jupyterCells.indexOf(cellId);
    if (currentIndex < jupyterCells.length - 1) {
        // äº¤æ›é™£åˆ—ä¸­çš„ä½ç½®
        [jupyterCells[currentIndex], jupyterCells[currentIndex + 1]] = 
        [jupyterCells[currentIndex + 1], jupyterCells[currentIndex]];
        
        // ç§»å‹• DOM å…ƒç´ 
        const cellsContainer = document.getElementById('jupyterCells');
        const currentCell = document.getElementById(cellId);
        const nextCell = document.getElementById(jupyterCells[currentIndex]);
        
        if (currentCell && nextCell) {
            cellsContainer.insertBefore(currentCell, nextCell.nextSibling);
        }
        
        // é‡æ–°ç·¨è™Ÿ
        renumberJupyterCells();
        
        console.log(`Cell ${cellId} å·²å‘ä¸‹ç§»å‹•`);
    } else {
        showAlert('å·²ç¶“æ˜¯æœ€å¾Œä¸€å€‹å–®å…ƒæ ¼', 'info');
    }
}

// é¡¯ç¤º Jupyter è¼¸å‡º
function displayJupyterOutputs(container, outputs) {
    container.innerHTML = '';
    
    if (!outputs || outputs.length === 0) {
        return;
    }
    
    outputs.forEach(output => {
        const outputItem = document.createElement('div');
        outputItem.className = 'output-item';
        
        switch (output.output_type) {
            case 'stream':
                const streamDiv = document.createElement('div');
                streamDiv.className = `output-stream ${output.name}`;
                streamDiv.textContent = output.text.join('\n');
                outputItem.appendChild(streamDiv);
                break;
                
            case 'error':
                const errorDiv = document.createElement('div');
                errorDiv.className = 'output-error';
                errorDiv.innerHTML = `
                    <strong>${output.ename}:</strong> ${output.evalue}<br>
                    ${output.traceback.join('\n')}
                `;
                outputItem.appendChild(errorDiv);
                break;
                
            case 'display_data':
                const displayDiv = document.createElement('div');
                displayDiv.className = 'output-display';
                
                if (output.data['image/png']) {
                    // é¡¯ç¤ºåœ–ç‰‡
                    const img = document.createElement('img');
                    img.src = `data:image/png;base64,${output.data['image/png']}`;
                    img.alt = 'Generated Chart';
                    displayDiv.appendChild(img);
                } else if (output.data['text/html']) {
                    // é¡¯ç¤º HTML
                    displayDiv.innerHTML = output.data['text/html'];
                } else if (output.data['text/plain']) {
                    // é¡¯ç¤ºç´”æ–‡å­—
                    const pre = document.createElement('pre');
                    pre.textContent = output.data['text/plain'];
                    displayDiv.appendChild(pre);
                }
                
                outputItem.appendChild(displayDiv);
                break;
                
            case 'execute_result':
                const resultDiv = document.createElement('div');
                resultDiv.className = 'output-display';
                resultDiv.innerHTML = `<pre>${output.data['text/plain']}</pre>`;
                outputItem.appendChild(resultDiv);
                break;
        }
        
        container.appendChild(outputItem);
    });
}

// æ¸…é™¤æ‰€æœ‰è¼¸å‡º
function clearAllOutputs() {
    jupyterCells.forEach(cellId => {
        const outputContainer = document.getElementById(`output_${cellId}`);
        if (outputContainer) {
            outputContainer.innerHTML = '';
        }
        
        const cell = document.getElementById(cellId);
        cell.className = 'jupyter-cell';
    });
}

// æ¸…é™¤ Jupyter è¼¸å‡º
function clearJupyterOutputs() {
    // æ¸…é™¤æ‰€æœ‰å–®å…ƒæ ¼çš„è¼¸å‡º
    jupyterCells.forEach(cellId => {
        const outputDiv = document.getElementById(`output_${cellId}`);
        if (outputDiv) {
            outputDiv.innerHTML = '';
        }
    });
}

// æ¸…é™¤ Jupyter å…¨åŸŸè®Šæ•¸
async function clearJupyterVariables() {
    if (!isJupyterMode) {
        showAlert('æ­¤åŠŸèƒ½åƒ…é©ç”¨æ–¼ Jupyter æ¨¡å¼', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/jupyter/clear-variables', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showAlert('å…¨åŸŸè®Šæ•¸å·²æ¸…é™¤', 'success');
        } else {
            showAlert('æ¸…é™¤è®Šæ•¸å¤±æ•—', 'danger');
        }
    } catch (error) {
        console.error('æ¸…é™¤è®Šæ•¸å¤±æ•—:', error);
        showAlert('æ¸…é™¤è®Šæ•¸å¤±æ•—', 'danger');
    }
}

// æ¸…é™¤ Jupyter è¼¸å‡ºå’Œè®Šæ•¸ï¼ˆéœé»˜æ¨¡å¼ï¼Œä¸é¡¯ç¤ºæç¤ºï¼‰
async function clearJupyterSilently() {
    // æ¸…é™¤è¼¸å‡ºï¼ˆä¸ç®¡æ˜¯å¦ç‚º Jupyter æ¨¡å¼ï¼‰
    clearJupyterOutputs();
    
    // å¦‚æœæ˜¯ Jupyter æ¨¡å¼ï¼Œä¹Ÿæ¸…é™¤è®Šæ•¸
    if (isJupyterMode) {
        try {
            await fetch('/api/jupyter/clear-variables', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
        } catch (error) {
            console.warn('æ¸…é™¤ Jupyter è®Šæ•¸å¤±æ•—:', error);
        }
    }
}

// æŸ¥çœ‹ Jupyter å…¨åŸŸè®Šæ•¸
async function showJupyterVariables() {
    if (!isJupyterMode) {
        showAlert('æ­¤åŠŸèƒ½åƒ…é©ç”¨æ–¼ Jupyter æ¨¡å¼', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/jupyter/variables', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            // æ›´æ–°å…¨åŸŸè®Šæ•¸ç‹€æ…‹
            window.jupyterGlobalVariables = data.variables.reduce((acc, varName) => {
                acc[varName] = true;
                return acc;
            }, {});
            
            let message = `ç•¶å‰è¼‰å…¥çš„è®Šæ•¸ (å…± ${data.count} å€‹):\n`;
            if (data.variables.length > 0) {
                message += data.variables.join(', ');
            } else {
                message += 'ç„¡';
            }
            message += `\n\næª”æ¡ˆè·¯å¾‘: ${data.file_path}`;
            
            // ä½¿ç”¨ alert é¡¯ç¤ºï¼Œæˆ–è€…å¯ä»¥æ”¹ç‚ºæ›´ç¾è§€çš„ modal
            alert(message);
        } else {
            showAlert('ç²å–è®Šæ•¸å¤±æ•—', 'danger');
        }
    } catch (error) {
        console.error('ç²å–è®Šæ•¸å¤±æ•—:', error);
        showAlert('ç²å–è®Šæ•¸å¤±æ•—', 'danger');
    }
}

// åŸ·è¡Œ Jupyter ç­–ç•¥å›æ¸¬
async function executeJupyterBacktest() {
    if (!isJupyterMode) {
        showAlert('æ­¤åŠŸèƒ½åƒ…é©ç”¨æ–¼ Jupyter æ¨¡å¼', 'warning');
        return;
    }
    
    // æ”¶é›†æ‰€æœ‰å–®å…ƒæ ¼çš„ç¨‹å¼ç¢¼
    let allCode = '';
    jupyterCells.forEach(cellId => {
        const editor = jupyterCellEditors[cellId];
        if (editor) {
            allCode += editor.getValue() + '\n\n';
        }
    });
    
    if (!allCode.trim()) {
        showAlert('è«‹å…ˆåœ¨å–®å…ƒæ ¼ä¸­è¼¸å…¥ç­–ç•¥ç¨‹å¼ç¢¼', 'warning');
        return;
    }
    
    // å–å¾—ç­–ç•¥åƒæ•¸
    updateStrategyParameters();
    const parameters = window.currentStrategyParameters || {};
    
    // å–å¾—ç•¶å‰è³‡æ–™ä¾†æº
    const strategyTable = document.getElementById('strategyDataTable').value;
    const excelFile = document.getElementById('excelFile').files[0];
    
    try {
        showAlert('æ­£åœ¨åŸ·è¡Œç­–ç•¥å›æ¸¬...', 'info');
        
        // æº–å‚™è«‹æ±‚è³‡æ–™
        const requestData = {
            strategy_code: allCode,
            parameters: parameters,
            strategy_table: strategyTable
        };
        
        // å¦‚æœæœ‰ Excel æª”æ¡ˆï¼Œè½‰æ›ç‚º base64
        if (excelFile) {
            const reader = new FileReader();
            reader.onload = async function(e) {
                requestData.excel_file = e.target.result;
                
                const response = await fetch('/api/jupyter/strategy-backtest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    // é¡¯ç¤ºå›æ¸¬çµæœ
                    displayJupyterBacktestResults(data.result);
                    showAlert('ç­–ç•¥å›æ¸¬åŸ·è¡ŒæˆåŠŸ', 'success');
                } else {
                    showAlert(`ç­–ç•¥å›æ¸¬å¤±æ•—: ${data.error}`, 'danger');
                }
            };
            reader.readAsDataURL(excelFile);
        } else {
            // æ²’æœ‰ Excel æª”æ¡ˆï¼Œç›´æ¥ç™¼é€è«‹æ±‚
            const response = await fetch('/api/jupyter/strategy-backtest', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                // é¡¯ç¤ºå›æ¸¬çµæœ
                displayJupyterBacktestResults(data.result);
                showAlert('ç­–ç•¥å›æ¸¬åŸ·è¡ŒæˆåŠŸ', 'success');
            } else {
                showAlert(`ç­–ç•¥å›æ¸¬å¤±æ•—: ${data.error}`, 'danger');
            }
        }
    } catch (error) {
        console.error('åŸ·è¡Œç­–ç•¥å›æ¸¬å¤±æ•—:', error);
        showAlert('åŸ·è¡Œç­–ç•¥å›æ¸¬å¤±æ•—', 'danger');
    }
}

// é¡¯ç¤º Jupyter å›æ¸¬çµæœ
function displayJupyterBacktestResults(data) {
    console.log('Jupyter å›æ¸¬çµæœ:', data);
    console.log('è³‡æ–™é¡å‹:', typeof data);
    console.log('è³‡æ–™éµå€¼:', Object.keys(data));
    
    // æª¢æŸ¥è³‡æ–™çµæ§‹
    if (data && typeof data === 'object') {
        console.log('trade_records:', data.trade_records);
        console.log('holding_positions:', data.holding_positions);
        console.log('backtest_statistics:', data.backtest_statistics);
        console.log('charts:', data.charts);
        console.log('result_df:', data.result_df);
        console.log('strategy_info:', data.strategy_info);
    }
    
    // é¡¯ç¤ºäº¤æ˜“è¨˜éŒ„
    if (data.trade_records && data.trade_records.length > 0) {
        console.log('é¡¯ç¤ºäº¤æ˜“è¨˜éŒ„:', data.trade_records.length, 'ç­†');
        // å°‡è³‡æ–™è½‰æ›ç‚º showTradeReport æœŸæœ›çš„æ ¼å¼
        const backtestResults = {
            trade_records: data.trade_records,
            holding_positions: data.holding_positions || [],
            total_trades: data.backtest_statistics?.total_trades || data.trade_records.length,
            win_rate: data.backtest_statistics?.win_rate || 0,
            total_return: data.backtest_statistics?.total_return || 0,
            max_drawdown: data.backtest_statistics?.max_drawdown || 0
        };
        showTradeReport(backtestResults);
    } else {
        console.log('æ²’æœ‰äº¤æ˜“è¨˜éŒ„');
        showAlert('æ²’æœ‰ç”¢ç”Ÿä»»ä½•äº¤æ˜“è¨˜éŒ„', 'info');
    }
    
    // é¡¯ç¤ºå›æ¸¬çµ±è¨ˆ
    if (data.backtest_statistics) {
        console.log('é¡¯ç¤ºå›æ¸¬çµ±è¨ˆ:', data.backtest_statistics);
        displayBacktestStatistics(data.backtest_statistics);
    } else {
        console.log('æ²’æœ‰å›æ¸¬çµ±è¨ˆ');
    }
    
    // é¡¯ç¤ºåœ–è¡¨
    if (data.charts && data.charts.length > 0) {
        console.log('é¡¯ç¤ºåœ–è¡¨:', data.charts.length, 'å€‹');
        displayJupyterCharts(data.charts);
    } else {
        console.log('æ²’æœ‰åœ–è¡¨');
    }
    
    // é¡¯ç¤ºçµæœè³‡æ–™
    if (data.result_df) {
        console.log('é¡¯ç¤ºçµæœè³‡æ–™');
        displayResultData(data.result_df);
    } else {
        console.log('æ²’æœ‰çµæœè³‡æ–™');
    }
    
    // é¡¯ç¤ºç­–ç•¥è³‡è¨Š
    if (data.strategy_info) {
        console.log('é¡¯ç¤ºç­–ç•¥è³‡è¨Š:', data.strategy_info);
        displayStrategyInfo(data.strategy_info);
    } else {
        console.log('æ²’æœ‰ç­–ç•¥è³‡è¨Š');
    }
}

// é¡¯ç¤ºå›æ¸¬çµ±è¨ˆ
function displayBacktestStatistics(stats) {
    const container = document.getElementById('chartsContainer');
    if (!container) return;
    
    console.log('é¡¯ç¤ºçµ±è¨ˆè³‡æ–™:', stats);
    
    let html = '<div class="row mb-3">';
    html += '<div class="col-12"><h6>å›æ¸¬çµ±è¨ˆ</h6></div>';
    
    if (stats.total_trades !== undefined) {
        html += `<div class="col-md-3"><div class="card"><div class="card-body text-center">`;
        html += `<h5 class="text-primary">${stats.total_trades}</h5><small>ç¸½äº¤æ˜“æ¬¡æ•¸</small></div></div></div>`;
    }
    
    if (stats.win_rate !== undefined) {
        const winRateClass = stats.win_rate >= 50 ? 'text-success' : 'text-danger';
        html += `<div class="col-md-3"><div class="card"><div class="card-body text-center">`;
        html += `<h5 class="${winRateClass}">${stats.win_rate.toFixed(2)}%</h5><small>å‹ç‡</small></div></div></div>`;
    }
    
    if (stats.total_return !== undefined) {
        const returnClass = stats.total_return >= 0 ? 'text-success' : 'text-danger';
        html += `<div class="col-md-3"><div class="card"><div class="card-body text-center">`;
        html += `<h5 class="${returnClass}">${stats.total_return.toFixed(2)}%</h5><small>ç¸½å ±é…¬ç‡</small></div></div></div>`;
    }
    
    if (stats.max_drawdown !== undefined) {
        html += `<div class="col-md-3"><div class="card"><div class="card-body text-center">`;
        html += `<h5 class="text-danger">${stats.max_drawdown.toFixed(2)}%</h5><small>æœ€å¤§å›æ’¤</small></div></div></div>`;
    }
    
    // æ·»åŠ æ›´å¤šçµ±è¨ˆè³‡è¨Š
    if (stats.total_profit_loss !== undefined) {
        const profitClass = stats.total_profit_loss >= 0 ? 'text-success' : 'text-danger';
        html += `<div class="col-md-3"><div class="card"><div class="card-body text-center">`;
        html += `<h5 class="${profitClass}">${stats.total_profit_loss.toLocaleString()}</h5><small>ç¸½æç›Š</small></div></div></div>`;
    }
    
    if (stats.sharpe_ratio !== undefined) {
        html += `<div class="col-md-3"><div class="card"><div class="card-body text-center">`;
        html += `<h5 class="text-info">${stats.sharpe_ratio.toFixed(2)}</h5><small>å¤æ™®æ¯”ç‡</small></div></div></div>`;
    }
    
    html += '</div>';
    container.insertAdjacentHTML('beforeend', html);
}

// é¡¯ç¤ºåœ–è¡¨
function displayCharts(charts) {
    const container = document.getElementById('chartsContainer');
    if (!container) return;
    
    // å…ˆæ¸…ç©ºå®¹å™¨
    container.innerHTML = '';
    
    if (!charts || charts.length === 0) {
        let html = '<div class="row mb-3">';
        html += '<div class="col-12"><h6>ç­–ç•¥åœ–è¡¨</h6></div>';
        html += '<div class="col-12"><div class="alert alert-info">æ²’æœ‰å¯é¡¯ç¤ºçš„åœ–è¡¨</div></div>';
        html += '</div>';
        container.insertAdjacentHTML('beforeend', html);
        return;
    }
    
    let html = '<div class="row mb-3">';
    html += '<div class="col-12"><h6>ç­–ç•¥åœ–è¡¨</h6></div>';
    
    charts.forEach((chart, index) => {
        html += '<div class="col-12 mb-3">';
        html += '<div class="card">';
        html += `<div class="card-header"><h6>${chart.title || chart.id}</h6></div>`;
        html += '<div class="card-body">';
        if (chart.html) {
            html += chart.html;
        } else {
            html += '<div class="alert alert-warning">åœ–è¡¨å…§å®¹è¼‰å…¥å¤±æ•—</div>';
        }
        html += '</div>';
        html += '</div>';
        html += '</div>';
    });
    
    html += '</div>';
    container.insertAdjacentHTML('beforeend', html);
    
    // è®“ chart.html å…§çš„ <script> èƒ½åŸ·è¡Œ
    const scripts = container.querySelectorAll('script');
    scripts.forEach(oldScript => {
        const newScript = document.createElement('script');
        if (oldScript.src) {
            newScript.src = oldScript.src;
        } else {
            newScript.textContent = oldScript.textContent;
        }
        oldScript.parentNode.replaceChild(newScript, oldScript);
    });
}

// é¡¯ç¤º Jupyter åœ–è¡¨
function displayJupyterCharts(charts) {
    const container = document.getElementById('jupyterChartsContainer');
    const section = document.getElementById('jupyterChartsSection');
    const noChartsMessage = document.getElementById('jupyterNoChartsMessage');
    
    if (!container) {
        console.error('æ‰¾ä¸åˆ° jupyterChartsContainer');
        return;
    }
    
    // é¡¯ç¤ºåœ–è¡¨å€åŸŸ
    if (section) section.style.display = 'block';
    if (noChartsMessage) noChartsMessage.style.display = 'none';
    
    // å…ˆæ¸…ç©ºå®¹å™¨
    container.innerHTML = '';
    
    if (!charts || charts.length === 0) {
        let html = '<div class="row mb-3">';
        html += '<div class="col-12"><h6>ç­–ç•¥åœ–è¡¨</h6></div>';
        html += '<div class="col-12"><div class="alert alert-info">æ²’æœ‰å¯é¡¯ç¤ºçš„åœ–è¡¨</div></div>';
        html += '</div>';
        container.insertAdjacentHTML('beforeend', html);
        return;
    }
    
    console.log('é–‹å§‹ç”Ÿæˆ Jupyter åœ–è¡¨ HTML');
    
    let html = '<div class="row mb-3">';
    html += '<div class="col-12"><h6>ç­–ç•¥åœ–è¡¨</h6></div>';
    
    charts.forEach((chart, index) => {
        console.log(`è™•ç†åœ–è¡¨ ${index}:`, chart);
        html += '<div class="col-12 mb-3">';
        html += '<div class="card">';
        html += `<div class="card-header"><h6>${chart.title || chart.id || `åœ–è¡¨ ${index + 1}`}</h6></div>`;
        html += '<div class="card-body">';
        if (chart.html) {
            console.log(`åœ–è¡¨ ${index} HTML é•·åº¦:`, chart.html.length);
            html += chart.html;
        } else {
            console.log(`åœ–è¡¨ ${index} æ²’æœ‰ HTML å…§å®¹`);
            html += '<div class="alert alert-warning">åœ–è¡¨å…§å®¹è¼‰å…¥å¤±æ•—</div>';
        }
        html += '</div>';
        html += '</div>';
        html += '</div>';
    });
    
    html += '</div>';
    container.insertAdjacentHTML('beforeend', html);
    
    console.log('Jupyter åœ–è¡¨ HTML ç”Ÿæˆå®Œæˆï¼Œé–‹å§‹è™•ç† script æ¨™ç±¤');
    
    // è®“ chart.html å…§çš„ <script> èƒ½åŸ·è¡Œ
    const scripts = container.querySelectorAll('script');
    console.log('æ‰¾åˆ° script æ¨™ç±¤æ•¸é‡:', scripts.length);
    scripts.forEach((oldScript, index) => {
        console.log(`è™•ç† script ${index}:`, oldScript.src || 'å…§è¯è…³æœ¬');
        const newScript = document.createElement('script');
        if (oldScript.src) {
            newScript.src = oldScript.src;
        } else {
            newScript.textContent = oldScript.textContent;
        }
        oldScript.parentNode.replaceChild(newScript, oldScript);
    });
    
    console.log('Jupyter åœ–è¡¨é¡¯ç¤ºå®Œæˆ');
}

// é‡æ–°æ•´ç† Jupyter åœ–è¡¨
function refreshJupyterCharts() {
    const container = document.getElementById('jupyterChartsContainer');
    if (container) {
        container.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> é‡æ–°æ•´ç†ä¸­...</div>';
        setTimeout(() => {
            container.innerHTML = '<div class="alert alert-info">è«‹é‡æ–°åŸ·è¡Œç­–ç•¥å›æ¸¬ä»¥é¡¯ç¤ºåœ–è¡¨</div>';
        }, 1000);
    }
}

// åŒ¯å‡º Jupyter åœ–è¡¨
function exportJupyterCharts() {
    const container = document.getElementById('jupyterChartsContainer');
    if (!container || container.children.length === 0) {
        showAlert('æ²’æœ‰å¯åŒ¯å‡ºçš„åœ–è¡¨', 'warning');
        return;
    }
    
    // é€™è£¡å¯ä»¥å¯¦ä½œåœ–è¡¨åŒ¯å‡ºåŠŸèƒ½
    showAlert('åœ–è¡¨åŒ¯å‡ºåŠŸèƒ½é–‹ç™¼ä¸­', 'info');
}

// é¡¯ç¤ºçµæœè³‡æ–™
function displayResultData(resultData) {
    const container = document.getElementById('dataPreview');
    if (!container) return;
    
    if (resultData && resultData.length > 0) {
        const table = document.getElementById('dataTable');
        if (table) {
            // ç”Ÿæˆè¡¨æ ¼
            let html = '<thead class="table-dark sticky-top"><tr>';
            const columns = Object.keys(resultData[0]);
            columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            resultData.slice(0, 10).forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    html += `<td>${row[col]}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody>';
            
            table.innerHTML = html;
            container.style.display = 'block';
            document.getElementById('dataInfo').textContent = `é¡¯ç¤º ${resultData.length} ç­†è³‡æ–™çš„å‰ 10 ç­†`;
        }
    }
}

// é¡¯ç¤ºç­–ç•¥è³‡è¨Š
function displayStrategyInfo(strategyInfo) {
    const container = document.getElementById('chartsContainer');
    if (!container) return;
    
    let html = '<div class="row mb-3">';
    html += '<div class="col-12"><h6>ç­–ç•¥è³‡è¨Š</h6></div>';
    
    if (strategyInfo.strategy_name) {
        html += `<div class="col-md-6"><div class="card"><div class="card-body">`;
        html += `<h6>ç­–ç•¥åç¨±</h6><p>${strategyInfo.strategy_name}</p></div></div></div>`;
    }
    
    if (strategyInfo.strategy_description) {
        html += `<div class="col-md-6"><div class="card"><div class="card-body">`;
        html += `<h6>ç­–ç•¥æè¿°</h6><p>${strategyInfo.strategy_description}</p></div></div></div>`;
    }
    
    html += '</div>';
    container.insertAdjacentHTML('beforeend', html);
}

// åˆ†æç­–ç•¥é¡å‹
async function analyzeStrategyType() {
    if (!isJupyterMode) {
        showAlert('æ­¤åŠŸèƒ½åƒ…é©ç”¨æ–¼ Jupyter æ¨¡å¼', 'warning');
        return;
    }
    
    // æ”¶é›†æ‰€æœ‰å–®å…ƒæ ¼çš„ç¨‹å¼ç¢¼
    let allCode = '';
    jupyterCells.forEach(cellId => {
        const editor = jupyterCellEditors[cellId];
        if (editor) {
            allCode += editor.getValue() + '\n\n';
        }
    });
    
    if (!allCode.trim()) {
        showAlert('è«‹å…ˆåœ¨å–®å…ƒæ ¼ä¸­è¼¸å…¥ç­–ç•¥ç¨‹å¼ç¢¼', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/jupyter/analyze-strategy', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                code: allCode
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            const strategyType = data.strategy_type;
            const analysis = data.analysis;
            
            // é¡¯ç¤ºåˆ†æçµæœ
            let resultHtml = `
                <div class="alert alert-info">
                    <h6><i class="fas fa-search"></i> ç­–ç•¥é¡å‹åˆ†æçµæœ</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>ç­–ç•¥é¡å‹ï¼š</strong>
                            <span class="badge bg-primary">${getStrategyTypeDisplayName(strategyType)}</span>
                        </div>
                        <div class="col-md-6">
                            <strong>åˆ†æç‹€æ…‹ï¼š</strong>
                            <span class="badge bg-success">${analysis.description}</span>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>ç‹€æ…‹æ©Ÿå‡½æ•¸ï¼š</strong>
                            <span class="badge ${analysis.has_should_entry ? 'bg-success' : 'bg-secondary'}">
                                ${analysis.has_should_entry ? 'âœ“ æ‰¾åˆ° should_entry' : 'âœ— æœªæ‰¾åˆ° should_entry'}
                            </span>
                        </div>
                        <div class="col-md-6">
                            <strong>å‘é‡åŒ–å‡½æ•¸ï¼š</strong>
                            <span class="badge ${analysis.has_calculate_entry_signals ? 'bg-success' : 'bg-secondary'}">
                                ${analysis.has_calculate_entry_signals ? 'âœ“ æ‰¾åˆ° calculate_entry_signals' : 'âœ— æœªæ‰¾åˆ° calculate_entry_signals'}
                            </span>
                        </div>
                    </div>
                    <hr>
                    <div>
                        <strong>ç™¼ç¾çš„å‡½æ•¸ï¼š</strong>
                        <div class="mt-2">
                            ${analysis.functions_found.length > 0 ? 
                                analysis.functions_found.map(func => `<span class="badge bg-light text-dark me-1">${func}</span>`).join('') :
                                '<span class="text-muted">æœªç™¼ç¾ä»»ä½•å‡½æ•¸</span>'
                            }
                        </div>
                    </div>
                </div>
            `;
            
            // åœ¨æœ€å¾Œä¸€å€‹å–®å…ƒæ ¼å¾Œæ–°å¢åˆ†æçµæœå–®å…ƒæ ¼
            const analysisCell = document.createElement('div');
            analysisCell.className = 'jupyter-cell analysis-result mb-3';
            analysisCell.innerHTML = `
                <div class="jupyter-input">
                    <div class="cell-header">
                        <span class="cell-number">åˆ†æçµæœ</span>
                        <div class="cell-actions">
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.parentElement.parentElement.remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="jupyter-output" style="display: block;">
                        ${resultHtml}
                    </div>
                </div>
            `;
            
            document.getElementById('jupyterCells').appendChild(analysisCell);
            
            showAlert(`ç­–ç•¥é¡å‹åˆ†æå®Œæˆï¼š${getStrategyTypeDisplayName(strategyType)}`, 'success');
        } else {
            showAlert(data.error || 'åˆ†æç­–ç•¥é¡å‹å¤±æ•—', 'danger');
        }
    } catch (error) {
        console.error('åˆ†æç­–ç•¥é¡å‹å¤±æ•—:', error);
        showAlert('åˆ†æç­–ç•¥é¡å‹å¤±æ•—', 'danger');
    }
}

// å–å¾—ç­–ç•¥é¡å‹é¡¯ç¤ºåç¨±
function getStrategyTypeDisplayName(strategyType) {
    const typeNames = {
        'state_machine': 'ç‹€æ…‹æ©Ÿç­–ç•¥',
        'vectorized': 'å‘é‡åŒ–ç­–ç•¥',
        'mixed': 'æ··åˆå¼ç­–ç•¥',
        'unknown': 'æœªçŸ¥é¡å‹'
    };
    return typeNames[strategyType] || strategyType;
}



// å„²å­˜ Jupyter ç­–ç•¥åˆ°å¾Œç«¯
async function saveJupyterStrategy() {
    if (!currentStrategyId) {
        showAlert('è«‹å…ˆé¸æ“‡æˆ–å»ºç«‹ç­–ç•¥', 'warning');
        return;
    }
    
    // åˆä½µæ‰€æœ‰ cell ç¨‹å¼ç¢¼
    let code = '';
    const cells = [];
    
    jupyterCells.forEach(cellId => {
        const editor = jupyterCellEditors[cellId];
        if (editor) {
            const cellCode = editor.getValue();
            code += cellCode + '\n\n';
            
            // æ”¶é›† cell çµæ§‹è³‡è¨Š
            const outputContainer = document.getElementById(`output_${cellId}`);
            cells.push({
                id: cellId,
                code: cellCode,
                outputs: outputContainer ? outputContainer.innerHTML : '',
                metadata: {
                    cell_type: 'code',
                    execution_count: 1
                }
            });
        }
    });
    code = code.trim();
    
    // è¨­å®šåˆ°å…¨åŸŸè®Šæ•¸ï¼Œè®“ saveStrategy èƒ½æ­£ç¢ºå–å¾—
    window.jupyterMergedCode = code;
    
    try {
        // 1. å„²å­˜ cell çµæ§‹åˆ° Jupyter notebook API
        const notebookResponse = await fetch(`/api/jupyter/notebook/${currentStrategyId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                cells: cells
            })
        });
        
        const notebookResult = await notebookResponse.json();
        if (notebookResult.status === 'success') {
            console.log('Jupyter notebook çµæ§‹å„²å­˜æˆåŠŸ');
        } else {
            console.warn('Jupyter notebook çµæ§‹å„²å­˜å¤±æ•—:', notebookResult.error);
        }
        
        // 2. å„²å­˜åˆä½µå¾Œçš„ç¨‹å¼ç¢¼åˆ°ç­–ç•¥ API
        await saveStrategy();
        
        showAlert('Jupyter ç­–ç•¥å„²å­˜æˆåŠŸ', 'success');
        
    } catch (error) {
        console.error('å„²å­˜ Jupyter ç­–ç•¥å¤±æ•—:', error);
        showAlert('å„²å­˜ Jupyter ç­–ç•¥å¤±æ•—', 'danger');
    }
}

// å„²å­˜ Jupyter ç­†è¨˜æœ¬ï¼ˆæœ¬åœ°+å¾Œç«¯ï¼‰
async function saveJupyterNotebook() {
    if (!currentStrategyId) {
        showAlert('è«‹å…ˆé¸æ“‡æˆ–å»ºç«‹ç­–ç•¥', 'warning');
        return;
    }
    const notebook = {
        cells: jupyterCells.map(cellId => {
            const editor = jupyterCellEditors[cellId];
            return {
                id: cellId,
                code: editor ? editor.getValue() : '',
                outputs: document.getElementById(`output_${cellId}`).innerHTML
            };
        }),
        metadata: {
            created: new Date().toISOString(),
            total_cells: jupyterCells.length
        }
    };
    // å„²å­˜åˆ° localStorage
    localStorage.setItem('jupyter_notebook', JSON.stringify(notebook));
    // åŒæ­¥å„²å­˜åˆ°å¾Œç«¯
    try {
        const response = await fetch(`/api/jupyter/notebook/${currentStrategyId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cells: notebook.cells })
        });
        const data = await response.json();
        if (data.status === 'success') {
            showAlert('ç­†è¨˜æœ¬å·²å„²å­˜ï¼ˆæœ¬åœ°+å¾Œç«¯ï¼‰', 'success');
        } else {
            showAlert('æœ¬åœ°å·²å„²å­˜ï¼Œä½†å¾Œç«¯å„²å­˜å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'), 'warning');
        }
    } catch (error) {
        showAlert('æœ¬åœ°å·²å„²å­˜ï¼Œä½†å¾Œç«¯å„²å­˜å¤±æ•—: ' + error, 'warning');
    }
}

// åŒ¯å‡º Jupyter ç­†è¨˜æœ¬
function exportJupyterNotebook() {
    const notebook = {
        cells: jupyterCells.map(cellId => {
            const editor = jupyterCellEditors[cellId];
            return {
                id: cellId,
                code: editor ? editor.getValue() : '',
                outputs: document.getElementById(`output_${cellId}`).innerHTML
            };
        }),
        metadata: {
            created: new Date().toISOString(),
            total_cells: jupyterCells.length
        }
    };
    
    // ä¸‹è¼‰ JSON æª”æ¡ˆ
    const blob = new Blob([JSON.stringify(notebook, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `jupyter_notebook_${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showAlert('ç­†è¨˜æœ¬åŒ¯å‡ºæˆåŠŸ', 'success');
}

// è¼‰å…¥ Jupyter ç­†è¨˜æœ¬ï¼ˆæœ¬åœ°ï¼‰
function loadJupyterNotebook(notebookData) {
    // æ¸…é™¤ç¾æœ‰å–®å…ƒæ ¼
    jupyterCells.forEach(cellId => {
        const editor = jupyterCellEditors[cellId];
        if (editor) {
            editor.toTextArea();
            delete jupyterCellEditors[cellId];
        }
    });
    jupyterCells = [];
    document.getElementById('jupyterCells').innerHTML = '';
    jupyterCellCounter = 0; // <--- æ–°å¢ï¼šæ¯æ¬¡è¼‰å…¥æ­¸é›¶
    // è¼‰å…¥ç­†è¨˜æœ¬å–®å…ƒæ ¼
    if (notebookData.cells && notebookData.cells.length > 0) {
        notebookData.cells.forEach(cellData => {
            const cellId = addJupyterCell(cellData.code);
            
            // æ¢å¾©è¼¸å‡º
            if (cellData.outputs) {
                const outputContainer = document.getElementById(`output_${cellId}`);
                outputContainer.innerHTML = cellData.outputs;
            }
        });
    } else {
        addJupyterCell('');
    }
    showAlert('ç­†è¨˜æœ¬è¼‰å…¥æˆåŠŸ', 'success');
}

// å¾å¾Œç«¯è¼‰å…¥ Jupyter notebook çµæ§‹
function loadJupyterNotebookFromBackend(notebookData) {
    // æ¸…é™¤ç¾æœ‰å–®å…ƒæ ¼
    jupyterCells.forEach(cellId => {
        const editor = jupyterCellEditors[cellId];
        if (editor) {
            editor.toTextArea();
            delete jupyterCellEditors[cellId];
        }
    });
    jupyterCells = [];
    document.getElementById('jupyterCells').innerHTML = '';
    jupyterCellCounter = 0;
    
    // è¼‰å…¥ç­†è¨˜æœ¬å–®å…ƒæ ¼
    if (notebookData.cells && notebookData.cells.length > 0) {
        notebookData.cells.forEach(cellData => {
            const cellId = addJupyterCell(cellData.code || '');
            
            // æ¢å¾©è¼¸å‡º
            if (cellData.outputs) {
                const outputContainer = document.getElementById(`output_${cellId}`);
                if (outputContainer) {
                    outputContainer.innerHTML = cellData.outputs;
                }
            }
        });
    } else {
        addJupyterCell('');
    }
    
    console.log(`å¾å¾Œç«¯è¼‰å…¥ Jupyter notebookï¼Œå…± ${notebookData.cells ? notebookData.cells.length : 0} å€‹ cell`);
}

// è¼‰å…¥ç­–ç•¥ç¨‹å¼ç¢¼åˆ° Jupyter ç·¨è¼¯å™¨
function loadStrategyCodeToJupyter(strategyCode, strategyType) {
    // æ¸…é™¤ç¾æœ‰å–®å…ƒæ ¼
    jupyterCells.forEach(cellId => {
        const editor = jupyterCellEditors[cellId];
        if (editor) {
            editor.toTextArea();
            delete jupyterCellEditors[cellId];
        }
    });
    jupyterCells = [];
    document.getElementById('jupyterCells').innerHTML = '';
    jupyterCellCounter = 0; // <--- æ¯æ¬¡è¼‰å…¥æ­¸é›¶
    if (strategyCode && strategyCode.trim()) {
        // æ”¯æ´å¤š cell è¼‰å…¥ï¼šä»¥ # %% æˆ– # <cell> ç‚ºåˆ†éš”ç¬¦
        let cellBlocks = strategyCode.split(/(?:^|\n)\s*# ?(?:%%|<cell>)(?:\s|$)/g);
        cellBlocks = cellBlocks.map(block => block.trim()).filter(block => block.length > 0);
        if (cellBlocks.length > 0) {
            cellBlocks.forEach(code => addJupyterCell(code));
            showAlert(cellBlocks.length > 1 ? 'å¤šå–®å…ƒæ ¼ç­–ç•¥ç¨‹å¼ç¢¼å·²è¼‰å…¥åˆ° Jupyter ç·¨è¼¯å™¨' : 'ç­–ç•¥ç¨‹å¼ç¢¼å·²è¼‰å…¥åˆ° Jupyter ç·¨è¼¯å™¨', 'success');
        } else {
            // è‹¥ code æœ‰å…§å®¹ä½†æ²’åˆ†éš”ç¬¦ï¼Œç›´æ¥å»ºç«‹ä¸€å€‹ cell ä¸¦é¡¯ç¤ºå…§å®¹
            addJupyterCell(strategyCode);
            showAlert('ç­–ç•¥ç¨‹å¼ç¢¼å·²è¼‰å…¥åˆ° Jupyter ç·¨è¼¯å™¨', 'success');
        }
    } else {
        // å¦‚æœæ²’æœ‰ç¨‹å¼ç¢¼ï¼Œè¼‰å…¥å°æ‡‰çš„æ¨¡æ¿
        loadJupyterStrategyTemplate(strategyType);
    }
}

// è¼‰å…¥ Jupyter ç­–ç•¥æ¨¡æ¿
function loadJupyterStrategyTemplate(strategyType) {
    // æ¸…é™¤ç¾æœ‰å–®å…ƒæ ¼
    jupyterCells.forEach(cellId => {
        const editor = jupyterCellEditors[cellId];
        if (editor) {
            editor.toTextArea();
            delete jupyterCellEditors[cellId];
        }
    });
    jupyterCells = [];
    document.getElementById('jupyterCells').innerHTML = '';
    jupyterCellCounter = 0; // <--- æ–°å¢ï¼šæ¯æ¬¡è¼‰å…¥æ­¸é›¶
    // æ ¹æ“šç­–ç•¥é¡å‹è¼‰å…¥å°æ‡‰çš„æ¨¡æ¿
    switch (strategyType) {
        case 'vectorized':
            loadVectorizedJupyterTemplate();
            break;
        case 'state_machine':
            loadStateMachineJupyterTemplate();
            break;
        case 'hybrid':
            loadHybridJupyterTemplate();
            break;
        case 'analysis':
        default:
            loadAnalysisJupyterTemplate();
            break;
    }
    // è‹¥è¼‰å…¥å¾Œ cell æ•¸ç‚º 0ï¼Œå¼·åˆ¶å»ºç«‹ä¸€å€‹ç©º cell
    if (jupyterCells.length === 0) {
        addJupyterCell('');
    }
}

// è¼‰å…¥å‘é‡åŒ–ç­–ç•¥æ¨¡æ¿
function loadVectorizedJupyterTemplate() {
    addJupyterCell(`# å‘é‡åŒ–ç­–ç•¥æ¨¡æ¿
# é€™å€‹ç­–ç•¥ä½¿ç”¨å‘é‡åŒ–è¨ˆç®—ï¼Œä¸€æ¬¡æ€§è™•ç†æ‰€æœ‰è³‡æ–™

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt

print("å‘é‡åŒ–ç­–ç•¥æ¨¡æ¿è¼‰å…¥å®Œæˆï¼")`);
    
    addJupyterCell(`# è¼‰å…¥æˆ–ç”Ÿæˆè‚¡ç¥¨è³‡æ–™
# é€™è£¡å¯ä»¥è¼‰å…¥å¯¦éš›çš„è‚¡ç¥¨è³‡æ–™æˆ–ä½¿ç”¨ç¯„ä¾‹è³‡æ–™

# ç”Ÿæˆç¯„ä¾‹è‚¡ç¥¨è³‡æ–™
dates = pd.date_range('2024-01-01', '2024-12-31', freq='D')
np.random.seed(42)

close_prices = 100 + np.cumsum(np.random.normal(0, 0.5, len(dates)))
df = pd.DataFrame({
    'date': dates,
    'close': close_prices,
    'volume': np.random.uniform(1000000, 5000000, len(dates))
})

print(f"è¼‰å…¥ {len(df)} ç­†è‚¡ç¥¨è³‡æ–™")
df.head()`);
    
    addJupyterCell(`# è¨ˆç®—æŠ€è¡“æŒ‡æ¨™ï¼ˆå‘é‡åŒ–ï¼‰
# ä¸€æ¬¡æ€§è¨ˆç®—æ‰€æœ‰æŠ€è¡“æŒ‡æ¨™

df['ma5'] = df['close'].rolling(5).mean()
df['ma20'] = df['close'].rolling(20).mean()
df['ma60'] = df['close'].rolling(60).mean()

# è¨ˆç®—å¸ƒæ—é€šé“
df['bb_upper'] = df['ma20'] + 2 * df['close'].rolling(20).std()
df['bb_lower'] = df['ma20'] - 2 * df['close'].rolling(20).std()

# è¨ˆç®— RSI
delta = df['close'].diff()
gain = (delta.where(delta > 0, 0)).rolling(window=14).mean()
loss = (-delta.where(delta < 0, 0)).rolling(window=14).mean()
rs = gain / loss
df['rsi'] = 100 - (100 / (1 + rs))

print("æŠ€è¡“æŒ‡æ¨™è¨ˆç®—å®Œæˆ")
df.tail()`);
    
    addJupyterCell(`# å‘é‡åŒ–ä¿¡è™Ÿç”Ÿæˆ
# ä¸€æ¬¡æ€§ç”Ÿæˆæ‰€æœ‰äº¤æ˜“ä¿¡è™Ÿ

# ç§»å‹•å¹³å‡äº¤å‰ä¿¡è™Ÿ
df['ma_cross_signal'] = np.where(
    (df['ma5'] > df['ma20']) & (df['ma5'].shift(1) <= df['ma20'].shift(1)), 
    1,  # è²·å…¥ä¿¡è™Ÿ
    np.where(
        (df['ma5'] < df['ma20']) & (df['ma5'].shift(1) >= df['ma20'].shift(1)), 
        -1,  # è³£å‡ºä¿¡è™Ÿ
        0  # ç„¡ä¿¡è™Ÿ
    )
)

# RSI è¶…è²·è¶…è³£ä¿¡è™Ÿ
df['rsi_signal'] = np.where(
    df['rsi'] < 30, 1,  # RSI è¶…è³£ï¼Œè²·å…¥ä¿¡è™Ÿ
    np.where(df['rsi'] > 70, -1, 0)  # RSI è¶…è²·ï¼Œè³£å‡ºä¿¡è™Ÿ
)

# å¸ƒæ—é€šé“çªç ´ä¿¡è™Ÿ
df['bb_signal'] = np.where(
    df['close'] < df['bb_lower'], 1,  # åƒ¹æ ¼çªç ´ä¸‹è»Œï¼Œè²·å…¥ä¿¡è™Ÿ
    np.where(df['close'] > df['bb_upper'], -1, 0)  # åƒ¹æ ¼çªç ´ä¸Šè»Œï¼Œè³£å‡ºä¿¡è™Ÿ
)

# ç¶œåˆä¿¡è™Ÿ
df['combined_signal'] = df['ma_cross_signal'] + df['rsi_signal'] + df['bb_signal']

print("ä¿¡è™Ÿç”Ÿæˆå®Œæˆ")
print(f"è²·å…¥ä¿¡è™Ÿæ•¸é‡: {(df['combined_signal'] > 0).sum()}")
print(f"è³£å‡ºä¿¡è™Ÿæ•¸é‡: {(df['combined_signal'] < 0).sum()}")
df[['date', 'close', 'ma_cross_signal', 'rsi_signal', 'bb_signal', 'combined_signal']].tail()`);
    
    addJupyterCell(`# ç­–ç•¥å›æ¸¬ï¼ˆå‘é‡åŒ–ï¼‰
# è¨ˆç®—ç­–ç•¥å ±é…¬

# è¨ˆç®—æ—¥å ±é…¬ç‡
df['daily_return'] = df['close'].pct_change()

# ç­–ç•¥å ±é…¬ç‡ï¼ˆå‡è¨­ä¿¡è™Ÿç‚º 1 æ™‚è²·å…¥ï¼Œ-1 æ™‚è³£å‡ºï¼‰
df['strategy_return'] = df['combined_signal'].shift(1) * df['daily_return']

# ç´¯ç©å ±é…¬ç‡
df['cumulative_return'] = (1 + df['daily_return']).cumprod()
df['strategy_cumulative_return'] = (1 + df['strategy_return']).cumprod()

# è¨ˆç®—ç­–ç•¥ç¸¾æ•ˆæŒ‡æ¨™
total_return = df['strategy_cumulative_return'].iloc[-1] - 1
annual_return = (1 + total_return) ** (252 / len(df)) - 1
volatility = df['strategy_return'].std() * np.sqrt(252)
sharpe_ratio = annual_return / volatility if volatility > 0 else 0

print(f"ç¸½å ±é…¬ç‡: {total_return:.2%}")
print(f"å¹´åŒ–å ±é…¬ç‡: {annual_return:.2%}")
print(f"å¹´åŒ–æ³¢å‹•ç‡: {volatility:.2%}")
print(f"å¤æ™®æ¯”ç‡: {sharpe_ratio:.2f}")`);
    
    addJupyterCell(`# ç¹ªè£½ç­–ç•¥ç¸¾æ•ˆåœ–
plt.figure(figsize=(15, 10))

# å­åœ– 1: è‚¡åƒ¹å’Œç§»å‹•å¹³å‡ç·š
plt.subplot(3, 1, 1)
plt.plot(df['date'], df['close'], label='æ”¶ç›¤åƒ¹', linewidth=2)
plt.plot(df['date'], df['ma5'], label='5æ—¥å‡ç·š', alpha=0.7)
plt.plot(df['date'], df['ma20'], label='20æ—¥å‡ç·š', alpha=0.7)
plt.plot(df['date'], df['ma60'], label='60æ—¥å‡ç·š', alpha=0.7)

# æ¨™è¨˜è²·è³£ä¿¡è™Ÿ
buy_signals = df[df['combined_signal'] > 0]
sell_signals = df[df['combined_signal'] < 0]

plt.scatter(buy_signals['date'], buy_signals['close'], 
           color='green', marker='^', s=100, label='è²·å…¥ä¿¡è™Ÿ', alpha=0.7)
plt.scatter(sell_signals['date'], sell_signals['close'], 
           color='red', marker='v', s=100, label='è³£å‡ºä¿¡è™Ÿ', alpha=0.7)

plt.title('å‘é‡åŒ–ç­–ç•¥ - è‚¡åƒ¹èˆ‡ä¿¡è™Ÿ', fontsize=14)
plt.ylabel('åƒ¹æ ¼')
plt.legend()
plt.grid(True, alpha=0.3)

# å­åœ– 2: RSI æŒ‡æ¨™
plt.subplot(3, 1, 2)
plt.plot(df['date'], df['rsi'], label='RSI', linewidth=2)
plt.axhline(y=70, color='r', linestyle='--', alpha=0.7, label='è¶…è²·ç·š')
plt.axhline(y=30, color='g', linestyle='--', alpha=0.7, label='è¶…è³£ç·š')
plt.title('RSI æŒ‡æ¨™', fontsize=14)
plt.ylabel('RSI')
plt.legend()
plt.grid(True, alpha=0.3)

# å­åœ– 3: ç´¯ç©å ±é…¬ç‡
plt.subplot(3, 1, 3)
plt.plot(df['date'], df['cumulative_return'], label='è²·å…¥æŒæœ‰', linewidth=2)
plt.plot(df['date'], df['strategy_cumulative_return'], label='ç­–ç•¥å ±é…¬', linewidth=2)
plt.title('ç­–ç•¥ç¸¾æ•ˆæ¯”è¼ƒ', fontsize=14)
plt.xlabel('æ—¥æœŸ')
plt.ylabel('ç´¯ç©å ±é…¬ç‡')
plt.legend()
plt.grid(True, alpha=0.3)

plt.tight_layout()
plt.show()`);
}

// è¼‰å…¥ç‹€æ…‹æ©Ÿç­–ç•¥æ¨¡æ¿
function loadStateMachineJupyterTemplate() {
    addJupyterCell(`# ç‹€æ…‹æ©Ÿç­–ç•¥æ¨¡æ¿
# é€™å€‹ç­–ç•¥ä½¿ç”¨ç‹€æ…‹æ©Ÿæ¨¡å¼ï¼Œé€ç­†è™•ç†è³‡æ–™ä¸¦è¿½è¹¤ç‹€æ…‹

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from enum import Enum

class PositionState(Enum):
    CASH = "ç¾é‡‘"
    LONG = "åšå¤š"
    SHORT = "åšç©º"

print("ç‹€æ…‹æ©Ÿç­–ç•¥æ¨¡æ¿è¼‰å…¥å®Œæˆï¼")`);
    
    addJupyterCell(`# è¼‰å…¥æˆ–ç”Ÿæˆè‚¡ç¥¨è³‡æ–™
# é€™è£¡å¯ä»¥è¼‰å…¥å¯¦éš›çš„è‚¡ç¥¨è³‡æ–™æˆ–ä½¿ç”¨ç¯„ä¾‹è³‡æ–™

# ç”Ÿæˆç¯„ä¾‹è‚¡ç¥¨è³‡æ–™
dates = pd.date_range('2024-01-01', '2024-12-31', freq='D')
np.random.seed(42)

close_prices = 100 + np.cumsum(np.random.normal(0, 0.5, len(dates)))
df = pd.DataFrame({
    'date': dates,
    'close': close_prices,
    'volume': np.random.uniform(1000000, 5000000, len(dates))
})

print(f"è¼‰å…¥ {len(df)} ç­†è‚¡ç¥¨è³‡æ–™")
df.head()`);
    
    addJupyterCell(`# è¨ˆç®—æŠ€è¡“æŒ‡æ¨™
df['ma5'] = df['close'].rolling(5).mean()
df['ma20'] = df['close'].rolling(20).mean()
df['ma60'] = df['close'].rolling(60).mean()

# è¨ˆç®— RSI
delta = df['close'].diff()
gain = (delta.where(delta > 0, 0)).rolling(window=14).mean()
loss = (-delta.where(delta < 0, 0)).rolling(window=14).mean()
rs = gain / loss
df['rsi'] = 100 - (100 / (1 + rs))

print("æŠ€è¡“æŒ‡æ¨™è¨ˆç®—å®Œæˆ")
df.tail()`);
    
    addJupyterCell(`# ç‹€æ…‹æ©Ÿç­–ç•¥é‚è¼¯
class StateMachineStrategy:
    def __init__(self):
        self.position = PositionState.CASH
        self.entry_price = 0
        self.entry_date = None
        self.trades = []
        self.current_capital = 100000  # åˆå§‹è³‡é‡‘ 10 è¬
        
    def should_entry(self, row):
        """åˆ¤æ–·æ˜¯å¦æ‡‰è©²é€²å ´"""
        if self.position != PositionState.CASH:
            return False
            
        # é€²å ´æ¢ä»¶ï¼š5æ—¥å‡ç·š > 20æ—¥å‡ç·š ä¸” RSI < 70
        return (row['ma5'] > row['ma20'] and 
                row['rsi'] < 70 and 
                row['ma5'] > row['ma5'].shift(1))  # å‡ç·šå‘ä¸Š
    
    def should_exit(self, row):
        """åˆ¤æ–·æ˜¯å¦æ‡‰è©²å‡ºå ´"""
        if self.position == PositionState.CASH:
            return False
            
        # å‡ºå ´æ¢ä»¶ï¼š5æ—¥å‡ç·š < 20æ—¥å‡ç·š æˆ– RSI > 80
        return (row['ma5'] < row['ma20'] or 
                row['rsi'] > 80)
    
    def execute_trade(self, row, action):
        """åŸ·è¡Œäº¤æ˜“"""
        if action == 'entry' and self.position == PositionState.CASH:
            self.position = PositionState.LONG
            self.entry_price = row['close']
            self.entry_date = row['date']
            print(f"è²·å…¥: {row['date'].strftime('%Y-%m-%d')} åƒ¹æ ¼: {row['close']:.2f}")
            
        elif action == 'exit' and self.position == PositionState.LONG:
            exit_price = row['close']
            profit_loss = exit_price - self.entry_price
            profit_rate = (profit_loss / self.entry_price) * 100
            
            self.trades.append({
                'entry_date': self.entry_date,
                'exit_date': row['date'],
                'entry_price': self.entry_price,
                'exit_price': exit_price,
                'profit_loss': profit_loss,
                'profit_rate': profit_rate
            })
            
            self.position = PositionState.CASH
            self.entry_price = 0
            self.entry_date = None
            
            print(f"è³£å‡º: {row['date'].strftime('%Y-%m-%d')} åƒ¹æ ¼: {exit_price:.2f} æç›Š: {profit_loss:.2f} ({profit_rate:.2f}%)")

# å»ºç«‹ç­–ç•¥å¯¦ä¾‹
strategy = StateMachineStrategy()
print("ç‹€æ…‹æ©Ÿç­–ç•¥å¯¦ä¾‹å»ºç«‹å®Œæˆ")`);
    
    addJupyterCell(`# åŸ·è¡Œç‹€æ…‹æ©Ÿç­–ç•¥
# é€ç­†è™•ç†è³‡æ–™

for index, row in df.iterrows():
    if strategy.should_entry(row):
        strategy.execute_trade(row, 'entry')
    elif strategy.should_exit(row):
        strategy.execute_trade(row, 'exit')

# å¦‚æœæœ€å¾Œé‚„æœ‰æŒå€‰ï¼Œå¼·åˆ¶å¹³å€‰
if strategy.position == PositionState.LONG:
    last_row = df.iloc[-1]
    strategy.execute_trade(last_row, 'exit')

print(f"ç­–ç•¥åŸ·è¡Œå®Œæˆï¼Œå…±åŸ·è¡Œ {len(strategy.trades)} ç­†äº¤æ˜“")`);
    
    addJupyterCell(`# åˆ†æäº¤æ˜“çµæœ
if strategy.trades:
    trades_df = pd.DataFrame(strategy.trades)
    
    print("äº¤æ˜“è¨˜éŒ„:")
    print(trades_df)
    
    # è¨ˆç®—ç¸¾æ•ˆæŒ‡æ¨™
    total_trades = len(trades_df)
    winning_trades = len(trades_df[trades_df['profit_loss'] > 0])
    losing_trades = len(trades_df[trades_df['profit_loss'] < 0])
    
    win_rate = (winning_trades / total_trades) * 100 if total_trades > 0 else 0
    total_profit = trades_df['profit_loss'].sum()
    avg_profit = trades_df['profit_loss'].mean()
    max_profit = trades_df['profit_loss'].max()
    max_loss = trades_df['profit_loss'].min()
    
    print(f"\\nç¸¾æ•ˆçµ±è¨ˆ:")
    print(f"ç¸½äº¤æ˜“æ¬¡æ•¸: {total_trades}")
    print(f"ç²åˆ©äº¤æ˜“: {winning_trades}")
    print(f"è™§æäº¤æ˜“: {losing_trades}")
    print(f"å‹ç‡: {win_rate:.2f}%")
    print(f"ç¸½æç›Š: {total_profit:.2f}")
    print(f"å¹³å‡æç›Š: {avg_profit:.2f}")
    print(f"æœ€å¤§ç²åˆ©: {max_profit:.2f}")
    print(f"æœ€å¤§è™§æ: {max_loss:.2f}")
    
    # ç¹ªè£½äº¤æ˜“çµæœ
    plt.figure(figsize=(15, 10))
    
    # å­åœ– 1: è‚¡åƒ¹å’Œäº¤æ˜“é»ä½
    plt.subplot(2, 1, 1)
    plt.plot(df['date'], df['close'], label='æ”¶ç›¤åƒ¹', linewidth=2)
    
    # æ¨™è¨˜è²·è³£é»ä½
    for trade in strategy.trades:
        plt.scatter(trade['entry_date'], trade['entry_price'], 
                   color='green', marker='^', s=100, alpha=0.7)
        plt.scatter(trade['exit_date'], trade['exit_price'], 
                   color='red', marker='v', s=100, alpha=0.7)
    
    plt.title('ç‹€æ…‹æ©Ÿç­–ç•¥ - äº¤æ˜“é»ä½', fontsize=14)
    plt.ylabel('åƒ¹æ ¼')
    plt.legend()
    plt.grid(True, alpha=0.3)
    
    # å­åœ– 2: ç´¯ç©æç›Š
    plt.subplot(2, 1, 2)
    cumulative_profit = trades_df['profit_loss'].cumsum()
    plt.plot(trades_df['exit_date'], cumulative_profit, 
             label='ç´¯ç©æç›Š', linewidth=2, marker='o')
    plt.title('ç´¯ç©æç›Šæ›²ç·š', fontsize=14)
    plt.xlabel('æ—¥æœŸ')
    plt.ylabel('ç´¯ç©æç›Š')
    plt.legend()
    plt.grid(True, alpha=0.3)
    
    plt.tight_layout()
    plt.show()
    
else:
    print("æ²’æœ‰åŸ·è¡Œä»»ä½•äº¤æ˜“")`);
}

// è¼‰å…¥æ··åˆç­–ç•¥æ¨¡æ¿
function loadHybridJupyterTemplate() {
    addJupyterCell(`# æ··åˆç­–ç•¥æ¨¡æ¿
# çµåˆå‘é‡åŒ–å’Œç‹€æ…‹æ©Ÿçš„å„ªå‹¢

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from enum import Enum

class PositionState(Enum):
    CASH = "ç¾é‡‘"
    LONG = "åšå¤š"
    SHORT = "åšç©º"

print("æ··åˆç­–ç•¥æ¨¡æ¿è¼‰å…¥å®Œæˆï¼")`);
    
    addJupyterCell(`# è¼‰å…¥æˆ–ç”Ÿæˆè‚¡ç¥¨è³‡æ–™
dates = pd.date_range('2024-01-01', '2024-12-31', freq='D')
np.random.seed(42)

close_prices = 100 + np.cumsum(np.random.normal(0, 0.5, len(dates)))
df = pd.DataFrame({
    'date': dates,
    'close': close_prices,
    'volume': np.random.uniform(1000000, 5000000, len(dates))
})

print(f"è¼‰å…¥ {len(df)} ç­†è‚¡ç¥¨è³‡æ–™")
df.head()`);
    
    addJupyterCell(`# å‘é‡åŒ–è¨ˆç®—æŠ€è¡“æŒ‡æ¨™
df['ma5'] = df['close'].rolling(5).mean()
df['ma20'] = df['close'].rolling(20).mean()
df['ma60'] = df['close'].rolling(60).mean()

# è¨ˆç®—å¸ƒæ—é€šé“
df['bb_upper'] = df['ma20'] + 2 * df['close'].rolling(20).std()
df['bb_lower'] = df['ma20'] - 2 * df['close'].rolling(20).std()

# è¨ˆç®— RSI
delta = df['close'].diff()
gain = (delta.where(delta > 0, 0)).rolling(window=14).mean()
loss = (-delta.where(delta < 0, 0)).rolling(window=14).mean()
rs = gain / loss
df['rsi'] = 100 - (100 / (1 + rs))

# è¨ˆç®— MACD
exp1 = df['close'].ewm(span=12).mean()
exp2 = df['close'].ewm(span=26).mean()
df['macd'] = exp1 - exp2
df['macd_signal'] = df['macd'].ewm(span=9).mean()
df['macd_histogram'] = df['macd'] - df['macd_signal']

print("æŠ€è¡“æŒ‡æ¨™è¨ˆç®—å®Œæˆ")
df.tail()`);
    
    addJupyterCell(`# å‘é‡åŒ–ä¿¡è™Ÿç”Ÿæˆ
# ä½¿ç”¨å‘é‡åŒ–è¨ˆç®—ç”Ÿæˆåˆæ­¥ä¿¡è™Ÿ

# ç§»å‹•å¹³å‡äº¤å‰ä¿¡è™Ÿ
df['ma_cross_signal'] = np.where(
    (df['ma5'] > df['ma20']) & (df['ma5'].shift(1) <= df['ma20'].shift(1)), 
    1,  # è²·å…¥ä¿¡è™Ÿ
    np.where(
        (df['ma5'] < df['ma20']) & (df['ma5'].shift(1) >= df['ma20'].shift(1)), 
        -1,  # è³£å‡ºä¿¡è™Ÿ
        0  # ç„¡ä¿¡è™Ÿ
    )
)

# RSI ä¿¡è™Ÿ
df['rsi_signal'] = np.where(
    df['rsi'] < 30, 1,  # RSI è¶…è³£ï¼Œè²·å…¥ä¿¡è™Ÿ
    np.where(df['rsi'] > 70, -1, 0)  # RSI è¶…è²·ï¼Œè³£å‡ºä¿¡è™Ÿ
)

# MACD ä¿¡è™Ÿ
df['macd_signal'] = np.where(
    (df['macd'] > df['macd_signal']) & (df['macd'].shift(1) <= df['macd_signal'].shift(1)), 
    1,  # MACD é‡‘å‰ï¼Œè²·å…¥ä¿¡è™Ÿ
    np.where(
        (df['macd'] < df['macd_signal']) & (df['macd'].shift(1) >= df['macd_signal'].shift(1)), 
        -1,  # MACD æ­»å‰ï¼Œè³£å‡ºä¿¡è™Ÿ
        0  # ç„¡ä¿¡è™Ÿ
    )
)

# ç¶œåˆä¿¡è™Ÿï¼ˆå‘é‡åŒ–ï¼‰
df['vector_signal'] = df['ma_cross_signal'] + df['rsi_signal'] + df['macd_signal']

print("å‘é‡åŒ–ä¿¡è™Ÿç”Ÿæˆå®Œæˆ")
print(f"å‘é‡åŒ–è²·å…¥ä¿¡è™Ÿ: {(df['vector_signal'] > 0).sum()}")
print(f"å‘é‡åŒ–è³£å‡ºä¿¡è™Ÿ: {(df['vector_signal'] < 0).sum()}")`);
    
    addJupyterCell(`# ç‹€æ…‹æ©Ÿä¿¡è™Ÿéæ¿¾
# ä½¿ç”¨ç‹€æ…‹æ©Ÿé‚è¼¯éæ¿¾å’Œå„ªåŒ–å‘é‡åŒ–ä¿¡è™Ÿ

class HybridStrategy:
    def __init__(self):
        self.position = PositionState.CASH
        self.entry_price = 0
        self.entry_date = None
        self.trades = []
        
    def should_entry(self, row):
        """åˆ¤æ–·æ˜¯å¦æ‡‰è©²é€²å ´ï¼ˆçµåˆå‘é‡åŒ–å’Œç‹€æ…‹æ©Ÿé‚è¼¯ï¼‰"""
        if self.position != PositionState.CASH:
            return False
            
        # å‘é‡åŒ–ä¿¡è™Ÿæ¢ä»¶
        vector_condition = row['vector_signal'] > 0
        
        # ç‹€æ…‹æ©Ÿç¢ºèªæ¢ä»¶
        state_condition = (
            row['ma5'] > row['ma20'] and  # å‡ç·šå¤šé ­æ’åˆ—
            row['rsi'] < 70 and  # RSI æœªè¶…è²·
            row['close'] > row['bb_lower'] and  # åƒ¹æ ¼åœ¨å¸ƒæ—é€šé“å…§
            row['macd_histogram'] > 0  # MACD æŸ±ç‹€åœ–ç‚ºæ­£
        )
        
        return vector_condition and state_condition
    
    def should_exit(self, row):
        """åˆ¤æ–·æ˜¯å¦æ‡‰è©²å‡ºå ´"""
        if self.position == PositionState.CASH:
            return False
            
        # å‘é‡åŒ–ä¿¡è™Ÿæ¢ä»¶
        vector_condition = row['vector_signal'] < 0
        
        # ç‹€æ…‹æ©Ÿæ¢ä»¶
        state_condition = (
            row['ma5'] < row['ma20'] or  # å‡ç·šç©ºé ­æ’åˆ—
            row['rsi'] > 80 or  # RSI è¶…è²·
            row['close'] < row['bb_lower'] or  # åƒ¹æ ¼è·Œç ´å¸ƒæ—ä¸‹è»Œ
            row['macd_histogram'] < 0  # MACD æŸ±ç‹€åœ–ç‚ºè² 
        )
        
        return vector_condition or state_condition
    
    def execute_trade(self, row, action):
        """åŸ·è¡Œäº¤æ˜“"""
        if action == 'entry' and self.position == PositionState.CASH:
            self.position = PositionState.LONG
            self.entry_price = row['close']
            self.entry_date = row['date']
            print(f"è²·å…¥: {row['date'].strftime('%Y-%m-%d')} åƒ¹æ ¼: {row['close']:.2f}")
            
        elif action == 'exit' and self.position == PositionState.LONG:
            exit_price = row['close']
            profit_loss = exit_price - self.entry_price
            profit_rate = (profit_loss / self.entry_price) * 100
            
            self.trades.append({
                'entry_date': self.entry_date,
                'exit_date': row['date'],
                'entry_price': self.entry_price,
                'exit_price': exit_price,
                'profit_loss': profit_loss,
                'profit_rate': profit_rate
            })
            
            self.position = PositionState.CASH
            self.entry_price = 0
            self.entry_date = None
            
            print(f"è³£å‡º: {row['date'].strftime('%Y-%m-%d')} åƒ¹æ ¼: {exit_price:.2f} æç›Š: {profit_loss:.2f} ({profit_rate:.2f}%)")

# å»ºç«‹æ··åˆç­–ç•¥å¯¦ä¾‹
hybrid_strategy = HybridStrategy()
print("æ··åˆç­–ç•¥å¯¦ä¾‹å»ºç«‹å®Œæˆ")`);
    
    addJupyterCell(`# åŸ·è¡Œæ··åˆç­–ç•¥
# çµåˆå‘é‡åŒ–å’Œç‹€æ…‹æ©Ÿçš„åŸ·è¡Œé‚è¼¯

for index, row in df.iterrows():
    if hybrid_strategy.should_entry(row):
        hybrid_strategy.execute_trade(row, 'entry')
    elif hybrid_strategy.should_exit(row):
        hybrid_strategy.execute_trade(row, 'exit')

# å¦‚æœæœ€å¾Œé‚„æœ‰æŒå€‰ï¼Œå¼·åˆ¶å¹³å€‰
if hybrid_strategy.position == PositionState.LONG:
    last_row = df.iloc[-1]
    hybrid_strategy.execute_trade(last_row, 'exit')

print(f"æ··åˆç­–ç•¥åŸ·è¡Œå®Œæˆï¼Œå…±åŸ·è¡Œ {len(hybrid_strategy.trades)} ç­†äº¤æ˜“")`);
    
    addJupyterCell(`# æ··åˆç­–ç•¥ç¸¾æ•ˆåˆ†æ
if hybrid_strategy.trades:
    trades_df = pd.DataFrame(hybrid_strategy.trades)
    
    print("äº¤æ˜“è¨˜éŒ„:")
    print(trades_df)
    
    # è¨ˆç®—ç¸¾æ•ˆæŒ‡æ¨™
    total_trades = len(trades_df)
    winning_trades = len(trades_df[trades_df['profit_loss'] > 0])
    losing_trades = len(trades_df[trades_df['profit_loss'] < 0])
    
    win_rate = (winning_trades / total_trades) * 100 if total_trades > 0 else 0
    total_profit = trades_df['profit_loss'].sum()
    avg_profit = trades_df['profit_loss'].mean()
    max_profit = trades_df['profit_loss'].max()
    max_loss = trades_df['profit_loss'].min()
    
    print(f"\\næ··åˆç­–ç•¥ç¸¾æ•ˆçµ±è¨ˆ:")
    print(f"ç¸½äº¤æ˜“æ¬¡æ•¸: {total_trades}")
    print(f"ç²åˆ©äº¤æ˜“: {winning_trades}")
    print(f"è™§æäº¤æ˜“: {losing_trades}")
    print(f"å‹ç‡: {win_rate:.2f}%")
    print(f"ç¸½æç›Š: {total_profit:.2f}")
    print(f"å¹³å‡æç›Š: {avg_profit:.2f}")
    print(f"æœ€å¤§ç²åˆ©: {max_profit:.2f}")
    print(f"æœ€å¤§è™§æ: {max_loss:.2f}")
    
    # ç¹ªè£½æ··åˆç­–ç•¥çµæœ
    plt.figure(figsize=(15, 12))
    
    # å­åœ– 1: è‚¡åƒ¹å’Œäº¤æ˜“é»ä½
    plt.subplot(3, 1, 1)
    plt.plot(df['date'], df['close'], label='æ”¶ç›¤åƒ¹', linewidth=2)
    plt.plot(df['date'], df['ma5'], label='5æ—¥å‡ç·š', alpha=0.7)
    plt.plot(df['date'], df['ma20'], label='20æ—¥å‡ç·š', alpha=0.7)
    
    # æ¨™è¨˜è²·è³£é»ä½
    for trade in hybrid_strategy.trades:
        plt.scatter(trade['entry_date'], trade['entry_price'], 
                   color='green', marker='^', s=100, alpha=0.7)
        plt.scatter(trade['exit_date'], trade['exit_price'], 
                   color='red', marker='v', s=100, alpha=0.7)
    
    plt.title('æ··åˆç­–ç•¥ - è‚¡åƒ¹èˆ‡äº¤æ˜“é»ä½', fontsize=14)
    plt.ylabel('åƒ¹æ ¼')
    plt.legend()
    plt.grid(True, alpha=0.3)
    
    # å­åœ– 2: RSI æŒ‡æ¨™
    plt.subplot(3, 1, 2)
    plt.plot(df['date'], df['rsi'], label='RSI', linewidth=2)
    plt.axhline(y=70, color='r', linestyle='--', alpha=0.7, label='è¶…è²·ç·š')
    plt.axhline(y=30, color='g', linestyle='--', alpha=0.7, label='è¶…è³£ç·š')
    plt.title('RSI æŒ‡æ¨™', fontsize=14)
    plt.ylabel('RSI')
    plt.legend()
    plt.grid(True, alpha=0.3)
    
    # å­åœ– 3: ç´¯ç©æç›Š
    plt.subplot(3, 1, 3)
    cumulative_profit = trades_df['profit_loss'].cumsum()
    plt.plot(trades_df['exit_date'], cumulative_profit, 
             label='ç´¯ç©æç›Š', linewidth=2, marker='o')
    plt.title('æ··åˆç­–ç•¥ç´¯ç©æç›Š', fontsize=14)
    plt.xlabel('æ—¥æœŸ')
    plt.ylabel('ç´¯ç©æç›Š')
    plt.legend()
    plt.grid(True, alpha=0.3)
    
    plt.tight_layout()
    plt.show()
    
else:
    print("æ²’æœ‰åŸ·è¡Œä»»ä½•äº¤æ˜“")`);
}

// è¼‰å…¥åˆ†ææ¨¡å¼æ¨¡æ¿
function loadAnalysisJupyterTemplate() {
    addJupyterCell(`# è³‡æ–™åˆ†ææ¨¡å¼æ¨¡æ¿
# ç´”è³‡æ–™åˆ†æï¼Œç„¡äº¤æ˜“é‚è¼¯

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

print("è³‡æ–™åˆ†ææ¨¡å¼æ¨¡æ¿è¼‰å…¥å®Œæˆï¼")`);
    
    addJupyterCell(`# è¼‰å…¥æˆ–ç”Ÿæˆè‚¡ç¥¨è³‡æ–™
dates = pd.date_range('2024-01-01', '2024-12-31', freq='D')
np.random.seed(42)

close_prices = 100 + np.cumsum(np.random.normal(0, 0.5, len(dates)))
df = pd.DataFrame({
    'date': dates,
    'close': close_prices,
    'volume': np.random.uniform(1000000, 5000000, len(dates))
})

print(f"è¼‰å…¥ {len(df)} ç­†è‚¡ç¥¨è³‡æ–™")
df.head()`);
    
    addJupyterCell(`# åŸºæœ¬çµ±è¨ˆåˆ†æ
print("åŸºæœ¬çµ±è¨ˆè³‡è¨Š:")
print(df.describe())

print("\\nè³‡æ–™å½¢ç‹€:", df.shape)
print("è³‡æ–™é¡å‹:")
print(df.dtypes)

print("\\nå‰ 5 ç­†è³‡æ–™:")
print(df.head())

print("\\nå¾Œ 5 ç­†è³‡æ–™:")
print(df.tail())`);
    
    addJupyterCell(`# è¨ˆç®—æŠ€è¡“æŒ‡æ¨™
# ç§»å‹•å¹³å‡ç·š
df['ma5'] = df['close'].rolling(5).mean()
df['ma10'] = df['close'].rolling(10).mean()
df['ma20'] = df['close'].rolling(20).mean()
df['ma60'] = df['close'].rolling(60).mean()

# æ—¥å ±é…¬ç‡
df['daily_return'] = df['close'].pct_change()

# æ³¢å‹•ç‡ï¼ˆ20æ—¥æ»¾å‹•ï¼‰
df['volatility'] = df['daily_return'].rolling(20).std() * np.sqrt(252)

# RSI
delta = df['close'].diff()
gain = (delta.where(delta > 0, 0)).rolling(window=14).mean()
loss = (-delta.where(delta < 0, 0)).rolling(window=14).mean()
rs = gain / loss
df['rsi'] = 100 - (100 / (1 + rs))

# å¸ƒæ—é€šé“
df['bb_upper'] = df['ma20'] + 2 * df['close'].rolling(20).std()
df['bb_lower'] = df['ma20'] - 2 * df['close'].rolling(20).std()
df['bb_width'] = (df['bb_upper'] - df['bb_lower']) / df['ma20']

print("æŠ€è¡“æŒ‡æ¨™è¨ˆç®—å®Œæˆ")
df.tail()`);
    
    addJupyterCell(`# åƒ¹æ ¼èµ°å‹¢åˆ†æ
plt.figure(figsize=(15, 12))

# å­åœ– 1: è‚¡åƒ¹å’Œç§»å‹•å¹³å‡ç·š
plt.subplot(3, 1, 1)
plt.plot(df['date'], df['close'], label='æ”¶ç›¤åƒ¹', linewidth=2)
plt.plot(df['date'], df['ma5'], label='5æ—¥å‡ç·š', alpha=0.7)
plt.plot(df['date'], df['ma10'], label='10æ—¥å‡ç·š', alpha=0.7)
plt.plot(df['date'], df['ma20'], label='20æ—¥å‡ç·š', alpha=0.7)
plt.plot(df['date'], df['ma60'], label='60æ—¥å‡ç·š', alpha=0.7)

plt.title('è‚¡ç¥¨åƒ¹æ ¼èˆ‡ç§»å‹•å¹³å‡ç·š', fontsize=14)
plt.ylabel('åƒ¹æ ¼')
plt.legend()
plt.grid(True, alpha=0.3)

# å­åœ– 2: å¸ƒæ—é€šé“
plt.subplot(3, 1, 2)
plt.plot(df['date'], df['close'], label='æ”¶ç›¤åƒ¹', linewidth=2)
plt.plot(df['date'], df['bb_upper'], label='å¸ƒæ—ä¸Šè»Œ', linestyle='--', alpha=0.7)
plt.plot(df['date'], df['bb_lower'], label='å¸ƒæ—ä¸‹è»Œ', linestyle='--', alpha=0.7)
plt.fill_between(df['date'], df['bb_upper'], df['bb_lower'], alpha=0.1)

plt.title('å¸ƒæ—é€šé“', fontsize=14)
plt.ylabel('åƒ¹æ ¼')
plt.legend()
plt.grid(True, alpha=0.3)

# å­åœ– 3: RSI æŒ‡æ¨™
plt.subplot(3, 1, 3)
plt.plot(df['date'], df['rsi'], label='RSI', linewidth=2)
plt.axhline(y=70, color='r', linestyle='--', alpha=0.7, label='è¶…è²·ç·š')
plt.axhline(y=30, color='g', linestyle='--', alpha=0.7, label='è¶…è³£ç·š')
plt.axhline(y=50, color='gray', linestyle='-', alpha=0.5, label='ä¸­ä½ç·š')

plt.title('RSI æŒ‡æ¨™', fontsize=14)
plt.xlabel('æ—¥æœŸ')
plt.ylabel('RSI')
plt.legend()
plt.grid(True, alpha=0.3)

plt.tight_layout()
plt.show()`);
    
    addJupyterCell(`# å ±é…¬ç‡åˆ†æ
plt.figure(figsize=(15, 10))

# å­åœ– 1: æ—¥å ±é…¬ç‡åˆ†å¸ƒ
plt.subplot(2, 2, 1)
plt.hist(df['daily_return'].dropna(), bins=50, alpha=0.7, edgecolor='black')
plt.title('æ—¥å ±é…¬ç‡åˆ†å¸ƒ')
plt.xlabel('æ—¥å ±é…¬ç‡')
plt.ylabel('é »ç‡')
plt.grid(True, alpha=0.3)

# å­åœ– 2: ç´¯ç©å ±é…¬ç‡
plt.subplot(2, 2, 2)
cumulative_return = (1 + df['daily_return']).cumprod()
plt.plot(df['date'], cumulative_return, linewidth=2)
plt.title('ç´¯ç©å ±é…¬ç‡')
plt.xlabel('æ—¥æœŸ')
plt.ylabel('ç´¯ç©å ±é…¬ç‡')
plt.grid(True, alpha=0.3)

# å­åœ– 3: æ³¢å‹•ç‡
plt.subplot(2, 2, 3)
plt.plot(df['date'], df['volatility'], linewidth=2)
plt.title('20æ—¥æ»¾å‹•æ³¢å‹•ç‡')
plt.xlabel('æ—¥æœŸ')
plt.ylabel('å¹´åŒ–æ³¢å‹•ç‡')
plt.grid(True, alpha=0.3)

# å­åœ– 4: å ±é…¬ç‡ vs æ³¢å‹•ç‡æ•£é»åœ–
plt.subplot(2, 2, 4)
plt.scatter(df['volatility'], df['daily_return'], alpha=0.5)
plt.title('å ±é…¬ç‡ vs æ³¢å‹•ç‡')
plt.xlabel('æ³¢å‹•ç‡')
plt.ylabel('æ—¥å ±é…¬ç‡')
plt.grid(True, alpha=0.3)

plt.tight_layout()
plt.show()`);
    
    addJupyterCell(`# çµ±è¨ˆåˆ†æå ±å‘Š
# è¨ˆç®—å„ç¨®çµ±è¨ˆæŒ‡æ¨™

# åŸºæœ¬çµ±è¨ˆ
total_return = (df['close'].iloc[-1] / df['close'].iloc[0]) - 1
annual_return = (1 + total_return) ** (252 / len(df)) - 1
volatility = df['daily_return'].std() * np.sqrt(252)
sharpe_ratio = annual_return / volatility if volatility > 0 else 0

# æœ€å¤§å›æ’¤
cumulative_return = (1 + df['daily_return']).cumprod()
rolling_max = cumulative_return.expanding().max()
drawdown = (cumulative_return - rolling_max) / rolling_max
max_drawdown = drawdown.min()

# ååº¦å’Œå³°åº¦
skewness = df['daily_return'].skew()
kurtosis = df['daily_return'].kurtosis()

print("=== è‚¡ç¥¨è³‡æ–™çµ±è¨ˆåˆ†æå ±å‘Š ===")
print(f"åˆ†ææœŸé–“: {df['date'].iloc[0].strftime('%Y-%m-%d')} è‡³ {df['date'].iloc[-1].strftime('%Y-%m-%d')}")
print(f"è³‡æ–™ç­†æ•¸: {len(df)}")
print(f"\\n=== å ±é…¬ç‡çµ±è¨ˆ ===")
print(f"ç¸½å ±é…¬ç‡: {total_return:.2%}")
print(f"å¹´åŒ–å ±é…¬ç‡: {annual_return:.2%}")
print(f"å¹´åŒ–æ³¢å‹•ç‡: {volatility:.2%}")
print(f"å¤æ™®æ¯”ç‡: {sharpe_ratio:.2f}")
print(f"æœ€å¤§å›æ’¤: {max_drawdown:.2%}")
print(f"\\n=== åˆ†å¸ƒçµ±è¨ˆ ===")
print(f"ååº¦: {skewness:.2f}")
print(f"å³°åº¦: {kurtosis:.2f}")
print(f"\\n=== åƒ¹æ ¼çµ±è¨ˆ ===")
print(f"æœ€é«˜åƒ¹: {df['close'].max():.2f}")
print(f"æœ€ä½åƒ¹: {df['close'].min():.2f}")
print(f"å¹³å‡åƒ¹: {df['close'].mean():.2f}")
print(f"åƒ¹æ ¼æ¨™æº–å·®: {df['close'].std():.2f}")`);
}

// æ–°å¢ï¼šé¡¯ç¤º Jupyter ç·¨è¼¯å™¨çš„è¼”åŠ©å‡½å¼
function showJupyterEditor() {
    const jupyterEditor = document.getElementById('jupyterEditor');
    const traditionalEditor = document.getElementById('traditionalEditor');
    const jupyterModeBtn = document.getElementById('jupyterModeBtn');
    if (jupyterEditor && traditionalEditor && jupyterModeBtn) {
        jupyterEditor.style.display = 'block';
        traditionalEditor.style.display = 'none';
        jupyterModeBtn.innerHTML = '<i class="fas fa-file-code"></i> åˆ‡æ›å‚³çµ±æ¨¡å¼';
        jupyterModeBtn.className = 'btn btn-sm btn-outline-primary';
    }
}

// åœ–è¡¨å°èˆªå‡½æ•¸
function navigateChartsSection(e) {
    e.preventDefault();
    if (isJupyterMode) {
        location.hash = '#jupyterChartsSection';
        // é¡¯ç¤º Jupyter å€å¡Š
        const jupyterChartsSection = document.getElementById('jupyterChartsSection');
        if (jupyterChartsSection) jupyterChartsSection.style.display = 'block';
    } else {
        location.hash = '#charts';
        // é¡¯ç¤ºå‚³çµ±åœ–è¡¨å€å¡Š
        const chartsSection = document.getElementById('charts');
        if (chartsSection) chartsSection.style.display = 'block';
        const noChartsMessage = document.getElementById('noChartsMessage');
        if (noChartsMessage && chartsSection.querySelectorAll('.chart-wrapper').length === 0) {
            noChartsMessage.style.display = 'block';
        }
    }
}
</script>
{% endblock %}