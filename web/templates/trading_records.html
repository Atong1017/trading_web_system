{% extends "base.html" %}

{% block title %}äº¤æ˜“è¨˜éŒ„{% endblock %}

{% block feature_nav %}
<div class="feature-nav">
    <h4><i class="fas fa-compass"></i> åŠŸèƒ½å€å°èˆª</h4>
    <!-- äº¤æ˜“è¨˜éŒ„åŠŸèƒ½å€ -->
    <div class="feature-section">
        <h5><i class="fas fa-history"></i> äº¤æ˜“è¨˜éŒ„åŠŸèƒ½</h5>
        <div class="feature-links">
            <a href="/trading-records#filter" class="feature-link">ç¯©é¸æ¢ä»¶ğŸ”</a>
            <a href="/trading-records#summary" class="feature-link">çµ±è¨ˆæ‘˜è¦ğŸ¯</a>
            <a href="/trading-records#records" class="feature-link">äº¤æ˜“è¨˜éŒ„ğŸ’°</a>
            <a href="/trading-records#export" class="feature-link">åŒ¯å‡ºåŠŸèƒ½ğŸ’¾</a>
        </div>
    </div>    
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-list-alt"></i> äº¤æ˜“è¨˜éŒ„
            </h2>
        </div>
    </div>

    <!-- ç¯©é¸æ¢ä»¶ -->
    <div class="row mb-4" id="filter">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-filter"></i> ç¯©é¸æ¢ä»¶</h5>
                </div>
                <div class="card-body">
                    <form id="filter-form">
                        <div class="row">
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="date-start">é–‹å§‹æ—¥æœŸ</label>
                                    <input type="date" class="form-control" id="date-start">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="date-end">çµæŸæ—¥æœŸ</label>
                                    <input type="date" class="form-control" id="date-end">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="stock-id">è‚¡ç¥¨ä»£ç¢¼</label>
                                    <input type="text" class="form-control" id="stock-id" placeholder="ä¾‹: 2330">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="strategy-filter">ç­–ç•¥</label>
                                    <select class="form-control" id="strategy-filter">
                                        <option value="">å…¨éƒ¨ç­–ç•¥</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="direction-filter">æ–¹å‘</label>
                                    <select class="form-control" id="direction-filter">
                                        <option value="">å…¨éƒ¨</option>
                                        <option value="buy">è²·å…¥</option>
                                        <option value="sell">è³£å‡º</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-search"></i> æœå°‹
                                        </button>
                                        <button type="button" class="btn btn-secondary" id="reset-filter">
                                            <i class="fas fa-undo"></i> é‡ç½®
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- çµ±è¨ˆæ‘˜è¦ -->
    <div class="row mb-4" id="summary">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-pie"></i> çµ±è¨ˆæ‘˜è¦</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <div class="stat-card">
                                <div class="stat-title">ç¸½äº¤æ˜“æ¬¡æ•¸</div>
                                <div class="stat-value" id="total-trades">0</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card">
                                <div class="stat-title">å‹ç‡</div>
                                <div class="stat-value" id="win-rate">0%</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card">
                                <div class="stat-title">ç¸½å ±é…¬</div>
                                <div class="stat-value" id="total-return">0%</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card">
                                <div class="stat-title">å¹³å‡å ±é…¬</div>
                                <div class="stat-value" id="avg-return">0%</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card">
                                <div class="stat-title">æœ€å¤§å–®ç­†ç²åˆ©</div>
                                <div class="stat-value" id="max-profit">0</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card">
                                <div class="stat-title">æœ€å¤§å–®ç­†è™§æ</div>
                                <div class="stat-value" id="max-loss">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- äº¤æ˜“è¨˜éŒ„è¡¨æ ¼ -->
    <div class="row mb-4" id="records">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-table"></i> äº¤æ˜“è¨˜éŒ„</h5>
                    <div>
                        <button type="button" class="btn btn-success" id="export-excel">
                            <i class="fas fa-file-excel"></i> åŒ¯å‡ºExcel
                        </button>
                        <button type="button" class="btn btn-info" id="refresh-data">
                            <i class="fas fa-sync-alt"></i> é‡æ–°æ•´ç†
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="trading-records-table">
                            <thead class="thead-dark">
                                <tr>
                                    <th>é€²å ´æ—¥æœŸ</th>
                                    <th>å‡ºå ´æ—¥æœŸ</th>
                                    <th>è‚¡ç¥¨ä»£ç¢¼</th>
                                    <th>è‚¡ç¥¨åç¨±</th>
                                    <th>æ–¹å‘</th>
                                    <th>é€²å ´åƒ¹æ ¼</th>
                                    <th>å‡ºå ´åƒ¹æ ¼</th>
                                    <th>è‚¡æ•¸</th>
                                    <th>æç›Š</th>
                                    <th>æç›Šç‡</th>
                                    <th>æ‰‹çºŒè²»</th>
                                    <th>è­‰äº¤ç¨…</th>
                                    <th>æ·¨æç›Š</th>
                                    <th>åœåˆ©åƒ¹</th>
                                    <th>åœæåƒ¹</th>
                                    <th>å‡ºå ´åŸå› </th>
                                    <th>æŒæœ‰å¤©æ•¸</th>
                                    <th>ç­–ç•¥</th>
                                </tr>
                            </thead>
                            <tbody id="trading-records-tbody">
                                <!-- å‹•æ…‹è¼‰å…¥äº¤æ˜“è¨˜éŒ„ -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- åˆ†é  -->
                    <nav aria-label="äº¤æ˜“è¨˜éŒ„åˆ†é ">
                        <ul class="pagination justify-content-center" id="pagination">
                            <!-- å‹•æ…‹è¼‰å…¥åˆ†é  -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- è©³ç´°è³‡è¨Šå°è©±æ¡† -->
    <div class="modal fade" id="tradeDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">äº¤æ˜“è©³ç´°è³‡è¨Š</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="trade-detail-content">
                    <!-- å‹•æ…‹è¼‰å…¥è©³ç´°è³‡è¨Š -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">é—œé–‰</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    let currentPage = 1;
    let pageSize = 20;
    let totalRecords = 0;
    let currentFilters = {};
    
    // åˆå§‹åŒ–é é¢
    initializePage();
    
    // è¼‰å…¥ç­–ç•¥åˆ—è¡¨
    loadStrategies();
    
    // è¼‰å…¥äº¤æ˜“è¨˜éŒ„
    loadTradingRecords();
    
    // ç¯©é¸è¡¨å–®æäº¤
    $('#filter-form').submit(function(e) {
        e.preventDefault();
        currentPage = 1;
        loadTradingRecords();
    });
    
    // é‡ç½®ç¯©é¸
    $('#reset-filter').click(function() {
        $('#filter-form')[0].reset();
        currentFilters = {};
        currentPage = 1;
        loadTradingRecords();
    });
    
    // åŒ¯å‡ºExcel
    $('#export-excel').click(function() {
        exportToExcel();
    });
    
    // é‡æ–°æ•´ç†è³‡æ–™
    $('#refresh-data').click(function() {
        loadTradingRecords();
    });
    
    // é»æ“Šäº¤æ˜“è¨˜éŒ„è¡Œé¡¯ç¤ºè©³ç´°è³‡è¨Š
    $(document).on('click', '.trade-row', function() {
        const tradeId = $(this).data('trade-id');
        showTradeDetail(tradeId);
    });
    
    function initializePage() {
        // è¨­å®šé è¨­æ—¥æœŸç¯„åœï¼ˆæœ€è¿‘30å¤©ï¼‰
        const today = new Date();
        const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
        
        $('#date-end').val(today.toISOString().split('T')[0]);
        $('#date-start').val(thirtyDaysAgo.toISOString().split('T')[0]);
        
        console.log('äº¤æ˜“è¨˜éŒ„é é¢åˆå§‹åŒ–å®Œæˆ');
    }
    
    function loadStrategies() {
        $.get('/api/strategies')
            .done(function(response) {
                if (response.status === 'success') {
                    const select = $('#strategy-filter');
                    
                    response.strategies.forEach(function(strategy) {
                        select.append(`<option value="${strategy.name}">${strategy.display_name}</option>`);
                    });
                }
            })
            .fail(function(xhr) {
                showError('è¼‰å…¥ç­–ç•¥åˆ—è¡¨å¤±æ•—: ' + xhr.responseText);
            });
    }
    
    function loadTradingRecords() {
        // æ”¶é›†ç¯©é¸æ¢ä»¶
        currentFilters = {
            start_date: $('#date-start').val(),
            end_date: $('#date-end').val(),
            stock_id: $('#stock-id').val(),
            strategy: $('#strategy-filter').val(),
            direction: $('#direction-filter').val(),
            page: currentPage,
            page_size: pageSize
        };
        
        // é¡¯ç¤ºè¼‰å…¥ä¸­
        showLoading();
        
        $.get('/api/trades', currentFilters)
            .done(function(response) {
                if (response.status === 'success') {
                    renderTradingRecords(response.trades);
                    renderPagination(response.total, response.page, response.page_size);
                    updateStatistics(response.statistics);
                }
            })
            .fail(function(xhr) {
                showError('è¼‰å…¥äº¤æ˜“è¨˜éŒ„å¤±æ•—: ' + xhr.responseText);
            })
            .always(function() {
                hideLoading();
            });
    }
    
    function renderTradingRecords(trades) {
        const tbody = $('#trading-records-tbody');
        tbody.empty();
        
        if (trades.length === 0) {
            tbody.append('<tr><td colspan="18" class="text-center text-muted">å°šç„¡äº¤æ˜“è¨˜éŒ„</td></tr>');
            return;
        }
        
        trades.forEach(function(trade) {
            const row = $('<tr class="trade-row" data-trade-id="' + trade.id + '"></tr>');
            row.append(`<td>${formatDate(trade.entry_date)}</td>`);
            row.append(`<td>${formatDate(trade.exit_date)}</td>`);
            row.append(`<td>${trade.stock_id}</td>`);
            row.append(`<td>${trade.stock_name || '-'}</td>`);
            row.append(`<td><span class="badge ${trade.trade_direction === 'buy' ? 'badge-success' : 'badge-danger'}">${trade.trade_direction === 'buy' ? 'è²·å…¥' : 'è³£å‡º'}</span></td>`);
            row.append(`<td>${formatPrice(trade.entry_price)}</td>`);
            row.append(`<td>${formatPrice(trade.exit_price)}</td>`);
            row.append(`<td>${trade.shares.toLocaleString()}</td>`);
            row.append(`<td class="${trade.profit_loss >= 0 ? 'text-success' : 'text-danger'}">${formatMoney(trade.profit_loss)}</td>`);
            row.append(`<td class="${trade.profit_loss_rate >= 0 ? 'text-success' : 'text-danger'}">${formatPercentage(trade.profit_loss_rate)}</td>`);
            row.append(`<td>${formatMoney(trade.commission)}</td>`);
            row.append(`<td>${formatMoney(trade.securities_tax)}</td>`);
            row.append(`<td class="${trade.net_profit_loss >= 0 ? 'text-success' : 'text-danger'} font-weight-bold">${formatMoney(trade.net_profit_loss)}</td>`);
            row.append(`<td>${formatPrice(trade.take_profit_price)}</td>`);
            row.append(`<td>${formatPrice(trade.stop_loss_price)}</td>`);
            row.append(`<td>${trade.exit_reason || '-'}</td>`);
            row.append(`<td>${trade.holding_days || '-'}</td>`);
            row.append(`<td>${trade.strategy || '-'}</td>`);
            
            tbody.append(row);
        });
    }
    
    function renderPagination(total, currentPage, pageSize) {
        const pagination = $('#pagination');
        pagination.empty();
        
        if (total <= pageSize) {
            return;
        }
        
        const totalPages = Math.ceil(total / pageSize);
        
        // ä¸Šä¸€é 
        const prevLi = $('<li class="page-item"></li>');
        const prevLink = $('<a class="page-link" href="#">ä¸Šä¸€é </a>');
        if (currentPage <= 1) {
            prevLi.addClass('disabled');
        } else {
            prevLink.click(function(e) {
                e.preventDefault();
                currentPage = currentPage - 1;
                loadTradingRecords();
            });
        }
        prevLi.append(prevLink);
        pagination.append(prevLi);
        
        // é ç¢¼
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);
        
        for (let i = startPage; i <= endPage; i++) {
            const li = $('<li class="page-item"></li>');
            const link = $(`<a class="page-link" href="#">${i}</a>`);
            
            if (i === currentPage) {
                li.addClass('active');
            } else {
                link.click(function(e) {
                    e.preventDefault();
                    currentPage = i;
                    loadTradingRecords();
                });
            }
            
            li.append(link);
            pagination.append(li);
        }
        
        // ä¸‹ä¸€é 
        const nextLi = $('<li class="page-item"></li>');
        const nextLink = $('<a class="page-link" href="#">ä¸‹ä¸€é </a>');
        if (currentPage >= totalPages) {
            nextLi.addClass('disabled');
        } else {
            nextLink.click(function(e) {
                e.preventDefault();
                currentPage = currentPage + 1;
                loadTradingRecords();
            });
        }
        nextLi.append(nextLink);
        pagination.append(nextLi);
    }
    
    function updateStatistics(stats) {
        $('#total-trades').text(stats.total_trades || 0);
        $('#win-rate').text(formatPercentage(stats.win_rate || 0));
        $('#total-return').text(formatPercentage(stats.total_return || 0));
        $('#avg-return').text(formatPercentage(stats.avg_return || 0));
        $('#max-profit').text(formatMoney(stats.max_profit || 0));
        $('#max-loss').text(formatMoney(stats.max_loss || 0));
    }
    
    function showTradeDetail(tradeId) {
        $.get(`/api/trades/${tradeId}`)
            .done(function(response) {
                if (response.status === 'success') {
                    renderTradeDetail(response.trade);
                    $('#tradeDetailModal').modal('show');
                }
            })
            .fail(function(xhr) {
                showError('è¼‰å…¥äº¤æ˜“è©³ç´°è³‡è¨Šå¤±æ•—: ' + xhr.responseText);
            });
    }
    
    function renderTradeDetail(trade) {
        const content = $('#trade-detail-content');
        content.html(`
            <div class="row">
                <div class="col-md-6">
                    <h6>åŸºæœ¬è³‡è¨Š</h6>
                    <table class="table table-sm">
                        <tr><td>è‚¡ç¥¨ä»£ç¢¼:</td><td>${trade.stock_id}</td></tr>
                        <tr><td>è‚¡ç¥¨åç¨±:</td><td>${trade.stock_name || '-'}</td></tr>
                        <tr><td>äº¤æ˜“æ–¹å‘:</td><td><span class="badge ${trade.trade_direction === 'buy' ? 'badge-success' : 'badge-danger'}">${trade.trade_direction === 'buy' ? 'è²·å…¥' : 'è³£å‡º'}</span></td></tr>
                        <tr><td>ç­–ç•¥:</td><td>${trade.strategy || '-'}</td></tr>
                        <tr><td>æŒæœ‰å¤©æ•¸:</td><td>${trade.holding_days || '-'}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>åƒ¹æ ¼è³‡è¨Š</h6>
                    <table class="table table-sm">
                        <tr><td>é€²å ´åƒ¹æ ¼:</td><td>${formatPrice(trade.entry_price)}</td></tr>
                        <tr><td>å‡ºå ´åƒ¹æ ¼:</td><td>${formatPrice(trade.exit_price)}</td></tr>
                        <tr><td>åœåˆ©åƒ¹æ ¼:</td><td>${formatPrice(trade.take_profit_price)}</td></tr>
                        <tr><td>åœæåƒ¹æ ¼:</td><td>${formatPrice(trade.stop_loss_price)}</td></tr>
                        <tr><td>è‚¡æ•¸:</td><td>${trade.shares.toLocaleString()}</td></tr>
                    </table>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <h6>æç›Šè¨ˆç®—</h6>
                    <table class="table table-sm">
                        <tr><td>æç›Š:</td><td class="${trade.profit_loss >= 0 ? 'text-success' : 'text-danger'}">${formatMoney(trade.profit_loss)}</td></tr>
                        <tr><td>æç›Šç‡:</td><td class="${trade.profit_loss_rate >= 0 ? 'text-success' : 'text-danger'}">${formatPercentage(trade.profit_loss_rate)}</td></tr>
                        <tr><td>æ‰‹çºŒè²»:</td><td>${formatMoney(trade.commission)}</td></tr>
                        <tr><td>è­‰äº¤ç¨…:</td><td>${formatMoney(trade.securities_tax)}</td></tr>
                        <tr><td>æ·¨æç›Š:</td><td class="${trade.net_profit_loss >= 0 ? 'text-success' : 'text-danger'} font-weight-bold">${formatMoney(trade.net_profit_loss)}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>æ™‚é–“è³‡è¨Š</h6>
                    <table class="table table-sm">
                        <tr><td>é€²å ´æ—¥æœŸ:</td><td>${formatDateTime(trade.entry_date)}</td></tr>
                        <tr><td>å‡ºå ´æ—¥æœŸ:</td><td>${formatDateTime(trade.exit_date)}</td></tr>
                        <tr><td>å‡ºå ´åŸå› :</td><td>${trade.exit_reason || '-'}</td></tr>
                    </table>
                </div>
            </div>
        `);
    }
    
    function exportToExcel() {
        // å»ºç«‹åŒ¯å‡ºåƒæ•¸
        const exportParams = {
            ...currentFilters,
            export_type: 'detailed'
        };
        
        // å»ºç«‹è¡¨å–®ä¸¦æäº¤
        const form = $('<form method="POST" action="/api/trades/export-excel"></form>');
        form.append('<input type="hidden" name="filters" value="' + JSON.stringify(exportParams) + '">');
        $('body').append(form);
        form.submit();
        form.remove();
    }
    
    function formatDate(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-TW');
    }
    
    function formatDateTime(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleString('zh-TW');
    }
    
    function formatPrice(price) {
        return price ? price.toFixed(2) : '-';
    }
    
    function formatMoney(amount) {
        if (amount === null || amount === undefined) return '-';
        return amount.toLocaleString('zh-TW', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });
    }
    
    function formatPercentage(value) {
        if (value === null || value === undefined) return '-';
        return (value * 100).toFixed(2) + '%';
    }
    
    function showLoading() {
        $('#trading-records-tbody').html('<tr><td colspan="18" class="text-center"><i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</td></tr>');
    }
    
    function hideLoading() {
        // è¼‰å…¥å®Œæˆå¾Œæœƒç”±renderTradingRecordsè™•ç†
    }
    
    function showError(message) {
        showAlert('danger', message);
    }
    
    function showAlert(type, message) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        `;
        $('.container-fluid').prepend(alertHtml);
        
        // è‡ªå‹•ç§»é™¤è­¦å‘Š
        setTimeout(function() {
            $('.alert').alert('close');
        }, 5000);
    }
});
</script>
{% endblock %} 