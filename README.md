# 台灣股票回測與自動下單系統

這是一個完整的台灣股票回測與自動下單系統，支援多策略、多資料來源、多股票並行處理，並提供完整的前後端介面。系統採用現代化的 Web 架構，支援 Jupyter 風格的互動式策略開發。

## 🚀 功能特色

### 📊 回測功能
- **策略支援**：自定義策略
- **多資料來源**：Excel上傳、API資料、手動輸入、範例資料
- **多股票並行處理**：使用多執行緒提升回測效能
- **智能欄位映射**：支援多種Excel欄位格式
- **完整前後端**：現代化Web介面，支援即時回測

### 🤖 自動下單功能
- **即時監控**：自動執行策略信號
- **風險控制**：停利停損、部位管理
- **多券商支援**：可擴展的券商API介面

### 🗄️ 快取系統
- **雙層快取**：記憶體快取 + 檔案快取
- **自動管理**：記憶體不足時自動清理最舊的資料
- **TTL 機制**：可設定快取存活時間
- **統計資訊**：提供詳細的快取使用統計

### 📈 自定義策略系統
- **傳統編輯器**：完整的程式碼編輯器，支援語法高亮、自動縮排
- **Jupyter 風格**：互動式單元格編輯，即時程式碼執行
- **模板系統**：提供策略模板
- **版本管理**：策略的建立、更新、刪除
- **圖表顯示**：支援 Matplotlib、Seaborn、Plotly 圖表

### 📋 資料預覽系統
- **範例資料**：提供多種預設資料類型
- **表格預覽**：支援最多100筆資料的表格顯示
- **自定義資料類型**：可新增和管理自定義資料類型

### 📊 交易記錄管理
- **多維度篩選**：支援日期、股票、策略、方向等多種篩選條件
- **統計分析**：提供勝率、報酬率、最大回撤等關鍵指標
- **匯出功能**：支援Excel匯出和分頁顯示

### 🎯 股票選擇器
- **多來源支援**：Excel匯入、手動新增、條件篩選
- **列表管理**：建立、編輯、刪除選股列表
- **策略整合**：與策略編輯器無縫整合

## 📁 專案結構

```
trading_web_system/
├── api/                    # API模組
├── config/                # 配置檔案
├── core/                  # 核心功能
├── data/                  # 資料目錄
├── routes/                # 路由模組
├── strategies/            # 策略模組
├── web/                   # 網頁介面
├── main.py               # FastAPI主程式
├── run.py                # 啟動腳本
└── requirements.txt      # 依賴套件
```

## 🛠️ 安裝與設定

### 1. 環境需求
- Python 3.8+
- Windows 10/11 或 Linux/macOS

### 2. 安裝依賴
```bash
pip install -r requirements.txt
```

### 3. 啟動系統
```bash
python run.py
```

系統將在 `http://localhost:8000` 啟動

## 📖 使用說明

### 首頁功能
- **回測系統**: 進入股票策略回測功能
- **策略編輯器**: 進入 Jupyter 風格策略編輯器
- **股票選擇器**: 管理股票清單
- **快取管理**: 管理系統快取
- **自動下單**: 進入自動交易系統
- **交易記錄**: 查看歷史交易記錄
- **系統設定**: 配置API和系統參數

### 策略編輯器

#### 編輯模式
- **傳統模式**: 完整的程式碼編輯器，適合編寫完整的策略程式碼
- **Jupyter 模式**: 互動式單元格編輯器，適合探索性資料分析和策略開發

#### 支援的模組
- **基本 Python 模組**: np, pd, pl, plt, sns, go
- **策略工具模組**: PriceUtils, Utils, TradeRecord, HoldingPosition

#### 快捷鍵
- **Shift+Enter**: 執行當前單元格
- **Ctrl+Enter**: 執行並新增單元格
- **Tab**: 自動縮排

### 快取系統

#### 快取管理頁面
訪問 `/cache-manager` 可以查看：
- 記憶體使用量統計
- 快取項目詳情
- 股票代碼列表
- 快取清理功能

### 自定義策略系統

#### 策略編輯器
訪問 `/strategy-editor` 進入策略編輯器，可以：
- 建立新策略
- 編輯現有策略
- 載入策略模板
- 驗證策略程式碼
- 測試策略功能

### 資料預覽系統

#### 預設資料類型
- **每日股價**: 股票每日開盤、收盤、最高、最低價等基本資訊
- **分K股價**: 股票分K線圖資料
- **除權息資料**: 股票除權息相關資訊
- **技術指標**: 包含各種技術指標的股價資料

### 回測功能使用

#### 選擇策略
- **當沖策略**：當日沖銷，以漲跌停為依據
- **波段策略**：波段交易，以20日新高為依據
- **詢圈公告策略**：基於詢圈公告進行交易
- **自定義策略**：使用策略編輯器建立的自定義策略

#### 設定資料來源
- **API模式**：上傳包含股票代碼和日期的Excel檔案，系統從API取得股價資料
- **Excel模式**：上傳包含完整K線資料的Excel檔案
- **範例資料**：使用系統提供的範例資料

## 📊 資料格式

### Excel檔案格式

#### 股價資料檔案
| 欄位 | 說明 | 範例 |
|------|------|------|
| stock_id | 股票代碼 | 2330 |
| date | 日期 | 2024-01-01 |
| open | 開盤價 | 100.0 |
| high | 最高價 | 101.0 |
| low | 最低價 | 99.0 |
| close | 收盤價 | 100.5 |
| volume | 成交量 | 1000000 |

#### 股票清單檔案
| 欄位 | 說明 | 範例 |
|------|------|------|
| stock_id | 股票代碼 | 2330 |
| date | 日期 | 2024-01-01 |

## 🔒 安全性

- API金鑰使用環境變數或加密儲存
- 檔案上傳有大小和格式限制
- 系統支援HTTPS加密傳輸
- 定期備份重要資料

## 🐛 故障排除

### 常見問題

#### 1. 模組導入錯誤
```bash
# 檢查Python版本
python --version

# 重新安裝依賴
pip install -r requirements.txt --force-reinstall
```

#### 2. 檔案上傳失敗
- 檢查檔案格式是否為Excel (.xlsx, .xls)
- 檢查檔案大小是否超過50MB
- 確認檔案包含必要欄位

#### 3. API連線失敗
- 檢查網路連線
- 確認API金鑰是否正確
- 檢查API服務是否正常

#### 4. 回測執行失敗
- 檢查資料格式是否正確
- 確認策略參數是否合理
- 查看系統日誌檔案

### 日誌檔案
系統日誌位於 `logs/` 目錄下，包含:
- `app.log`: 應用程式日誌
- `error.log`: 錯誤日誌
- `access.log`: 存取日誌

## 🤝 貢獻指南

1. Fork 專案
2. 建立功能分支 (`git checkout -b feature/AmazingFeature`)
3. 提交變更 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 開啟 Pull Request

## 📄 授權條款

本專案採用 MIT 授權條款 - 詳見 [LICENSE](LICENSE) 檔案

## 📞 支援

如有問題或建議，請:
1. 查看 [Issues](../../issues) 頁面
2. 建立新的 Issue
3. 聯繫開發團隊

## 🔄 更新日誌

### v3.0.0 (最新)
- 新增 Jupyter 風格策略編輯器
- 新增快取系統
- 新增自定義策略系統
- 新增資料預覽系統
- 新增股票選擇器功能
- 改善策略編輯器使用者體驗

### v2.0.0
- 新增完整的參數設定系統
- 支援共用參數（手續費、證交稅、交易股數）
- 新增進場/出場條件選擇
- 新增停利/停損開關選項

### v1.0.0
- 初始版本
- 支援基本回測功能
- 支援Excel檔案上傳
- 支援多執行緒處理
